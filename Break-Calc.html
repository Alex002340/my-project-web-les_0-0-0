<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Розширений калькулятор натиску гальмівних колодок</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* --- Neon Dark Theme (Default) --- */
            --bg-color: #10101a; --container-bg: #1a1a2e; --section-bg: rgba(26, 26, 46, 0.7); --section-bg-alt: rgba(35, 35, 60, 0.8); --input-bg: #252540;
            --text-color: #e5e5e5; --text-color-darker: #a0a0c0; --border-color: #404060;
            --primary-neon: #00e676; --secondary-neon: #00e5ff; --tertiary-neon: #ff00ff;
            --accent-color: var(--primary-neon); --accent-bg-light: rgba(0, 230, 118, 0.1); --accent-bg-medium: rgba(0, 230, 118, 0.2); --accent-bg-strong: rgba(0, 230, 118, 0.3); --accent-bg-hover: rgba(0, 230, 118, 0.4);
            --table-header-bg: rgba(42, 58, 90, 0.8); --table-row-odd-bg: rgba(30, 30, 50, 0.5); --table-row-hover-bg: rgba(52, 73, 94, 0.7);
            --button-text-color: white; --shadow-color: rgba(0, 0, 0, 0.5);
            --glow-color: rgba(0, 230, 118, 0.4); --glow-color-secondary: rgba(0, 229, 255, 0.3);
            --error-color: #ff4d4d; --warning-color: #ffcc00; --scroll-track-bg: #2a3a5a; --scroll-thumb-bg: #556a91;
            --link-color: var(--secondary-neon); --icon-filter: invert(0.9) hue-rotate(180deg) brightness(1.2);
            --animation-speed: 0.3s; --shine-speed: 0.8s;
            --neon-text-shadow: 0 0 2px rgba(229, 229, 229, 0.7), 0 0 4px var(--accent-color);
            --heading-neon-shadow: 0 0 4px var(--secondary-neon), 0 0 8px var(--secondary-neon);
            --th-neon-shadow: 0 0 3px rgba(229, 229, 229, 0.5);
            /* Chart Gradients (Dark) */
            --chart-grad-1-start: #00e676; --chart-grad-1-end: #00bfa5;
            --chart-grad-2-start: #00e5ff; --chart-grad-2-end: #00a2ff;
            --chart-grad-3-start: #ff00ff; --chart-grad-3-end: #c600ff;
            --chart-grad-4-start: #ff8a00; --chart-grad-4-end: #e52e71; /* For temperature chart & calc-temp-btn in dark */
            --chart-grad-5-start: #f0ff00; --chart-grad-5-end: #ffae00;
        }

        body.light-theme {
            /* --- Gradient Light Theme --- */
            --bg-color: linear-gradient(135deg, #eef2f7 0%, #f8fafc 100%); --container-bg: rgba(255, 255, 255, 0.9); --section-bg: rgba(255, 255, 255, 0.85); --section-bg-alt: #f8f9fa; --input-bg: #ffffff;
            --text-color: #343a40; --text-color-darker: #495057; --border-color: #ced4da;
            --primary-gradient-start: #007bff; --primary-gradient-end: #0056b3; --accent-color: #17a2b8;
            --accent-bg-light: rgba(23, 162, 184, 0.08); --accent-bg-medium: rgba(23, 162, 184, 0.12); --accent-bg-strong: rgba(23, 162, 184, 0.18); --accent-bg-hover: rgba(23, 162, 184, 0.25);
            --table-header-bg: #e9ecef; --table-row-odd-bg: transparent; --table-row-hover-bg: #e2e6ea;
            --button-text-color: white;
            --shadow-color: rgba(100, 100, 150, 0.15);
            --glow-color: rgba(0, 123, 255, 0.2); --glow-color-secondary: rgba(23, 162, 184, 0.25);
            --error-color: #dc3545; --warning-color: #ffc107; --scroll-track-bg: #e9ecef; --scroll-thumb-bg: #adb5bd;
            --link-color: var(--primary-gradient-start); --icon-filter: none;
            --neon-text-shadow: none; --heading-neon-shadow: none; --th-neon-shadow: none;
            /* Chart Gradients (Light) */
            --chart-grad-1-start: #007bff; --chart-grad-1-end: #56abff;
            --chart-grad-2-start: #17a2b8; --chart-grad-2-end: #52c2d5;
            --chart-grad-3-start: #28a745; --chart-grad-3-end: #5dd080;
            --chart-grad-4-start: #fd7e14; --chart-grad-4-end: #e83e8c; /* For temperature chart & calc-temp-btn in light (same as #temperature-btn) */
            --chart-grad-5-start: #ffc107; --chart-grad-5-end: #ffe082; /* Alt for light theme, e.g., if calc-temp-btn needs dark text */
        }

        /* Base Styles */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text-color); line-height: 1.6; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: background var(--animation-speed) ease, color var(--animation-speed) ease; }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: var(--scroll-track-bg); border-radius: 4px; } ::-webkit-scrollbar-thumb { background-color: var(--scroll-thumb-bg); border-radius: 4px; border: 2px solid var(--scroll-track-bg); } ::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--scroll-thumb-bg) 80%, white); }
        .calculator-container { background-color: var(--container-bg); padding: 35px 40px; border-radius: 15px; box-shadow: 0 10px 30px var(--shadow-color), 0 0 15px var(--glow-color-secondary); width: 100%; max-width: 1100px; margin-top: 20px; transition: all var(--animation-speed) ease; border: 1px solid var(--border-color); position: relative; backdrop-filter: blur(5px); }
        body.light-theme .calculator-container { box-shadow: 0 8px 25px var(--shadow-color); backdrop-filter: blur(10px); }
        .theme-toggle { position: absolute; top: 20px; right: 20px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all var(--animation-speed) ease; z-index: 20; text-shadow: none; }
        .theme-toggle:hover { background: var(--section-bg-alt); box-shadow: 0 0 8px var(--glow-color); }
        body.light-theme .theme-toggle:hover { box-shadow: 0 0 8px var(--shadow-color); }
        .version-info { position: absolute; top: 20px; left: 20px; font-size: 0.8em; color: var(--text-color-darker); opacity: 0.8; }

        /* Headings */
        h1, h2, h3 { color: var(--text-color); text-align: center; margin-bottom: 25px; padding-bottom: 12px; border-bottom: 2px solid; border-image: linear-gradient(to right, var(--secondary-neon), var(--tertiary-neon)) 1; transition: color var(--animation-speed) ease, border-image var(--animation-speed) ease, text-shadow var(--animation-speed) ease; text-shadow: var(--heading-neon-shadow); }
        body.light-theme h1, body.light-theme h2, body.light-theme h3 { border-image: linear-gradient(to right, var(--primary-gradient-start), var(--primary-gradient-end)) 1; }
        h1 { font-size: 1.8rem; font-weight: 600; margin-top: 10px; text-transform: uppercase; }
        h2 { font-size: 1.4rem; font-weight: 500; margin-top: 30px; }
        h3 { font-size: 1.2rem; font-weight: 500; margin-top: 20px; }
        h4 { font-size: 1.1rem; font-weight: 500; margin-top: 15px; color: var(--text-color); }
        body.light-theme h4 { color: var(--text-color); }
        .advanced-result-item h4,
        .calculation-details h4,
        .context-params h4,
        .interactive-controls h4,
        .locomotive-section .sub-options h4 {
             color: var(--accent-color);
        }


        /* Sections */
        .input-section, .results-section, .report-section, .advanced-section { margin-bottom: 30px; padding: 25px; border: 1px solid var(--border-color); border-radius: 10px; background-color: var(--section-bg); transition: all 0.5s ease-in-out; }
        .advanced-section { background-color: var(--section-bg-alt); }

        /* Locomotive Section Specifics */
        .locomotive-section .sub-options {
            padding-left: 20px;
            border-left: 2px solid var(--border-color);
            margin-left: 5px;
            margin-top: 15px;
            padding-top: 10px;
            display: none;
        }
        .locomotive-section .sub-options.active {
            display: block;
        }
        .locomotive-section .sub-options h4 {
            font-size: 1.05em;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--border-color);
        }


        .input-section.disabled-section {
            opacity: 0.5;
            pointer-events: none;
        }
        .input-section.disabled-section h2::after {
            content: " (Неактивно для МВПС)";
            font-style: italic;
            font-size: 0.8em;
            color: var(--text-color-darker);
            margin-left: 5px;
        }


        /* Inputs & Select */
        .input-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 18px; align-items: center; row-gap: 5px; position: relative; }
        .input-group label { flex-basis: 160px; font-weight: 500; color: var(--text-color-darker); transition: color var(--animation-speed); order: 0; }
        .temperature-modal-content .input-group label,
        #braking-distance-modal .interactive-controls label,
        .locomotive-section .input-group label { flex-basis: 220px; }
        .input-group input[type="text"], .input-group input[type="number"], .input-group input[type="date"], .input-group select { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; background-color: var(--input-bg); color: var(--text-color); transition: all var(--animation-speed); min-width: 150px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); order: 1; }
        .input-group input[type="range"] { flex-grow: 1; appearance: none; height: 8px; background: var(--border-color); border-radius: 4px; outline: none; cursor: pointer; margin: 0 10px; order: 1; }
        .input-group input[type="range"]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: var(--accent-color); border-radius: 50%; cursor: pointer; box-shadow: 0 0 5px var(--glow-color); transition: background var(--animation-speed); }
        .input-group input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: var(--accent-color); border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 0 5px var(--glow-color); transition: background var(--animation-speed); }
        .input-group input[type="range"]:hover::-webkit-slider-thumb { background: color-mix(in srgb, var(--accent-color) 80%, white); }
        .input-group input[type="range"]:hover::-moz-range-thumb { background: color-mix(in srgb, var(--accent-color) 80%, white); }
        .input-group.sync-range-number { align-items: baseline; }
        .input-group.sync-range-number input[type="number"] { min-width: 80px; flex-grow: 0; text-align: center; }
        .input-group select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23a0a0c0' d='M6 8L0 2l1.4-1.4L6 5.2 10.6.6 12 2z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; background-size: 12px; }
        body:not(.light-theme) .input-group select { filter: var(--icon-filter); }
        .input-group option { background-color: var(--input-bg); color: var(--text-color); padding: 5px; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: var(--icon-filter); }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--secondary-neon); box-shadow: 0 0 8px var(--glow-color-secondary), inset 0 1px 3px rgba(0,0,0,0.3); }
        body.light-theme .input-group input:focus, body.light-theme .input-group select:focus { border-color: var(--primary-gradient-end); box-shadow: 0 0 8px var(--glow-color), inset 0 1px 3px rgba(0,0,0,0.1); }
        .input-group input[style*="border-color: red"], .input-group select[style*="border-color: red"],
        .input-group input[style*="border-color:var(--error-color)"], .input-group select[style*="border-color:var(--error-color)"]
        { border-color: var(--error-color) !important; box-shadow: 0 0 5px color-mix(in srgb, var(--error-color) 50%, transparent); }
        .input-group .unit { margin-left: 8px; color: var(--text-color-darker); font-size: 0.9em; transition: color var(--animation-speed); order: 2; white-space: nowrap; }
        .input-hint { position: absolute; right: 0; top: 100%; font-size: 0.85em; color: var(--text-color-darker); font-style: italic; margin-top: 2px; transition: color var(--animation-speed); text-align: right; width: 100%; }
        .input-warning { color: var(--warning-color); font-size: 0.85em; margin-top: 5px; display: none; position: absolute; right: 0; top: calc(100% + 1.8em); width: 100%; text-align: right; }

        /* Floating warning messages */
        .floating-message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--error-color); color: white; padding: 10px 20px; border-radius: 5px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 1000; animation: slideIn 0.3s ease-out forwards; max-width: 80%; text-align: center; }
        .floating-warning { background-color: var(--warning-color); color: #000; }
        @keyframes slideIn { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes slideOut { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -20px); } }

        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all var(--animation-speed) ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--container-bg); padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px var(--shadow-color); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0; transition: all var(--animation-speed) ease; }
        .modal-close:hover { background-color: var(--accent-bg-light); }
        .modal-title { margin-top: 0; margin-bottom: 20px; color: var(--accent-color); }

        /* Dictionary styles */
        .dictionary { margin-top: 20px; }
        .dictionary-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .dictionary-term { font-weight: bold; margin-bottom: 5px; color: var(--accent-color); }
        .dictionary-definition { margin-left: 20px; }

        /* Calculation details styles */
        .calculation-details { margin-top: 20px; padding: 15px; background-color: var(--section-bg-alt); border-radius: 8px; border: 1px solid var(--border-color); }
        .calculation-formula { font-family: 'Courier New', Courier, monospace; background-color: var(--input-bg); padding: 10px; border-radius: 5px; margin: 10px 0; overflow-x: auto; font-size: 0.9em; }
        .calculation-formula p { margin: 5px 0; }

        /* Abbreviations highlighting */
        .abbreviation { color: var(--accent-color); font-weight: bold; text-shadow: 0 0 4px var(--glow-color); cursor: help; position: relative; }
        body.light-theme .abbreviation { text-shadow: none; }

        /* Wagon Module */
        .wagon-module { border: 1px dashed var(--tertiary-neon); padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: var(--section-bg-alt); position: relative; overflow: hidden; animation: fadeIn var(--animation-speed) ease forwards; transition: background-color var(--animation-speed) ease, border-color var(--animation-speed) ease; }
        body.light-theme .wagon-module { border: 1px dashed var(--primary-gradient-start); }
        .wagon-module h3 { margin-top: 0; margin-bottom: 15px; color: var(--text-color); font-size: 1.2em; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; transition: color var(--animation-speed) ease, border-color var(--animation-speed) ease; text-shadow: var(--neon-text-shadow); }
        body.light-theme .wagon-module h3 { text-shadow: none; }
        .wagon-module[style*="border: 2px solid"] { border: 2px solid var(--error-color) !important; }
        .remove-wagon-btn { position: absolute; top: 15px; right: 15px; background: var(--error-color); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-weight: bold; cursor: pointer; transition: background-color var(--animation-speed), transform var(--animation-speed); line-height: 28px; text-align: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-shadow: none; }
        .remove-wagon-btn:hover { background-color: color-mix(in srgb, var(--error-color) 70%, black); transform: scale(1.1); }

        /* Buttons */
        button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close) { position: relative; overflow: hidden; display: inline-flex; justify-content: center; align-items: center; min-width: 150px; padding: 10px 25px; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; color: var(--button-text-color); cursor: pointer; transition: filter var(--animation-speed), transform var(--animation-speed), box-shadow var(--animation-speed), background var(--animation-speed); margin: 5px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); text-shadow: 0 0 2px rgba(0,0,0,0.4); z-index: 1; }
        body:not(.light-theme) button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close) { text-shadow: 0 0 3px rgba(0, 0, 0, 0.8); }
        button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close):hover { filter: brightness(1.15); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4); }
        button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close):active { transform: translateY(0); filter: brightness(0.9); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); }
        button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close)::before { content: ""; position: absolute; top: 0; left: -100%; width: 75%; height: 100%; background: linear-gradient( 100deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.3) 50%, rgba(255, 255, 255, 0) 100% ); transform: skewX(-25deg); z-index: 2; pointer-events: none; opacity: 0; transition: none; }
        button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close):hover::before { opacity: 1; left: 125%; transition: left var(--shine-speed) ease-in-out; }

        /* Button Gradients (Main buttons) */
        button[onclick="calculateAll()"] { background: linear-gradient(45deg, var(--primary-neon), var(--secondary-neon)); }
        #pressure-charts-btn { background: linear-gradient(45deg, var(--secondary-neon), var(--tertiary-neon)); }
        #braking-distance-btn { background: linear-gradient(45deg, var(--primary-neon), var(--tertiary-neon)); }
        #temperature-btn { background: linear-gradient(45deg, #ff5722, #e91e63); } /* Button that opens the modal */
        button[onclick="generateReport()"] { background: linear-gradient(45deg, #ff00ff, #c600ff); }
        #print-btn { background: linear-gradient(45deg, #ff8a00, #e52e71); }
        button[onclick="resetCalculator()"] { background: linear-gradient(45deg, #7f8c8d, #505f60); }
        #add-wagon-btn { background: linear-gradient(45deg, var(--primary-neon), #00bfa5); }
        #help-btn { background: linear-gradient(45deg, var(--tertiary-neon), #00e5ff); }
        #save-config-btn { background: linear-gradient(45deg, #00bcd4, #0097a7); }
        #load-config-btn { background: linear-gradient(45deg, #9c27b0, #7b1fa2); }

        /* Light theme for Main buttons */
        body.light-theme button[onclick="calculateAll()"] { background: linear-gradient(45deg, #007bff, #0056b3); }
        body.light-theme #pressure-charts-btn { background: linear-gradient(45deg, #17a2b8, #117a8b); }
        body.light-theme #braking-distance-btn { background: linear-gradient(45deg, #007bff, #28a745); }
        body.light-theme #temperature-btn { background: linear-gradient(45deg, #fd7e14, #e83e8c); } /* Button that opens the modal - Light theme */
        body.light-theme button[onclick="generateReport()"] { background: linear-gradient(45deg, #28a745, #218838); }
        body.light-theme #print-btn { background: linear-gradient(45deg, #6c757d, #5a6268); }
        body.light-theme button[onclick="resetCalculator()"] { background: linear-gradient(45deg, #ffc107, #e0a800); }
        body.light-theme #add-wagon-btn { background: linear-gradient(45deg, #007bff, #17a2b8); }
        body.light-theme #help-btn { background: linear-gradient(45deg, #6f42c1, #d63384); }
        body.light-theme #save-config-btn { background: linear-gradient(45deg, #00acc1, #00838f); }
        body.light-theme #load-config-btn { background: linear-gradient(45deg, #8e24aa, #6a1b9a); }


        /* Specific style for the "Calculate Temperature" button inside the modal */
        /* Default (Dark Theme) */
        .temperature-modal-content #calculate-temperature-btn {
            background: linear-gradient(45deg, var(--chart-grad-4-start), var(--chart-grad-4-end));
            color: white;
        }
        /* Light Theme for "Calculate Temperature" button */
        body.light-theme .temperature-modal-content #calculate-temperature-btn {
            background: linear-gradient(45deg, var(--chart-grad-4-start), var(--chart-grad-4-end));
            color: white;
            text-shadow: none;
        }
        .temperature-modal-content #calculate-temperature-btn:hover { filter: brightness(1.2); }
        body.light-theme .temperature-modal-content #calculate-temperature-btn:hover { filter: brightness(1.1); }
        .temperature-modal-content #calculate-temperature-btn:active { filter: brightness(0.85); }
         body.light-theme .temperature-modal-content #calculate-temperature-btn:active { filter: brightness(0.95); }
        .temperature-modal-content #calculate-temperature-btn::before {
            content: ""; position: absolute; top: 0; left: -100%; width: 75%; height: 100%;
            background: linear-gradient( 100deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0) 100% );
            transform: skewX(-25deg); z-index: 2; pointer-events: none; opacity: 0; transition: none;
        }
        .temperature-modal-content #calculate-temperature-btn:hover::before { opacity: 1; left: 125%; transition: left var(--shine-speed) ease-in-out; }


        /* Results */
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .results-table th, .results-table td { border: 1px solid var(--border-color); padding: 12px 14px; text-align: center; vertical-align: middle; transition: background-color var(--animation-speed) ease, border-color var(--animation-speed) ease; }
        .results-table th { background-color: var(--table-header-bg); font-weight: 600; color: var(--text-color); transition: background-color var(--animation-speed) ease, color var(--animation-speed) ease; text-shadow: var(--th-neon-shadow); }
        body.light-theme .results-table th { text-shadow: none; }
        .results-table tbody tr:nth-child(odd) td { background-color: var(--table-row-odd-bg); }
        .results-table tbody tr:hover td { background-color: var(--table-row-hover-bg); }
        .results-table td span.result-value { font-weight: bold; color: var(--accent-color); display: inline-block; min-width: 50px; transition: all 0.5s ease; padding: 3px 6px; border-radius: 4px; background-color: var(--accent-bg-light); text-shadow: 0 0 4px var(--accent-color); }
        body.light-theme .results-table td span.result-value { text-shadow: none; }
        .results-table td span.result-value.highlight { background-color: var(--accent-bg-strong); animation: highlightAnim 1s ease; filter: brightness(1.3); }
        .total-result { margin-top: 25px; text-align: right; font-size: 1.3em; font-weight: bold; color: var(--text-color); transition: color var(--animation-speed); text-shadow: var(--neon-text-shadow); }
        body.light-theme .total-result { text-shadow: none; }
        .total-result span { color: var(--accent-color); font-size: 1.35em; padding: 8px 15px; background-color: var(--accent-bg-medium); border-radius: 5px; display: inline-block; min-width: 90px; text-align: center; transition: all 0.5s ease; border: 1px solid var(--accent-bg-strong); text-shadow: 0 0 6px var(--accent-color); }
        body.light-theme .total-result span { text-shadow: none; }
        .total-result span.highlight { background-color: var(--accent-bg-hover); animation: highlightAnim 1s ease; filter: brightness(1.4); }

        /* Advanced Results */
        .advanced-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .advanced-result-item { background-color: var(--accent-bg-light); border-radius: 8px; padding: 15px; transition: all 0.3s ease; border: 1px solid var(--border-color); position: relative; }
        .advanced-result-item:hover { background-color: var(--accent-bg-medium); }
        /* .advanced-result-item h4 styled above */
        .advanced-result-value { font-size: 1.4em; font-weight: bold; color: var(--text-color); }
        .advanced-result-unit { font-size: 0.9em; color: var(--text-color-darker); margin-left: 5px; }
        .advanced-result-item.highlight { background-color: var(--accent-bg-strong); animation: highlightAnim 1s ease; filter: brightness(1.3); }

        /* Report */
        #report-content {
            background-color: var(--input-bg); padding: 20px; border: 1px solid var(--border-color); border-radius: 5px;
            font-family: 'Courier New', Courier, monospace; max-height: 400px; overflow-y: auto;
            color: var(--text-color); box-shadow: inset 0 1px 4px rgba(0,0,0,0.3); transition: all var(--animation-speed) ease;
        }
        #report-content h2, #report-content h3, #report-content h4, #report-content p, #report-content ul, #report-content li {
            white-space: normal;
        }
        #report-content .calculation-formula p {
             white-space: pre-wrap; margin: 5px 0 !important; line-height: 1.3;
        }
        #report-content .temperature-report-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border-color); }


        /* Temperature Modal Specifics - Text Color Adjustments for Light Theme */
        body.light-theme .temperature-modal-content .input-group label,
        body.light-theme .temperature-modal-content .unit,
        body.light-theme .temperature-modal-content .input-hint {
            color: var(--text-color-darker);
        }
        body.light-theme .temperature-modal-content .advanced-result-item h4 {
            color: var(--accent-color);
        }
        body.light-theme .temperature-modal-content .advanced-result-value {
            color: var(--text-color);
        }
        body.light-theme .temperature-modal-content .advanced-result-unit {
            color: var(--text-color-darker);
        }
        body.light-theme .temperature-modal-content .calculation-details h4 {
            color: var(--accent-color);
        }
        body.light-theme .temperature-modal-content .calculation-formula {
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        body.light-theme .temperature-modal-content .calculation-formula .abbreviation {
            color: var(--accent-color);
        }


        /* Actions */
        .actions { text-align: center; margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }

        /* Styles for modal charts */
        #pressure-charts-modal .modal-content { max-width: 900px; display: flex; flex-direction: column; gap: 20px; }
        .chart-container-modal { position: relative; width: 100%; height: 350px; margin: 10px 0; }
        .chart-container-modal canvas { display: block; height: 100% !important; width: 100% !important; background-color: transparent; }
        .modal-placeholder-msg { text-align: center; padding: 40px 20px; color: var(--text-color-darker); font-style: italic; }

        /* Temperature Modal Specifics */
        .temperature-modal-content { max-width: 700px; }
        .temperature-chart-container { height: 300px; margin: 20px 0; }
        #temperature-warning { position: relative; transform: none; left: auto; top: auto; margin-top: 15px; margin-bottom: 15px; animation: none; box-shadow: none; border: 1px solid; padding: 8px 15px; border-radius: 4px; font-size: 0.9em; }
        #temperature-warning.error-level { background-color: var(--error-color); color: white; border-color: color-mix(in srgb, var(--error-color) 70%, black); }
        #temperature-warning.warning-level { background-color: var(--warning-color); color: #000; border-color: color-mix(in srgb, var(--warning-color) 80%, black); }
        body.light-theme #temperature-warning.warning-level { border-color: color-mix(in srgb, var(--warning-color) 80%, white); }
        body.light-theme #temperature-warning.error-level { border-color: color-mix(in srgb, var(--error-color) 70%, white); }

        /* Braking Distance Modal Specifics */
        #braking-distance-modal .modal-content { max-width: 850px; }
        .context-params { background-color: var(--section-bg-alt); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        /* .context-params h4 styled above */
        .context-param-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em;}
        .context-param-item span:first-child { color: var(--text-color-darker); }
        .context-param-item span:last-child { font-weight: bold; color: var(--text-color); }
        /* .interactive-controls h4 styled above */
        .distance-results { margin-top: 20px; }
        .braking-process-chart-container, .dependency-chart-container { height: 280px; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background-color: var(--section-bg-alt); }
        .dependency-selector { margin-top: 20px; padding: 15px; background-color: var(--section-bg); border-radius: 8px; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; }
        .dependency-selector label { margin-right: 10px; color: var(--text-color-darker); font-weight: 500; }
        .dependency-selector select { padding: 8px 12px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes highlightAnim { 0% { filter: brightness(1.6); } 100% { filter: brightness(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); max-height: 200px; } to { opacity: 0; transform: scale(0.9); max-height: 0; padding: 0; margin: 0; border: none; } }

        /* Print Styles */
        @media print {
            :root {} body { padding: 0; background: #fff; color: #000; font-size: 10pt; } .calculator-container { box-shadow: none; border: none; padding: 0; max-width: 100%; background: #fff; backdrop-filter: none; } h1, h2, h3 { border: none; color: #000; text-align: left; font-size: 14pt; border-image: none; text-shadow: none; } h1 { text-transform: uppercase; } .input-section, .results-section, .advanced-section { border: none; padding: 0; margin-bottom: 15px; background-color: transparent; } .wagon-module { border: 1px solid #ccc; background-color: transparent; page-break-inside: avoid; padding: 10px;} .wagon-module h3 { text-shadow: none; font-size: 11pt; margin-bottom: 10px; } .input-group { flex-direction: row; align-items: baseline; gap: 5px; margin-bottom: 5px; } .input-group label { color: #000; flex-basis: 140px; order: 0; margin-bottom: 0; font-size: 9pt;} .input-group input[type="text"], .input-group input[type="number"], .input-group input[type="date"], .input-group select { border: none; border-bottom: 1px dotted #ccc; padding: 2px 0; background: transparent; box-shadow: none; font-size: 10pt; color: #000; appearance: none; background-image: none; filter: none; order: 1; flex-grow: 1; min-width: 80px; } .input-group select { position: relative; } .input-group select::after { content: " (" attr(data-selected-text) ")"; font-style: italic; font-size: 9pt; color: #333; display: inline; } .input-group select option { display: none; } input[type="date"]::-webkit-calendar-picker-indicator { display: none; filter: none; } .input-group input[type="date"]::after { content: " " attr(value); display: inline;} .unit { display: inline; font-size: 9pt; color: #333; order: 2; margin-left: 3px; } .input-hint, .input-warning { display: none; } .results-table { margin-top: 10px; } .results-table th, .results-table td { border: 1px solid #666; padding: 5px; font-size: 9pt; background: #fff !important; color: #000; } .results-table th { background-color: #eee !important; color: #000; text-shadow: none; font-weight: bold; } .results-table td span.result-value { font-weight: normal; color: #000 !important; background: none !important; padding: 0; border: none; text-shadow: none; filter: none; } .total-result { font-size: 11pt; text-align: left; color: #000; text-shadow: none; margin-top: 10px;} .total-result span { color: #000 !important; font-size: 11pt; background: none !important; padding: 0; border: none; text-shadow: none; filter: none; font-weight: bold;} .advanced-results { grid-template-columns: 1fr; gap: 5px; margin-top: 10px; } .advanced-result-item { border: 1px solid #ddd; background: #f9f9f9 !important; padding: 8px; } .advanced-result-item h4 { color: #000 !important; font-size: 10pt; margin-bottom: 3px;} .advanced-result-value { color: #000 !important; font-size: 11pt; } .advanced-result-unit { font-size: 9pt; }
            .actions, .remove-wagon-btn, #report-content, .report-section h2, .theme-toggle, .version-info, .modal-overlay, #temperature-btn, #save-config-btn, #load-config-btn, #help-btn, #pressure-charts-btn, #braking-distance-btn, button[onclick="resetCalculator()"], #calculate-temperature-btn { display: none !important; } /* Hide calc temp button in modal on print */
            #report-print-area { display: block !important; font-family: 'Times New Roman', serif; font-size: 10pt; white-space: pre-wrap; margin-top: 20px; color: #000; background: none; } #report-print-area h2, #report-print-area h4 { font-size: 12pt; margin-top: 15px; margin-bottom: 8px; text-align: left; border-bottom: 1px solid #000; padding-bottom: 3px;} #report-print-area h4 { font-size: 11pt; border-bottom: none;} #report-print-area .abbreviation { color: #000; font-weight: bold; text-shadow: none; font-style: italic; } #report-print-area .calculation-details, #report-print-area .temperature-report-section { background-color: #f8f8f8; border: 1px solid #ccc; margin-top: 15px; padding: 10px; page-break-inside: avoid; } #report-print-area .calculation-formula { background-color: #eee; padding: 5px; margin: 5px 0; border: 1px dashed #ccc; font-size: 9pt; } #report-print-area .print-chart-container img { max-width: 90%; height: auto; display: block; margin: 15px auto; border: 1px solid #aaa; page-break-inside: avoid; } #report-print-area .print-chart-container p { text-align: center; font-style: italic; color: #555; font-size: 9pt; } button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close) { border: 1px solid #ccc; background: #eee; color: #000; box-shadow: none; text-shadow: none; filter: none; } button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close)::before { display: none; }
        }
        #report-print-area { display: none; }

        /* Mobile Adaptation */
        @media (max-width: 768px) {
             body { padding: 10px; } .calculator-container { padding: 15px; } .theme-toggle, .version-info { top: 10px; right: 10px; padding: 6px 10px; font-size: 0.8em; } .version-info { left: 10px; right: auto; } h1 { font-size: 1.4rem; margin-top: 40px; } h2 { font-size: 1.1rem; } .input-group { flex-direction: column; align-items: stretch; gap: 5px; margin-bottom: 25px; padding-bottom: 1.5em; } .input-group label { flex-basis: auto; margin-bottom: 5px; font-weight: 500; order: 0; text-align: left; width: 100%; } .temperature-modal-content .input-group label, #braking-distance-modal .interactive-controls label, .locomotive-section .input-group label { flex-basis: auto; } .input-group input[type="text"], .input-group input[type="number"], .input-group input[type="date"], .input-group select { width: 100%; min-width: unset; order: 1; box-sizing: border-box; } .input-group .unit { order: 2; margin-left: 0; text-align: right; width: 100%; margin-top: 5px; } .input-hint { position: static; text-align: left; margin-left: 0; margin-top: 4px; flex-basis: auto; width: 100%; order: 3; } .input-warning { position: static; text-align: left; margin-left: 0; margin-top: 4px; flex-basis: auto; width: 100%; order: 4; }
             .actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 20px; }
             .actions button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close) { width: calc(33.33% - 10px); margin: 4px; padding: 10px 8px; font-size: 0.85rem; min-width: 90px; }
             #add-wagon-btn { width: 100%; margin-bottom: 10px; } .results-table th, .results-table td { font-size: 0.8rem; padding: 5px; } .results-section div[style*="overflow-x: auto"] { border: 1px solid var(--border-color); border-radius: 5px; margin-top: 10px; } .total-result { font-size: 1.1em; text-align: center; } .total-result span { font-size: 1.15em; padding: 6px 10px; } .advanced-results { grid-template-columns: 1fr; }
             .chart-container-modal { height: 300px; }
             .braking-process-chart-container, .dependency-chart-container { height: 250px; }
             .modal-content { max-width: 95%; padding: 20px; max-height: 80vh; } .modal-close { top: 10px; right: 10px; }
             .context-params { padding: 10px; } .context-param-item {font-size: 0.9em;}
             .dependency-selector { padding: 10px; flex-direction: column; align-items: flex-start;}
             .dependency-selector label { margin-right: 0; margin-bottom: 5px; font-size: 0.9em;}
             .dependency-selector select { width: 100%; padding: 6px 8px; font-size: 0.9em;}
             .locomotive-section .sub-options { padding-left: 10px; margin-left: 0; }
         }
        @media (max-width: 480px) {
             h1 { font-size: 1.2rem; } h2 { font-size: 1rem; }
             .actions button:not(.theme-toggle):not(.remove-wagon-btn):not(.modal-close) { width: calc(50% - 10px); font-size: 0.8rem; padding: 8px 5px; min-width: unset;}
             #add-wagon-btn { min-width: unset; width: 100%;}
             .actions button:nth-child(odd) { margin-right: 5px; } .actions button:nth-child(even) { margin-left: 5px; }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="version-info">BrakeCalc Версія 1.9.1 Pro | Автор: Маляр О.С.</div>
        <button class="theme-toggle" id="theme-toggle-btn" title="Змінити тему">Тема</button>
        <h1>КАЛЬКУЛЯТОР НАТИСКУ ГАЛЬМІВНИХ КОЛОДОК</h1>

        <section class="input-section student-info">
            <h2>Інформація про виконавця</h2>
            <div class="input-group"> <label for="student-name">ПІБ:</label> <input type="text" id="student-name" placeholder="Введіть ваше ПІБ"> <span class="input-hint">(Повне ім'я студента)</span> </div>
            <div class="input-group"> <label for="student-group">Група:</label> <input type="text" id="student-group" placeholder="Введіть назву групи"> <span class="input-hint">(Номер або назва навчальної групи)</span> </div>
            <div class="input-group"> <label for="report-date">Дата:</label> <input type="date" id="report-date"> <span class="input-hint">(Дата виконання роботи)</span> </div>
        </section>

        <section class="input-section common-params">
            <h2>Загальні параметри поїзда</h2>
            <div class="input-group"> <label for="pressure-mpa">Тиск у ГЦ (<span class="abbreviation" title="Тиск у гальмівному циліндрі">p_ц</span>):</label> <input type="number" id="pressure-mpa" step="0.01" value="0.4" required> <span class="unit">МПа</span> <span class="input-hint">(0.38 - 0.42 МПа для вантажних поїздів)</span> <div class="input-warning" id="pressure-warning"></div> </div>
            <div class="input-group"> <label for="train-mass">Маса поїзда (<span class="abbreviation" title="Маса брутто поїзда">M</span>):</label> <input type="number" id="train-mass" step="1" value="5000"> <span class="unit">т</span> <span class="input-hint">(Загальна маса локомотива/МВПС + вагонів)</span> <div class="input-warning" id="mass-warning"></div> </div>
            <div class="input-group"> <label for="max-speed">Макс. швидкість (<span class="abbreviation" title="Максимальна швидкість руху">v₀</span>):</label> <input type="number" id="max-speed" step="1" value="80"> <span class="unit">км/год</span> <span class="input-hint">(60-90 км/год для вантажних поїздів)</span> <div class="input-warning" id="speed-warning"></div> </div>
            <div class="input-group"> <label for="track-condition">Стан колії:</label> <select id="track-condition" data-selected-text="Суха"> <option value="dry">Суха</option> <option value="wet">Мокра</option> <option value="contaminated">Забруднена</option> </select> <span class="input-hint">(Впливає на <span class="abbreviation" title="Коефіцієнт тертя між колесом і рейкою">μ</span>)</span> </div>
            <div class="input-group"> <label for="track-gradient">Ухил колії (<span class="abbreviation" title="Ухил поздовжнього профілю колії">i</span>):</label> <input type="number" id="track-gradient" step="0.1" value="0"> <span class="unit">‰</span> <span class="input-hint">(Додатні - спуск, від'ємні - підйом)</span> </div>
            <div class="input-group"> <label for="brake-mode">Режим гальмування:</label> <select id="brake-mode" data-selected-text="Повне службове"> <option value="full">Повне службове</option> <option value="step">Ступінчасте</option> <option value="emergency">Екстрене</option> </select> <span class="input-hint">(Впливає на швидкість спрацювання та тиск)</span> </div>
        </section>

        <!-- НОВА СЕКЦІЯ ДЛЯ ЛОКОМОТИВІВ / МВПС -->
         <section class="input-section locomotive-section">
            <h2>Тяговий рухомий склад</h2>
            <div class="input-group">
                <label for="traction-unit-type">Тип тягової одиниці:</label>
                <select id="traction-unit-type">
                    <option value="locomotive">Локомотив + вагони</option>
                    <option value="emu">Електропоїзд (МВПС)</option>
                    <option value="dmu">Дизель-поїзд (МВПС)</option>
                </select>
                <span class="input-hint">(Оберіть тип тяги)</span>
            </div>

            <!-- Опції для Локомотива -->
            <div id="locomotive-options" class="sub-options active">
                <h4>Параметри локомотива</h4>
                <div class="input-group">
                    <label for="loco-series">Серія локомотива:</label>
                    <select id="loco-series">
                        <option value="vl80">ВЛ80 (різні модиф.)</option>
                        <option value="chme3">ЧМЕ3</option>
                        <option value="2te116">2ТЕ116</option>
                        <option value="de1">ДЕ1</option>
                        <option value="ds3">ДС3</option>
                        <option value="vl11">ВЛ11/ВЛ11М</option>
                        <option value="custom_loco">Інша серія (ввести вручну)</option>
                    </select>
                     <span class="input-hint">(Оберіть серію або введіть параметри вручну)</span>
                </div>
                <div class="input-group">
                    <label for="loco-cylinder-diameter">Діаметр ГЦ локомотива:</label>
                    <input type="number" id="loco-cylinder-diameter" step="any" placeholder="напр. 14">
                    <span class="unit">дюйм</span>
                    <span class="input-hint">(Діаметр гальмівного циліндра)</span>
                </div>
                <div class="input-group">
                    <label for="loco-transmission-ratio">Передаточне число ГП:</label>
                    <input type="number" id="loco-transmission-ratio" step="any" placeholder="напр. 7.85">
                     <span class="input-hint">(Передаточне число гальмівної передачі)</span>
                </div>
                <div class="input-group">
                    <label for="loco-efficiency">ККД ГП:</label>
                    <input type="number" id="loco-efficiency" step="0.01" min="0" max="1" placeholder="напр. 0.85">
                     <span class="input-hint">(Коефіцієнт корисної дії гальмівної передачі)</span>
                </div>
                <div class="input-group">
                    <label for="loco-cylinder-count">К-сть ГЦ на секцію:</label>
                    <input type="number" id="loco-cylinder-count" min="1" step="1" value="1">
                     <span class="input-hint">(Кількість гальмівних циліндрів на одну секцію)</span>
                </div>
                 <div class="input-group">
                    <label for="loco-sections">Кількість секцій:</label>
                    <input type="number" id="loco-sections" min="1" step="1" value="1">
                    <span class="input-hint">(Для багатосекційних локомотивів)</span>
                </div>
                <div class="input-group">
                    <label for="loco-brake-shoes-type">Тип колодок локомотива:</label>
                    <select id="loco-brake-shoes-type">
                        <option value="cast_iron">Чавунні</option>
                        <option value="composite">Композиційні</option>
                    </select>
                    <span class="input-hint">(Матеріал гальмівних колодок)</span>
                </div>
                 <div class="input-group">
                    <label for="loco-axle-count">Кількість гальм. осей (на секцію):</label>
                    <input type="number" id="loco-axle-count" min="2" step="1" placeholder="напр. 8">
                    <span class="input-hint">(Кількість осей з гальмами на одну секцію)</span>
                </div>
                 <div class="input-group">
                    <label for="loco-weight-per-section">Маса однієї секції:</label>
                    <input type="number" id="loco-weight-per-section" step="1" placeholder="напр. 92">
                    <span class="unit">т</span>
                    <span class="input-hint">(Тара однієї секції локомотива)</span>
                </div>
            </div>

            <!-- Опції для Електропоїзда (МВПС) -->
            <div id="emu-options" class="sub-options">
                <h4>Параметри електропоїзда</h4>
                <div class="input-group">
                    <label for="emu-series">Модель електропоїзда:</label>
                    <select id="emu-series">
                        <option value="er2">ЕР2/ЕР2Р/ЕР2Т</option>
                        <option value="er9">ЕР9 (різні модиф.)</option>
                        <option value="epl2t">ЕПЛ2Т</option>
                        <option value="epl9t">ЕПЛ9Т</option>
                        <option value="hrsc2">HRSC2 (Hyundai Rotem)</option>
                        <option value="ej675">EJ 675 (Škoda)</option>
                        <option value="custom_emu">Інший (ввести вручну)</option>
                    </select>
                    <span class="input-hint">(Оберіть модель або введіть параметри вручну)</span>
                </div>
                <div class="input-group">
                    <label for="emu-car-count">Кількість вагонів у составі:</label>
                    <input type="number" id="emu-car-count" min="2" step="1" value="10">
                    <span class="input-hint">(Загальна кількість вагонів состава)</span>
                </div>
                <div class="input-group">
                    <label for="emu-avg-cylinder-diameter">Середній діаметр ГЦ вагона:</label>
                    <input type="number" id="emu-avg-cylinder-diameter" step="any" placeholder="дюйми">
                    <span class="unit">дюйм</span>
                     <span class="input-hint">(Усереднений для одного вагона состава)</span>
                </div>
                <div class="input-group">
                    <label for="emu-avg-transmission-ratio">Середнє передаточне число ГП:</label>
                    <input type="number" id="emu-avg-transmission-ratio" step="any" placeholder="i_гп">
                     <span class="input-hint">(Усереднене для одного вагона состава)</span>
                </div>
                 <div class="input-group">
                    <label for="emu-avg-efficiency">Середній ККД ГП:</label>
                    <input type="number" id="emu-avg-efficiency" step="0.01" min="0" max="1" placeholder="η_гп">
                     <span class="input-hint">(Усереднений для одного вагона состава)</span>
                </div>
                 <div class="input-group">
                    <label for="emu-avg-cylinder-count">Середня к-сть ГЦ на вагон:</label>
                    <input type="number" id="emu-avg-cylinder-count" min="1" step="1" value="1">
                     <span class="input-hint">(Усереднена для одного вагона состава)</span>
                </div>
                 <div class="input-group">
                    <label for="emu-brake-shoes-type">Тип колодок:</label>
                    <select id="emu-brake-shoes-type">
                        <option value="composite">Композиційні (типово)</option>
                        <option value="cast_iron">Чавунні</option>
                    </select>
                     <span class="input-hint">(Тип колодок для вагонів состава)</span>
                </div>
                 <div class="input-group">
                    <label for="emu-axle-count-per-car">К-сть гальм. осей на вагон:</label>
                    <input type="number" id="emu-axle-count-per-car" min="2" step="1" value="4">
                    <span class="input-hint">(Кількість осей з гальмами на один вагон состава)</span>
                </div>
                <div class="input-group">
                    <label for="emu-weight-per-car">Середня маса одного вагона:</label>
                    <input type="number" id="emu-weight-per-car" step="1" placeholder="напр. 45">
                    <span class="unit">т</span>
                    <span class="input-hint">(Середня тара одного вагона МВПС)</span>
                </div>
            </div>

            <!-- Опції для Дизель-поїзда (МВПС) -->
            <div id="dmu-options" class="sub-options">
                <h4>Параметри дизель-поїзда</h4>
                <div class="input-group">
                    <label for="dmu-series">Модель дизель-поїзда:</label>
                    <select id="dmu-series">
                        <option value="d1">Д1</option>
                        <option value="dr1a">ДР1А</option>
                        <option value="dpl1">ДПЛ1</option>
                        <option value="dpl2">ДПЛ2</option>
                        <option value="pesa620m">PESA 620M</option>
                        <option value="pesa630m">PESA 630M</option>
                        <option value="dpkr">ДПКр-2/ДПКр-3</option>
                        <option value="custom_dmu">Інший (ввести вручну)</option>
                    </select>
                     <span class="input-hint">(Оберіть модель або введіть параметри вручну)</span>
                </div>
                <div class="input-group">
                    <label for="dmu-car-count">Кількість вагонів у составі:</label>
                    <input type="number" id="dmu-car-count" min="2" step="1" value="3">
                    <span class="input-hint">(Загальна кількість вагонів состава)</span>
                </div>
                 <div class="input-group">
                    <label for="dmu-avg-cylinder-diameter">Середній діаметр ГЦ вагона:</label>
                    <input type="number" id="dmu-avg-cylinder-diameter" step="any" placeholder="дюйми">
                    <span class="unit">дюйм</span>
                     <span class="input-hint">(Усереднений для одного вагона состава)</span>
                </div>
                <div class="input-group">
                    <label for="dmu-avg-transmission-ratio">Середнє передаточне число ГП:</label>
                    <input type="number" id="dmu-avg-transmission-ratio" step="any" placeholder="i_гп">
                    <span class="input-hint">(Усереднене для одного вагона состава)</span>
                </div>
                 <div class="input-group">
                    <label for="dmu-avg-efficiency">Середній ККД ГП:</label>
                    <input type="number" id="dmu-avg-efficiency" step="0.01" min="0" max="1" placeholder="η_гп">
                    <span class="input-hint">(Усереднений для одного вагона состава)</span>
                </div>
                 <div class="input-group">
                    <label for="dmu-avg-cylinder-count">Середня к-сть ГЦ на вагон:</label>
                    <input type="number" id="dmu-avg-cylinder-count" min="1" step="1" value="1">
                    <span class="input-hint">(Усереднена для одного вагона состава)</span>
                </div>
                 <div class="input-group">
                    <label for="dmu-brake-shoes-type">Тип колодок:</label>
                    <select id="dmu-brake-shoes-type">
                        <option value="composite">Композиційні (типово)</option>
                        <option value="cast_iron">Чавунні</option>
                    </select>
                     <span class="input-hint">(Тип колодок для вагонів состава)</span>
                </div>
                 <div class="input-group">
                    <label for="dmu-axle-count-per-car">К-сть гальм. осей на вагон:</label>
                    <input type="number" id="dmu-axle-count-per-car" min="2" step="1" value="4">
                    <span class="input-hint">(Кількість осей з гальмами на один вагон состава)</span>
                </div>
                 <div class="input-group">
                    <label for="dmu-weight-per-car">Середня маса одного вагона:</label>
                    <input type="number" id="dmu-weight-per-car" step="1" placeholder="напр. 50">
                    <span class="unit">т</span>
                    <span class="input-hint">(Середня тара одного вагона МВПС)</span>
                </div>
            </div>
        </section>

        <section class="input-section wagon-modules" id="wagon-params-section">
            <h2>Типи вагонів у поїзді</h2>
            <div id="wagon-modules-container"></div>
            <button id="add-wagon-btn">+ Додати тип вагона</button>
        </section>

        <section class="results-section">
            <h2>Результати розрахунків натиску</h2>
            <div style="overflow-x: auto;"> <table class="results-table" id="results-table"> <thead> <tr> <th>Тип од./вагона</th> <th>К-ть (<span class="abbreviation" title="Кількість вагонів/секцій даного типу">N</span>)</th> <th><span class="abbreviation" title="Діаметр гальмівного циліндра">D_ц</span>, м</th> <th><span class="abbreviation" title="Площа поршня гальмівного циліндра">F_ц</span>, м²</th> <th><span class="abbreviation" title="Передаточне число гальмівної передачі">i_гп</span></th> <th><span class="abbreviation" title="ККД гальмівної передачі">η_гп</span></th> <th><span class="abbreviation" title="Кількість гальмівних циліндрів на одиницю">N_ц</span></th> <th><span class="abbreviation" title="Натиск на одиницю">K_од</span>, Н</th> <th><span class="abbreviation" title="Натиск на одиницю">K_од</span>, тс</th> <th>Σ K типу, тс</th> </tr> </thead> <tbody id="results-tbody"></tbody> </table> </div>
            <div class="total-result"> Загальний натиск поїзда (<span class="abbreviation" title="Сумарний натиск всіх гальмівних колодок поїзда">K_поїзда</span>): <span id="total-pressure">0.00</span> тс </div>
        </section>

        <section class="advanced-section">
            <h2>Розширені параметри гальмування</h2>
            <div class="advanced-results" id="advanced-results"> <div class="advanced-result-item"> <h4>Питомий натиск (<span class="abbreviation" title="K_поїзда / M">K_пит</span>)</h4> <div class="advanced-result-value" id="specific-pressure">0.000</div> <span class="advanced-result-unit">тс/т</span> </div> <div class="advanced-result-item"> <h4>Гальмівний шлях (<span class="abbreviation" title="Відстань, пройдена від початку гальмування до повної зупинки">S</span>)</h4> <div class="advanced-result-value" id="braking-distance">0</div> <span class="advanced-result-unit">м</span> </div> <div class="advanced-result-item"> <h4>Уповільнення (<span class="abbreviation" title="Середнє сповільнення під час гальмування">a</span>)</h4> <div class="advanced-result-value" id="braking-deceleration">0.00</div> <span class="advanced-result-unit">м/с²</span> </div> <div class="advanced-result-item"> <h4>Час гальмування (<span class="abbreviation" title="Тривалість гальмування до повної зупинки">t</span>)</h4> <div class="advanced-result-value" id="braking-time">0.0</div> <span class="advanced-result-unit">с</span> </div> <div class="advanced-result-item"> <h4>Середній коеф. тертя (<span class="abbreviation" title="Середній коефіцієнт тертя між колодками та колесами">φ_сер</span>)</h4> <div class="advanced-result-value" id="friction-coefficient">0.00</div> <span class="advanced-result-unit">-</span> </div> <div class="advanced-result-item"> <h4>Загальна ефективність (<span class="abbreviation" title="Добуток ефективності від стану колії та режиму гальмування">η_заг</span>)</h4> <div class="advanced-result-value" id="brake-efficiency">0.00</div> <span class="advanced-result-unit">-</span> </div> </div>
        </section>

        <section class="report-section">
            <h2>Звіт про виконання роботи</h2>
            <div id="report-content">Натисніть "Сформувати звіт" після розрахунку.</div>
        </section>

        <div class="actions">
            <button onclick="calculateAll()">Розрахувати</button>
            <button id="pressure-charts-btn" onclick="showPressureChartsModal()">Графіки натиску</button>
            <button id="braking-distance-btn" onclick="showBrakingDistanceModal()">Аналіз Гальм. Шляху</button>
            <button id="temperature-btn" onclick="showTemperatureModal()">Температура коліс</button>
            <button onclick="generateReport()">Сформувати звіт</button>
            <button id="print-btn" onclick="printReport()">Друкувати звіт</button>
            <button id="save-config-btn" onclick="saveConfiguration()">Зберегти</button>
            <button id="load-config-btn" onclick="loadConfiguration()">Завантажити</button>
            <button onclick="resetCalculator()">Скинути</button>
            <button id="help-btn" onclick="showHelpModal()">Довідка</button>
        </div>
    </div>

    <div id="report-print-area"></div>
    <input type="file" id="config-file-input" accept=".json" style="display: none;">

    <div class="modal-overlay" id="help-modal">
        <div class="modal-content"> <button class="modal-close" onclick="hideHelpModal()">×</button> <h2 class="modal-title">Інструкція та довідник</h2> <h3>Інструкція з використання</h3> <ol> <li>Заповніть інформацію про виконавця (ПІБ, група, дата).</li> <li>Введіть загальні параметри поїзда (тиск у ГЦ, маса поїзда, швидкість, стан колії, ухил, режим гальмування).</li> <li>Оберіть тип тягового рухомого складу.
                <ul><li>Якщо "Локомотив + вагони": оберіть серію локомотива (або введіть параметри вручну) та додайте типи вагонів за допомогою кнопки "+ Додати тип вагона".</li>
                <li>Якщо "Електропоїзд" або "Дизель-поїзд": оберіть модель (або введіть параметри вручну) та вкажіть кількість вагонів у составі. Секція додавання типів вагонів буде неактивна.</li></ul>
            </li> <li>Для кожного типу вагона/локомотива/МВПС вкажіть характеристики.</li> <li>Натисніть "Розрахувати".</li><li>Інші функції (графіки, аналіз шляху, температура, звіт, друк, збереження/завантаження, скидання) працюють аналогічно.</li></ol> <div class="dictionary"> <h3>Словник основних скорочень (звіт)</h3> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">p_ц</span></div> <div class="dictionary-definition">Розрахунковий тиск у гальмівному циліндрі (МПа)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">M</span></div> <div class="dictionary-definition">Маса поїзда (т або кг, залежно від формули)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">v₀</span></div> <div class="dictionary-definition">Початкова (максимальна) швидкість (км/год або м/с)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">i</span></div> <div class="dictionary-definition">Ухил колії (‰)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">N</span></div> <div class="dictionary-definition">Кількість вагонів/секцій даного типу</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">D_ц</span></div> <div class="dictionary-definition">Діаметр гальмівного циліндра (м)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">F_ц</span></div> <div class="dictionary-definition">Площа поршня гальмівного циліндра (м²)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">i_гп</span></div> <div class="dictionary-definition">Передаточне число гальмівної передачі</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">η_гп</span></div> <div class="dictionary-definition">ККД гальмівної передачі</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">N_ц</span></div> <div class="dictionary-definition">Кількість гальмівних циліндрів на одиницю</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">K_од</span> / <span class="abbreviation">K_ваг</span></div> <div class="dictionary-definition">Натиск гальмівних колодок на одну одиницю (локомотив, секцію, вагон МВПС, вагон) (Н або тс)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">K_поїзда</span></div> <div class="dictionary-definition">Загальний натиск гальмівних колодок поїзда (тс)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">K_пит</span></div> <div class="dictionary-definition">Питомий гальмівний натиск (тс/т)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">φ_сер</span></div> <div class="dictionary-definition">Середній коефіцієнт тертя колодок об колеса</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">η_заг</span></div> <div class="dictionary-definition">Загальна ефективність гальмування (колія + режим)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">F_гальм</span></div> <div class="dictionary-definition">Гальмівна сила від колодок (Н)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">F_ухил</span></div> <div class="dictionary-definition">Сила опору (або допомоги) від ухилу (Н)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">F_сум</span></div> <div class="dictionary-definition">Сумарна сила, що спричиняє уповільнення (Н)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">a</span></div> <div class="dictionary-definition">Розрахункове уповільнення (м/с²)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">S</span></div> <div class="dictionary-definition">Розрахунковий гальмівний шлях (м)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">t</span></div> <div class="dictionary-definition">Розрахунковий час гальмування (с)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">E_k</span></div> <div class="dictionary-definition">Кінетична енергія поїзда (Дж)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">N_axles</span></div> <div class="dictionary-definition">Загальна кількість гальмівних осей</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">E_axle</span></div> <div class="dictionary-definition">Енергія, що розсіюється однією віссю (Дж)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">m_eff</span></div> <div class="dictionary-definition">Ефективна теплова маса колісної пари (кг)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">c</span></div> <div class="dictionary-definition">Питома теплоємність матеріалу колеса (Дж/кг·K)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">ΔT</span></div> <div class="dictionary-definition">Розрахунковий підйом температури (°C або K)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">T_max</span></div> <div class="dictionary-definition">Максимальна розрахункова температура колеса (°C)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">T_amb</span></div> <div class="dictionary-definition">Температура навколишнього середовища (°C)</div> </div> <div class="dictionary-item"> <div class="dictionary-term"><span class="abbreviation">k</span></div> <div class="dictionary-definition">Базовий коефіцієнт охолодження колеса (1/хв)</div> </div> </div> </div>
    </div>

    <div class="modal-overlay" id="temperature-modal">
         <div class="modal-content temperature-modal-content">
             <button class="modal-close" onclick="hideTemperatureModal()">×</button>
             <h2 class="modal-title">Температурний розрахунок колісних пар</h2>
             <div class="input-group"> <label for="initial-temperature">Початкова температура (<span class="abbreviation" title="Початкова температура коліс">T_initial</span>):</label> <input type="number" id="initial-temperature" value="20" step="1"> <span class="unit">°C</span> <span class="input-hint">(Температура коліс перед гальмуванням)</span> </div>
             <div class="input-group"> <label for="ambient-temperature">Температура навколишнього середовища (<span class="abbreviation" title="Температура навколишнього повітря">T_amb</span>):</label> <input type="number" id="ambient-temperature" value="20" step="1"> <span class="unit">°C</span> <span class="input-hint">(Температура повітря, впливає на охолодження)</span> </div>
             <div class="input-group"> <label for="effective-wheelset-mass">Ефективна теплова маса (<span class="abbreviation" title="Маса частини колеса, що швидко нагрівається">m_eff</span>):</label> <input type="number" id="effective-wheelset-mass" value="150" step="10"> <span class="unit">кг/вісь</span> <span class="input-hint">(~50-150 кг для піку t°; ~300-500 кг для середньої t°; менше значення = вища пікова t°)</span> </div>
             <div class="input-group"> <label for="wheel-specific-heat">Питома теплоємність (<span class="abbreviation" title="Питома теплоємність матеріалу колеса (сталь)">c</span>):</label> <input type="number" id="wheel-specific-heat" value="480" step="10"> <span class="unit">Дж/(кг·K)</span> <span class="input-hint">(Для сталі ~450-500)</span> </div>
             <div class="input-group"> <label for="cooling-coefficient">Базовий коеф. охолодження (<span class="abbreviation" title="Коефіцієнт тепловіддачі до навколишнього середовища">k</span>):</label> <input type="number" id="cooling-coefficient" value="0.02" step="0.001"> <span class="unit">1/хв</span> <span class="input-hint">(Залежить від обдування, погоди; ~0.01(штиль)-0.05(вітер). Модифікується станом колії.)</span> </div>
             <div class="input-group"> <label for="cooling-time">Час охолодження для аналізу (<span class="abbreviation" title="Час, що пройшов після зупинки">t</span>):</label> <input type="number" id="cooling-time" value="60" step="1"> <span class="unit">хв</span> <span class="input-hint">(Час після завершення гальмування)</span> </div>
             <div class="input-group"> <label for="axles-per-wagon">К-сть гальм. осей/вагон (для лок. поїздів):</label> <input type="number" id="axles-per-wagon" value="4" step="1" min="2"> <span class="unit">осей</span> <span class="input-hint">(Використовується для вагонів у локомотивному поїзді)</span> </div>
             <button id="calculate-temperature-btn" onclick="calculateTemperature()">Розрахувати температуру</button>
             <div id="temperature-warning" style="display: none;"></div>
             <div class="temperature-chart-container"> <canvas id="temperatureChart"></canvas> </div>
             <div class="advanced-results">
                 <div class="advanced-result-item"> <h4>Макс. темп. (<span class="abbreviation" title="Максимальна розрахункова температура колеса">T_max</span>)</h4> <div class="advanced-result-value" id="max-temperature">0</div> <span class="advanced-result-unit">°C</span> </div>
                 <div class="advanced-result-item"> <h4>Темп. після <span id="cooled-time-label">60</span> хв</h4> <div class="advanced-result-value" id="cooled-temperature">0</div> <span class="advanced-result-unit">°C</span> </div>
                 <div class="advanced-result-item"> <h4>Час охол. до 100°C</h4> <div class="advanced-result-value" id="cooling-to-safe">0</div> <span class="advanced-result-unit">хв</span> </div>
                 <div class="advanced-result-item"> <h4>Фактичний коеф. охол.</h4> <div class="advanced-result-value" id="actual-cooling-coeff">0.00</div> <span class="advanced-result-unit">1/хв</span> </div>
             </div>
             <div class="calculation-details">
                 <h4>Формули розрахунку (спрощені):</h4>
                 <div class="calculation-formula">
                     <p>1. Кінетична енергія поїзда (<span class="abbreviation" title="Кінетична енергія поїзда">E_k</span>): E_k = 0.5 × <span class="abbreviation" title="Маса брутто поїзда">M</span>[кг] × (<span class="abbreviation" title="Початкова (максимальна) швидкість">v₀</span>[м/с])²</p>
                     <p>2. Загальна кількість гальмівних осей (<span class="abbreviation" title="Загальна кількість гальмівних осей">N_axles</span>): Розраховується на основі типу тяги.</p>
                     <p>3. Енергія на одну вісь (<span class="abbreviation" title="Енергія, що розсіюється однією віссю">E_axle</span>): E_axle = E_k / N_axles</p>
                     <p>4. Підйом температури (<span class="abbreviation" title="Розрахунковий підйом температури">ΔT</span>): ΔT = E_axle / (<span class="abbreviation" title="Ефективна теплова маса колісної пари">m_eff</span> × <span class="abbreviation" title="Питома теплоємність матеріалу колеса">c</span>)</p>
                     <p>5. Максимальна температура (<span class="abbreviation" title="Максимальна розрахункова температура колеса">T_max</span>): T_max = <span class="abbreviation" title="Початкова температура коліс">T_initial</span> + ΔT</p>
                     <p>6. Охолодження (T(t)): T(t) = <span class="abbreviation" title="Температура навколишнього повітря">T_amb</span> + (T_max - T_amb) × e<sup>(-k_fact × t)</sup></p>
                     <p>(де k_fact - фактичний коеф. охолодження)</p>
                 </div>
             </div>
         </div>
    </div>

    <div class="modal-overlay" id="pressure-charts-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="hidePressureChartsModal()">×</button>
            <h2 class="modal-title">Інфографіка розподілу гальмівного натиску</h2>
            <p class="modal-placeholder-msg" style="display: none;">Спочатку виконайте успішний розрахунок.</p>
            <div class="chart-container-modal" id="pressurePieChartContainerModal">
                <canvas id="pressurePieChartModal"></canvas>
            </div>
            <div class="chart-container-modal" id="pressureBarChartContainerModal">
                <canvas id="pressureBarChartModal"></canvas>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="braking-distance-modal">
        <div class="modal-content">
             <button class="modal-close" onclick="hideBrakingDistanceModal()">×</button>
             <h2 class="modal-title">Аналіз гальмівного шляху</h2>

             <div class="context-params">
                 <h4>Контекст розрахунку (з основного розрахунку):</h4>
                 <div class="context-param-item"><span>Маса поїзда (<span class="abbreviation">M</span>):</span> <span id="bd-modal-mass">N/A</span> т</div>
                 <div class="context-param-item"><span>Заг. натиск (<span class="abbreviation">K_поїзда</span>):</span> <span id="bd-modal-k-poizda">N/A</span> тс</div>
                 <div class="context-param-item"><span>Сер. коеф. тертя (<span class="abbreviation">φ_сер</span>):</span> <span id="bd-modal-friction">N/A</span></div>
                 <div class="context-param-item"><span>Заг. ефективність (<span class="abbreviation">η_заг</span>):</span> <span id="bd-modal-efficiency">N/A</span></div>
             </div>

             <div class="interactive-controls">
                 <h4>Інтерактивні параметри:</h4>
                 <div class="input-group sync-range-number">
                     <label for="bd-modal-speed-range">Швидкість (<span class="abbreviation">v₀</span>):</label>
                     <input type="range" id="bd-modal-speed-range" min="1" max="120" step="1" value="80">
                     <input type="number" id="bd-modal-speed-number" min="1" max="120" step="1" value="80">
                     <span class="unit">км/год</span>
                 </div>
                 <div class="input-group sync-range-number">
                     <label for="bd-modal-gradient-range">Ухил (<span class="abbreviation">i</span>):</label>
                     <input type="range" id="bd-modal-gradient-range" min="-20" max="20" step="0.5" value="0">
                     <input type="number" id="bd-modal-gradient-number" min="-20" max="20" step="0.5" value="0">
                     <span class="unit">‰</span>
                 </div>
             </div>

              <div class="distance-results advanced-results">
                  <div class="advanced-result-item">
                      <h4>Розрахунковий шлях (<span class="abbreviation">S</span>)</h4>
                      <div class="advanced-result-value" id="bd-modal-distance">0</div>
                      <span class="advanced-result-unit">м</span>
                  </div>
                  <div class="advanced-result-item">
                      <h4>Розрахункове уповільнення (<span class="abbreviation">a</span>)</h4>
                      <div class="advanced-result-value" id="bd-modal-deceleration">0.00</div>
                      <span class="advanced-result-unit">м/с²</span>
                  </div>
                  <div class="advanced-result-item">
                      <h4>Розрахунковий час (<span class="abbreviation">t</span>)</h4>
                      <div class="advanced-result-value" id="bd-modal-time">0.0</div>
                      <span class="advanced-result-unit">с</span>
                  </div>
              </div>

              <div class="braking-process-chart-container">
                  <canvas id="brakingProcessChart"></canvas>
              </div>

               <!-- Перемикач та графік залежності -->
               <div class="dependency-selector">
                   <label for="dependency-type">Показати залежність S від:</label>
                   <select id="dependency-type" onchange="recalculateBrakingDistanceInModal()">
                       <option value="speed">Швидкості (при i = <span id="fixed-gradient-label">0</span> ‰)</option>
                       <option value="gradient">Ухилу (при v = <span id="fixed-speed-label">80</span> км/год)</option>
                   </select>
               </div>
               <div class="dependency-chart-container">
                   <canvas id="brakingDependencyChart"></canvas>
               </div>


              <div class="calculation-details">
                  <h4>Формули розрахунку (для аналізу):</h4>
                  <div class="calculation-formula">
                      <p>1. <span class="abbreviation" title="Гальмівна сила від колодок">F_гальм</span> = <span class="abbreviation" title="Загальний натиск гальмівних колодок поїзда">K_поїзда</span>[тс] × 9810 × <span class="abbreviation" title="Середній коефіцієнт тертя між колодками та колесами">φ_сер</span> × <span class="abbreviation" title="Загальна ефективність гальмування">η_заг</span></p>
                      <p>2. <span class="abbreviation" title="Сила опору (або допомоги) від ухилу">F_ухил</span> = <span class="abbreviation" title="Маса брутто поїзда">M</span>[кг] × <span class="abbreviation" title="Прискорення вільного падіння">g</span> × (<span class="abbreviation" title="Ухил поздовжнього профілю колії">i</span>[‰] / 1000)</p>
                      <p>3. <span class="abbreviation" title="Сумарна сила, що спричиняє уповільнення">F_сум</span> = <span class="abbreviation" title="Гальмівна сила від колодок">F_гальм</span> - <span class="abbreviation" title="Сила опору (або допомоги) від ухилу">F_ухил</span></p>
                      <p>4. <span class="abbreviation" title="Розрахункове уповільнення">a</span> = <span class="abbreviation" title="Сумарна сила, що спричиняє уповільнення">F_сум</span> / <span class="abbreviation" title="Маса брутто поїзда">M</span>[кг]</p>
                      <p>5. <span class="abbreviation" title="Розрахунковий гальмівний шлях">S</span> = (<span class="abbreviation" title="Початкова (максимальна) швидкість">v₀</span>[м/с])² / (2 × <span class="abbreviation" title="Розрахункове уповільнення">a</span>)</p>
                      <p>6. <span class="abbreviation" title="Розрахунковий час гальмування">t</span> = <span class="abbreviation" title="Початкова (максимальна) швидкість">v₀</span>[м/с] / <span class="abbreviation" title="Розрахункове уповільнення">a</span></p>
                  </div>
              </div>

         </div>
     </div>

    <script>
	 // --- Global Variables (non-DOM, non-chart instances) ---
        let wagonCounter = 0;
        const PI = Math.PI;
        const N_TO_TC_FACTOR = 9810;
        const G = 9.81;
        let calculationSuccess = false;
        let temperatureCalculationDone = false;
        let chartData = null;

        let bdModalContext = {
            massTonnes: 0, kPoizdaTc: 0, avgFriction: 0, totalEfficiency: 0,
            brakingProcessTimeData: [], brakingProcessSpeedData: [],
            brakingDependencyXData: [], brakingDependencyYData: [],
            brakingDependencyXAxisLabel: '', brakingDependencyYAxisLabel: '', brakingDependencyChartTitle: ''
        };

        // Coefficients and static data
        const frictionCoefficients = { cast_iron: { dry: 0.18, wet: 0.12, contaminated: 0.08 }, composite: { dry: 0.30, wet: 0.25, contaminated: 0.15 } };
        const trackEfficiency = { dry: 1.0, wet: 0.85, contaminated: 0.7 };
        const brakeModeEfficiency = { full: 1.0, step: 0.9, emergency: 1.05 };
        const wagonTypeData = {
            'custom': { name: 'Інший (ввести вручну)', diameter_in: '', i_gp: '', eta_gp: '', n_cyl: 1, shoes_type: 'cast_iron', shoes_count: 4, weight: 22 },
            'gondola_14': { name: 'Піввагон (14")', diameter_in: 14, i_gp: 6.8, eta_gp: 0.85, n_cyl: 1, shoes_type: 'cast_iron', shoes_count: 4, weight: 22 },
            'tank_12': { name: 'Цистерна (12")', diameter_in: 12, i_gp: 5.5, eta_gp: 0.88, n_cyl: 1, shoes_type: 'cast_iron', shoes_count: 4, weight: 24 },
            'platform': { name: 'Платформа (14")', diameter_in: 14, i_gp: 6.5, eta_gp: 0.85, n_cyl: 1, shoes_type: 'cast_iron', shoes_count: 4, weight: 21 },
            'covered': { name: 'Критий (14")', diameter_in: 14, i_gp: 7.0, eta_gp: 0.86, n_cyl: 1, shoes_type: 'cast_iron', shoes_count: 4, weight: 23 },
            'hopper': { name: 'Хоппер (16")', diameter_in: 16, i_gp: 7.2, eta_gp: 0.84, n_cyl: 1, shoes_type: 'composite', shoes_count: 8, weight: 25 },
            'reefer': { name: 'Рефрижератор (14")', diameter_in: 14, i_gp: 6.0, eta_gp: 0.88, n_cyl: 1, shoes_type: 'composite', shoes_count: 8, weight: 28 },
            'tank_16': { name: 'Цистерна велика (16")', diameter_in: 16, i_gp: 5.8, eta_gp: 0.87, n_cyl: 1, shoes_type: 'composite', shoes_count: 8, weight: 26 }
        };
        const tractionData = { // ЗАПОВНІТЬ ТОЧНИМИ ДАНИМИ!
            locomotive: {
                vl80: { name: "ВЛ80 (різні модиф.)", D_c: 14, i_gp: 7.85, eta_gp: 0.85, n_cyl: 1, axles: 8, sections: 2, shoes: 'cast_iron', weight_sec: 92 },
                chme3: { name: "ЧМЕ3", D_c: 10, i_gp: 10.47, eta_gp: 0.8, n_cyl: 1, axles: 6, sections: 1, shoes: 'cast_iron', weight_sec: 123 },
                "2te116": { name: "2ТЕ116", D_c: 10, i_gp: 10.47, eta_gp: 0.8, n_cyl: 1, axles: 6, sections: 2, shoes: 'cast_iron', weight_sec: 138 },
                de1: { name: "ДЕ1", D_c: 14, i_gp: 9.63, eta_gp: 0.85, n_cyl: 1, axles: 8, sections: 2, shoes: 'cast_iron', weight_sec: 100 },
                ds3: { name: "ДС3", D_c: 10, i_gp: 8.7, eta_gp: 0.88, n_cyl: 2, axles: 4, sections: 1, shoes: 'composite', weight_sec: 88 },
                vl11: { name: "ВЛ11/ВЛ11М", D_c: 14, i_gp: 7.85, eta_gp: 0.85, n_cyl: 1, axles: 8, sections: 2, shoes: 'cast_iron', weight_sec: 92 },
                custom_loco: { name: "Інша серія (ввести вручну)", D_c: '', i_gp: '', eta_gp: '', n_cyl: 1, axles: '', sections: 1, shoes: 'cast_iron', weight_sec: '' }
            },
            emu: {
                er2: { name: "ЕР2/ЕР2Р/ЕР2Т", cars: 10, D_c_avg: 10, i_gp_avg: 5.64, eta_gp_avg: 0.85, n_cyl_avg: 1, axles_car: 4, shoes: 'cast_iron', weight_car: 45 },
                er9: { name: "ЕР9 (різні модиф.)", cars: 10, D_c_avg: 10, i_gp_avg: 5.64, eta_gp_avg: 0.85, n_cyl_avg: 1, axles_car: 4, shoes: 'cast_iron', weight_car: 47 },
                epl2t: { name: "ЕПЛ2Т", cars: 8, D_c_avg: 10, i_gp_avg: 5.0, eta_gp_avg: 0.88, n_cyl_avg: 1, axles_car: 4, shoes: 'composite', weight_car: 50 },
                epl9t: { name: "ЕПЛ9Т", cars: 8, D_c_avg: 10, i_gp_avg: 5.0, eta_gp_avg: 0.88, n_cyl_avg: 1, axles_car: 4, shoes: 'composite', weight_car: 52 },
                hrsc2: { name: "HRSC2 (Hyundai Rotem)", cars: 9, D_c_avg: 8, i_gp_avg: 6.0, eta_gp_avg: 0.9, n_cyl_avg: 2, axles_car: 4, shoes: 'composite', weight_car: 55 },
                ej675: { name: "EJ 675 (Škoda)", cars: 6, D_c_avg: 8, i_gp_avg: 6.0, eta_gp_avg: 0.9, n_cyl_avg: 2, axles_car: 4, shoes: 'composite', weight_car: 60 },
                custom_emu: { name: "Інший (ввести вручну)", cars: '', D_c_avg: '', i_gp_avg: '', eta_gp_avg: '', n_cyl_avg: 1, axles_car: 4, shoes: 'composite', weight_car: '' }
            },
            dmu: {
                d1: { name: "Д1", cars: 4, D_c_avg: 10, i_gp_avg: 7.0, eta_gp_avg: 0.8, n_cyl_avg: 1, axles_car: 4, shoes: 'cast_iron', weight_car: 50 },
                dr1a: { name: "ДР1А", cars: 6, D_c_avg: 10, i_gp_avg: 7.0, eta_gp_avg: 0.8, n_cyl_avg: 1, axles_car: 4, shoes: 'cast_iron', weight_car: 52 },
                pesa620m: { name: "PESA 620M", cars: 1, D_c_avg: 8, i_gp_avg: 5.5, eta_gp_avg: 0.9, n_cyl_avg: 2, axles_car: 2, shoes: 'composite', weight_car: 40 },
                pesa630m: { name: "PESA 630M", cars: 3, D_c_avg: 8, i_gp_avg: 5.5, eta_gp_avg: 0.9, n_cyl_avg: 2, axles_car: 2, shoes: 'composite', weight_car: 45 },
                dpkr: { name: "ДПКр-2/ДПКр-3", cars: 3, D_c_avg: 8, i_gp_avg: 5.8, eta_gp_avg: 0.9, n_cyl_avg: 1, axles_car: 4, shoes: 'composite', weight_car: 58 },
                custom_dmu: { name: "Інший (ввести вручну)", cars: '', D_c_avg: '', i_gp_avg: '', eta_gp_avg: '', n_cyl_avg: 1, axles_car: 4, shoes: 'composite', weight_car: '' }
            }
        };

        // --- Chart instances - ОГОЛОШУЄМО ГЛОБАЛЬНО НАЙПЕРШИМИ ---
        let pressurePieChart = null;
        let pressureBarChart = null;
        let temperatureChart = null;
        let brakingProcessChart = null;
        let brakingDependencyChart = null;

        // DOM element variables - declare globally
        let themeToggleBtn, bodyElement,
            tractionUnitTypeSelect, locomotiveOptionsDiv, emuOptionsDiv, dmuOptionsDiv,
            wagonParamsSection, addWagonBtn,
            locoSeriesSelect, emuSeriesSelect, dmuSeriesSelect,
            reportDateInput, studentNameInput, studentGroupInput,
            pressureMpaInput, trainMassInput, maxSpeedInput, trackConditionSelect, trackGradientInput, brakeModeSelect,
            totalPressureDisplay, specificPressureDisplay, brakingDistanceDisplay, brakingDecelerationDisplay,
            brakingTimeDisplay, frictionCoefficientDisplay, brakeEfficiencyDisplay,
            maxTemperatureDisplay, cooledTemperatureDisplay, cooledTimeLabelDisplay, coolingToSafeDisplay, actualCoolingCoeffDisplay,
            bdModalDistanceDisplay, bdModalDecelerationDisplay, bdModalTimeDisplay,
            reportContentDiv, reportPrintAreaDiv, temperatureWarningDiv,
            wagonModulesContainerDiv, configFileInput,
            helpModal, temperatureModal, pressureChartsModal, brakingDistanceModal;


        // --- ALL FUNCTION DEFINITIONS ---

        function getThemeColors() {
            if (!bodyElement) bodyElement = document.body;
            if (!bodyElement) return { textColor: '#e5e5e5', gridColor: '#404060', isLight: false, gradients: [], sectionBgAlt: '#1a1a2e', inputBg: '#252540' }; // Default fallback
            const styles = getComputedStyle(bodyElement);
            const isLightTheme = bodyElement.classList.contains('light-theme');
            const gradientPairs = [];
            for (let i = 1; i <= 5; i++) {
                const startColor = styles.getPropertyValue(`--chart-grad-${i}-start`)?.trim();
                const endColor = styles.getPropertyValue(`--chart-grad-${i}-end`)?.trim();
                if (startColor && endColor) gradientPairs.push({ start: startColor, end: endColor });
                else gradientPairs.push({ start: '#cccccc', end: '#999999' });
            }
            return {
                textColor: styles.getPropertyValue('--text-color').trim() || (isLightTheme ? '#343a40' : '#e5e5e5'),
                textColorDarker: styles.getPropertyValue('--text-color-darker').trim() || (isLightTheme ? '#495057' : '#a0a0c0'),
                accentColor: styles.getPropertyValue('--accent-color').trim() || (isLightTheme ? '#17a2b8' : '#00e676'),
                gridColor: styles.getPropertyValue('--border-color').trim() || (isLightTheme ? '#ced4da' : '#404060'),
                isLight: isLightTheme,
                gradients: gradientPairs,
                containerBg: styles.getPropertyValue('--container-bg').trim(),
                sectionBgAlt: styles.getPropertyValue('--section-bg-alt').trim() || (isLightTheme ? '#f8f9fa' : 'rgba(35, 35, 60, 0.8)'),
                inputBg: styles.getPropertyValue('--input-bg').trim()  || (isLightTheme ? '#ffffff' : '#252540')
            };
        }

        function updateChartThemes() {
             if (pressureChartsModal && pressureChartsModal.classList.contains('active')) { if (calculationSuccess && chartData) { renderCharts('pressurePieChartModal', 'pressureBarChartModal'); } }
             if (temperatureModal && temperatureModal.classList.contains('active') && temperatureChart ) { if (temperatureCalculationDone) { const lastMaxTemp = parseFloat(maxTemperatureDisplay?.textContent) || 20; const lastAmbient = parseFloat(document.getElementById('ambient-temperature')?.value) || 20; const lastCoolCoeff = parseFloat(actualCoolingCoeffDisplay?.textContent) || 0.02; const lastCoolTime = parseFloat(document.getElementById('cooling-time')?.value) || 60; renderTemperatureChart(lastMaxTemp, lastAmbient, lastCoolCoeff, lastCoolTime); } }
             if (brakingDistanceModal && brakingDistanceModal.classList.contains('active') && (brakingProcessChart || brakingDependencyChart)) {
                 if (typeof recalculateBrakingDistanceInModal === 'function') {
                    if (bdModalContext.brakingProcessTimeData && bdModalContext.brakingProcessTimeData.length > 0) {
                        renderBrakingProcessChart(bdModalContext.brakingProcessTimeData, bdModalContext.brakingProcessSpeedData);
                    }
                    if (bdModalContext.brakingDependencyXData && bdModalContext.brakingDependencyXData.length > 0) {
                        renderBrakingDependencyChart(bdModalContext.brakingDependencyXData, bdModalContext.brakingDependencyYData, bdModalContext.brakingDependencyXAxisLabel, bdModalContext.brakingDependencyYAxisLabel, bdModalContext.brakingDependencyChartTitle);
                    }
                 }
             }
        }

        function setPreferredTheme() {
            if (!bodyElement || !themeToggleBtn) {
                console.warn("setPreferredTheme: bodyElement or themeToggleBtn not ready yet.");
                return;
            }
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                bodyElement.classList.add('light-theme');
                themeToggleBtn.textContent = 'Темна Тема';
            } else {
                bodyElement.classList.remove('light-theme');
                themeToggleBtn.textContent = 'Світла Тема';
            }
            updateChartThemes();
        }

        function showHelpModal() { if(helpModal) helpModal.classList.add('active');}
        function hideHelpModal() { if(helpModal) helpModal.classList.remove('active'); }
        function showTemperatureModal() {
            console.log("showTemperatureModal called. calculationSuccess =", calculationSuccess);
            if (!calculationSuccess) { showFloatingMessage('Спочатку виконайте основний розрахунок гальмування (без помилок).', 4000, true); return; }
            if (!temperatureModal) {console.error("Temperature modal not found"); return;}
            const warningDiv = temperatureModal.querySelector('#temperature-warning');
            if (warningDiv) warningDiv.style.display = 'none';
            temperatureModal.querySelectorAll('input').forEach(input => input.style.borderColor = '');
            temperatureModal.classList.add('active');
            if (temperatureCalculationDone) {
                const lastMaxTemp = parseFloat(maxTemperatureDisplay?.textContent) || 20; // Use optional chaining
                const lastAmbient = parseFloat(document.getElementById('ambient-temperature')?.value) || 20;
                const lastCoolCoeff = parseFloat(actualCoolingCoeffDisplay?.textContent) || 0.02;
                const lastCoolTime = parseFloat(document.getElementById('cooling-time')?.value) || 60;
                renderTemperatureChart(lastMaxTemp, lastAmbient, lastCoolCoeff, lastCoolTime);
            } else if (!temperatureChart) {
                renderTemperatureChart(); // Render empty or default chart
            }
        }
        function hideTemperatureModal() { if(temperatureModal) temperatureModal.classList.remove('active'); }
        function showPressureChartsModal() {
            if (!pressureChartsModal) {console.error("Pressure charts modal not found!"); return; }
            const placeholder = pressureChartsModal.querySelector('.modal-placeholder-msg');
            const pieContainer = pressureChartsModal.querySelector('#pressurePieChartContainerModal');
            const barContainer = pressureChartsModal.querySelector('#pressureBarChartContainerModal');
            if (!calculationSuccess) { showFloatingMessage('Спочатку виконайте основний розрахунок (без помилок).', 4000, true); return; }
            if (placeholder) placeholder.style.display = 'none';
            if (pieContainer) pieContainer.style.display = 'block';
            if (barContainer) barContainer.style.display = 'block';
            pressureChartsModal.classList.add('active');
            setTimeout(() => { renderCharts('pressurePieChartModal', 'pressureBarChartModal'); }, 50);
        }
        function hidePressureChartsModal() { if(pressureChartsModal) pressureChartsModal.classList.remove('active'); }
        function showBrakingDistanceModal() {
            if (!calculationSuccess) { showFloatingMessage('Спочатку виконайте основний розрахунок (без помилок).', 4000, true); return; }
            if (!brakingDistanceModal) {console.error("Braking distance modal not found!"); return; }
            try {
                 bdModalContext.massTonnes = parseFloat(trainMassInput.value);
                 bdModalContext.kPoizdaTc = parseFloat(totalPressureDisplay.textContent);
                 bdModalContext.avgFriction = parseFloat(frictionCoefficientDisplay.textContent);
                 bdModalContext.totalEfficiency = parseFloat(brakeEfficiencyDisplay.textContent);
                 const initialSpeed = parseFloat(maxSpeedInput.value);
                 const initialGradient = parseFloat(trackGradientInput.value);

                 if (isNaN(bdModalContext.massTonnes) || isNaN(bdModalContext.kPoizdaTc) || isNaN(bdModalContext.avgFriction) || isNaN(bdModalContext.totalEfficiency) || isNaN(initialSpeed) || isNaN(initialGradient)) {
                    throw new Error("Некоректні значення в результатах основного розрахунку для модального вікна.");
                 }
                 document.getElementById('bd-modal-mass').textContent = bdModalContext.massTonnes.toFixed(0);
                 document.getElementById('bd-modal-k-poizda').textContent = bdModalContext.kPoizdaTc.toFixed(2);
                 document.getElementById('bd-modal-friction').textContent = bdModalContext.avgFriction.toFixed(2);
                 document.getElementById('bd-modal-efficiency').textContent = bdModalContext.totalEfficiency.toFixed(2);

                 const speedRange = document.getElementById('bd-modal-speed-range'); const speedNumber = document.getElementById('bd-modal-speed-number');
                 const gradientRange = document.getElementById('bd-modal-gradient-range'); const gradientNumber = document.getElementById('bd-modal-gradient-number');
                 const depSelect = document.getElementById('dependency-type');

                 if (speedRange && speedNumber && gradientRange && gradientNumber && depSelect) {
                     speedRange.value = initialSpeed; speedNumber.value = initialSpeed;
                     gradientRange.value = initialGradient; gradientNumber.value = initialGradient;
                     depSelect.value = 'speed';
                 } else { throw new Error("Не знайдено інтерактивні елементи керування в модалі гальмівного шляху."); }
                 recalculateBrakingDistanceInModal();
                 brakingDistanceModal.classList.add('active');
             } catch (error) { console.error("Error opening braking distance modal:", error); showFloatingMessage("Помилка відкриття аналізу шляху: " + error.message, 5000, true); }
        }
        function hideBrakingDistanceModal() { if(brakingDistanceModal) brakingDistanceModal.classList.remove('active'); }

        function setupInputValidation() { const addWarningLogic = (inputId, warningId, minOk, maxOk, minWarn, maxWarn, errorMsg, warnMsg) => { const input = document.getElementById(inputId); const warning = document.getElementById(warningId); if (!input || !warning) {console.warn(`Validation setup: Element ${inputId} or ${warningId} not found.`); return;} input.addEventListener('input', function() { const value = parseFloat(this.value); let isInvalid = isNaN(value); let allowZeroOrNegative = (inputId === 'track-gradient'); if (!allowZeroOrNegative && value <=0) isInvalid = true; if (allowZeroOrNegative && inputId !== 'track-gradient' && value < 0) isInvalid = true; this.style.borderColor = ''; warning.style.display = 'none'; if (isInvalid) { this.style.borderColor = 'var(--error-color)'; warning.textContent = errorMsg; warning.style.color = 'var(--error-color)'; warning.style.display = 'block'; } else if ((minWarn !== null && value < minWarn) || (maxWarn !== null && value > maxWarn)) { this.style.borderColor = 'var(--warning-color)'; warning.textContent = warnMsg; warning.style.color = 'var(--warning-color)'; warning.style.display = 'block'; } else if ((minOk !== null && value < minOk) || (maxOk !== null && value > maxOk)) { this.style.borderColor = 'var(--warning-color)'; warning.textContent = warnMsg; warning.style.color = 'var(--warning-color)'; warning.style.display = 'block'; } }); }; addWarningLogic('pressure-mpa', 'pressure-warning', 0.38, 0.42, 0.35, 0.45, 'Тиск має бути > 0.', 'Рекомендовано: 0.38-0.42 МПа'); addWarningLogic('train-mass', 'mass-warning', 100, 10000, 50, 12000, 'Маса має бути > 0.', 'Типова маса: 3000-6000 т для вантажних.'); addWarningLogic('max-speed', 'speed-warning', 20, 160, 10, 200, 'Швидкість має бути > 0.', 'Типово для вантажних: 60-90 км/год'); document.querySelectorAll('select').forEach(select => { select.addEventListener('change', function() { this.setAttribute('data-selected-text', this.options[this.selectedIndex].text); }); if(select.selectedIndex >= 0) { select.setAttribute('data-selected-text', select.options[select.selectedIndex].text); } }); }
        function showFloatingMessage(message, duration = 5000, isWarning = false) { const existingMessage = document.querySelector('.floating-message:not(#temperature-warning)'); if (existingMessage) existingMessage.remove(); const messageElement = document.createElement('div'); messageElement.className = `floating-message ${isWarning ? 'floating-warning' : ''}`; messageElement.textContent = message; if(bodyElement) bodyElement.appendChild(messageElement); else document.body.appendChild(messageElement); setTimeout(() => { messageElement.style.animation = 'slideOut 0.3s ease-out forwards'; setTimeout(() => messageElement.remove(), 300); }, duration); return messageElement; }
        function saveConfiguration() { try { const config = { version: "1.9.1", studentInfo: { name: studentNameInput.value, group: studentGroupInput.value, date: reportDateInput.value }, commonParams: { pressure: pressureMpaInput.value, mass: trainMassInput.value, speed: maxSpeedInput.value, trackCondition: trackConditionSelect.value, trackGradient: trackGradientInput.value, brakeMode: brakeModeSelect.value }, tractionUnit: { type: tractionUnitTypeSelect.value, locoSeries: locoSeriesSelect.value, locoDc: document.getElementById('loco-cylinder-diameter').value, locoIgp: document.getElementById('loco-transmission-ratio').value, locoEta: document.getElementById('loco-efficiency').value, locoNcyl: document.getElementById('loco-cylinder-count').value, locoSections: document.getElementById('loco-sections').value, locoShoes: document.getElementById('loco-brake-shoes-type').value, locoAxles: document.getElementById('loco-axle-count').value, locoWeightPerSection: document.getElementById('loco-weight-per-section').value, emuSeries: emuSeriesSelect.value, emuCars: document.getElementById('emu-car-count').value, emuDc: document.getElementById('emu-avg-cylinder-diameter').value, emuIgp: document.getElementById('emu-avg-transmission-ratio').value, emuEta: document.getElementById('emu-avg-efficiency').value, emuNcyl: document.getElementById('emu-avg-cylinder-count').value, emuShoes: document.getElementById('emu-brake-shoes-type').value, emuAxlesCar: document.getElementById('emu-axle-count-per-car').value, emuWeightPerCar: document.getElementById('emu-weight-per-car').value, dmuSeries: dmuSeriesSelect.value, dmuCars: document.getElementById('dmu-car-count').value, dmuDc: document.getElementById('dmu-avg-cylinder-diameter').value, dmuIgp: document.getElementById('dmu-avg-transmission-ratio').value, dmuEta: document.getElementById('dmu-avg-efficiency').value, dmuNcyl: document.getElementById('dmu-avg-cylinder-count').value, dmuShoes: document.getElementById('dmu-brake-shoes-type').value, dmuAxlesCar: document.getElementById('dmu-axle-count-per-car').value, dmuWeightPerCar: document.getElementById('dmu-weight-per-car').value }, tempParams: { initialTemp: document.getElementById('initial-temperature').value, ambientTemp: document.getElementById('ambient-temperature').value, effectiveMass: document.getElementById('effective-wheelset-mass').value, specificHeat: document.getElementById('wheel-specific-heat').value, coolingCoeff: document.getElementById('cooling-coefficient').value, coolingTime: document.getElementById('cooling-time').value, axlesPerWagon: document.getElementById('axles-per-wagon').value }, wagons: [] }; document.querySelectorAll('.wagon-module').forEach(module => { const id = module.id.split('-').pop(); config.wagons.push({ type: document.getElementById(`wagon-type-select-${id}`)?.value ?? 'custom', count: document.getElementById(`wagon-count-${id}`)?.value ?? '1', diameter: document.getElementById(`cylinder-diameter-${id}`)?.value ?? '', ratio: document.getElementById(`transmission-ratio-${id}`)?.value ?? '', efficiency: document.getElementById(`efficiency-${id}`)?.value ?? '', cylCount: document.getElementById(`cylinder-count-${id}`)?.value ?? '1', shoesType: document.getElementById(`brake-shoes-type-${id}`)?.value ?? 'cast_iron', shoesCount: document.getElementById(`brake-shoes-count-${id}`)?.value ?? '4' }); }); const dataStr = JSON.stringify(config, null, 2); const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr); const exportName = `brake_calc_config_v1.9.1_${new Date().toISOString().slice(0,10)}.json`; const linkElement = document.createElement('a'); linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', exportName); linkElement.click(); showFloatingMessage('Конфігурацію збережено: ' + exportName, 4000); } catch (error) { console.error("Error saving configuration:", error); showFloatingMessage('Помилка збереження: ' + error.message, 5000, true); } }
        function loadConfiguration() { if(!configFileInput) return; configFileInput.value = ''; configFileInput.click(); const handleFileLoad = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(event) { try { const config = JSON.parse(event.target.result); studentNameInput.value = config.studentInfo?.name ?? ''; studentGroupInput.value = config.studentInfo?.group ?? ''; reportDateInput.value = config.studentInfo?.date ?? new Date().toISOString().slice(0,10); pressureMpaInput.value = config.commonParams?.pressure ?? '0.4'; trainMassInput.value = config.commonParams?.mass ?? '5000'; maxSpeedInput.value = config.commonParams?.speed ?? '80'; trackConditionSelect.value = config.commonParams?.trackCondition ?? 'dry'; trackGradientInput.value = config.commonParams?.trackGradient ?? '0'; brakeModeSelect.value = config.commonParams?.brakeMode ?? 'full'; if(config.tractionUnit){ tractionUnitTypeSelect.value = config.tractionUnit.type || 'locomotive'; locoSeriesSelect.value = config.tractionUnit.locoSeries || 'vl80'; document.getElementById('loco-cylinder-diameter').value = config.tractionUnit.locoDc || ''; document.getElementById('loco-transmission-ratio').value = config.tractionUnit.locoIgp || ''; document.getElementById('loco-efficiency').value = config.tractionUnit.locoEta || ''; document.getElementById('loco-cylinder-count').value = config.tractionUnit.locoNcyl || '1'; document.getElementById('loco-sections').value = config.tractionUnit.locoSections || '1'; document.getElementById('loco-brake-shoes-type').value = config.tractionUnit.locoShoes || 'cast_iron'; document.getElementById('loco-axle-count').value = config.tractionUnit.locoAxles || ''; document.getElementById('loco-weight-per-section').value = config.tractionUnit.locoWeightPerSection || ''; emuSeriesSelect.value = config.tractionUnit.emuSeries || 'er2'; document.getElementById('emu-car-count').value = config.tractionUnit.emuCars || '10'; document.getElementById('emu-avg-cylinder-diameter').value = config.tractionUnit.emuDc || ''; document.getElementById('emu-avg-transmission-ratio').value = config.tractionUnit.emuIgp || ''; document.getElementById('emu-avg-efficiency').value = config.tractionUnit.emuEta || ''; document.getElementById('emu-avg-cylinder-count').value = config.tractionUnit.emuNcyl || '1'; document.getElementById('emu-brake-shoes-type').value = config.tractionUnit.emuShoes || 'composite'; document.getElementById('emu-axle-count-per-car').value = config.tractionUnit.emuAxlesCar || '4'; document.getElementById('emu-weight-per-car').value = config.tractionUnit.emuWeightPerCar || ''; dmuSeriesSelect.value = config.tractionUnit.dmuSeries || 'd1'; document.getElementById('dmu-car-count').value = config.tractionUnit.dmuCars || '3'; document.getElementById('dmu-avg-cylinder-diameter').value = config.tractionUnit.dmuDc || ''; document.getElementById('dmu-avg-transmission-ratio').value = config.tractionUnit.dmuIgp || ''; document.getElementById('dmu-avg-efficiency').value = config.tractionUnit.dmuEta || ''; document.getElementById('dmu-avg-cylinder-count').value = config.tractionUnit.dmuNcyl || '1'; document.getElementById('dmu-brake-shoes-type').value = config.tractionUnit.dmuShoes || 'composite'; document.getElementById('dmu-axle-count-per-car').value = config.tractionUnit.dmuAxlesCar || '4'; document.getElementById('dmu-weight-per-car').value = config.tractionUnit.dmuWeightPerCar || ''; updateTractionOptionsVisibility(); populateLocoFields(); populateEmuFields(); populateDmuFields(); } trackConditionSelect.dispatchEvent(new Event('change')); brakeModeSelect.dispatchEvent(new Event('change')); if (config.tempParams) { document.getElementById('initial-temperature').value = config.tempParams.initialTemp ?? '20'; document.getElementById('ambient-temperature').value = config.tempParams.ambientTemp ?? '20'; document.getElementById('effective-wheelset-mass').value = config.tempParams.effectiveMass ?? '150'; document.getElementById('wheel-specific-heat').value = config.tempParams.specificHeat ?? '480'; document.getElementById('cooling-coefficient').value = config.tempParams.coolingCoeff ?? '0.02'; document.getElementById('cooling-time').value = config.tempParams.coolingTime ?? '60'; document.getElementById('axles-per-wagon').value = config.tempParams.axlesPerWagon ?? '4'; } if(wagonModulesContainerDiv) wagonModulesContainerDiv.innerHTML = ''; wagonCounter = 0; if (config.wagons && Array.isArray(config.wagons)) { config.wagons.forEach(wagon => { wagonCounter++; const defaultType = wagon.type || 'custom'; const module = createWagonModule(wagonCounter, defaultType); if(wagonModulesContainerDiv) wagonModulesContainerDiv.appendChild(module); document.getElementById(`wagon-count-${wagonCounter}`).value = wagon.count ?? '1'; document.getElementById(`cylinder-diameter-${wagonCounter}`).value = wagon.diameter ?? ''; document.getElementById(`transmission-ratio-${wagonCounter}`).value = wagon.ratio ?? ''; document.getElementById(`efficiency-${wagonCounter}`).value = wagon.efficiency ?? ''; document.getElementById(`cylinder-count-${wagonCounter}`).value = wagon.cylCount ?? '1'; document.getElementById(`brake-shoes-type-${wagonCounter}`).value = wagon.shoesType ?? 'cast_iron'; document.getElementById(`brake-shoes-count-${wagonCounter}`).value = wagon.shoesCount ?? '4'; const typeSelect = document.getElementById(`wagon-type-select-${wagonCounter}`); if(typeSelect) { typeSelect.value = defaultType; // Не викликаємо updateWagonInputs тут, щоб не скинути інші поля
                if(wagon.diameter != null) document.getElementById(`cylinder-diameter-${wagonCounter}`).value = wagon.diameter; if(wagon.ratio != null) document.getElementById(`transmission-ratio-${wagonCounter}`).value = wagon.ratio; if(wagon.efficiency != null) document.getElementById(`efficiency-${wagonCounter}`).value = wagon.efficiency; if(wagon.cylCount != null) document.getElementById(`cylinder-count-${wagonCounter}`).value = wagon.cylCount; if(wagon.shoesType) document.getElementById(`brake-shoes-type-${wagonCounter}`).value = wagon.shoesType; if(wagon.shoesCount) document.getElementById(`brake-shoes-count-${wagonCounter}`).value = wagon.shoesCount; typeSelect.setAttribute('data-selected-text', typeSelect.options[typeSelect.selectedIndex]?.text ?? 'Інший'); document.getElementById(`brake-shoes-type-${wagonCounter}`).setAttribute('data-selected-text', document.getElementById(`brake-shoes-type-${wagonCounter}`).options[document.getElementById(`brake-shoes-type-${wagonCounter}`).selectedIndex]?.text ?? 'Чавунні'); } }); } if (wagonCounter === 0 && config.tractionUnit?.type === 'locomotive') { addInitialData(); } showFloatingMessage('Конфігурацію завантажено.', 4000); calculationSuccess = false; temperatureCalculationDone = false; hidePressureChartsModal(); hideBrakingDistanceModal(); resetResultsAndCharts(); updateTrainMassField(); } catch (error) { showFloatingMessage('Помилка завантаження: ' + error.message, 6000, true); console.error('Error loading config:', error); } finally { if(configFileInput) configFileInput.removeEventListener('change', handleFileLoad); } }; reader.onerror = (error) => { showFloatingMessage('Помилка читання файлу.', 5000, true); console.error('File reading error:', error); if(configFileInput) configFileInput.removeEventListener('change', handleFileLoad); }; reader.readAsText(file); }; if(configFileInput) configFileInput.addEventListener('change', handleFileLoad); }
        function updateTractionOptionsVisibility() {
            if (!tractionUnitTypeSelect || !locomotiveOptionsDiv || !emuOptionsDiv || !dmuOptionsDiv || !wagonParamsSection || !addWagonBtn) { console.warn("updateTractionOptionsVisibility: One or more UI elements missing."); return; }
            const selectedType = tractionUnitTypeSelect.value;
            locomotiveOptionsDiv.classList.remove('active'); emuOptionsDiv.classList.remove('active'); dmuOptionsDiv.classList.remove('active');
            if (selectedType === 'locomotive') {
                locomotiveOptionsDiv.classList.add('active'); wagonParamsSection.classList.remove('disabled-section'); addWagonBtn.disabled = false;
                if (document.querySelectorAll('.wagon-module').length === 0 && typeof addInitialData === "function") addInitialData();
            } else {
                if (selectedType === 'emu') emuOptionsDiv.classList.add('active');
                else if (selectedType === 'dmu') dmuOptionsDiv.classList.add('active');
                wagonParamsSection.classList.add('disabled-section'); addWagonBtn.disabled = true;
                if(wagonModulesContainerDiv) wagonModulesContainerDiv.innerHTML = ''; wagonCounter = 0;
            }
            resetResultsAndCharts(); updateTrainMassField();
        }
        function populateLocoFields() {
            if(!locoSeriesSelect) return; const seriesKey = locoSeriesSelect.value; const data = tractionData.locomotive[seriesKey];
            if (data) { document.getElementById('loco-cylinder-diameter').value = data.D_c !== undefined ? data.D_c : ''; document.getElementById('loco-transmission-ratio').value = data.i_gp !== undefined ? data.i_gp : ''; document.getElementById('loco-efficiency').value = data.eta_gp !== undefined ? data.eta_gp : ''; document.getElementById('loco-cylinder-count').value = data.n_cyl || '1'; document.getElementById('loco-sections').value = data.sections || '1'; document.getElementById('loco-brake-shoes-type').value = data.shoes || 'cast_iron'; document.getElementById('loco-axle-count').value = data.axles !== undefined ? data.axles : ''; document.getElementById('loco-weight-per-section').value = data.weight_sec !== undefined ? data.weight_sec : ''; const shoeSelect = document.getElementById('loco-brake-shoes-type'); if (shoeSelect) shoeSelect.dispatchEvent(new Event('change')); }
            updateTrainMassField();
        }
        function populateEmuFields() {
            if(!emuSeriesSelect) return; const seriesKey = emuSeriesSelect.value; const data = tractionData.emu[seriesKey];
            if (data) { document.getElementById('emu-car-count').value = data.cars !== undefined ? data.cars : ''; document.getElementById('emu-avg-cylinder-diameter').value = data.D_c_avg !== undefined ? data.D_c_avg : ''; document.getElementById('emu-avg-transmission-ratio').value = data.i_gp_avg !== undefined ? data.i_gp_avg : ''; document.getElementById('emu-avg-efficiency').value = data.eta_gp_avg !== undefined ? data.eta_gp_avg : ''; document.getElementById('emu-avg-cylinder-count').value = data.n_cyl_avg || '1'; document.getElementById('emu-brake-shoes-type').value = data.shoes || 'composite'; document.getElementById('emu-axle-count-per-car').value = data.axles_car !== undefined ? data.axles_car : '4'; document.getElementById('emu-weight-per-car').value = data.weight_car !== undefined ? data.weight_car : ''; const shoeSelect = document.getElementById('emu-brake-shoes-type'); if (shoeSelect) shoeSelect.dispatchEvent(new Event('change')); }
            updateTrainMassField();
        }
        function populateDmuFields() {
            if(!dmuSeriesSelect) return; const seriesKey = dmuSeriesSelect.value; const data = tractionData.dmu[seriesKey];
            if (data) { document.getElementById('dmu-car-count').value = data.cars !== undefined ? data.cars : ''; document.getElementById('dmu-avg-cylinder-diameter').value = data.D_c_avg !== undefined ? data.D_c_avg : ''; document.getElementById('dmu-avg-transmission-ratio').value = data.i_gp_avg !== undefined ? data.i_gp_avg : ''; document.getElementById('dmu-avg-efficiency').value = data.eta_gp_avg !== undefined ? data.eta_gp_avg : ''; document.getElementById('dmu-avg-cylinder-count').value = data.n_cyl_avg || '1'; document.getElementById('dmu-brake-shoes-type').value = data.shoes || 'composite'; document.getElementById('dmu-axle-count-per-car').value = data.axles_car !== undefined ? data.axles_car : '4'; document.getElementById('dmu-weight-per-car').value = data.weight_car !== undefined ? data.weight_car : ''; const shoeSelect = document.getElementById('dmu-brake-shoes-type'); if(shoeSelect) shoeSelect.dispatchEvent(new Event('change'));}
            updateTrainMassField();
        }
        function createWagonModule(id, selectedTypeKey = 'gondola_14') { const module = document.createElement('div'); module.classList.add('wagon-module'); module.id = `wagon-module-${id}`; let optionsHTML = ''; for (const key in wagonTypeData) { optionsHTML += `<option value="${key}" ${key === selectedTypeKey ? 'selected' : ''}>${wagonTypeData[key].name}</option>`; } const defaults = wagonTypeData[selectedTypeKey] || wagonTypeData['custom']; module.innerHTML = ` <button class="remove-wagon-btn" onclick="removeWagonModule(${id})" title="Видалити тип вагона">×</button> <h3>Вагон #${id}</h3> <div class="input-group"> <label for="wagon-type-select-${id}">Тип вагона:</label> <select id="wagon-type-select-${id}" onchange="updateWagonInputs(${id})">${optionsHTML}</select> <span class="input-hint">(Оберіть тип вагона зі списку)</span> </div> <div class="input-group"> <label for="wagon-count-${id}">Кількість (N):</label> <input type="number" id="wagon-count-${id}" min="0" step="1" value="1" required oninput="updateTrainMassField()"> <span class="input-hint">(Кількість вагонів даного типу)</span> </div> <div class="input-group"> <label for="cylinder-diameter-${id}">Діаметр ГЦ (<span class="abbreviation" title="Діаметр гальмівного циліндра">D_ц</span>):</label> <input type="number" id="cylinder-diameter-${id}" step="any" value="${defaults.diameter_in ?? ''}" required> <span class="unit">дюйм</span> <span class="input-hint">(Стандартні: 12", 14", 16")</span> </div> <div class="input-group"> <label for="transmission-ratio-${id}">Передаточне число (<span class="abbreviation" title="Передаточне число гальмівної передачі">i_гп</span>):</label> <input type="number" id="transmission-ratio-${id}" step="any" value="${defaults.i_gp ?? ''}" required> <span class="input-hint">(Типово: 5.5 - 7.2)</span> </div> <div class="input-group"> <label for="efficiency-${id}">ККД (<span class="abbreviation" title="ККД гальмівної передачі">η_гп</span>):</label> <input type="number" id="efficiency-${id}" step="0.01" min="0" max="1" value="${defaults.eta_gp ?? ''}" required> <span class="input-hint">(Типово: 0.84 - 0.88)</span> </div> <div class="input-group"> <label for="cylinder-count-${id}">К-сть циліндрів (<span class="abbreviation" title="Кількість гальмівних циліндрів на вагон">N_ц</span>):</label> <input type="number" id="cylinder-count-${id}" min="1" step="1" value="${defaults.n_cyl ?? 1}" required> <span class="input-hint">(Зазвичай 1-2)</span> </div> <div class="input-group"> <label for="brake-shoes-type-${id}">Тип колодок:</label> <select id="brake-shoes-type-${id}" data-selected-text="${defaults.shoes_type === 'composite' ? 'Композиційні' : 'Чавунні'}"> <option value="cast_iron" ${defaults.shoes_type === 'cast_iron' ? 'selected' : ''}>Чавунні</option> <option value="composite" ${defaults.shoes_type === 'composite' ? 'selected' : ''}>Композиційні</option> </select> <span class="input-hint">(Впливає на <span class="abbreviation" title="Коефіцієнт тертя">φ</span> та нагрів)</span> </div> <div class="input-group"> <label for="brake-shoes-count-${id}">К-ть колодок:</label> <input type="number" id="brake-shoes-count-${id}" min="4" max="8" step="4" value="${defaults.shoes_count ?? 4}" required> <span class="input-hint">(На вагон, зазвичай 4 або 8)</span> </div>`; const typeSelect = module.querySelector(`#wagon-type-select-${id}`); if (typeSelect && typeSelect.selectedIndex >= 0) { typeSelect.setAttribute('data-selected-text', typeSelect.options[typeSelect.selectedIndex].text); typeSelect.addEventListener('change', function() { this.setAttribute('data-selected-text', this.options[this.selectedIndex].text); updateTrainMassField(); }); } const shoeSelect = module.querySelector(`#brake-shoes-type-${id}`); if (shoeSelect && shoeSelect.selectedIndex >= 0) { shoeSelect.setAttribute('data-selected-text', shoeSelect.options[shoeSelect.selectedIndex].text); shoeSelect.addEventListener('change', function() { this.setAttribute('data-selected-text', this.options[this.selectedIndex].text); }); } return module; }
        function updateWagonInputs(id) { const selectElement = document.getElementById(`wagon-type-select-${id}`); if (!selectElement) return; const selectedKey = selectElement.value; const data = wagonTypeData[selectedKey] || wagonTypeData['custom']; const setInputIfEmptyOrNotCustom = (inputId, value) => { const input = document.getElementById(inputId); if (input && (selectedKey !== 'custom' || input.value === '')) input.value = value ?? ''; }; setInputIfEmptyOrNotCustom(`cylinder-diameter-${id}`, data.diameter_in); setInputIfEmptyOrNotCustom(`transmission-ratio-${id}`, data.i_gp); setInputIfEmptyOrNotCustom(`efficiency-${id}`, data.eta_gp); setInputIfEmptyOrNotCustom(`cylinder-count-${id}`, data.n_cyl); setInputIfEmptyOrNotCustom(`brake-shoes-count-${id}`, data.shoes_count); const shoesTypeInput = document.getElementById(`brake-shoes-type-${id}`); if (shoesTypeInput) { shoesTypeInput.value = data.shoes_type ?? 'cast_iron'; shoesTypeInput.dispatchEvent(new Event('change')); } if (selectElement.selectedIndex >= 0) { selectElement.setAttribute('data-selected-text', selectElement.options[selectElement.selectedIndex].text); } resetResultsAndCharts(); updateTrainMassField(); }
        function removeWagonModule(id) { const module = document.getElementById(`wagon-module-${id}`); if (module) { module.style.animation = 'fadeOut var(--animation-speed) ease forwards'; setTimeout(() => { module.remove(); resetResultsAndCharts(); updateTrainMassField(); }, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--animation-speed') || '0.3') * 1000); } }
        function addInitialData() { if (!wagonModulesContainerDiv) { console.warn("Wagon container not found for addInitialData"); return; } wagonModulesContainerDiv.innerHTML = ''; wagonCounter = 0; wagonCounter++; wagonModulesContainerDiv.appendChild(createWagonModule(wagonCounter, 'gondola_14')); const firstCountInput = document.getElementById(`wagon-count-${wagonCounter}`); if (firstCountInput) { firstCountInput.value = 40; firstCountInput.addEventListener('input', updateTrainMassField); } wagonCounter++; wagonModulesContainerDiv.appendChild(createWagonModule(wagonCounter, 'tank_12')); const secondCountInput = document.getElementById(`wagon-count-${wagonCounter}`); if (secondCountInput) { secondCountInput.value = 20; secondCountInput.addEventListener('input', updateTrainMassField); } updateTrainMassField(); }
        function updateTrainMassField() {
            if (!trainMassInput || !tractionUnitTypeSelect) { console.warn("Required elements for mass update not found."); return;}
            let calculatedMass = 0;
            const selectedType = tractionUnitTypeSelect.value;

            if (selectedType === 'locomotive') {
                const locoSections = parseInt(document.getElementById('loco-sections')?.value) || 0;
                const weightPerSection = parseFloat(document.getElementById('loco-weight-per-section')?.value) || 0;
                calculatedMass += locoSections * weightPerSection;

                document.querySelectorAll('.wagon-module').forEach(module => {
                    const id = module.id.split('-').pop();
                    const count = parseInt(document.getElementById(`wagon-count-${id}`)?.value) || 0;
                    const wagonKey = document.getElementById(`wagon-type-select-${id}`)?.value;
                    const wagonData = wagonTypeData[wagonKey];
                    const wagonWeight = wagonData?.weight || 22; // Default weight if not in data
                    calculatedMass += count * wagonWeight;
                });
            } else if (selectedType === 'emu') {
                const carCount = parseInt(document.getElementById('emu-car-count')?.value) || 0;
                const weightPerCar = parseFloat(document.getElementById('emu-weight-per-car')?.value) || 0;
                calculatedMass = carCount * weightPerCar;
            } else if (selectedType === 'dmu') {
                const carCount = parseInt(document.getElementById('dmu-car-count')?.value) || 0;
                const weightPerCar = parseFloat(document.getElementById('dmu-weight-per-car')?.value) || 0;
                calculatedMass = carCount * weightPerCar;
            }

            if (calculatedMass > 0) {
                trainMassInput.value = calculatedMass.toFixed(0);
            } else if (trainMassInput.value === "" || parseFloat(trainMassInput.value) === 0) {
                 // trainMassInput.value = '0'; // Or some other default
                 // Якщо маса = 0, можливо, варто показати 0, а не залишати порожнім
                 trainMassInput.value = '0';
            }
        }
        function highlightElement(element) { if (!element || typeof element !== 'object' || typeof element.classList === 'undefined') { console.warn("highlightElement: Invalid element:", element); return; } if (!document.body.contains(element)) { console.warn("highlightElement: Element not in DOM:", element); return; } try { if (element.classList.contains('highlight')) element.classList.remove('highlight'); void element.offsetWidth; element.classList.add('highlight'); setTimeout(() => { if (element && typeof element.classList !== 'undefined' && element.classList.contains('highlight')) element.classList.remove('highlight'); }, 1000); } catch (e) { console.error("Error highlighting:", e, "on element:", element); } }
        function resetResultsAndCharts() {
            const resultsTbody = document.getElementById('results-tbody'); if (resultsTbody) resultsTbody.innerHTML = '';
            if(totalPressureDisplay) { totalPressureDisplay.textContent = '0.00'; totalPressureDisplay.classList.remove('highlight');}
            if(specificPressureDisplay) specificPressureDisplay.textContent = '0.000';
            if(brakingDistanceDisplay) brakingDistanceDisplay.textContent = '0';
            if(brakingDecelerationDisplay) brakingDecelerationDisplay.textContent = '0.00';
            if(brakingTimeDisplay) brakingTimeDisplay.textContent = '0.0';
            if(frictionCoefficientDisplay) frictionCoefficientDisplay.textContent = '0.00';
            if(brakeEfficiencyDisplay) brakeEfficiencyDisplay.textContent = '0.00';
            if(maxTemperatureDisplay) maxTemperatureDisplay.textContent = '0';
            if(cooledTemperatureDisplay) cooledTemperatureDisplay.textContent = '0';
            const coolingTimeEl = document.getElementById('cooling-time');
            if(cooledTimeLabelDisplay && coolingTimeEl) cooledTimeLabelDisplay.textContent = coolingTimeEl.value ?? '60';
            if(coolingToSafeDisplay) coolingToSafeDisplay.textContent = '0';
            if(actualCoolingCoeffDisplay) actualCoolingCoeffDisplay.textContent = '0.00';
            if(bdModalDistanceDisplay) bdModalDistanceDisplay.textContent = '0';
            if(bdModalDecelerationDisplay) bdModalDecelerationDisplay.textContent = '0.00';
            if(bdModalTimeDisplay) bdModalTimeDisplay.textContent = '0.0';
            document.querySelectorAll('.advanced-result-item, #total-pressure').forEach(el => el.classList.remove('highlight'));
            if(reportContentDiv) reportContentDiv.innerHTML = 'Натисніть "Сформувати звіт" після розрахунку.';
            if(reportPrintAreaDiv) reportPrintAreaDiv.innerHTML = '';
            if(temperatureWarningDiv) temperatureWarningDiv.style.display = 'none';
            chartData = null; bdModalContext.brakingProcessTimeData = []; bdModalContext.brakingProcessSpeedData = []; bdModalContext.brakingDependencyXData = []; bdModalContext.brakingDependencyYData = [];
            if (pressurePieChart) { pressurePieChart.destroy(); pressurePieChart = null; }
            if (pressureBarChart) { pressureBarChart.destroy(); pressureBarChart = null; }
            if (temperatureChart) { temperatureChart.destroy(); temperatureChart = null; }
            if (brakingProcessChart) { brakingProcessChart.destroy(); brakingProcessChart = null; }
            if (brakingDependencyChart) { brakingDependencyChart.destroy(); brakingDependencyChart = null; }
            calculationSuccess = false; temperatureCalculationDone = false;
            console.log("Results and charts have been reset.");
        }
        function calculateAll() {
            console.log("--- calculateAll CALLED ---");
            resetResultsAndCharts();
            let commonInputError = false;
            const validateAndGet = (id, isFloat = true, allowZeroOrNegative = false, errorMessage = "Некоректне значення", contextElement = document) => {
                const selector = `#${id}`; const el = contextElement.querySelector(selector);
                if (!el) { console.error(`Element with selector '${selector}' not found in context:`, contextElement); commonInputError = true; return NaN; }
                const value = isFloat ? parseFloat(el.value) : parseInt(el.value); el.style.borderColor = ''; let isInvalid = isNaN(value);
                if (id === 'track-gradient') { if(isNaN(value)) isInvalid = true; }
                else if (!allowZeroOrNegative && value <= 0) { isInvalid = true; }
                else if (allowZeroOrNegative && value < 0) { isInvalid = true;}
                if ((id === 'loco-efficiency' || id === 'emu-avg-efficiency' || id === 'dmu-avg-efficiency' || id.startsWith('efficiency-')) && (value < 0 || value > 1) ) { errorMessage = "ККД має бути в межах 0-1"; isInvalid = true; }
                if (isInvalid) { const labelElement = el.closest('.input-group')?.querySelector('label'); const fieldName = labelElement?.textContent?.replace(/:$/, '') || id; showFloatingMessage(`${errorMessage} для поля "${fieldName}".`, 4000, true); el.style.borderColor = 'var(--error-color)'; commonInputError = true; return NaN; }
                return value;
            };

            const pressureMpa = validateAndGet('pressure-mpa', true, false, "Тиск має бути > 0");
            let trainMass = validateAndGet('train-mass', true, false, "Маса поїзда має бути > 0");
            const maxSpeed = validateAndGet('max-speed', true, false, "Швидкість має бути > 0");
            const trackCondition = trackConditionSelect.value; const trackGradient = validateAndGet('track-gradient', true, true, "Некоректний ухил"); const brakeMode = brakeModeSelect.value;
            if (commonInputError) { if(totalPressureDisplay) totalPressureDisplay.textContent = 'ПОМИЛКА ВХІДНИХ'; return; }

            const pressurePa = pressureMpa * 1e6; const resultsTbody = document.getElementById('results-tbody'); let totalTrainPressureTc = 0; let totalAxlesForTempCalc = 0; let effectiveTrainMassForCalc = trainMass;
            currentChartData = { labels: [], totalPressuresTc: [], perWagonPressuresTc: [], shoesTypes: [], wagonCounts: [] };
            const selectedTractionType = tractionUnitTypeSelect.value;

            if (selectedTractionType === 'locomotive') {
                const seriesKey = locoSeriesSelect.value; const data = tractionData.locomotive[seriesKey]; let params = (seriesKey === 'custom_loco' || !data) ? { name: "Інший локомотив", D_c: validateAndGet('loco-cylinder-diameter', true, false, "Діам. ГЦ локо"), i_gp: validateAndGet('loco-transmission-ratio', true, false, "Пер. число локо"), eta_gp: validateAndGet('loco-efficiency', true, false, "ККД локо"), n_cyl: validateAndGet('loco-cylinder-count', false, false, "К-ть ГЦ локо"), sections: validateAndGet('loco-sections', false, false, "К-ть секцій локо"), shoes: document.getElementById('loco-brake-shoes-type').value, axles: validateAndGet('loco-axle-count', false, false, "К-ть осей локо") } : { ...data, name: data.name || seriesKey };
                if (commonInputError) { if(totalPressureDisplay) totalPressureDisplay.textContent = 'ПОМИЛКА ЛОКО'; return; }
                const sections = params.sections || 1; const diameterM = params.D_c * 0.0254; const areaM2 = PI * (diameterM ** 2) / 4; const forcePerCylinderN = pressurePa * areaM2; const pressurePerSectionN = forcePerCylinderN * params.i_gp * params.eta_gp * params.n_cyl; const totalLocoPressureN = pressurePerSectionN * sections; const totalLocoPressureTc = totalLocoPressureN / N_TO_TC_FACTOR;
                totalTrainPressureTc += totalLocoPressureTc; totalAxlesForTempCalc += (params.axles || 0) * sections;
                const row = resultsTbody.insertRow(); row.innerHTML = `<td>Локомотив (${params.name}, ${sections}с.)</td><td>${sections}</td><td>${diameterM.toFixed(4)}</td><td><span class="result-value">${areaM2.toFixed(4)}</span></td><td>${params.i_gp.toFixed(2)}</td><td>${params.eta_gp.toFixed(2)}</td><td>${params.n_cyl}</td><td><span class="result-value">${pressurePerSectionN.toFixed(0)}</span></td><td><span class="result-value">${(pressurePerSectionN / N_TO_TC_FACTOR).toFixed(2)}</span></td><td><span class="result-value">${totalLocoPressureTc.toFixed(2)}</span></td>`;
                currentChartData.labels.push(`Локомотив: ${params.name}`); currentChartData.totalPressuresTc.push(totalLocoPressureTc); currentChartData.perWagonPressuresTc.push(totalLocoPressureTc / sections); currentChartData.shoesTypes.push(params.shoes); currentChartData.wagonCounts.push(sections);
            } else if (selectedTractionType === 'emu' || selectedTractionType === 'dmu') {
                const seriesKey = document.getElementById(`${selectedTractionType}-series`).value; const data = tractionData[selectedTractionType][seriesKey]; let carCount = validateAndGet(`${selectedTractionType}-car-count`, false, false, `К-ть вагонів ${selectedTractionType.toUpperCase()}`); let params = (seriesKey === `custom_${selectedTractionType}` || !data) ? { name: `Інший ${selectedTractionType.toUpperCase()}`, D_c_avg: validateAndGet(`${selectedTractionType}-avg-cylinder-diameter`, true, false, `Сер. діам. ГЦ`), i_gp_avg: validateAndGet(`${selectedTractionType}-avg-transmission-ratio`, true, false, `Сер. пер. число`), eta_gp_avg: validateAndGet(`${selectedTractionType}-avg-efficiency`, true, false, `Сер. ККД`), n_cyl_avg: validateAndGet(`${selectedTractionType}-avg-cylinder-count`, false, false, `Сер. к-ть ГЦ`), shoes: document.getElementById(`${selectedTractionType}-brake-shoes-type`).value, axles_car: validateAndGet(`${selectedTractionType}-axle-count-per-car`, false, false, `К-ть осей/вагон`) } : { ...data, name: data.name || seriesKey };
                if (commonInputError) { if(totalPressureDisplay) totalPressureDisplay.textContent = `ПОМИЛКА ${selectedTractionType.toUpperCase()}`; return; }
                const diameterM = params.D_c_avg * 0.0254; const areaM2 = PI * (diameterM ** 2) / 4; const forcePerCylinderN = pressurePa * areaM2; const pressurePerCarN = forcePerCylinderN * params.i_gp_avg * params.eta_gp_avg * params.n_cyl_avg; const totalMvpsPressureN = pressurePerCarN * carCount; const totalMvpsPressureTc = totalMvpsPressureN / N_TO_TC_FACTOR;
                totalTrainPressureTc = totalMvpsPressureTc; totalAxlesForTempCalc = (params.axles_car || 0) * carCount; effectiveTrainMassForCalc = trainMass;
                const row = resultsTbody.insertRow(); row.innerHTML = `<td>${params.name} (${carCount} ваг.)</td><td>${carCount}</td><td>${diameterM.toFixed(4)} (сер.)</td><td><span class="result-value">${areaM2.toFixed(4)}</span> (сер.)</td><td>${params.i_gp_avg.toFixed(2)} (сер.)</td><td>${params.eta_gp_avg.toFixed(2)} (сер.)</td><td>${params.n_cyl_avg} (сер.)</td><td><span class="result-value">${pressurePerCarN.toFixed(0)}</span></td><td><span class="result-value">${(pressurePerCarN / N_TO_TC_FACTOR).toFixed(2)}</span></td><td><span class="result-value">${totalMvpsPressureTc.toFixed(2)}</span></td>`;
                currentChartData.labels.push(params.name); currentChartData.totalPressuresTc.push(totalMvpsPressureTc); currentChartData.perWagonPressuresTc.push(pressurePerCarN / N_TO_TC_FACTOR); currentChartData.shoesTypes.push(params.shoes); currentChartData.wagonCounts.push(carCount);
            }

            if (selectedTractionType === 'locomotive') {
                const modules = document.querySelectorAll('.wagon-module'); let wagonErrorInLoop = false;
                modules.forEach(module => {
                    if (wagonErrorInLoop || commonInputError) return; const id = module.id.split('-').pop(); const count = validateAndGet(`wagon-count-${id}`, false, true, "К-ть вагонів", module); if (count === 0) return; if (isNaN(count)) { wagonErrorInLoop = true; return; } const diameterIn = validateAndGet(`cylinder-diameter-${id}`, true, false, "Діам. ГЦ вагона", module); const i_gp = validateAndGet(`transmission-ratio-${id}`, true, false, "Пер. число вагона", module); const eta_gp = validateAndGet(`efficiency-${id}`, true, false, "ККД вагона", module); const n_cyl = validateAndGet(`cylinder-count-${id}`, false, false, "К-ть ГЦ вагона", module); const shoesType = document.getElementById(`brake-shoes-type-${id}`).value; const type = document.getElementById(`wagon-type-select-${id}`).options[document.getElementById(`wagon-type-select-${id}`).selectedIndex].text; if (eta_gp > 1 || eta_gp < 0) {showFloatingMessage(`ККД вагона ${type} має бути між 0 та 1`, 4000, true); wagonErrorInLoop = true;} if (wagonErrorInLoop || commonInputError) return;
                    const diameterM = diameterIn * 0.0254; const areaM2 = PI * (diameterM ** 2) / 4; const forcePerCylinderN = pressurePa * areaM2; const pressurePerWagonN = forcePerCylinderN * i_gp * eta_gp * n_cyl; const pressurePerWagonTc = pressurePerWagonN / N_TO_TC_FACTOR; const totalPressureTypeTc = pressurePerWagonTc * count; totalTrainPressureTc += totalPressureTypeTc; const axlesPerWagonForTemp = parseInt(document.getElementById('axles-per-wagon').value) || 4; totalAxlesForTempCalc += axlesPerWagonForTemp * count; const row = resultsTbody.insertRow(); row.innerHTML = `<td>${type}</td><td>${count}</td><td>${diameterM.toFixed(4)}</td><td><span class="result-value">${areaM2.toFixed(4)}</span></td><td>${i_gp.toFixed(2)}</td><td>${eta_gp.toFixed(2)}</td><td>${n_cyl}</td><td><span class="result-value">${pressurePerWagonN.toFixed(0)}</span></td><td><span class="result-value">${pressurePerWagonTc.toFixed(2)}</span></td><td><span class="result-value">${totalPressureTypeTc.toFixed(2)}</span></td>`;
                    row.querySelectorAll('.result-value').forEach(highlightElement); currentChartData.labels.push(type); currentChartData.totalPressuresTc.push(totalPressureTypeTc); currentChartData.perWagonPressuresTc.push(pressurePerWagonTc); currentChartData.shoesTypes.push(shoesType); currentChartData.wagonCounts.push(count);
                });
                if (wagonErrorInLoop || commonInputError) { if(totalPressureDisplay) totalPressureDisplay.textContent = 'ПОМИЛКА ВАГОНА'; return; }
            }
             if (commonInputError) { return; }

            totalPressureDisplay.textContent = totalTrainPressureTc.toFixed(2);
            highlightElement(totalPressureDisplay);
            document.body.dataset.totalBrakedAxles = totalAxlesForTempCalc;

            try {
                calculateAdvancedResults(totalTrainPressureTc, effectiveTrainMassForCalc, maxSpeed, trackCondition, trackGradient, brakeMode, currentChartData);
            } catch (error) {
                console.error("Error during advanced calculations caught in calculateAll (final):", error);
                if(totalPressureDisplay) totalPressureDisplay.textContent = 'ПОМИЛКА РОЗШ.';
                calculationSuccess = false;
                return;
            }
            chartData = currentChartData; calculationSuccess = true;
            console.log("Calculation successful, calculationSuccess =", calculationSuccess);
            if (reportContentDiv && reportContentDiv.innerHTML.trim() !== 'Натисніть "Сформувати звіт" після розрахунку.') { generateReport(); }
            console.log("--- calculateAll FINISHED ---");
        }
        function checkSafetyStandards(specificPressure, brakingDistance, maxSpeed) { const minSpecificPressure = 0.33; const maxBrakingDistance = { 60: 800, 70: 1000, 80: 1200, 90: 1500 }; const speedKeys = Object.keys(maxBrakingDistance).map(Number).sort((a,b) => a-b); let applicableSpeedKey = speedKeys[speedKeys.length - 1]; for (const key of speedKeys) { if (maxSpeed <= key) { applicableSpeedKey = key; break; } } const allowedDistance = maxBrakingDistance[applicableSpeedKey] || 2000; document.querySelectorAll('.floating-message.spec-pressure-warning').forEach(el => el.remove()); document.querySelectorAll('.floating-message.brake-dist-warning').forEach(el => el.remove()); if (specificPressure < minSpecificPressure) { const specPressureMsgEl = showFloatingMessage(`УВАГА: Питомий натиск (${specificPressure.toFixed(3)} тс/т) < реком. (${minSpecificPressure} тс/т).`, 6000, true); if (specPressureMsgEl) specPressureMsgEl.classList.add('spec-pressure-warning');} if (isFinite(brakingDistance) && brakingDistance > 0 && brakingDistance > allowedDistance) { const brakeDistMsgEl = showFloatingMessage(`УВАГА: Гальм. шлях (${Math.round(brakingDistance)} м) > допуст. (~${allowedDistance} м для ${maxSpeed} км/год).`, 6000, true); if(brakeDistMsgEl) brakeDistMsgEl.classList.add('brake-dist-warning');} }
        function calculateAdvancedResults(totalPressureTc, trainMass, maxSpeed, trackCondition, trackGradient, brakeMode, chartDataForAdvanced) {
            if (trainMass <= 0) { showFloatingMessage("Маса поїзда нульова або від'ємна, розширені розрахунки неможливі.", 4000, true); ['specific-pressure', 'braking-distance', 'braking-deceleration', 'braking-time', 'friction-coefficient', 'brake-efficiency'].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = (id === 'specific-pressure') ? '0.000' : ((id === 'braking-distance' || id === 'braking-time') ? '0' : '0.00'); }); return; }
            if (!specificPressureDisplay || !brakingDistanceDisplay || !brakingDecelerationDisplay || !brakingTimeDisplay || !frictionCoefficientDisplay || !brakeEfficiencyDisplay) { console.error("DOM elements for advanced results not found!"); showFloatingMessage("Помилка інтерфейсу: Не знайдено поля для розширених результатів.", 6000, true); return; }
            try {
                const specificPressure = totalPressureTc > 0 && trainMass > 0 ? totalPressureTc / trainMass : 0;
                specificPressureDisplay.textContent = specificPressure.toFixed(3);
                let weightedFrictionSum = 0; let totalWagonCountForFriction = 0; if (chartDataForAdvanced.shoesTypes.length > 0) { chartDataForAdvanced.shoesTypes.forEach((shoesType, index) => { const count = chartDataForAdvanced.wagonCounts[index] || 0; const friction = frictionCoefficients[shoesType]?.[trackCondition] ?? 0.1; weightedFrictionSum += friction * count; totalWagonCountForFriction += count; }); } const avgFrictionCoefficient = totalWagonCountForFriction > 0 ? weightedFrictionSum / totalWagonCountForFriction : (frictionCoefficients.cast_iron[trackCondition] || 0.1);
                frictionCoefficientDisplay.textContent = avgFrictionCoefficient.toFixed(2);
                const trackEff = trackEfficiency[trackCondition] ?? 1.0; const brakeModeEff = brakeModeEfficiency[brakeMode] ?? 1.0; const totalEfficiency = trackEff * brakeModeEff;
                brakeEfficiencyDisplay.textContent = totalEfficiency.toFixed(2);
                const gradientFactor = (trackGradient / 1000); const totalBrakingForceN = totalPressureTc * N_TO_TC_FACTOR * avgFrictionCoefficient * totalEfficiency; const gradientForceN = trainMass * 1000 * G * gradientFactor; const netBrakingForceN = totalBrakingForceN - gradientForceN; const trainMassKg = trainMass * 1000; let deceleration = 0; if (trainMassKg > 0) { deceleration = netBrakingForceN / trainMassKg; } let decelerationDisplay = deceleration;
                if (deceleration <= 0) { console.warn("Net deceleration is zero or negative."); deceleration = 0.00001; if (decelerationDisplay <= 0 && !document.querySelector('.floating-message.deceleration-warning')) { showFloatingMessage("Увага: Розрахункове уповільнення ≤ 0. Гальмування недостатнє або відсутнє!", 6000, true).classList.add('deceleration-warning'); } } else { const existingWarning = document.querySelector('.floating-message.deceleration-warning'); if (existingWarning) existingWarning.remove(); }
                brakingDecelerationDisplay.textContent = decelerationDisplay.toFixed(2);
                const speedMs = maxSpeed / 3.6; let brakingTime = Infinity; let brakingDistance = Infinity; if (deceleration > 0.00001) { brakingTime = speedMs / deceleration; brakingDistance = (speedMs ** 2) / (2 * deceleration); }
                brakingTimeDisplay.textContent = isFinite(brakingTime) ? brakingTime.toFixed(1) : "∞";
                brakingDistanceDisplay.textContent = isFinite(brakingDistance) ? Math.round(brakingDistance) : "∞";
                const highlightParentItem = (elementId) => { const element = document.getElementById(elementId); const parentItem = element ? element.closest('.advanced-result-item') : null; if (parentItem) { highlightElement(parentItem); } };
                highlightParentItem('specific-pressure'); highlightParentItem('braking-distance'); highlightParentItem('braking-deceleration'); highlightParentItem('braking-time'); highlightParentItem('friction-coefficient'); highlightParentItem('brake-efficiency');
                if (typeof checkSafetyStandards === 'function') { const specificPressureValue = parseFloat(specificPressureDisplay.textContent); const brakingDistanceValue = brakingDistanceDisplay.textContent === "∞" ? Infinity : parseFloat(brakingDistanceDisplay.textContent); const maxSpeedValue = parseFloat(maxSpeedInput.value); if (!isNaN(specificPressureValue) && !isNaN(maxSpeedValue)) { checkSafetyStandards(specificPressureValue, brakingDistanceValue, maxSpeedValue); } else { console.warn("Недійсні значення для checkSafetyStandards:", specificPressureValue, brakingDistanceValue, maxSpeedValue); } }
            } catch (error) { console.error("Помилка під час виконання розширених розрахунків (внутрішня):", error); showFloatingMessage("Помилка обробки розширених параметрів: " + error.message, 6000, true); if(specificPressureDisplay) specificPressureDisplay.textContent = 'Error'; if(brakingDistanceDisplay) brakingDistanceDisplay.textContent = 'Error'; if(brakingDecelerationDisplay) brakingDecelerationDisplay.textContent = 'Error'; if(brakingTimeDisplay) brakingTimeDisplay.textContent = 'Error'; if(frictionCoefficientDisplay) frictionCoefficientDisplay.textContent = 'Error'; if(brakeEfficiencyDisplay) brakeEfficiencyDisplay.textContent = 'Error'; throw error; }
        }
        function calculateTemperature() {
            temperatureCalculationDone = false; if (!calculationSuccess) { showFloatingMessage("Спочатку виконайте основний розрахунок.", 4000, true); return; }
            const trainMassTonnes = parseFloat(trainMassInput.value); const maxSpeedKmh = parseFloat(maxSpeedInput.value);
            const totalBrakedAxles = parseInt(document.body.dataset.totalBrakedAxles) || 0;
            if (isNaN(trainMassTonnes) || trainMassTonnes <= 0 || isNaN(maxSpeedKmh) || maxSpeedKmh <= 0) { showFloatingMessage("Перевірте масу та швидкість.", 4000, true); return; }
            if (totalBrakedAxles <= 0) { showFloatingMessage("Загальна кількість гальмівних осей для розрахунку температури ≤ 0. Перевірте дані тяги/вагонів.", 6000, true); return; }
            const initialTemp = parseFloat(document.getElementById('initial-temperature').value); const ambientTemp = parseFloat(document.getElementById('ambient-temperature').value); const effectiveMassKg = parseFloat(document.getElementById('effective-wheelset-mass').value); const specificHeatJkgK = parseFloat(document.getElementById('wheel-specific-heat').value); const baseCoolingCoeffPerMin = parseFloat(document.getElementById('cooling-coefficient').value); const coolingTimeMins = parseFloat(document.getElementById('cooling-time').value); const axlesPerWagonInput = document.getElementById('axles-per-wagon'); const axlesPerWagon = parseInt(axlesPerWagonInput?.value) || 4;
            let isValid = true; const validateTempInput = (value, _elementId, message, checkPositive = true) => { if (isNaN(value) || (checkPositive && value <= 0) || (!checkPositive && isNaN(value)) ) { showFloatingMessage(message, 4000, true); return false; } return true; }; isValid = validateTempInput(initialTemp, 'initial-temperature', "Кор. початкова температура.", false) && isValid; isValid = validateTempInput(ambientTemp, 'ambient-temperature', "Кор. температура середовища.", false) && isValid; isValid = validateTempInput(effectiveMassKg, 'effective-wheelset-mass', "Кор. ефект. маса (> 0).") && isValid; isValid = validateTempInput(specificHeatJkgK, 'wheel-specific-heat', "Кор. пит. теплоємність (> 0).") && isValid; isValid = validateTempInput(baseCoolingCoeffPerMin, 'cooling-coefficient', "Кор. базовий коеф. охолодження (> 0).") && isValid; isValid = validateTempInput(coolingTimeMins, 'cooling-time', "Кор. час охолодження (>= 0).", false) && isValid; if (!isValid) return;
            const trackCondition = trackConditionSelect.value; let coolingModifier = 1.0; if (trackCondition === 'wet') { coolingModifier = 1.15; } else if (trackCondition === 'contaminated') { coolingModifier = 0.9; } const actualCoolingCoeff = baseCoolingCoeffPerMin * coolingModifier;
            const trainMassKg = trainMassTonnes * 1000; const speedMps = maxSpeedKmh / 3.6; const totalKineticEnergy = 0.5 * trainMassKg * (speedMps ** 2);
            const energyPerAxle = totalKineticEnergy / totalBrakedAxles; const deltaT = energyPerAxle / (effectiveMassKg * specificHeatJkgK); const maxTemp = initialTemp + deltaT;
            const currentMaxTempForCooling = Math.max(maxTemp, ambientTemp); const cooledTemp = ambientTemp + (currentMaxTempForCooling - ambientTemp) * Math.exp(-actualCoolingCoeff * coolingTimeMins); let coolingToSafeMins = 0; const safeTemp = 100; if (maxTemp > safeTemp) { if (safeTemp > ambientTemp && maxTemp > ambientTemp && actualCoolingCoeff > 0) { coolingToSafeMins = Math.log((maxTemp - ambientTemp) / (safeTemp - ambientTemp)) / actualCoolingCoeff; if (!isFinite(coolingToSafeMins) || coolingToSafeMins < 0) coolingToSafeMins = Infinity; } else if (maxTemp <= ambientTemp && safeTemp < ambientTemp) { coolingToSafeMins = 0; } else { coolingToSafeMins = Infinity; } } else { coolingToSafeMins = 0; }
            maxTemperatureDisplay.textContent = Math.round(maxTemp); cooledTemperatureDisplay.textContent = Math.round(cooledTemp); cooledTimeLabelDisplay.textContent = coolingTimeMins; coolingToSafeDisplay.textContent = (coolingToSafeMins === Infinity) ? "∞" : (isFinite(coolingToSafeMins) && coolingToSafeMins >= 0 ? Math.round(coolingToSafeMins) : "N/A"); actualCoolingCoeffDisplay.textContent = actualCoolingCoeff.toFixed(3);
            const highlightTempParentItem = (elementId) => { const element = document.getElementById(elementId); const parentItem = element ? element.closest('.advanced-result-item') : null; if (parentItem) highlightElement(parentItem); };
            highlightTempParentItem('max-temperature'); highlightTempParentItem('cooled-temperature'); highlightTempParentItem('cooling-to-safe'); highlightTempParentItem('actual-cooling-coeff');
            const criticalTemp = 650; const warningTemp = 500; if(temperatureWarningDiv) {temperatureWarningDiv.className = ''; temperatureWarningDiv.style.display = 'none'; if (maxTemp > criticalTemp) { temperatureWarningDiv.textContent = `!!! УВАГА: Розрахункова Tmax (${Math.round(maxTemp)}°C) > ${criticalTemp}°C! РИЗИК ПОШКОДЖЕННЯ!`; temperatureWarningDiv.classList.add('error-level'); temperatureWarningDiv.style.display = 'block'; } else if (maxTemp > warningTemp) { temperatureWarningDiv.textContent = `ПОПЕРЕДЖЕННЯ: Висока Tmax (${Math.round(maxTemp)}°C). Можливий підвищений знос.`; temperatureWarningDiv.classList.add('warning-level'); temperatureWarningDiv.style.display = 'block'; }}
            renderTemperatureChart(maxTemp, ambientTemp, actualCoolingCoeff, coolingTimeMins); temperatureCalculationDone = true;
        }
        function createChartGradient(context, themeGradientPairs) { const chart = context.chart; const {ctx, chartArea} = chart; if (!chartArea) { const colorIndex = context.dataIndex % themeGradientPairs.length; return themeGradientPairs[colorIndex]?.start || '#cccccc'; } const gradientIndex = context.dataIndex % themeGradientPairs.length; const colors = themeGradientPairs[gradientIndex]; if (!colors) return '#cccccc'; let x0, y0, x1, y1; if (chart.config.type === 'bar' && chart.config.options.indexAxis === 'y') { x0 = chartArea.left; y0 = 0; x1 = chartArea.right; y1 = 0; } else { x0 = 0; y0 = chartArea.bottom; x1 = 0; y1 = chartArea.top; } const gradient = ctx.createLinearGradient(x0, y0, x1, y1); gradient.addColorStop(0, colors.start); gradient.addColorStop(1, colors.end); return gradient; }
        function renderCharts(pieCanvasId = 'pressurePieChartModal', barCanvasId = 'pressureBarChartModal') { if (!calculationSuccess || !chartData || chartData.labels.length === 0) { console.warn("RenderCharts: No data or calculation failed."); const modal = document.getElementById('pressure-charts-modal'); const placeholder = modal?.querySelector('.modal-placeholder-msg'); if (placeholder) placeholder.style.display = 'block'; const pieCanvasModal = document.getElementById(pieCanvasId); if(pieCanvasModal) pieCanvasModal.style.display = 'none'; const barCanvasModal = document.getElementById(barCanvasId); if(barCanvasModal) barCanvasModal.style.display = 'none'; return false; } const modal = document.getElementById('pressure-charts-modal'); const placeholder = modal?.querySelector('.modal-placeholder-msg'); if (placeholder) placeholder.style.display = 'none'; let pieCanvas = document.getElementById(pieCanvasId); if (!pieCanvas) { console.error(`Canvas with ID ${pieCanvasId} not found!`); return false; } pieCanvas.style.display = 'block'; let barCanvas = document.getElementById(barCanvasId); if (!barCanvas) { console.error(`Canvas with ID ${barCanvasId} not found!`); return false; } barCanvas.style.display = 'block'; const pieCtx = pieCanvas.getContext('2d'); const barCtx = barCanvas.getContext('2d'); if (pressurePieChart && pressurePieChart.canvas.id === pieCanvasId) pressurePieChart.destroy(); if (pressureBarChart && pressureBarChart.canvas.id === barCanvasId) pressureBarChart.destroy(); const themeColors = getThemeColors(); const tooltipBackgroundColor = themeColors.isLight ? 'rgba(255,255,255,0.95)' : themeColors.sectionBgAlt || 'rgba(26, 26, 46, 0.85)'; try { pressurePieChart = new Chart(pieCtx, { type: 'pie', data: { labels: chartData.labels, datasets: [{ label: 'Сумарний Натиск (тс)', data: chartData.totalPressuresTc.map(p => p.toFixed(2)), backgroundColor: context => createChartGradient(context, themeColors.gradients), borderWidth: 1, borderColor: themeColors.gridColor, hoverOffset: 15, hoverBorderColor: themeColors.textColor, hoverBorderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: themeColors.textColor, font: { size: 12 }, padding: 15, boxWidth: 15 } }, tooltip: { bodyFont: { size: 13 }, titleFont: { size: 14 }, titleColor: themeColors.textColor, bodyColor: themeColors.textColor, backgroundColor: tooltipBackgroundColor, borderColor: themeColors.gridColor, borderWidth: 1, callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; const value = parseFloat(context.raw || context.parsed); if (!isNaN(value)) label += value.toFixed(2) + ' тс'; const total = context.chart.data.datasets[0].data.reduce((a, b) => parseFloat(a) + parseFloat(b), 0); const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0; label += ` (${percentage}%)`; return label; } } }, title: { display: true, text: 'Розподіл Загального Натиску (тс)', color: themeColors.textColor, font: { size: 16, weight: 'bold' }, padding: { top: 10, bottom: 20 } } }, animation: { duration: 800, easing: 'easeInOutQuart' } } }); pressureBarChart = new Chart(barCtx, { type: 'bar', data: { labels: chartData.labels, datasets: [{ label: 'Натиск на 1 Вагон (тс)', data: chartData.perWagonPressuresTc.map(p => p.toFixed(2)), backgroundColor: context => createChartGradient(context, themeColors.gradients), borderWidth: 1, borderColor: themeColors.gridColor, hoverBorderColor: themeColors.textColor, hoverBorderWidth: 2, borderRadius: 3 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, title: { display: true, text: 'Натиск на 1 вагон (тс)', color: themeColors.textColor, font: {size: 13} }, ticks: { color: themeColors.textColor }, grid: { color: themeColors.gridColor, drawBorder: false } }, y: { ticks: { color: themeColors.textColor }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { bodyFont: { size: 13 }, titleFont: { size: 14 }, titleColor: themeColors.textColor, bodyColor: themeColors.textColor, backgroundColor: tooltipBackgroundColor, borderColor: themeColors.gridColor, borderWidth: 1, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; const value = parseFloat(context.raw || context.parsed.x); if (!isNaN(value)) label += value.toFixed(2) + ' тс'; return label; } } }, title: { display: true, text: 'Порівняння Натиску на Один Вагон (тс)', color: themeColors.textColor, font: { size: 16, weight: 'bold' }, padding: { top: 10, bottom: 20 } } }, animation: { duration: 800, easing: 'easeInOutQuart' } } }); } catch (error) { console.error("Error creating charts:", error); showFloatingMessage("Помилка при створенні графіків.", 5000, true); const modalPlaceholder = modal?.querySelector('.modal-placeholder-msg'); if (modalPlaceholder) modalPlaceholder.style.display = 'block'; if (pieCanvas) pieCanvas.style.display = 'none'; if (barCanvas) barCanvas.style.display = 'none'; return false; } return true; }
        function renderTemperatureChart(maxTemp = 20, ambientTemp = 20, coolingCoeffPerMin = 0.02, maxTimeMins = 60) { const canvas = document.getElementById('temperatureChart'); if (!canvas) return; const ctx = canvas.getContext('2d'); if (temperatureChart) { temperatureChart.destroy(); temperatureChart = null; } const dataPoints = 30; const validMaxTime = (isNaN(maxTimeMins) || maxTimeMins < 0) ? 60 : maxTimeMins; const timeStep = validMaxTime > 0 ? validMaxTime / (dataPoints - 1) : 1; const labels = Array.from({length: dataPoints}, (_, i) => (i * timeStep).toFixed(1)); const currentMaxTempForCooling = Math.max(maxTemp, ambientTemp); const data = labels.map(t => Math.max(ambientTemp, ambientTemp + (currentMaxTempForCooling - ambientTemp) * Math.exp(-coolingCoeffPerMin * parseFloat(t)))); const themeColors = getThemeColors(); const tooltipBackgroundColor = themeColors.isLight ? 'rgba(255,255,255,0.95)' : themeColors.sectionBgAlt || 'rgba(26, 26, 46, 0.85)'; const gradientPair = themeColors.gradients[3]; temperatureChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Температура колеса', data: data.map(temp => temp.toFixed(1)), borderColor: gradientPair.start, backgroundColor: gradientPair.start + '33', borderWidth: 2, fill: true, tension: 0.1, pointRadius: 2, pointHoverRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Час після гальмування (хв)', color: themeColors.textColor, font: { size: 12 } }, ticks: { color: themeColors.textColor, font: { size: 10 } }, grid: { color: themeColors.gridColor } }, y: { title: { display: true, text: 'Температура (°C)', color: themeColors.textColor, font: { size: 12 } }, suggestedMin: Math.floor(Math.min(ambientTemp, maxTemp) / 10) * 10 - 10, suggestedMax: Math.ceil(Math.max(ambientTemp + 20, maxTemp * 1.1) / 10) * 10, beginAtZero: false, ticks: { color: themeColors.textColor, font: { size: 10 } }, grid: { color: themeColors.gridColor } } }, plugins: { legend: { display: true, position: 'bottom', labels: { color: themeColors.textColor, font: { size: 11 }, boxWidth: 12, padding: 10 } }, tooltip: { titleColor: themeColors.textColor, bodyColor: themeColors.textColor, backgroundColor: tooltipBackgroundColor, borderColor: themeColors.gridColor, borderWidth: 1, callbacks: { label: function(context) { const tempValue = parseFloat(context.raw || context.parsed.y); return ` Температура: ${tempValue.toFixed(1)}°C`; } } }, title: { display: true, text: 'Профіль охолодження колісної пари', color: themeColors.textColor, font: { size: 15, weight: 'bold' }, padding: { top: 10, bottom: 15 } } }, interaction: { mode: 'index', intersect: false, }, animation: { duration: 500 } } }); }
        function renderBrakingProcessChart(timeData, speedData) { const canvas = document.getElementById('brakingProcessChart'); if (!canvas) { console.error("Braking process chart canvas not found!"); return; } const ctx = canvas.getContext('2d'); if (brakingProcessChart) { brakingProcessChart.destroy(); brakingProcessChart = null; } const themeColors = getThemeColors(); const tooltipBackgroundColor = themeColors.isLight ? 'rgba(255,255,255,0.95)' : themeColors.sectionBgAlt || 'rgba(26, 26, 46, 0.85)'; const gradientPair = themeColors.gradients[1]; if (!timeData || !speedData || timeData.length === 0 || speedData.length === 0) { console.warn("No data provided for braking process chart."); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = themeColors.textColorDarker || '#a0a0c0'; ctx.textAlign = 'center'; ctx.font = '12px Segoe UI'; ctx.fillText("Недостатньо даних для графіка.", canvas.width / 2, canvas.height / 2); return; } try { brakingProcessChart = new Chart(ctx, { type: 'line', data: { labels: timeData, datasets: [{ label: 'Швидкість', data: speedData, borderColor: gradientPair.start, backgroundColor: gradientPair.start + '33', borderWidth: 2, fill: true, tension: 0.1, pointRadius: 1, pointHoverRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Час (с)', color: themeColors.textColor, font: { size: 12 } }, ticks: { color: themeColors.textColor, font: { size: 10 } }, grid: { color: themeColors.gridColor } }, y: { title: { display: true, text: 'Швидкість (км/год)', color: themeColors.textColor, font: { size: 12 } }, beginAtZero: true, ticks: { color: themeColors.textColor, font: { size: 10 } }, grid: { color: themeColors.gridColor }, suggestedMax: Math.ceil((parseFloat(speedData[0] || '80') * 1.1) / 10) * 10 } }, plugins: { legend: { display: false }, tooltip: { titleColor: themeColors.textColor, bodyColor: themeColors.textColor, backgroundColor: tooltipBackgroundColor, borderColor: themeColors.gridColor, borderWidth: 1, callbacks: { label: function(context) { const speedValue = parseFloat(context.raw || context.parsed.y); return ` Швидкість: ${speedValue.toFixed(1)} км/год`; }, title: function(context) { return `Час: ${context[0].label} с`; } } }, title: { display: true, text: 'Процес гальмування (Швидкість від часу)', color: themeColors.textColor, font: { size: 15, weight: 'bold' }, padding: { top: 10, bottom: 15 } } }, interaction: { mode: 'index', intersect: false }, animation: { duration: 300 } } }); } catch (error) { console.error("Error creating braking process chart:", error); showFloatingMessage("Помилка побудови графіка гальмування.", 5000, true); } }
        function renderBrakingDependencyChart(xData, yData, xAxisLabel, yAxisLabel, chartTitle) { const canvas = document.getElementById('brakingDependencyChart'); if (!canvas) { console.error("Braking dependency chart canvas not found!"); return; } const ctx = canvas.getContext('2d'); if (brakingDependencyChart) { brakingDependencyChart.destroy(); brakingDependencyChart = null; } const themeColors = getThemeColors(); const tooltipBackgroundColor = themeColors.isLight ? 'rgba(255,255,255,0.95)' : themeColors.sectionBgAlt || 'rgba(26, 26, 46, 0.85)'; const gradientPair = themeColors.gradients[2]; if (!xData || !yData || xData.length === 0 || yData.length === 0) { console.warn("No data for braking dependency chart."); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = themeColors.textColorDarker || '#a0a0c0'; ctx.textAlign = 'center'; ctx.font = '12px Segoe UI'; ctx.fillText("Недостатньо даних для графіка залежності.", canvas.width / 2, canvas.height / 2); return; } const processedYData = yData.map(val => isFinite(val) ? val : null); try { brakingDependencyChart = new Chart(ctx, { type: 'line', data: { labels: xData, datasets: [{ label: 'Гальмівний шлях', data: processedYData, borderColor: gradientPair.start, backgroundColor: gradientPair.start + '33', borderWidth: 2, fill: false, tension: 0.2, pointRadius: 2, pointHoverRadius: 5, spanGaps: false }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: xAxisLabel, color: themeColors.textColor, font: { size: 12 } }, ticks: { color: themeColors.textColor, font: { size: 10 } }, grid: { color: themeColors.gridColor } }, y: { title: { display: true, text: yAxisLabel, color: themeColors.textColor, font: { size: 12 } }, beginAtZero: true, ticks: { color: themeColors.textColor, font: { size: 10 } }, grid: { color: themeColors.gridColor }, suggestedMax: Math.max(100, ...processedYData.filter(y => y !== null && isFinite(y))) * 1.1 || 1000 } }, plugins: { legend: { display: false }, tooltip: { titleColor: themeColors.textColor, bodyColor: themeColors.textColor, backgroundColor: tooltipBackgroundColor, borderColor: themeColors.gridColor, borderWidth: 1, callbacks: { label: function(context) { const distValue = parseFloat(context.raw || context.parsed.y); return isNaN(distValue) ? ' Шлях: ∞ м' : ` Шлях: ${Math.round(distValue)} м`; }, title: function(context) { return `${xAxisLabel}: ${context[0].label}`; } } }, title: { display: true, text: chartTitle, color: themeColors.textColor, font: { size: 15, weight: 'bold' }, padding: { top: 10, bottom: 15 } } }, interaction: { mode: 'index', intersect: false }, animation: { duration: 300 } } }); } catch (error) { console.error("Error creating braking dependency chart:", error); showFloatingMessage("Помилка побудови графіка залежності.", 5000, true); } }
        function recalculateBrakingDistanceInModal() { try { const speedKmh = parseFloat(document.getElementById('bd-modal-speed-number').value); const gradientPermille = parseFloat(document.getElementById('bd-modal-gradient-number').value); if (isNaN(speedKmh) || speedKmh <= 0 || isNaN(gradientPermille)) { showFloatingMessage("Введіть коректні значення швидкості та ухилу.", 4000, true); return; } const { massTonnes, kPoizdaTc, avgFriction, totalEfficiency } = bdModalContext; if (massTonnes <= 0 || isNaN(kPoizdaTc) || isNaN(avgFriction) || isNaN(totalEfficiency)) { showFloatingMessage("Помилка: Недійсні контекстні дані поїзда.", 5000, true); return; } const calculateS_local = (v_kmh_local, i_permille_local) => { const gradFactor = (i_permille_local / 1000); const brakeForceN = kPoizdaTc * N_TO_TC_FACTOR * avgFriction * totalEfficiency; const massKg = massTonnes * 1000; const gradForceN = massKg * G * gradFactor; const netForceN = brakeForceN - gradForceN; let decel = 0; if (massKg > 0) decel = netForceN / massKg; if (decel <= 0.00001) return Infinity; const v_ms_local = v_kmh_local / 3.6; return (v_ms_local ** 2) / (2 * decel); }; const currentDistance = calculateS_local(speedKmh, gradientPermille); const currentSpeedMs = speedKmh / 3.6; let currentDeceleration = 0; if (isFinite(currentDistance) && currentDistance > 0) { currentDeceleration = (currentSpeedMs ** 2) / (2 * currentDistance); } else { const gradFactor = (gradientPermille / 1000); const brakeForceN = kPoizdaTc * N_TO_TC_FACTOR * avgFriction * totalEfficiency; const massKg = massTonnes * 1000; const gradForceN = massKg * G * gradFactor; const netForceN = brakeForceN - gradForceN; if (massKg > 0) currentDeceleration = netForceN / massKg; } const currentTime = isFinite(currentDistance) && currentDeceleration > 0.00001 ? currentSpeedMs / currentDeceleration : Infinity; const distEl = document.getElementById('bd-modal-distance'); const decelEl = document.getElementById('bd-modal-deceleration'); const timeEl = document.getElementById('bd-modal-time'); if(distEl) distEl.textContent = isFinite(currentDistance) ? Math.round(currentDistance) : "∞"; if(decelEl) decelEl.textContent = currentDeceleration.toFixed(2); if(timeEl) timeEl.textContent = isFinite(currentTime) ? currentTime.toFixed(1) : "∞"; highlightElement(distEl?.closest('.advanced-result-item')); highlightElement(decelEl?.closest('.advanced-result-item')); highlightElement(timeEl?.closest('.advanced-result-item')); bdModalContext.brakingProcessTimeData = []; bdModalContext.brakingProcessSpeedData = []; if (isFinite(currentTime) && currentTime > 0) { const numPoints = 30; const timeStep = currentTime / (numPoints - 1); for (let i = 0; i < numPoints; i++) { const t = i * timeStep; const v_ms = Math.max(0, currentSpeedMs - currentDeceleration * t); bdModalContext.brakingProcessTimeData.push(t.toFixed(1)); bdModalContext.brakingProcessSpeedData.push((v_ms * 3.6).toFixed(1)); } if (parseFloat(bdModalContext.brakingProcessTimeData[bdModalContext.brakingProcessTimeData.length-1]) < parseFloat(currentTime.toFixed(1))) { bdModalContext.brakingProcessTimeData.push(currentTime.toFixed(1)); bdModalContext.brakingProcessSpeedData.push('0.0');} } else { bdModalContext.brakingProcessTimeData = ['0.0', '10.0']; bdModalContext.brakingProcessSpeedData = [speedKmh.toFixed(1), speedKmh.toFixed(1)]; } renderBrakingProcessChart(bdModalContext.brakingProcessTimeData, bdModalContext.brakingProcessSpeedData); const dependencyType = document.getElementById('dependency-type').value; const numDepPoints = 25; bdModalContext.brakingDependencyXData = []; bdModalContext.brakingDependencyYData = []; document.getElementById('fixed-gradient-label').textContent = gradientPermille.toFixed(1); document.getElementById('fixed-speed-label').textContent = speedKmh.toFixed(0); if (dependencyType === 'speed') { bdModalContext.brakingDependencyXAxisLabel = 'Швидкість (км/год)'; bdModalContext.brakingDependencyChartTitle = `Залежність S від швидкості (при i = ${gradientPermille.toFixed(1)}‰)`; const minSpeed = 10; const maxSpeed = 120; const speedStep = (maxSpeed - minSpeed) / (numDepPoints - 1); for (let i = 0; i < numDepPoints; i++) { const v = minSpeed + i * speedStep; bdModalContext.brakingDependencyXData.push(v.toFixed(0)); bdModalContext.brakingDependencyYData.push(calculateS_local(v, gradientPermille)); } } else { bdModalContext.brakingDependencyXAxisLabel = 'Ухил (‰)'; bdModalContext.brakingDependencyChartTitle = `Залежність S від ухилу (при v = ${speedKmh.toFixed(0)} км/год)`; const minGradient = -20; const maxGradient = 20; const gradientStep = (maxGradient - minGradient) / (numDepPoints - 1); for (let i = 0; i < numDepPoints; i++) { const grad = minGradient + i * gradientStep; bdModalContext.brakingDependencyXData.push(grad.toFixed(1)); bdModalContext.brakingDependencyYData.push(calculateS_local(speedKmh, grad)); } } bdModalContext.brakingDependencyYAxisLabel = 'Гальмівний шлях (м)'; renderBrakingDependencyChart(bdModalContext.brakingDependencyXData, bdModalContext.brakingDependencyYData, bdModalContext.brakingDependencyXAxisLabel, bdModalContext.brakingDependencyYAxisLabel, bdModalContext.brakingDependencyChartTitle); } catch (error) { console.error("Error recalculating braking distance in modal:", error); showFloatingMessage("Помилка перерахунку шляху: " + error.message, 5000, true); } }
        function setupBrakingDistanceModalSync() { const speedRange = document.getElementById('bd-modal-speed-range'); const speedNumber = document.getElementById('bd-modal-speed-number'); const gradientRange = document.getElementById('bd-modal-gradient-range'); const gradientNumber = document.getElementById('bd-modal-gradient-number'); const depSelect = document.getElementById('dependency-type'); if (speedRange && speedNumber) { speedRange.addEventListener('input', () => { speedNumber.value = speedRange.value; recalculateBrakingDistanceInModal(); }); speedNumber.addEventListener('input', () => { const val = parseFloat(speedNumber.value); const min = parseFloat(speedRange.min); const max = parseFloat(speedRange.max); if (!isNaN(val) && val >= min && val <= max) { speedRange.value = val; } else if (!isNaN(val) && val < min) { speedNumber.value = min; speedRange.value = min; } else if (!isNaN(val) && val > max) { speedNumber.value = max; speedRange.value = max; } }); speedNumber.addEventListener('change', recalculateBrakingDistanceInModal); } else { console.warn("Braking distance speed controls not found for sync."); } if (gradientRange && gradientNumber) { gradientRange.addEventListener('input', () => { gradientNumber.value = gradientRange.value; recalculateBrakingDistanceInModal(); }); gradientNumber.addEventListener('input', () => { const val = parseFloat(gradientNumber.value); const min = parseFloat(gradientRange.min); const max = parseFloat(gradientRange.max); if (!isNaN(val) && val >= min && val <= max) { gradientRange.value = val; } else if (!isNaN(val) && val < min) { gradientNumber.value = min; gradientRange.value = min; } else if (!isNaN(val) && val > max) { gradientNumber.value = max; gradientRange.value = max; } }); gradientNumber.addEventListener('change', recalculateBrakingDistanceInModal); } else { console.warn("Braking distance gradient controls not found for sync."); } if(depSelect) { depSelect.addEventListener('change', recalculateBrakingDistanceInModal); } else { console.warn("Braking distance dependency selector not found.");} }
        function generateReport() { console.log("Generating report. Calculation Success:", calculationSuccess); if (!reportContentDiv) return; if (!calculationSuccess) { reportContentDiv.innerHTML = "Спочатку виконайте успішний розрахунок (без помилок)."; return; } const studentName = studentNameInput.value || "Не вказано"; const studentGroup = studentGroupInput.value || "Не вказано"; const reportDate = reportDateInput.value ? new Date(reportDateInput.value).toLocaleDateString('uk-UA') : "Не вказано"; const pressureMpa = pressureMpaInput.value; const trainMass = trainMassInput.value; const maxSpeed = maxSpeedInput.value; const trackConditionText = trackConditionSelect.options[trackConditionSelect.selectedIndex].text; const trackGradient = trackGradientInput.value; const brakeModeText = brakeModeSelect.options[brakeModeSelect.selectedIndex].text; let reportHTML = `<h2>Звіт про розрахунок натиску гальмівних колодок</h2><p><strong>Виконавець:</strong> ${studentName}</p><p><strong>Група:</strong> ${studentGroup}</p><p><strong>Дата:</strong> ${reportDate}</p><h3>Загальні параметри поїзда:</h3><ul><li>Тиск у ГЦ (<span class="abbreviation" title="Тиск у гальмівному циліндрі">p_ц</span>): ${pressureMpa} МПа</li><li>Маса поїзда (<span class="abbreviation" title="Маса брутто поїзда">M</span>): ${trainMass} т</li><li>Макс. швидкість (<span class="abbreviation" title="Максимальна швидкість руху">v₀</span>): ${maxSpeed} км/год</li><li>Стан колії: ${trackConditionText}</li><li>Ухил колії (<span class="abbreviation" title="Ухил поздовжнього профілю колії">i</span>): ${trackGradient} ‰</li><li>Режим гальмування: ${brakeModeText}</li></ul>`; const selectedTractionType = tractionUnitTypeSelect.value; reportHTML += `<h3>Тяговий Рухомий Склад:</h3><ul>`; if (selectedTractionType === 'locomotive') { reportHTML += `<li>Тип: Локомотив + вагони</li>`; reportHTML += `<li>Серія локомотива: ${locoSeriesSelect.options[locoSeriesSelect.selectedIndex].text}</li>`; reportHTML += `<li>Кількість секцій: ${document.getElementById('loco-sections').value}</li>`; } else if (selectedTractionType === 'emu') { reportHTML += `<li>Тип: Електропоїзд</li>`; reportHTML += `<li>Модель: ${emuSeriesSelect.options[emuSeriesSelect.selectedIndex].text}</li>`; reportHTML += `<li>Кількість вагонів: ${document.getElementById('emu-car-count').value}</li>`; } else if (selectedTractionType === 'dmu') { reportHTML += `<li>Тип: Дизель-поїзд</li>`; reportHTML += `<li>Модель: ${dmuSeriesSelect.options[dmuSeriesSelect.selectedIndex].text}</li>`; reportHTML += `<li>Кількість вагонів: ${document.getElementById('dmu-car-count').value}</li>`; } reportHTML += `</ul>`; reportHTML += `<h3>Результати розрахунків натиску:</h3><table class="results-table"><thead><tr>${document.getElementById('results-table').rows[0].innerHTML}</tr></thead><tbody>`; const resultsTbody = document.getElementById('results-tbody'); for (let i = 0; i < resultsTbody.rows.length; i++) { reportHTML += `<tr>${resultsTbody.rows[i].innerHTML}</tr>`; } reportHTML += `</tbody></table><p class="total-result" style="text-align: left; margin-top: 15px;">Загальний натиск поїзда (<span class="abbreviation" title="Сумарний натиск всіх гальмівних колодок поїзда">K_поїзда</span>): <span style="font-weight:bold;">${totalPressureDisplay.textContent}</span> тс</p><h3>Розширені параметри гальмування:</h3><ul><li>Питомий натиск (<span class="abbreviation" title="K_поїзда / M">K_пит</span>): ${specificPressureDisplay.textContent} тс/т</li><li>Гальмівний шлях (<span class="abbreviation" title="Відстань, пройдена від початку гальмування до повної зупинки">S</span>): ${brakingDistanceDisplay.textContent} м</li><li>Уповільнення (<span class="abbreviation" title="Середнє сповільнення під час гальмування">a</span>): ${brakingDecelerationDisplay.textContent} м/с²</li><li>Час гальмування (<span class="abbreviation" title="Тривалість гальмування до повної зупинки">t</span>): ${brakingTimeDisplay.textContent} с</li><li>Середній коеф. тертя (<span class="abbreviation" title="Середній коефіцієнт тертя між колодками та колесами">φ_сер</span>): ${frictionCoefficientDisplay.textContent}</li><li>Загальна ефективність (<span class="abbreviation" title="Добуток ефективності від стану колії та режиму гальмування">η_заг</span>): ${brakeEfficiencyDisplay.textContent}</li></ul>`; if (temperatureCalculationDone) { reportHTML += `<div class="temperature-report-section"><h4>Результати температурного розрахунку:</h4><ul><li>Початкова температура (<span class="abbreviation" title="Початкова температура коліс">T_initial</span>): ${document.getElementById('initial-temperature').value} °C</li><li>Температура навколишнього середовища (<span class="abbreviation" title="Температура навколишнього повітря">T_amb</span>): ${document.getElementById('ambient-temperature').value} °C</li><li>Ефективна теплова маса (<span class="abbreviation" title="Маса частини колеса, що швидко нагрівається">m_eff</span>): ${document.getElementById('effective-wheelset-mass').value} кг/вісь</li><li>Питома теплоємність (<span class="abbreviation" title="Питома теплоємність матеріалу колеса (сталь)">c</span>): ${document.getElementById('wheel-specific-heat').value} Дж/(кг·K)</li><li>Базовий коеф. охолодження (<span class="abbreviation" title="Коефіцієнт тепловіддачі до навколишнього середовища">k</span>): ${document.getElementById('cooling-coefficient').value} 1/хв</li><li>Фактичний коеф. охолодження: ${actualCoolingCoeffDisplay.textContent} 1/хв</li><li>К-сть гальмівних осей на вагон (для лок. поїздів): ${document.getElementById('axles-per-wagon').value}</li><li>Загальна к-сть гальмівних осей у поїзді (для темп. розр.): ${document.body.dataset.totalBrakedAxles || 'N/A'}</li><li><strong>Максимальна розрахункова температура (<span class="abbreviation" title="Максимальна розрахункова температура колеса">T_max</span>): ${maxTemperatureDisplay.textContent} °C</strong></li><li>Температура після ${document.getElementById('cooling-time').value} хв охолодження: ${cooledTemperatureDisplay.textContent} °C</li><li>Час охолодження до 100°C: ${coolingToSafeDisplay.textContent} хв</li></ul><div class="calculation-details"><h4>Формули розрахунку температури (спрощені):</h4><div class="calculation-formula"><p>1. Кінетична енергія поїзда (<span class="abbreviation" title="Кінетична енергія поїзда">E_k</span>): E_k = 0.5 × <span class="abbreviation" title="Маса брутто поїзда">M</span>[кг] × (<span class="abbreviation" title="Початкова (максимальна) швидкість">v₀</span>[м/с])²</p><p>2. Загальна кількість гальмівних осей (<span class="abbreviation" title="Загальна кількість гальмівних осей">N_axles</span>): Використовується розрахована загальна к-сть.</p><p>3. Енергія на одну вісь (<span class="abbreviation" title="Енергія, що розсіюється однією віссю">E_axle</span>): E_axle = E_k / N_axles</p><p>4. Підйом температури (<span class="abbreviation" title="Розрахунковий підйом температури">ΔT</span>): ΔT = E_axle / (<span class="abbreviation" title="Ефективна теплова маса колісної пари">m_eff</span> × <span class="abbreviation" title="Питома теплоємність матеріалу колеса">c</span>)</p><p>5. Максимальна температура (<span class="abbreviation" title="Максимальна розрахункова температура колеса">T_max</span>): T_max = <span class="abbreviation" title="Початкова температура коліс">T_initial</span> + ΔT</p><p>6. Охолодження (T(t)): T(t) = <span class="abbreviation" title="Температура навколишнього повітря">T_amb</span> + (T_max - T_amb) × e<sup>(-k_fact × t)</sup></p></div></div></div>`; } reportContentDiv.innerHTML = reportHTML; console.log("Report generated successfully."); }
        function printReport() { console.log("Print button clicked. Calculation Success:", calculationSuccess); if (!calculationSuccess) { showFloatingMessage('Спочатку виконайте успішний розрахунок.', 4000, true); return; } if (!reportPrintAreaDiv || !reportContentDiv) { console.error("Print area or report content not found."); return; } const reportClone = reportContentDiv.cloneNode(true); reportPrintAreaDiv.innerHTML = reportClone.innerHTML; const printChartColors = { textColor: '#000000', gridColor: '#777777', lineColor1: '#000000', lineColor2: '#555555', lineColor3: '#222222', pieSliceColors: ['#333333', '#555555', '#777777', '#999999', '#bbbbbb'] }; const chartsToPrint = [ { instance: pressurePieChart, canvasId: 'pressurePieChartModal', title: 'Розподіл Загального Натиску', type: 'pie' }, { instance: pressureBarChart, canvasId: 'pressureBarChartModal', title: 'Порівняння Натиску на Один Вагон', type: 'bar' }, ]; if (temperatureCalculationDone && temperatureChart) { chartsToPrint.push({ instance: temperatureChart, canvasId: 'temperatureChart', title: 'Профіль Охолодження Колісної Пари', type: 'line', lineColorKey: 'lineColor1' }); } if (brakingProcessChart && bdModalContext.brakingProcessTimeData && bdModalContext.brakingProcessTimeData.length > 0) { chartsToPrint.push({ instance: brakingProcessChart, canvasId: 'brakingProcessChart', title: 'Процес Гальмування (Аналіз)', type: 'line', lineColorKey: 'lineColor2' }); } if (brakingDependencyChart && bdModalContext.brakingDependencyXData && bdModalContext.brakingDependencyXData.length > 0) { chartsToPrint.push({ instance: brakingDependencyChart, canvasId: 'brakingDependencyChart', title: bdModalContext.brakingDependencyChartTitle || 'Залежність Гальмівного Шляху (Аналіз)', type: 'line', lineColorKey: 'lineColor3'}); } let allChartsProcessedPromise = Promise.resolve(); const tryPrint = () => { reportPrintAreaDiv.querySelectorAll('select').forEach(select => { const selectedText = select.options[select.selectedIndex]?.text || 'Не вибрано'; if (!select.dataset.selectedTextAppended) { select.insertAdjacentText('afterend', ` (${selectedText})`); select.dataset.selectedTextAppended = "true"; } select.style.border = "none"; select.style.appearance = "none"; select.style.webkitAppearance = "none"; select.style.mozAppearance = "none"; }); reportPrintAreaDiv.querySelectorAll('input[type="date"]').forEach(dateInput => { if (dateInput.value) { const dateValue = new Date(dateInput.value).toLocaleDateString('uk-UA'); if (!dateInput.dataset.dateValueAppended) { dateInput.insertAdjacentText('afterend', ` ${dateValue}`); dateInput.dataset.dateValueAppended = "true"; } } dateInput.style.border = "none"; }); console.log("All charts processed for print. Attempting window.print()."); window.print(); reportPrintAreaDiv.querySelectorAll('select').forEach(s => { delete s.dataset.selectedTextAppended; const sib = s.nextSibling; if(sib && sib.nodeType === Node.TEXT_NODE && sib.textContent.startsWith(' (')) sib.remove(); }); reportPrintAreaDiv.querySelectorAll('input[type="date"]').forEach(i => { delete i.dataset.dateValueAppended; const sib = i.nextSibling; if(sib && sib.nodeType === Node.TEXT_NODE && sib.textContent.trim().match(/^\d{2}\.\d{2}\.\d{4}$/)) sib.remove(); }); reportPrintAreaDiv.querySelectorAll('.print-chart-container').forEach(el => el.remove()); updateChartThemes(); }; if (chartsToPrint.length === 0) { tryPrint(); return; } allChartsProcessedPromise = Promise.all(chartsToPrint.map(chartInfo => { return new Promise((resolve) => { const chartInstance = chartInfo.instance; const chartCanvas = document.getElementById(chartInfo.canvasId); const isVisible = chartCanvas && chartCanvas.offsetParent !== null; if (chartInstance && (isVisible || chartInstance.ctx)) { const originalOptions = JSON.parse(JSON.stringify(chartInstance.options)); const originalDatasetColors = chartInstance.data.datasets.map(ds => ({ backgroundColor: ds.backgroundColor, borderColor: ds.borderColor })); chartInstance.options.plugins.title.color = printChartColors.textColor; if(chartInstance.options.plugins.legend) chartInstance.options.plugins.legend.labels.color = printChartColors.textColor; if (chartInstance.options.scales) { if (chartInstance.options.scales.x) { chartInstance.options.scales.x.title.color = printChartColors.textColor; chartInstance.options.scales.x.ticks.color = printChartColors.textColor; chartInstance.options.scales.x.grid.color = printChartColors.gridColor; } if (chartInstance.options.scales.y) { chartInstance.options.scales.y.title.color = printChartColors.textColor; chartInstance.options.scales.y.ticks.color = printChartColors.textColor; chartInstance.options.scales.y.grid.color = printChartColors.gridColor; } } if (chartInfo.type === 'pie' || chartInfo.type === 'bar') { chartInstance.data.datasets[0].backgroundColor = printChartColors.pieSliceColors.slice(0, chartInstance.data.labels.length); chartInstance.data.datasets[0].borderColor = printChartColors.gridColor; } else if (chartInfo.type === 'line' && chartInfo.lineColorKey) { chartInstance.data.datasets[0].borderColor = printChartColors[chartInfo.lineColorKey]; chartInstance.data.datasets[0].backgroundColor = printChartColors[chartInfo.lineColorKey] + '1A'; } chartInstance.update('none'); try { const imgData = chartInstance.toBase64Image(); const imgContainer = document.createElement('div'); imgContainer.classList.add('print-chart-container'); imgContainer.innerHTML = `<p><strong>${chartInfo.title}:</strong></p><img src="${imgData}" alt="${chartInfo.title}" style="max-width: 90%; height: auto; display: block; margin: 15px auto; border: 1px solid #aaa;">`; let insertionPoint; if (chartInfo.canvasId.includes('pressure')) { insertionPoint = reportPrintAreaDiv.querySelector('p.total-result'); } else if (chartInfo.canvasId === 'temperatureChart') { insertionPoint = reportPrintAreaDiv.querySelector('.temperature-report-section ul'); } else if (chartInfo.canvasId === 'brakingProcessChart' || chartInfo.canvasId === 'brakingDependencyChart') { insertionPoint = Array.from(reportPrintAreaDiv.querySelectorAll('h3')).find(h => h.textContent.includes("Розширені параметри гальмування")); if (insertionPoint && insertionPoint.nextElementSibling && insertionPoint.nextElementSibling.tagName === 'UL') { insertionPoint = insertionPoint.nextElementSibling; } } if (insertionPoint && insertionPoint.parentElement) { insertionPoint.parentElement.insertBefore(imgContainer, insertionPoint.nextSibling); } else { reportPrintAreaDiv.appendChild(imgContainer); } console.log(`Chart ${chartInfo.title} added to print area with print colors.`); } catch (e) { console.error(`Error converting chart ${chartInfo.title} to image:`, e); } finally { chartInstance.options.plugins.title.color = originalOptions.plugins.title.color; if(chartInstance.options.plugins.legend) chartInstance.options.plugins.legend.labels.color = originalOptions.plugins.legend.labels.color; if (chartInstance.options.scales && originalOptions.scales) { if (chartInstance.options.scales.x && originalOptions.scales.x) { chartInstance.options.scales.x.title.color = originalOptions.scales.x.title.color; chartInstance.options.scales.x.ticks.color = originalOptions.scales.x.ticks.color; chartInstance.options.scales.x.grid.color = originalOptions.scales.x.grid.color; } if (chartInstance.options.scales.y && originalOptions.scales.y) { chartInstance.options.scales.y.title.color = originalOptions.scales.y.title.color; chartInstance.options.scales.y.ticks.color = originalOptions.scales.y.ticks.color; chartInstance.options.scales.y.grid.color = originalOptions.scales.y.grid.color; } } chartInstance.data.datasets.forEach((ds, index) => { ds.backgroundColor = originalDatasetColors[index].backgroundColor; ds.borderColor = originalDatasetColors[index].borderColor; }); chartInstance.update('none'); } } else { console.log(`Chart ${chartInfo.title} (canvas: ${chartInfo.canvasId}) not available for print.`); } resolve(); }); })); allChartsProcessedPromise.then(tryPrint).catch(err => console.error("Error processing charts for printing:", err)); }
        function resetCalculator() {
             if(studentNameInput) studentNameInput.value = ''; if(studentGroupInput) studentGroupInput.value = ''; if(reportDateInput) reportDateInput.valueAsDate = new Date(); if(pressureMpaInput) pressureMpaInput.value = '0.4'; if(trainMassInput) trainMassInput.value = '5000'; if(maxSpeedInput) maxSpeedInput.value = '80'; if(trackConditionSelect) trackConditionSelect.value = 'dry'; if(trackGradientInput) trackGradientInput.value = '0'; if(brakeModeSelect) brakeModeSelect.value = 'full'; if(trackConditionSelect) trackConditionSelect.dispatchEvent(new Event('change')); if(brakeModeSelect) brakeModeSelect.dispatchEvent(new Event('change')); if(tractionUnitTypeSelect) tractionUnitTypeSelect.value = 'locomotive';
             const tempModal = document.getElementById('temperature-modal'); if (tempModal) { tempModal.querySelector('#initial-temperature').value = '20'; tempModal.querySelector('#ambient-temperature').value = '20'; tempModal.querySelector('#effective-wheelset-mass').value = '150'; tempModal.querySelector('#wheel-specific-heat').value = '480'; tempModal.querySelector('#cooling-coefficient').value = '0.02'; tempModal.querySelector('#cooling-time').value = '60'; tempModal.querySelector('#axles-per-wagon').value = '4'; }
             if(typeof updateTractionOptionsVisibility === "function") updateTractionOptionsVisibility();
             if(typeof populateLocoFields === "function") populateLocoFields(); // Reset loco fields based on default selection
             calculationSuccess = false; temperatureCalculationDone = false; chartData = null;
             document.querySelectorAll('.input-group input, .input-group select').forEach(i => i.style.borderColor = '');
             document.querySelectorAll('.input-warning').forEach(w => w.style.display = 'none');
             document.querySelectorAll('.wagon-module').forEach(m => m.style.border = '');
             showFloatingMessage('Калькулятор скинуто.', 3000);
        }


        // --- Initial Setup Function ---
        function initializeCalculator() {
            console.log("Attempting to initialize calculator...");
            // Assign DOM element variables
            themeToggleBtn = document.getElementById('theme-toggle-btn'); bodyElement = document.body; tractionUnitTypeSelect = document.getElementById('traction-unit-type'); locomotiveOptionsDiv = document.getElementById('locomotive-options'); emuOptionsDiv = document.getElementById('emu-options'); dmuOptionsDiv = document.getElementById('dmu-options'); wagonParamsSection = document.getElementById('wagon-params-section'); addWagonBtn = document.getElementById('add-wagon-btn'); locoSeriesSelect = document.getElementById('loco-series'); emuSeriesSelect = document.getElementById('emu-series'); dmuSeriesSelect = document.getElementById('dmu-series'); reportDateInput = document.getElementById('report-date'); studentNameInput = document.getElementById('student-name'); studentGroupInput = document.getElementById('student-group'); pressureMpaInput = document.getElementById('pressure-mpa'); trainMassInput = document.getElementById('train-mass'); maxSpeedInput = document.getElementById('max-speed'); trackConditionSelect = document.getElementById('track-condition'); trackGradientInput = document.getElementById('track-gradient'); brakeModeSelect = document.getElementById('brake-mode'); totalPressureDisplay = document.getElementById('total-pressure'); specificPressureDisplay = document.getElementById('specific-pressure'); brakingDistanceDisplay = document.getElementById('braking-distance'); brakingDecelerationDisplay = document.getElementById('braking-deceleration'); brakingTimeDisplay = document.getElementById('braking-time'); frictionCoefficientDisplay = document.getElementById('friction-coefficient'); brakeEfficiencyDisplay = document.getElementById('brake-efficiency'); maxTemperatureDisplay = document.getElementById('max-temperature'); cooledTemperatureDisplay = document.getElementById('cooled-temperature'); cooledTimeLabelDisplay = document.getElementById('cooled-time-label'); coolingToSafeDisplay = document.getElementById('cooling-to-safe'); actualCoolingCoeffDisplay = document.getElementById('actual-cooling-coeff'); bdModalDistanceDisplay = document.getElementById('bd-modal-distance'); bdModalDecelerationDisplay = document.getElementById('bd-modal-deceleration'); bdModalTimeDisplay = document.getElementById('bd-modal-time'); reportContentDiv = document.getElementById('report-content'); reportPrintAreaDiv = document.getElementById('report-print-area'); temperatureWarningDiv = document.getElementById('temperature-warning'); wagonModulesContainerDiv = document.getElementById('wagon-modules-container'); configFileInput = document.getElementById('config-file-input'); helpModal = document.getElementById('help-modal'); temperatureModal = document.getElementById('temperature-modal'); pressureChartsModal = document.getElementById('pressure-charts-modal'); brakingDistanceModal = document.getElementById('braking-distance-modal');

            let criticalElementsMissing = false;
            if (!bodyElement) { console.error("document.body not found!"); criticalElementsMissing = true; }
            if (!themeToggleBtn) { console.error("#theme-toggle-btn not found!"); criticalElementsMissing = true; }
            if (!tractionUnitTypeSelect) { console.error("#traction-unit-type not found!"); criticalElementsMissing = true; }
            if (!addWagonBtn) { console.error("#add-wagon-btn not found!"); criticalElementsMissing = true; }
            if (!totalPressureDisplay) { console.error("#total-pressure not found!"); criticalElementsMissing = true; }

            if (criticalElementsMissing) { console.error("КРИТИЧНІ DOM ЕЛЕМЕНТИ НЕ ЗНАЙДЕНО! Ініціалізація зупинена."); showFloatingMessage("Помилка завантаження інтерфейсу. Перевірте HTML.", 10000, true); return; }

            if (reportDateInput) reportDateInput.valueAsDate = new Date();

            // Add event listeners
            themeToggleBtn.addEventListener('click', () => { bodyElement.classList.toggle('light-theme'); let newTheme = bodyElement.classList.contains('light-theme') ? 'light' : 'dark'; themeToggleBtn.textContent = newTheme === 'light' ? 'Темна Тема' : 'Світла Тема'; localStorage.setItem('theme', newTheme); updateChartThemes(); });
            tractionUnitTypeSelect.addEventListener('change', updateTractionOptionsVisibility);
            tractionUnitTypeSelect.addEventListener('change', updateTrainMassField);
            if (locoSeriesSelect) { locoSeriesSelect.addEventListener('change', populateLocoFields); locoSeriesSelect.addEventListener('change', updateTrainMassField); }
            if (emuSeriesSelect) { emuSeriesSelect.addEventListener('change', populateEmuFields); emuSeriesSelect.addEventListener('change', updateTrainMassField); }
            if (dmuSeriesSelect) { dmuSeriesSelect.addEventListener('change', populateDmuFields); dmuSeriesSelect.addEventListener('change', updateTrainMassField); }
            ['loco-sections', 'loco-weight-per-section', 'emu-car-count', 'emu-weight-per-car', 'dmu-car-count', 'dmu-weight-per-car'].forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('input', updateTrainMassField); else console.warn(`Element ${id} not found for mass update listener.`); });
            addWagonBtn.addEventListener('click', () => { if (tractionUnitTypeSelect && tractionUnitTypeSelect.value === 'locomotive') { wagonCounter++; if(wagonModulesContainerDiv) { const newModule = createWagonModule(wagonCounter, 'gondola_14'); wagonModulesContainerDiv.appendChild(newModule); const newCountInput = newModule.querySelector(`#wagon-count-${wagonCounter}`); if (newCountInput) newCountInput.addEventListener('input', updateTrainMassField); updateTrainMassField(); resetResultsAndCharts(); } } else { showFloatingMessage("Додавання вагонів можливе тільки для типу 'Локомотив + вагони'.", 4000, true); } });
            document.querySelectorAll('.modal-overlay').forEach(modal => { modal.addEventListener('click', function(e) { if (e.target === this) { if (this.id === 'help-modal' && typeof hideHelpModal === 'function') hideHelpModal(); if (this.id === 'temperature-modal' && typeof hideTemperatureModal === 'function') hideTemperatureModal(); if (this.id === 'pressure-charts-modal' && typeof hidePressureChartsModal === 'function') hidePressureChartsModal(); if (this.id === 'braking-distance-modal' && typeof hideBrakingDistanceModal === 'function') hideBrakingDistanceModal(); } }); });
            document.addEventListener('keydown', function(event) { if (event.key === "Escape") { if (typeof hideHelpModal === 'function') hideHelpModal(); if (typeof hideTemperatureModal === 'function') hideTemperatureModal(); if (typeof hidePressureChartsModal === 'function') hidePressureChartsModal(); if (typeof hideBrakingDistanceModal === 'function') hideBrakingDistanceModal(); } });

            // Call initial setup functions
            setPreferredTheme(); setupInputValidation(); setupBrakingDistanceModalSync();
            updateTractionOptionsVisibility(); populateLocoFields(); populateEmuFields(); populateDmuFields();
            if (tractionUnitTypeSelect && tractionUnitTypeSelect.value === 'locomotive') { addInitialData(); } else { updateTrainMassField(); } // Ensure mass is updated even if no wagons are added initially
            resetResultsAndCharts();
            const modalsToHide = ['help-modal', 'temperature-modal', 'pressure-charts-modal', 'braking-distance-modal'];
            modalsToHide.forEach(id => { const modal = document.getElementById(id); if (modal) modal.classList.remove('active'); });
            console.log("Calculator initialized successfully.");
        }

        // --- Function to check for DOM readiness and then initialize ---
        function tryInitializeApp() {
            const calculatorContainer = document.querySelector('.calculator-container');
            if (calculatorContainer && typeof Chart !== 'undefined') {
                console.log("DOM and Chart.js ready, initializing calculator.");
                initializeCalculator();
            } else {
                let statusMsg = "DOM or Chart.js not ready. ";
                if (!calculatorContainer) statusMsg += "CalculatorContainer: false. "; else statusMsg += "CalculatorContainer: true. ";
                if (typeof Chart === 'undefined') statusMsg += "Chart: false. "; else statusMsg += "Chart: true. ";
                statusMsg += "Retrying in 100ms...";
                console.log(statusMsg);
                setTimeout(tryInitializeApp, 100); // Keep retry short now
            }
        }

        // Start the initialization attempt
        tryInitializeApp();

    </script>
	</body>
</html>