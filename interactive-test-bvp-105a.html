<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивний Тест: БВП-105А</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        :root {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-light: rgba(255, 255, 255, 0.85);
            --text-color: #2c3e50; --correct: #28a745; --incorrect: #e74c3c; --partial: #f1c40f; --all-selected: #95a5a6;
            --accent: #3498db; --border-color: rgba(0, 0, 0, 0.1);
            --shadow: 0 8px 25px 0 rgba(44, 62, 80, 0.1);
            --shadow-light: 0 4px 15px 0 rgba(44, 62, 80, 0.08);
            --purple-gradient: linear-gradient(45deg, #8e44ad, #9b59b6);
        }
        body {
            font-family: 'Nunito', sans-serif; background-image: var(--bg-gradient); color: var(--text-color);
            margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .test-wrapper {
            width: 100%; max-width: 800px; background: var(--bg-light); backdrop-filter: blur(15px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow); overflow: hidden;
        }
        .header { padding: 25px 30px; text-align: center; border-bottom: 1px solid var(--border-color); }
        h1, h2, h3, h4 { margin: 0; padding: 0; }
        h1 { font-size: 1.8rem; font-weight: 800; }
        h2 { font-size: 1.5rem; margin-bottom: 25px; }
        .content { padding: 30px; transition: opacity 0.4s ease-in-out; }
        .content.is-changing { opacity: 0; }
        
        #user-info-form .form-group { margin: 0 auto 20px auto; max-width: 400px; }
        #user-info-form label { display: block; margin-bottom: 8px; font-weight: 600; }
        #user-info-form input { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: rgba(255,255,255,0.5); }
        .current-date { text-align: center; margin-bottom: 25px; color: #7f8c8d; }
        .button-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn {
            display: inline-block; background: linear-gradient(45deg, var(--correct), #228b22);
            color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem;
            font-weight: 700; cursor: pointer; text-align: center; box-sizing: border-box;
            transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; transform: none; }
        .save-btn { background: var(--purple-gradient); box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3); }

        #quiz-container { display: none; }
        .progress-bar-inner { height: 100%; width: 0%; background: var(--purple-gradient); border-radius: 5px; transition: width 0.5s ease-in-out; }
        .progress-bar { width: 100%; height: 10px; background-color: #e9ecef; border-radius: 5px; margin-bottom: 25px; overflow: hidden; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .question-points { background: var(--accent); color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; display: inline-block; white-space: nowrap; }
        .answers label {
            position: relative; overflow: hidden;
            display: flex; align-items: center; padding: 14px;
            border: 2px solid transparent; background-clip: padding-box;
            border-radius: 14px; margin-bottom: 12px; cursor: pointer;
            transition: all 0.2s ease; background-color: rgba(255,255,255,0.6);
            box-shadow: var(--shadow-light);
        }
        .answers label::before {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.2), transparent);
            transition: left 0.8s ease;
        }
        .answers label:has(input:checked)::before { left: 100%; }
        .answers label:hover { transform: scale(1.02); box-shadow: var(--shadow); }
        .answers input { display: none; }
        .answers label:has(input:checked) { border-color: var(--accent); }
        .answer-text::before { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #bdc3c7; border-radius: 50%; margin-right: 15px; transition: all 0.2s ease; }
        input[type="checkbox"] + .answer-text::before { border-radius: 5px; }
        .answers input:checked + .answer-text::before { border-color: var(--accent); background-color: var(--accent); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--accent); }
        .fill-in-input { padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); width: 100%; max-width: 300px; box-sizing: border-box; font-size: 1rem; }
        .answers.compact-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        .dnd-container { display: flex; gap: 20px; }
        .dnd-column { flex: 1; padding: 10px; border-radius: 10px; }
        .dnd-item { position: relative; padding: 12px; padding-left: 35px; background-color: white; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; cursor: grab; transition: all 0.2s ease; user-select: none; box-shadow: var(--shadow-light); }
        .dnd-item::before { content: '⠿'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 1.5rem; color: #aaa; cursor: grab; }
        .dnd-item.dragging { opacity: 0.5; box-shadow: var(--shadow); }
        .match-table { display: flex; flex-direction: column; gap: 10px; }
        .match-row { display: flex; align-items: stretch; gap: 10px; }
        .match-definition { flex: 1; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px; display: flex; align-items: center; }
        .drop-zone { flex: 1; min-height: 50px; background-color: rgba(0,0,0,0.02); border: 2px dashed var(--border-color); border-radius: 8px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .drop-zone.drag-over { background-color: rgba(52, 152, 219, 0.1); border-color: var(--accent); }
        .drop-zone .dnd-item { transform: scale(0.95); box-shadow: none; cursor: default; }
        .sequence-item { position: relative; padding: 15px; background-color: white; border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; user-select: none; box-shadow: var(--shadow-light); }
        .sequence-item.selected { border-color: var(--accent); background-color: rgba(52, 152, 219, 0.1); }
        .sequence-item.selected::after { content: attr(data-order); position: absolute; right: 15px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; background: rgba(52, 152, 219, 0.8); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1rem; font-weight: bold; }
        .reset-btn { font-size: 0.8rem; background: #f39c12; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 15px; }

        #results-container { display: none; animation: fadeIn 0.5s ease-in-out; }
        .results-layout { display: flex; gap: 20px; align-items: flex-start; }
        .results-main { flex: 1; display: flex; flex-direction: column; gap: 25px; }
        .results-summary { flex-basis: 260px; background: #e6f7ea; backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; text-align: center; }
        .user-info { display: flex; flex-direction: column; gap: 10px; align-items: flex-start; }
        .user-name { font-size: 2rem; font-weight: 800; }
        .user-info p { font-size: 1rem; color: #7f8c8d; margin: 0; }
        .answer-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .answer-grid span { display: flex; justify-content: center; align-items: center; height: 35px; border-radius: 6px; color: white; font-weight: 700; }
        .grid-correct { background: var(--correct); } .grid-incorrect { background: var(--incorrect); } .grid-partial { background: var(--partial); } .grid-all-selected { background: var(--all-selected); }
        .final-score .score-value { font-size: 4rem; font-weight: 800; color: var(--accent); line-height: 1; }
        .status-badge { display: inline-flex; align-items: center; justify-content: center; margin: 15px 0; padding: 12px 30px; border-radius: 50px; color: white; font-weight: 700; font-size: 1.1rem; }
        .status-passed { background: linear-gradient(45deg, var(--correct), #228b22); }
        .status-failed { background: linear-gradient(45deg, var(--incorrect), #c0392b); }
        
        details { background: rgba(255,255,255,0.5); border-radius: 10px; border: 1px solid var(--border-color); }
        details summary { padding: 15px; font-weight: 700; cursor: pointer; list-style: none; }
        details summary::-webkit-details-marker { display: none; }
        details summary::before { content: '▶'; margin-right: 10px; display: inline-block; transition: transform 0.2s; }
        details[open] summary::before { transform: rotate(90deg); }
        .details-content { padding: 0 15px 15px; border-top: 1px solid var(--border-color); }
        .details-content h4 { margin-top: 15px; padding-left: 10px; border-left: 3px solid; }
        #criteria-container h4 { color: var(--accent); border-left-color: var(--accent); }
        #conversion-explanation h4 { color: var(--correct); border-left-color: var(--correct); }
        #color-legend h4 { color: var(--partial); border-left-color: var(--partial); }
        #history-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        #history-table th, td { padding: 8px 12px; border: 1px solid var(--border-color); }

        .chart-area { display: flex; justify-content: space-around; align-items: flex-end; height: 150px; border-left: 2px solid #ccc; border-bottom: 2px solid #ccc; padding-top: 10px; }
        .chart-bar { width: 8%; background: var(--purple-gradient); border-radius: 5px 5px 0 0; position: relative; transition: height 0.5s ease-out; animation: growUp 0.5s ease-out; }
        .chart-bar .tooltip { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 3px 7px; border-radius: 4px; font-size: 0.8rem; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .chart-bar:hover .tooltip { opacity: 1; }
        .chart-labels { display: flex; justify-content: space-around; font-size: 0.8rem; margin-top: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes growUp { from { height: 0; } }
        
        @media (min-width: 992px) { .answers.grid-2-cols { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; } }
        @media (max-width: 768px) {
            body { padding: 10px; } .content { padding: 20px; } h1 { font-size: 1.5rem; }
            .results-layout, .dnd-container { flex-direction: column; }
            .answer-grid { grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); }
            
            /* ===== ОСЬ ЦЕЙ БЛОК БУЛО ДОДАНО ===== */
            .sequence-container .answers.grid-2-cols {
                display: grid; /* Вмикаємо grid-макет */
                grid-template-columns: 1fr; /* Робимо одну колонку */
                gap: 12px; /* Додаємо вертикальний відступ */
            }
            /* ===== КІНЕЦЬ ВИПРАВЛЕННЯ ===== */
        }
    </style>
</head>
<body>
<div class="test-wrapper">
    <header class="header"><h1>Інтерактивне тестування: <span style="color: var(--accent);">БВП-105А</span></h1></header>
    <main class="content" id="content-area">
        <div id="user-info-form">
            <h2>Введіть ваші дані</h2>
            <form onsubmit="startQuiz(event)">
                <div class="form-group"><label for="fullName">Прізвище, Ім'я</label><input type="text" id="fullName" required></div>
                <div class="form-group"><label for="group">Група</label><input type="text" id="group" required></div>
                <p class="current-date" id="current-date"></p>
                <div class="button-container"><button type="submit" class="btn">Почати тест</button></div>
            </form>
        </div>
        <div id="quiz-container">
            <div class="progress-bar"><div class="progress-bar-inner" id="progress-bar-inner"></div></div>
            <div class="question-header"><span class="question-counter" id="question-counter"></span><span class="timer" id="timer">00:00</span></div>
            <div id="question-display"></div>
            <div class="button-container"><button class="btn" id="next-btn" onclick="nextQuestion()">Наступне питання</button></div>
        </div>
        <div id="results-container">
             <div class="results-layout">
                <div class="results-main">
                    <div class="user-info">
                        <h2 class="user-name" id="result-fullName"></h2>
                        <p id="result-group"></p>
                        <p id="time-taken"></p>
                    </div>
                    <h3>Відповіді на питання:</h3>
                    <div class="answer-grid" id="answer-grid"></div>
                    <div id="chart-container"></div>
                    <details id="evaluation-details">
                        <summary>Детальніше про оцінювання</summary>
                        <div class="details-content">
                            <div id="criteria-container"><h4>Критерії оцінювання</h4><ul><li><b>1 бал:</b> Питання на відтворення інформації.</li><li><b>2 бали:</b> Питання на аналіз, в т.ч. частково правильні.</li><li><b>3 бали:</b> Питання на встановлення логічних зв'язків.</li></ul></div>
                            <div id="conversion-explanation"><h4>Перерахунок у 12-бальну систему</h4><p style="font-size: 0.9em;">Ваша оцінка розраховується на основі % набраних умовних балів. Наприклад, якщо ви набрали 15 з 23 можливих балів (≈65%), ваша оцінка буде 8.</p></div>
                             <div id="color-legend"><h4>Легенда кольорів</h4><ul style="padding-left: 20px; list-style: disc;"><li><span style="color:var(--correct)">■</span> Зелений - правильна відповідь.</li><li><span style="color:var(--partial)">■</span> Жовтий - частково правильна.</li><li><span style="color:var(--all-selected)">■</span> Сірий - обрано всі варіанти.</li><li><span style="color:var(--incorrect)">■</span> Червоний - неправильна відповідь.</li></ul></div>
                        </div>
                    </details>
                    <div id="history-container" style="display: none;"><h4>Попередні спроби:</h4><table id="history-table"><thead><tr><th>Дата</th><th>Умовні бали</th><th>Оцінка (12)</th></tr></thead><tbody id="history-body"></tbody></table></div>
                </div>
                <div class="results-summary" id="results-summary">
                    <div class="final-score">
                        <h3 class="score-title">Підсумкова оцінка:</h3>
                        <p class="score-value" id="final-grade">0</p>
                        <p class="conditional-score" id="conditional-score">Умовні бали: 0/0</p>
                    </div>
                    <div class="status-badge" id="status-badge"></div>
                    <div class="button-container">
                       <button class="btn save-btn" id="save-report-btn" onclick="saveReportAsHTML()">Зберегти звіт</button>
                       <button class="btn" onclick="location.reload()" style="background: linear-gradient(45deg, var(--accent), #2980b9);">Пройти ще раз</button>
                    </div>
                </div>
             </div>
        </div>
    </main>
</div>
<script>
    document.getElementById('current-date').innerText = `Сьогодні: ${new Date().toLocaleDateString('uk-UA')}`;
    const quizData = [
        { points: 1, type: "radio", question: "Яка головна функція БВП-105А?", options: ["Регулювання швидкості", "Захист від перевантажень та к.з.", "Подача повітря в гальма", "Увімкнення освітлення"], answer: "Захист від перевантажень та к.з." },
        { points: 1, type: "radio", question: "Який номінальний тиск повітря необхідний для роботи приводу?", options: ["3 кгс/см²", "5 кгс/см²", "8 кгс/см²", "10 кгс/см²"], answer: "5 кгс/см²" },
        { points: 1, type: "radio", question: "Твердження: \"БВ є поляризованим апаратом\".", options: ["Правильно", "Неправильно"], answer: "Правильно" },
        { points: 1, type: "radio", question: "Скільки витків має розмагнічувальна котушка?", options: ["3", "9", "161", "9500"], answer: "3" },
        { points: 1, type: "fill-in", question: "Вкажіть граничний струм відключення апарату (в Амперах).", answer: "20000" },
        { points: 2, type: "radio", question: "В який момент замикаються головні контакти вимикача?", options: ["В момент подачі живлення", "Коли шток досягає верху", "Після виходу повітря з циліндра", "Одночасно з подачею повітря"], answer: "Після виходу повітря з циліндра" },
        { points: 2, type: "checkbox", question: "Які елементи входять до складу дугогасної системи?", options: ["Дугогасні котушки", "Розмагнічувальний виток", "Деіонна решітка", "Пневматичний циліндр"], answer: ["Дугогасні котушки", "Деіонна решітка"] },
        { points: 2, type: "radio", question: "Для чого служить швидкодіючий контактор КЗ?", options: ["Для дублювання роботи БВ", "Для захисту кіл в гальмівних режимах", "Для ручного відключення", "Для регулювання уставки"], answer: "Для захисту кіл в гальмівних режимах" },
        { points: 3, type: "checkbox", question: "Які причини можуть призвести до того, що БВ НЕ утримується увімкненим?", options: ["Бруд на якорі", "Знижений тиск повітря", "Надмірно натягнуті пружини", "Несправна схема"], answer: ["Бруд на якорі", "Надмірно натягнуті пружини", "Несправна схема"] },
        { points: 3, type: "radio", question: "Який компонент створює зустрічний магнітний потік для відключення апарату?", options: ["Утримуюча котушка", "Дугогасна котушка", "Розмагнічувальний виток", "Відключаюча пружина"], answer: "Розмагнічувальний виток" },
        { points: 3, type: "match", question: "Встановіть відповідність:", items: ["Пневмопривод", "Дугогасна котушка", "Деіонна решітка"], definitions: ["Забезпечує початкове зусилля для зведення", "Виштовхує дугу на роги", "Остаточно гасить дугу, дроблячи її"], answer: ["Пневмопривод-Забезпечує початкове зусилля для зведення", "Дугогасна котушка-Виштовхує дугу на роги", "Деіонна решітка-Остаточно гасить дугу, дроблячи її"] },
        { points: 3, type: "sequence", question: "Розташуйте у правильному порядку етапи увімкнення БВ:", steps: ["Подача живлення на утримуючу котушку", "Подача повітря у циліндр", "Притискання якоря до електромагніту", "Дотискання контактів пружинами"], answer: ["Подача живлення на утримуючу котушку", "Подача повітря у циліндр", "Притискання якоря до електромагніту", "Дотискання контактів пружинами"] },
    ];
    const maxPossiblePoints = quizData.reduce((sum, q) => sum + (q.type === 'checkbox' ? q.answer.length : q.points), 0);
    let currentQuestionIndex = 0, userAnswers = new Array(quizData.length), questionTimings = [], questionStartTime, timerInterval, studentData = {}, sequenceCounter = 1;
    function startQuiz(e) { e.preventDefault(); studentData.fullName = document.getElementById('fullName').value; studentData.group = document.getElementById('group').value; document.getElementById('result-fullName').innerText = studentData.fullName; document.getElementById('result-group').innerText = `Група: ${studentData.group}`; document.getElementById('user-info-form').style.display = 'none'; document.getElementById('quiz-container').style.display = 'block'; startTimer(); renderQuestion(); }
    function startTimer() { let s = new Date(); timerInterval = setInterval(() => { const d = new Date() - s, m = String(Math.floor(d/60000)).padStart(2,'0'), c = String(Math.floor((d%60000)/1000)).padStart(2,'0'); document.getElementById('timer').innerText = `${m}:${c}`; }, 1000); }
    function renderQuestion() {
        document.getElementById('content-area').classList.add('is-changing');
        questionStartTime = new Date();
        setTimeout(() => {
            const q = quizData[currentQuestionIndex];
            const display = document.getElementById('question-display');
            let html = `<div class="question-block" id="current-question-block" data-type="${q.type}">
                <p class="question-title">${q.question} <span class="question-points">${q.points} ${q.points === 1 ? 'бал' : 'бали'}</span></p>`;
            switch (q.type) {
                case 'radio': 
                    const gridClass = (q.options.length > 2) ? 'grid-2-cols' : 'compact-options';
                    html += `<div class="answers ${gridClass}">${q.options.map(opt => `<label><input type="radio" name="answer" value="${opt}"><span class="answer-text">${opt}</span></label>`).join('')}</div>`;
                    break;
                case 'checkbox':
                    html += `<div class="answers grid-2-cols">${q.options.map(opt => `<label><input type="checkbox" name="answer" value="${opt}"><span class="answer-text">${opt}</span></label>`).join('')}</div>`;
                    break;
                case 'fill-in': html += `<input type="text" class="fill-in-input">`; break;
                case 'match':
                    const items = [...q.items].sort(() => Math.random() - 0.5);
                    html += `<div class="dnd-container"><div class="dnd-column"><h4>Перетягніть:</h4><div class="source-list">${items.map(i => `<div class="dnd-item" draggable="true" data-id="${i}">${i}</div>`).join('')}</div></div><div class="dnd-column"><h4 style="opacity:0;">-</h4><div class="match-table">${q.definitions.map((d, i) => `<div class="match-row"><div class="match-definition">${d}</div><div class="drop-zone" data-target-id="${q.items[i]}"></div></div>`).join('')}</div></div>`;
                    break;
                case 'sequence':
                    sequenceCounter = 1;
                    const steps = [...q.steps].sort(() => Math.random() - 0.5);
                    html += `<div class="sequence-container"><div class="answers grid-2-cols">${steps.map(s => `<div class="sequence-item" data-id="${s}">${s}</div>`).join('')}</div></div>
                    <div class="button-container" style="justify-content: flex-end;"><button class="reset-btn" onclick="resetSequence()">Скинути</button></div>`;
                    break;
            }
            display.innerHTML = html + '</div>';
            if (q.type === 'match') setupDragAndDrop();
            if (q.type === 'sequence') setupSequence();
            document.getElementById('question-counter').innerText = `Питання ${currentQuestionIndex+1} з ${quizData.length}`;
            updateProgressBar();
            document.getElementById('next-btn').innerText = (currentQuestionIndex === quizData.length - 1) ? 'Завершити тест' : 'Наступне питання';
            document.getElementById('content-area').classList.remove('is-changing');
            checkAnswerProvided(); 
            document.getElementById('current-question-block').addEventListener('change', checkAnswerProvided);
            document.getElementById('current-question-block').addEventListener('input', checkAnswerProvided);
        }, 400);
    }
    function checkAnswerProvided() {
        let isProvided = false; const qBlock = document.getElementById('current-question-block'); const qType = qBlock.dataset.type;
        switch (qType) {
            case 'radio': isProvided = !!qBlock.querySelector('input[name="answer"]:checked'); break;
            case 'checkbox': isProvided = qBlock.querySelectorAll('input[name="answer"]:checked').length > 0; break;
            case 'fill-in': isProvided = qBlock.querySelector('.fill-in-input').value.trim() !== ''; break;
            case 'match': isProvided = qBlock.querySelector('.source-list').children.length === 0; break;
            case 'sequence': isProvided = qBlock.querySelectorAll('.sequence-item.selected').length === quizData[currentQuestionIndex].steps.length; break;
        }
        document.getElementById('next-btn').disabled = !isProvided;
    }
    function setupDragAndDrop() {
        document.querySelectorAll('.dnd-item').forEach(d => { d.addEventListener('dragstart', () => { d.classList.add('dragging'); if (d.parentElement.classList.contains('drop-zone')) d.parentElement.classList.remove('has-item'); }); d.addEventListener('dragend', () => d.classList.remove('dragging')); });
        document.querySelectorAll('.drop-zone').forEach(z => {
            z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('drag-over'); });
            z.addEventListener('dragleave', () => z.classList.remove('drag-over'));
            z.addEventListener('drop', e => { e.preventDefault(); z.classList.remove('drag-over'); const d = document.querySelector('.dragging'); if (d && !z.querySelector('.dnd-item')) { z.appendChild(d); z.classList.add('has-item'); checkAnswerProvided(); } });
        });
    }
    function setupSequence() { document.querySelectorAll('.sequence-item').forEach(i => i.addEventListener('click', () => { if (!i.classList.contains('selected')) { i.classList.add('selected'); i.dataset.order = sequenceCounter++; checkAnswerProvided(); } })); }
    function resetSequence() { document.querySelectorAll('.sequence-item.selected').forEach(item => { item.classList.remove('selected'); delete item.dataset.order; }); sequenceCounter = 1; checkAnswerProvided(); }
    function collectAnswer() {
        const q = quizData[currentQuestionIndex];
        switch (q.type) {
            case 'radio': userAnswers[currentQuestionIndex] = document.querySelector('input[name="answer"]:checked')?.value || null; break;
            case 'checkbox': userAnswers[currentQuestionIndex] = Array.from(document.querySelectorAll('input[name="answer"]:checked')).map(cb => cb.value); break;
            case 'fill-in': userAnswers[currentQuestionIndex] = document.querySelector('.fill-in-input').value.trim(); break;
            case 'match': const m = []; document.querySelectorAll('.drop-zone').forEach(z => { const i = z.querySelector('.dnd-item'); if (i) m.push(`${i.dataset.id}-${z.dataset.targetId}`); }); userAnswers[currentQuestionIndex] = m.sort(); break;
            case 'sequence': const i = Array.from(document.querySelectorAll('.sequence-item.selected')); i.sort((a,b) => a.dataset.order - b.dataset.order); userAnswers[currentQuestionIndex] = i.map(item => item.dataset.id); break;
        }
    }
    function nextQuestion() { questionTimings.push(new Date() - questionStartTime); collectAnswer(); currentQuestionIndex++; if (currentQuestionIndex < quizData.length) renderQuestion(); else finishQuiz(); }
    function updateProgressBar() { document.getElementById('progress-bar-inner').style.width = `${((currentQuestionIndex) / quizData.length) * 100}%`; }
    function finishQuiz() {
        clearInterval(timerInterval); let conditionalScore = 0;
        const results = quizData.map((q, i) => {
            const uA = userAnswers[i], cA = q.answer;
            if (q.type === 'checkbox') {
                if (!uA || uA.length === 0) return 'incorrect';
                if (uA.length === q.options.length) return 'all-selected';
                const incorrectlySelected = uA.filter(ans => !cA.includes(ans)).length;
                if (incorrectlySelected > 0) return 'incorrect';
                const correctlySelected = uA.filter(ans => cA.includes(ans)).length;
                conditionalScore += correctlySelected;
                return correctlySelected === cA.length ? 'correct' : 'partial';
            } else {
                let isCorrect = Array.isArray(cA) ? JSON.stringify([...(uA || [])].sort()) === JSON.stringify([...cA].sort()) : (uA || '').toLowerCase() === cA.toLowerCase();
                if (isCorrect) conditionalScore += q.points;
                return isCorrect ? 'correct' : 'incorrect';
            }
        });
        const grade = convertTo12PointScale(conditionalScore, maxPossiblePoints);
        saveAttempt(studentData.fullName, studentData.group, conditionalScore, maxPossiblePoints, grade);
        document.getElementById('quiz-container').style.display = 'none'; document.getElementById('results-container').style.display = 'block';
        displayResults(results, conditionalScore, grade);
    }
    function convertTo12PointScale(s, m) { if (m === 0) return 0; const p = (s/m)*100; if (p>=92) return 12; if (p>=83) return 11; if (p>=75) return 10; if (p>=67) return 9; if (p>=58) return 8; if (p>=50) return 7; if (p>=42) return 6; if (p>=34) return 5; if (p>=25) return 4; if (p>=17) return 3; if (p>=9) return 2; if (p>0) return 1; return 0; }
    function displayResults(results, score, grade) {
        let totalTime = questionTimings.reduce((a,b) => a+b, 0);
        document.getElementById('time-taken').innerHTML = `⏱️ Загальний час: <strong>${String(Math.floor(totalTime/60000)).padStart(2,'0')}:${String(Math.floor((totalTime%60000)/1000)).padStart(2,'0')}</strong>`;
        document.getElementById('answer-grid').innerHTML = results.map((res, i) => `<span class="grid-${res}">${i+1}</span>`).join('');
        document.getElementById('conditional-score').innerText = `Умовні бали: ${score} / ${maxPossiblePoints}`;
        let currentGrade = 0;
        const counter = setInterval(() => { document.getElementById('final-grade').innerText = `${currentGrade}`; if (currentGrade >= grade) clearInterval(counter); currentGrade++; }, 100);
        const statusBadge = document.getElementById('status-badge');
        if (grade >= 4) { statusBadge.innerHTML = 'Зараховано'; statusBadge.className = 'status-badge status-passed'; }
        else { statusBadge.innerHTML = 'Не зараховано'; statusBadge.className = 'status-badge status-failed'; }
        renderTimeChart(); displayHistory(studentData.fullName);
    }
    function renderTimeChart() {
        const c = document.getElementById('chart-container'), maxTime = Math.max(...questionTimings);
        c.innerHTML = `<h4>Час на відповідь (секунди)</h4>
            <div class="chart-area">${questionTimings.map((t, i) => `<div class="chart-bar" style="height:${maxTime>0?(t/maxTime)*100:0}%;animation-delay:${i*50}ms"><span class="tooltip">${(t/1000).toFixed(1)} с</span></div>`).join('')}</div>
            <div class="chart-labels">${questionTimings.map((_, i) => `<span>${i+1}</span>`).join('')}</div>`;
    }
    function saveAttempt(n, g, s, m, gr) {
        const h = JSON.parse(localStorage.getItem('quizHistory_BVP105A')) || [];
        h.push({ name:n, group:g, score:`${s}/${m}`, grade:gr, date:new Date().toLocaleString('uk-UA') });
        localStorage.setItem('quizHistory_BVP105A', JSON.stringify(h));
    }
    function displayHistory(n) {
        const h = JSON.parse(localStorage.getItem('quizHistory_BVP105A')) || [];
        const uH = h.filter(a => a.name.toLowerCase() === n.toLowerCase());
        if (uH.length > 1) {
            document.getElementById('history-container').style.display = 'block';
            document.getElementById('history-body').innerHTML = uH.slice(0, -1).reverse().map(a => `<tr><td>${a.date}</td><td>${a.score}</td><td>${a.grade}</td></tr>`).join('');
        }
    }
    function saveReportAsHTML() {
        const btn = document.getElementById('save-report-btn'); btn.innerText = 'Зберігаємо...'; btn.disabled = true;
        const styles = document.querySelector('style').innerHTML;
        const report = document.getElementById('results-container').outerHTML;
        const header = document.querySelector('.header').outerHTML;
        const html = `<!DOCTYPE html><html lang="uk"><head><meta charset="UTF-8"><title>Звіт: ${studentData.fullName}</title><style>${styles}</style><style>body{align-items:flex-start}.test-wrapper{margin:20px auto}#results-container{display:block !important}.button-container{display:none !important}</style></head><body><div class="test-wrapper">${header}<main class="content">${report}</main></div></body></html>`;
        const blob = new Blob([html], { type: 'text/html' });
        const link = document.createElement('a');
        const date = new Date(), dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        const name = studentData.fullName.replace(/[^a-z0-я]/gi, '_').toLowerCase();
        link.download = `zvit-${name}-${dateStr}.html`;
        link.href = URL.createObjectURL(blob);
        link.click(); URL.revokeObjectURL(link.href);
        setTimeout(() => { btn.innerText = 'Зберегти звіт'; btn.disabled = false; }, 1000);
    }
</script>
</body>
</html>