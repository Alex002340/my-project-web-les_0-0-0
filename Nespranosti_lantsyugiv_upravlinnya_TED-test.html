<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивне ДЗ: Несправності ланцюгів керування</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        :root {
            --bg-light: #e6e7ee;
            --text-color: #37474f;
            --correct: #4caf50;
            --incorrect: #f44336;
            --partial: #ffc107;
            --accent: #546e7a;
            --border-color: rgba(84, 110, 122, 0.2);
            --shadow-dark: 5px 5px 10px rgba(55, 71, 79, 0.2);
            --shadow-light: -5px -5px 10px rgba(255, 255, 255, 0.9);
            --shadow-inset-dark: inset 4px 4px 8px rgba(55, 71, 79, 0.15);
            --shadow-inset-light: inset -4px -4px 8px rgba(255, 255, 255, 1);
            --action-gradient: linear-gradient(135deg, #78909c, #546e7a);
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            color: var(--text-color);
            margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .test-wrapper {
            width: 100%; max-width: 800px; background: var(--bg-light);
            border-radius: 20px;
            box-shadow: var(--shadow-dark), var(--shadow-light); overflow: hidden;
        }
        .header { padding: 25px 30px; text-align: center; border-bottom: 1px solid var(--border-color); }
        h1, h2, h3, h4 { margin: 0; padding: 0; color: var(--accent); }
        h1 { font-size: 1.8rem; font-weight: 800; }
        h1 span { color: var(--text-color); }
        h2 { font-size: 1.5rem; margin-bottom: 25px; }
        .content { padding: 30px; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; }
        .is-changing { opacity: 0; transform: translateY(15px); }
        #user-info-form .form-group { margin: 0 auto 20px auto; max-width: 400px; }
        #user-info-form label { display: block; margin-bottom: 8px; font-weight: 600; }
        #user-info-form input { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: var(--bg-light); box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); }
        .current-date { text-align: center; margin-bottom: 25px; color: #555; }
        .button-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .btn {
            display: inline-block; background: var(--action-gradient);
            color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem;
            font-weight: 700; cursor: pointer; text-align: center; box-sizing: border-box;
            box-shadow: var(--shadow-dark), var(--shadow-light);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn:hover { transform: translateY(-4px) scale(1.02); }
        .btn:active { transform: translateY(1px); box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; transform: none; }
        .save-btn { background: #00796b; }

        #quiz-container { display: none; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #timer { font-weight: 700; font-size: 1.1rem; }
        .progress-bar { width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 25px; overflow: hidden; box-shadow: inset 2px 2px 5px rgba(55, 71, 79, 0.1); }
        .progress-bar-inner { height: 100%; width: 0%; background: linear-gradient(135deg, #78909c, #455a64); border-radius: 5px; transition: width 0.5s ease-in-out; }
        .question-points { background: var(--accent); color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; }
        .answers { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
        @media (min-width: 600px) { .answers { grid-template-columns: repeat(2, 1fr); } }
        .answers label {
            position: relative; overflow: hidden; display: flex; align-items: center; gap: 15px; padding: 14px;
            border-radius: 14px; margin-bottom: 0; cursor: pointer;
            background-color: var(--bg-light); box-shadow: var(--shadow-dark), var(--shadow-light);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .answers label:hover { transform: translateY(-3px); }
        .answers input { display: none; }
        .answers label:has(input:checked) { box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); background-color: #d1d9e6; }
        .dnd-container { display: flex; flex-direction: column; gap: 20px; }
        @media (min-width: 600px) { .dnd-container { flex-direction: row; } }
        .dnd-source-column, .dnd-target-column { flex: 1; }
        .dnd-item { display: block; padding: 10px; cursor: grab; user-select: none; background-color: var(--bg-light); border-radius: 8px; margin-bottom: 10px; box-shadow: var(--shadow-dark), var(--shadow-light); transition: all 0.2s ease; }
        .dnd-item.dragging { opacity: 0.5; }
        .drop-zone { min-height: 40px; border: 2px dashed var(--border-color); border-radius: 8px; transition: all 0.2s ease; padding: 5px; box-shadow: inset 2px 2px 5px rgba(55, 71, 79, 0.1); }
        .drop-zone.drag-over { background-color: rgba(84, 110, 122, 0.1); }
        .sequence-click-item { position: relative; background-color: var(--bg-light); border-radius: 14px; padding: 14px; margin-bottom: 12px; cursor: pointer; user-select: none; box-shadow: var(--shadow-dark), var(--shadow-light); transition: all 0.2s ease; }
        .sequence-click-item:hover { transform: translateY(-2px); }
        .sequence-click-item.numbered { background-color: rgba(84, 110, 122, 0.1); cursor: not-allowed; box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); }
        .sequence-number { position: absolute; top: 50%; left: 14px; transform: translateY(-50%) scale(0); width: 30px; height: 30px; border-radius: 50%; background: rgba(84, 110, 122, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .sequence-click-item.numbered .sequence-number { transform: translateY(-50%) scale(1); }
        .sequence-text { margin-left: 45px; }
        .reset-sequence-btn { display: inline-block; background: transparent; color: var(--accent); padding: 10px 20px; border: 2px solid var(--accent); border-radius: 10px; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; margin-top: 10px; }
        .reset-sequence-btn:hover { background: var(--accent); color: white; }
        
        #results-container { display: none; }
        .results-layout { display: flex; flex-direction: column-reverse; gap: 30px; }
        @media (min-width: 768px) { .results-layout { flex-direction: row; } }
        .results-left-column { flex: 2; }
        .results-right-column { flex: 1; text-align: center; background: var(--bg-light); padding: 20px; border-radius: 15px; box-shadow: var(--shadow-dark), var(--shadow-light); }
        .answer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; margin-bottom: 30px; }
        .answer-grid span { display: flex; justify-content: center; align-items: center; height: 35px; border-radius: 6px; color: white; font-weight: 700; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.2); opacity: 0; transform: scale(0.5); animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop-in { to { opacity: 1; transform: scale(1); } }
        .grid-correct { background: var(--correct); } .grid-incorrect { background: var(--incorrect); } .grid-partial { background: var(--partial); }
        .results-legend { display: flex; justify-content: center; gap: 20px; margin-top: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color-box { width: 18px; height: 18px; border-radius: 4px; }
        .legend-text { font-size: 0.9rem; color: #555; }
        .legend-correct { background-color: var(--correct); }
        .legend-partial { background-color: var(--partial); }
        .legend-incorrect { background-color: var(--incorrect); }
        #time-chart-container { background: var(--bg-light); border-radius: 10px; padding: 15px; box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); margin-top: 15px; }
        .time-chart { display: flex; align-items: flex-end; gap: 5px; height: 150px; border-bottom: 2px solid #ccc; padding-top: 10px; }
        .time-bar { flex: 1; background: var(--action-gradient); border-radius: 5px 5px 0 0; position: relative; box-shadow: var(--shadow-dark); transform: scaleY(0); transform-origin: bottom; animation: grow-up 0.5s ease-out forwards; }
        @keyframes grow-up { to { transform: scaleY(1); } }
        .bar-label { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
        .final-score .score-value { font-size: 4.5rem; font-weight: 800; color: var(--accent); }
        .status-badge { font-size: 1.8rem; font-weight: 800; padding: 20px; margin: 20px 0; border-radius: 15px; display: flex; align-items: center; justify-content: center; gap: 15px; animation: status-pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: white; box-shadow: var(--shadow-dark); }
        @keyframes status-pop-in { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .status-passed { background: linear-gradient(45deg, #4caf50, #388e3c); }
        .status-failed { background: linear-gradient(45deg, #f44336, #d32f2f); }
        #history-table { width: 100%; border-collapse: collapse; background: var(--bg-light); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-dark), var(--shadow-light); margin-top: 15px; }
        #history-table th, #history-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #history-table th { background-color: rgba(84, 110, 122, 0.1); }
    </style>
</head>
<body>
<div class="test-wrapper">
    <header class="header"><h1>Домашнє завдання: <span>Несправності ланцюгів керування</span></h1></header>
    <main class="content" id="content-area">
        <div id="user-info-form"></div>
        <div id="quiz-container"></div>
        <div id="results-container"></div>
    </main>
</div>

<script>
    const fullUserInfoHTML = `<h2>Введіть ваші дані</h2><form onsubmit="startQuiz(event)"><div class="form-group"><label for="fullName">Прізвище, Ім'я</label><input type="text" id="fullName" required></div><div class="form-group"><label for="group">Група</label><input type="text" id="group" required></div><p class="current-date" id="current-date"></p><div class="button-container"><button type="submit" class="btn">Почати</button></div></form>`;
    const fullQuizContainerHTML = `<div class="quiz-header"><span id="question-counter"></span><span id="timer">00:00</span></div><div class="progress-bar"><div class="progress-bar-inner"></div></div><div id="question-display"></div><div class="button-container"><button id="next-btn" class="btn" onclick="nextQuestion()" disabled>Наступне питання</button></div>`;
    const fullResultsContainerHTML = `<h2>Результати тестування</h2><div class="results-layout"><div class="results-left-column"><h3 class="user-name"></h3><p id="result-group"></p><p id="time-taken"></p><h4>Ваші відповіді:</h4><div class="results-legend"><div class="legend-item"><span class="legend-color-box legend-correct"></span><span class="legend-text">Правильно</span></div><div class="legend-item"><span class="legend-color-box legend-partial"></span><span class="legend-text">Частково</span></div><div class="legend-item"><span class="legend-color-box legend-incorrect"></span><span class="legend-text">Неправильно</span></div></div><div class="answer-grid" id="answer-grid"></div><h4>Час на питання (сек):</h4><div id="time-chart-container"><div class="time-chart" id="time-chart"></div></div><div id="history-container"></div></div><aside class="results-right-column"><div class="final-score"><h4>Ваша оцінка (10-бальна):</h4><div class="score-value" id="final-grade">0</div><p id="raw-score"></p></div><div id="status-badge"></div><div class="button-container" style="flex-direction: column;"><button class="btn" onclick="repeatTest()">Повторити тест</button><button id="save-report-btn" class="btn save-btn" onclick="saveReportAsHTML()">Зберегти звіт</button></div></aside></div>`;

    document.getElementById('user-info-form').innerHTML = fullUserInfoHTML;
    document.getElementById('quiz-container').innerHTML = fullQuizContainerHTML;
    document.getElementById('results-container').innerHTML = fullResultsContainerHTML;

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('current-date').innerText = `Сьогодні: ${new Date().toLocaleString('uk-UA')}`;
    });
    
    const quizData = [
        // Part 1 (10 питань * 1 бал = 10 балів)
        { points: 1, type: "radio", question: "Що є першочерговою дією машиніста, якщо електропоїзд не рушає з місця, а сигнальна лампа не горить?", options: ["Перевірити наявність напруги в контактній мережі та в низьковольтних ланцюгах.", "Негайно розібрати контролер машиніста.", "Відключити несправний вагон за допомогою РУМ.", "Викликати допоміжний локомотив."], answer: "Перевірити наявність напруги в контактній мережі та в низьковольтних ланцюгах." },
        { points: 1, type: "radio", question: "На електропоїзді ЕР2 допоміжні машини працюють, але поїзд не розганяється при переведенні рукоятки з 1-го положення. В яких проводах, найімовірніше, стався обрив?", options: ["В проводі 22.", "В проводах 1 або 10.", "В проводі 3.", "В проводі 9."], answer: "В проводах 1 або 10." },
        { points: 1, type: "radio", question: "Яка ознака на амперметрі моторного вагона вказує на те, що його реостатний контролер не обертається під час розгону?", options: ["Стрілка амперметра постійно знаходиться на нулі.", "Стрілка амперметра \"зашкалює\".", "Відсутні різкі відхилення (кидки) стрілки при переході з позиції на позицію.", "Стрілка амперметра коливається з високою частотою."], answer: "Відсутні різкі відхилення (кидки) стрілки при переході з позиції на позицію." },
        { points: 1, type: "radio", question: "Що може бути причиною короткочасного зникнення напруги в контактній мережі (лампа РН гасне і знову загоряється) при спробі рушання?", options: ["Несправність акумуляторної батареї.", "Перегоряння запобіжника Пр8.", "Одночасне рушання кількох електропоїздів на одній фідерній ділянці.", "Обрив проводу 3."], answer: "Одночасне рушання кількох електропоїздів на одній фідерній ділянці." },
        { points: 1, type: "radio", question: "На електропоїзді ЕР2Р при встановленні рукоятки в робоче положення поїзд не розганяється, а лампа ЛКіГ не гасне. Який прилад на непрацюючому вагоні покаже відсутність тяги?", options: ["Вольтметр.", "Манометр.", "Амперметр.", "Лічильник електроенергії."], answer: "Амперметр." },
        { points: 1, type: "radio", question: "На електропоїзді ЕР9Е світиться лампа ЛК, але поїзд не рушає. Що з переліченого є найімовірнішою причиною?", options: ["Надто висока напруга в контактній мережі.", "Поганий контакт в ланцюзі проводу 11 або 3 в контролері машиніста.", "Несправність вентиля приводу реостатного контролера.", "Перегоряння запобіжника Пр19."], answer: "Поганий контакт в ланцюзі проводу 11 або 3 в контролері машиніста." },
        { points: 1, type: "radio", question: "Який простий діагностичний крок може виконати машиніст на ЕР2Р, щоб локалізувати несправність, коли не збирається тяговий режим (ЛКіГ не гасне)?", options: ["Перевести рукоятку в 2-ге або 3-тє гальмівне положення.", "Натиснути кнопку «Блінкери».", "Вимкнути та увімкнути вимикач ВУ.", "Перевірити всі запобіжники в шафі."], answer: "Перевести рукоятку в 2-ге або 3-тє гальмівне положення." },
        { points: 1, type: "radio", question: "Який апарат на несправному моторному вагоні ЕР2Р відключають на лінії, якщо неможливо швидко знайти причину відмови тяги?", options: ["Роз'єднувач ланцюга управління РУМ.", "Вимикач ВУ.", "Запобіжник Пр19.", "Реле контролю безпеки РКБ."], answer: "Роз'єднувач ланцюга управління РУМ." },
        { points: 1, type: "radio", question: "На електропоїзді ЕР9Е при наборі позицій поїзд рухається, але лампа ЛК не гасне. Яку кнопку має натиснути машиніст, щоб визначити непрацюючий вагон?", options: ["«Повернення захисту».", "«Блінкери».", "Кнопку безпеки КнБ.", "«Вимкнення РТ»."], answer: "«Блінкери»." },
        { points: 1, type: "radio", question: "На електропоїзді ЕР2 не вмикаються контактори ослаблення збудження. До чого це призведе?", options: ["До повної відмови тяги.", "До підвищеної швидкості руху.", "До зниженої швидкості руху, що не відповідає положенню рукоятки.", "До спрацювання захисту на тяговій підстанції."], answer: "До зниженої швидкості руху, що не відповідає положенню рукоятки." },
        { points: 3, type: "checkbox", question: "На електропоїзді ЕР2Р не збирається схема тяги. Виберіть два запобіжники, перегоряння яких може бути причиною цієї несправності.", options: ["Пр8.", "Пр19.", "Пр17.", "Пр31."], answer: ["Пр19.", "Пр31."] },
        // ВИПРАВЛЕНО: Додано дві неправильні відповіді
        { points: 5, type: "checkbox", question: "Виберіть три можливі причини, чому на електропоїзді ЕР2Р поїзд не приходить в рух (лампа ЛКіГ не горить).", options: ["Розімкнений стан реле РКБ або КВХ.", "Перегоряння запобіжника Пр19.", "Низький тиск у гальмівній магістралі.", "Вимкнене положення ключа ЕПК.", "Обрив проводу 3.", "Перегоряння запобіжника Пр17.", "Спрацювання реле перевантаження (РП).", "Занизька напруга в контактній мережі."], answer: ["Розімкнений стан реле РКБ або КВХ.", "Вимкнене положення ключа ЕПК.", "Перегоряння запобіжника Пр17."] },
        { points: 6, type: "match", question: "Встановіть відповідність між моделлю електропоїзда та характерною для неї несправністю або діагностичною дією.", items: ["ЕР2", "ЕР2Р", "ЕР9Е", "ЕР9Е (додатково)"], definitions: ["Натискання кнопки «Блінкери» для визначення вагона з несправністю.", "Поганий контакт у ланцюзі проводу 11 або 3 в контролері.", "Обрив проводу 1 або 10 при працюючих допоміжних машинах.", "Переведення рукоятки в гальмівне положення для перевірки ланцюгів реверсора та ЛКГ."], answer: ["ЕР2-Обрив проводу 1 або 10 при працюючих допоміжних машинах.", "ЕР2Р-Переведення рукоятки в гальмівне положення для перевірки ланцюгів реверсора та ЛКГ.", "ЕР9Е-Поганий контакт у ланцюзі проводу 11 або 3 в контролері.", "ЕР9Е (додатково)-Натискання кнопки «Блінкери» для визначення вагона з несправністю."] },
        { points: 4, type: "sequence", question: "Розташуйте у логічній послідовності кроки перевірки на ЕР2Р, якщо поїзд не рушає і лампа ЛКіГ не горить.", items: ["Перевірити цілісність запобіжника Пр17.", "Вимкнути і знову увімкнути вимикач ВУ.", "Натиснути кнопку «Повернення захисту»."], answer: ["Вимкнути і знову увімкнути вимикач ВУ.", "Натиснути кнопку «Повернення захисту».", "Перевірити цілісність запобіжника Пр17."] },
        { points: 2, type: "radio", question: "Якщо на ЕР2Р лампа ЛКіГ не гасне, машиніст переводить рукоятку в гальмівне положення. Яке твердження про результати цієї перевірки є правильним?", options: ["Якщо лампа погасла, це вказує на несправність у спільних ланцюгах реверсора та ЛКГ.", "Якщо лампа НЕ погасла, це означає, що несправність знаходиться в ланцюгах, які використовуються тільки в тяговому режимі.", "Якщо лампа ПОГАСЛА, це підтверджує справність спільних ланцюгів і вказує на проблему в суто тягових ланцюгах (напр., ЛК).", "Цей діагностичний прийом не дає інформації про місцезнаходження несправності."], answer: "Якщо лампа ПОГАСЛА, це підтверджує справність спільних ланцюгів і вказує на проблему в суто тягових ланцюгах (напр., ЛК)." },
    ];

    let maxPossiblePoints = quizData.reduce((sum, q) => sum + q.points, 0);
    let currentQuestionIndex = 0, userAnswers = [], questionTimings = [], questionStartTime, timerInterval, studentData = {};

    function isLocalStorageAvailable() { try { const storage = window.localStorage, x = '__storage_test__'; storage.setItem(x, x); storage.removeItem(x); return true; } catch (e) { return false; } }
    function loadHistory() { if (!isLocalStorageAvailable()) return; const historyContainer = document.getElementById('history-container'); try { const history = JSON.parse(localStorage.getItem('quizHistory_faults')) || []; if (history.length <= 1) return; const previousAttempts = history.slice(0, -1).sort((a, b) => new Date(b.date) - new Date(a.date)); let tableHTML = `<h4 style="margin-top: 30px;">Історія попередніх спроб</h4><table id="history-table"><tr><th>Дата і час</th><th>Бали</th><th>Оцінка</th></tr>`; previousAttempts.forEach(item => { const date = new Date(item.date).toLocaleString('uk-UA'); const score = `${Number(item.score).toFixed(1)} / ${maxPossiblePoints}`; const grade10 = item.grade ?? '-'; tableHTML += `<tr><td>${date}</td><td>${score}</td><td>${grade10}</td></tr>`; }); tableHTML += '</table>'; historyContainer.innerHTML = tableHTML; } catch (e) { console.error("Помилка завантаження історії:", e); localStorage.removeItem('quizHistory_faults'); } }
    function saveHistory(score, grade10) { if (!isLocalStorageAvailable()) return; try { const history = JSON.parse(localStorage.getItem('quizHistory_faults')) || []; history.push({ date: new Date().toISOString(), score: score, grade: grade10 }); localStorage.setItem('quizHistory_faults', JSON.stringify(history)); } catch (e) { console.error("Помилка збереження історії:", e); } }

    function startQuiz(e) { e.preventDefault(); studentData.fullName = document.getElementById('fullName').value; studentData.group = document.getElementById('group').value; document.getElementById('user-info-form').style.display = 'none'; document.getElementById('quiz-container').style.display = 'block'; startTimer(); renderQuestion(); }
    function startTimer() { let startTime = Date.now(); timerInterval = setInterval(() => { const elapsed = Date.now() - startTime; const minutes = String(Math.floor(elapsed / 60000)).padStart(2, '0'); const seconds = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, '0'); document.getElementById('timer').innerText = `${minutes}:${seconds}`; }, 1000); }

    function renderQuestion() {
        const contentArea = document.querySelector('.content');
        contentArea.classList.add('is-changing');
        questionStartTime = Date.now();
        setTimeout(() => {
            const q = quizData[currentQuestionIndex];
            const display = document.getElementById('question-display');
            let html = `<div id="current-question-block" data-type="${q.type}">
                <p style="font-size: 1.2rem; font-weight: 600;">${q.question} <span class="question-points">${q.points} ${q.points === 1 ? 'бал' : (q.points > 1 && q.points < 5 ? 'бали' : 'балів')}</span></p>`;
            switch (q.type) {
                case 'radio': html += `<div class="answers">${q.options.map(o => `<label><input type="radio" name="answer" value="${o}"><span class="answer-text">${o}</span></label>`).join('')}</div>`; break;
                case 'checkbox': html += `<div class="answers">${q.options.map(o => `<label><input type="checkbox" name="answer" value="${o}"><span class="answer-text">${o}</span></label>`).join('')}</div>`; break;
                case 'match':
                    const items = [...q.items].sort(() => Math.random() - 0.5);
                    html += `<div class="dnd-container"><div class="dnd-source-column"><h4>Модель:</h4><div class="source-list">${items.map(i => `<div class="dnd-item" draggable="true" data-id="${i}">${i}</div>`).join('')}</div></div><div class="dnd-target-column">${q.definitions.map(d => `<div><h4>Несправність / Дія:</h4><div class="drop-zone" data-target-id="${d}"><p style="padding:5px;color:#777;">${d}</p></div></div>`).join('')}</div></div>`;
                    break;
                case 'sequence':
                    html += `<div class="sequence-click-container">${[...q.items].sort(() => Math.random() - 0.5).map(i => `<div class="sequence-click-item" data-text="${i}"><span class="sequence-number"></span><span class="sequence-text">${i}</span></div>`).join('')}</div><div style="text-align: center;"><button class="reset-sequence-btn">Скинути</button></div>`;
                    break;
            }
            display.innerHTML = html + '</div>';
            if (q.type === 'match') setupDragAndDrop();
            if (q.type === 'sequence') setupSequenceClick();
            document.getElementById('question-counter').innerText = `Питання ${currentQuestionIndex + 1} з ${quizData.length}`;
            document.querySelector('.progress-bar-inner').style.width = `${((currentQuestionIndex) / quizData.length) * 100}%`;
            document.getElementById('next-btn').innerText = (currentQuestionIndex === quizData.length - 1) ? 'Завершити' : 'Наступне питання';
            document.getElementById('next-btn').disabled = true;
            contentArea.classList.remove('is-changing');
            document.getElementById('current-question-block').addEventListener('input', checkAnswerProvided);
            document.getElementById('current-question-block').addEventListener('click', checkAnswerProvided);
        }, 400);
    }
    
    function checkAnswerProvided() {
        const qBlock = document.getElementById('current-question-block');
        if (!qBlock) return;
        let isProvided = false;
        switch(qBlock.dataset.type) {
            case 'radio': isProvided = !!qBlock.querySelector('input:checked'); break;
            case 'checkbox': isProvided = qBlock.querySelectorAll('input:checked').length > 0; break;
            case 'match': isProvided = qBlock.querySelector('.source-list').children.length === 0; break;
            case 'sequence': isProvided = qBlock.querySelectorAll('.numbered').length === quizData[currentQuestionIndex].items.length; break;
        }
        document.getElementById('next-btn').disabled = !isProvided;
    }

    function setupDragAndDrop() {
        let draggedItem = null;
        document.querySelectorAll('.dnd-item').forEach(d => {
            d.addEventListener('dragstart', e => { draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); });
            d.addEventListener('dragend', () => { draggedItem.classList.remove('dragging'); draggedItem = null; checkAnswerProvided(); });
        });
        document.querySelectorAll('.drop-zone').forEach(z => {
            z.addEventListener('dragover', e => e.preventDefault());
            z.addEventListener('drop', e => { e.preventDefault(); if (z.children.length <= 1) { z.prepend(draggedItem); } });
        });
    }

    function setupSequenceClick() {
        const container = document.querySelector('.sequence-click-container');
        container.querySelectorAll('.sequence-click-item').forEach(item => item.addEventListener('click', () => { if (item.classList.contains('numbered')) return; item.classList.add('numbered'); item.dataset.order = container.querySelectorAll('.numbered').length; item.querySelector('.sequence-number').innerText = item.dataset.order; checkAnswerProvided(); }));
        document.querySelector('.reset-sequence-btn').addEventListener('click', () => { container.querySelectorAll('.sequence-click-item').forEach(item => { item.classList.remove('numbered'); delete item.dataset.order; item.querySelector('.sequence-number').innerText = ''; }); checkAnswerProvided(); });
    }

    function collectAnswer() {
        const qBlock = document.getElementById('current-question-block');
        if (!qBlock) return;
        switch(qBlock.dataset.type) {
            case 'radio': userAnswers[currentQuestionIndex] = qBlock.querySelector('input:checked')?.value || null; break;
            case 'checkbox': userAnswers[currentQuestionIndex] = Array.from(qBlock.querySelectorAll('input:checked')).map(cb => cb.value); break;
            case 'match': const matches = []; qBlock.querySelectorAll('.drop-zone').forEach(z => { if(z.querySelector('.dnd-item')) matches.push(`${z.querySelector('.dnd-item').dataset.id}-${z.dataset.targetId}`); }); userAnswers[currentQuestionIndex] = matches.sort(); break;
            case 'sequence': userAnswers[currentQuestionIndex] = Array.from(qBlock.querySelectorAll('.sequence-click-item')).sort((a, b) => a.dataset.order - b.dataset.order).map(i => i.dataset.text); break;
        }
    }

    function nextQuestion() { questionTimings.push(Date.now() - questionStartTime); collectAnswer(); currentQuestionIndex++; if (currentQuestionIndex < quizData.length) renderQuestion(); else finishQuiz(); }

    function finishQuiz() {
        clearInterval(timerInterval);
        let totalScore = 0;
        const results = quizData.map((q, i) => {
            const userAns = userAnswers[i];
            let questionScore = 0, resultType = 'incorrect';
            switch (q.type) {
                case 'radio': if (userAns === q.answer) { questionScore = q.points; resultType = 'correct'; } break;
                case 'checkbox':
                    if (userAns?.length) {
                        const correctCount = userAns.filter(ans => q.answer.includes(ans)).length;
                        const incorrectCount = userAns.length - correctCount;
                        const scorePerItem = q.points / q.answer.length;
                        const calculatedScore = Math.max(0, correctCount * scorePerItem - incorrectCount * scorePerItem);
                        questionScore = calculatedScore;
                        if (incorrectCount === 0 && correctCount === q.answer.length) { resultType = 'correct'; }
                        else if (questionScore > 0) resultType = 'partial';
                    } break;
                case 'match': 
                    if (userAns?.length) { 
                        const correctMatches = userAns.filter(m => q.answer.sort().includes(m)).length; 
                        questionScore = (correctMatches / q.items.length) * q.points; 
                        if (correctMatches === q.items.length) resultType = 'correct'; 
                        else if (questionScore > 0) resultType = 'partial'; 
                    } break;
                case 'sequence': 
                    if (userAns?.length === q.answer.length && userAns.every((item, idx) => item === q.answer[idx])) { 
                        questionScore = q.points; resultType = 'correct'; 
                    } break;
            }
            totalScore += questionScore;
            return resultType;
        });
        const finalGrade = Math.round((totalScore / maxPossiblePoints) * 10);
        saveHistory(totalScore, finalGrade);
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        displayResults(results, totalScore, finalGrade);
    }

    function displayResults(results, score, grade10) {
        let totalTime = questionTimings.reduce((a, b) => a + b, 0);
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.querySelector('.user-name').innerText = studentData.fullName;
        resultsContainer.querySelector('#result-group').innerText = `Група: ${studentData.group}`;
        resultsContainer.querySelector('#time-taken').innerHTML = `⏱️ Загальний час: <strong>${String(Math.floor(totalTime/60000)).padStart(2,'0')}:${String(Math.floor((totalTime%60000)/1000)).padStart(2,'0')}</strong>`;
        
        resultsContainer.querySelector('#answer-grid').innerHTML = results.map((res, i) =>
            `<span class="grid-${res}" style="animation-delay: ${i * 50}ms;">${i + 1}</span>`
        ).join('');

        const finalGradeEl = resultsContainer.querySelector('#final-grade');
        let currentGrade = 0;
        finalGradeEl.innerText = 0;
        if (grade10 > 0) {
            const counter = setInterval(() => {
                currentGrade++;
                finalGradeEl.innerText = currentGrade;
                if (currentGrade >= grade10) clearInterval(counter);
            }, 800 / (grade10 || 1));
        }

        resultsContainer.querySelector('#raw-score').innerHTML = `(Набрано <strong>${score.toFixed(1)}</strong> із <strong>${maxPossiblePoints}</strong> балів)`;
        const statusBadge = resultsContainer.querySelector('#status-badge');
        if (grade10 >= 4) { statusBadge.innerHTML = 'Зараховано'; statusBadge.className = 'status-badge status-passed'; }
        else { statusBadge.innerHTML = 'Не зараховано'; statusBadge.className = 'status-badge status-failed'; }

        const timeChart = document.getElementById('time-chart');
        const maxTime = Math.max(...questionTimings, 1);
        if(timeChart) {
            timeChart.innerHTML = questionTimings.map((time, index) => {
                const height = maxTime > 0 ? (time / maxTime) * 100 : 0;
                const timeInSeconds = (time / 1000).toFixed(1);
                return `<div class="time-bar" style="height: ${height}%; animation-delay: ${index * 50}ms;" title="Питання ${index + 1}: ${timeInSeconds} сек."><span class="bar-label">${timeInSeconds}с</span></div>`;
            }).join('');
        }
        loadHistory();
    };

    function repeatTest() { window.location.reload(); }
    
    function saveReportAsHTML() {
        const btn = document.getElementById('save-report-btn');
        btn.innerText = 'Зберігаємо...';
        btn.disabled = true;
        const styles = Array.from(document.styleSheets).map(s => { try { return Array.from(s.cssRules).map(r => r.cssText).join('\n'); } catch (e) { return ''; }}).join('\n');
        const reportContent = document.getElementById('results-container').innerHTML;
        const headerContent = document.querySelector('.header').outerHTML;
        const html = `<!DOCTYPE html><html lang="uk"><head><meta charset="UTF-8"><title>Звіт: ${studentData.fullName}</title><style>${styles}</style><style>body{align-items:flex-start}.test-wrapper{margin:20px auto}#results-container{display:block !important}.button-container{display:none !important}</style></head><body><div class="test-wrapper">${headerContent}<main class="content">${reportContent}</main></div></body></html>`;
        const blob = new Blob([html], { type: 'text/html' });
        const link = document.createElement('a');
        const dateStr = new Date().toISOString().slice(0, 10);
        const name = studentData.fullName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        link.download = `zvit-nespravnosti-${name}-${dateStr}.html`;
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);
        setTimeout(() => { btn.innerText = 'Зберегти звіт'; btn.disabled = false; }, 1000);
    };
</script>
</body>
</html>