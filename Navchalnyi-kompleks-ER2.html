<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ù–∞–≤—á–∞–ª—å–Ω–∏–π –ö–æ–º–ø–ª–µ–∫—Å –ï–†2 (Final V5)</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --accent: #0ea5e9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: #334155;
            
            /* --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –í–ò–°–û–¢–ò –ü–ê–ù–ï–õ–Ü --- */
            /* 60dvh = 60% –¥–∏–Ω–∞–º—ñ—á–Ω–æ—ó –≤–∏—Å–æ—Ç–∏ –µ–∫—Ä–∞–Ω—É (—Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω–∏) */
            --panel-height-mobile: 60dvh; 
            
            --handle-height: 24px;       
            --header-height-mobile: 40px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        *:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--bg-dark);
            font-family: 'Inter', system-ui, sans-serif;
            color: var(--text-main);
            touch-action: none;
            position: fixed; /* –ó–∞–ø–æ–±—ñ–≥–∞—î —Å–∫—Ä–æ–ª—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –Ω–∞ iOS */
        }

        /* --- MENU VIEW --- */
        .view-section { 
            display: none; 
            width: 100%; height: 100%; 
            position: absolute; top: 0; left: 0;
            flex-direction: column; 
            z-index: 10;
        }
        .view-section.active { display: flex; z-index: 20; }

        #menu-view {
            background: radial-gradient(circle at top right, #1e293b 0%, #0f172a 60%);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 40px 20px;
        }

        .menu-container { max-width: 1200px; width: 100%; margin: 0 auto; padding-bottom: 80px; }

        .app-header { text-align: center; margin-bottom: 60px; animation: fadeIn 0.8s ease-out; }
        .app-header h1 {
            font-size: 2.5rem; margin: 0 0 10px 0;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        .app-header p { color: var(--text-dim); font-size: 1.1rem; }
        
        .category-section { margin-bottom: 40px; animation: slideUp 0.6s ease-out forwards; }
        .category-title { 
            font-size: 1.4rem; color: var(--accent); margin-bottom: 20px; 
            display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; 
        }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }

        .module-card {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px; padding: 25px; cursor: pointer;
            transition: all 0.2s ease;
            display: flex; flex-direction: column; height: 100%; min-height: 220px;
            position: relative; overflow: hidden;
        }
        .module-card:hover { background: rgba(255, 255, 255, 0.06); border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        .module-card::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: var(--primary); transform: scaleX(0); transform-origin: left; transition: transform 0.3s ease; }
        .module-card:hover::after { transform: scaleX(1); }
        .module-card.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(0.8); pointer-events: none; }
        
        .card-icon { font-size: 2rem; margin-bottom: 15px; }
        .card-title { font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 10px; }
        .card-desc { font-size: 0.95rem; color: var(--text-dim); line-height: 1.5; flex-grow: 1; margin-bottom: 15px; }
        .card-badge { align-self: flex-start; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: rgba(59, 130, 246, 0.15); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.3); }

        /* === SIMULATOR LAYOUT === */
        
        .diagram-area {
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0; 
            width: 100%; height: 100%;
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            cursor: grab;
            z-index: 1;
            touch-action: none;
            overflow: hidden; 
        }
        .diagram-area:active { cursor: grabbing; }

        .control-panel {
            position: fixed;
            z-index: 100;
            background: var(--bg-panel);
            box-shadow: 0 -5px 40px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @media (min-width: 1001px) {
            .control-panel {
                top: 0; right: 0; bottom: 0;
                width: 450px;
                border-left: 1px solid var(--border);
                transform: translateX(0);
            }
            .control-panel.collapsed { transform: translateX(100%); }
            .panel-handle { display: none; }
        }

        .panel-header {
            padding: 15px 25px; border-bottom: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.95);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        
        .btn-menu {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-dim);
            padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s;
        }
        .btn-menu:hover { color: white; border-color: white; background: rgba(255,255,255,0.1); }

        .panel-content { 
            flex: 1; padding: 25px; overflow-y: auto;
            scrollbar-width: thin; scrollbar-color: var(--border) transparent; 
        }

        .step-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 15px; color: white; line-height: 1.2; }
        .description { line-height: 1.6; color: #cbd5e1; margin-bottom: 25px; font-size: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 20px;}

        .tech-box {
            background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border);
            border-left: 3px solid var(--accent); border-radius: 6px;
            padding: 20px; margin-bottom: 20px;
        }
        .tech-label { font-size: 0.75rem; color: var(--accent); font-weight: 800; text-transform: uppercase; display: block; margin-bottom: 12px; letter-spacing: 0.5px; }
        .tech-text { font-size: 0.9rem; color: #94a3b8; line-height: 1.6; }
        
        .specs-table { margin-top: 15px; width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; background: rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden; }
        .specs-table td { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .specs-table tr:last-child td { border-bottom: none; }
        .spec-key { color: var(--text-dim); }
        .spec-val { color: var(--accent); text-align: right; }

        .fault-wrapper { display: flex; justify-content: center; width: 100%; margin-bottom: 20px; }
        .btn-fault-inline {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            background: rgba(239, 68, 68, 0.15); 
            border: 1px dashed var(--danger);
            color: #fca5a5;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.2s;
            animation: fadeIn 0.5s;
        }
        .btn-fault-inline:hover { background: rgba(239, 68, 68, 0.25); color: white; border-style: solid; }
        .btn-fault-inline span { font-size: 1rem; }
        .btn-fault-inline.active { background: var(--danger); color: white; border-style: solid; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4); }

        .fault-card {
            background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px; padding: 15px; margin-bottom: 20px; display: none;
            animation: slideIn 0.3s ease;
        }
        .fault-card.visible { display: block; }
        .fault-header { color: var(--danger); font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; display: flex; gap: 8px; align-items: center;}
        .fault-text { font-size: 0.9rem; color: #fca5a5; line-height: 1.5; }

        .panel-actions {
            padding: 20px; border-top: 1px solid var(--border); 
            display: flex; gap: 12px; align-items: center; justify-content: space-between;
            background: var(--bg-panel);
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        
        .action-btn { 
            padding: 12px 20px; 
            border: none; border-radius: 8px; 
            font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; 
            flex: 0 0 auto;
        }

        .btn-prev { background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 12px 16px; }
        .btn-prev:hover:not(:disabled) { color: white; border-color: white; }
        .btn-prev:disabled { opacity: 0.3; cursor: default; }

        .btn-next { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); min-width: 120px; text-align: center; }
        .btn-next:hover { background: var(--primary-hover); transform: translateY(-1px); }
        
        .btn-choice { flex: 1; border: 1px solid var(--border); background: rgba(255,255,255,0.02); color: white; min-width: 80px;}
        .btn-choice:hover { background: rgba(255,255,255,0.05); }
        .btn-choice.success { border-color: rgba(16, 185, 129, 0.5); color: var(--success); }
        .btn-choice.warning { border-color: rgba(245, 158, 11, 0.5); color: var(--warning); }

        .zoom-controls { 
            position: absolute; 
            bottom: 30px; 
            right: 30px;
            left: auto;
            display: flex; gap: 8px; z-index: 10; 
        }
        .zoom-btn { 
            background: var(--bg-panel); color: white; border: 1px solid var(--border); 
            width: 44px; height: 44px; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); user-select: none;
        }
        .zoom-btn:active { background: var(--primary); border-color: var(--primary); transform: scale(0.95); }

        /* SVG Styles */
        .svg-container { width: 100%; height: 100%; will-change: transform; display: block; }
        #viewport { transform-origin: 0 0; }
        .connector { stroke: #475569; stroke-width: 2; fill: none; transition: stroke 0.4s, stroke-width 0.4s, filter 0.4s; }
        .connector.active { stroke: var(--primary); stroke-width: 4; filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.6)); }
        .wire-label { font-family: 'JetBrains Mono'; font-size: 10px; fill: #64748b; text-anchor: middle; background: #0f172a; transition: fill 0.3s; }
        .connector.active + .wire-label, .wire-label.active { fill: var(--accent); font-weight: bold; }
        .node-group { cursor: pointer; transition: opacity 0.3s; }
        .node-group:hover { opacity: 0.9; }
        .node-box { fill: var(--bg-panel); stroke: var(--border); stroke-width: 2; transition: all 0.3s; }
        .node-group:hover .node-box { stroke: var(--text-dim); fill: #2d3748; }
        .node-group.active .node-box { stroke: var(--primary); fill: #1e293b; stroke-width: 3; filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.3)); animation: pulseNode 2s infinite; }
        @keyframes pulseNode { 0% { stroke-opacity: 1; } 50% { stroke-opacity: 0.6; } 100% { stroke-opacity: 1; } }
        .node-group.error .node-box { stroke: var(--danger); filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.4)); animation: none; }
        .node-title { font-weight: 700; font-size: 13px; fill: var(--text-main); text-anchor: middle; pointer-events: none; }
        .node-sub { font-family: 'JetBrains Mono'; font-size: 10px; fill: var(--text-dim); text-anchor: middle; pointer-events: none; }

        /* === MOBILE OVERLAY === */
        @media (max-width: 1000px) {
            .control-panel {
                bottom: 0; left: 0; right: 0; top: auto;
                width: 100%;
                height: var(--panel-height-mobile); 
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
                border-radius: 20px 20px 0 0;
                transform: translateY(0);
            }

            .control-panel.collapsed {
                transform: translateY(calc(100% - var(--handle-height)));
            }

            .panel-handle {
                display: flex; width: 100%; height: var(--handle-height);
                justify-content: center; align-items: center; cursor: pointer;
                background: #1e293b; 
                position: absolute; top: 0; left: 0;
                flex-shrink: 0;
                border-radius: 12px 12px 0 0;
                z-index: 150;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            }
            .panel-handle::before { content: ''; width: 40px; height: 4px; background: rgba(255,255,255,0.4); border-radius: 3px; }

            .panel-content { 
                margin-top: var(--handle-height); 
                height: calc(100% - var(--handle-height)); 
                padding-bottom: 40px; 
            }
            .panel-header { display: none; }
            
            .zoom-controls { 
                top: 20px; right: 20px; bottom: auto; left: auto; 
                flex-direction: column; 
            }
            .panel-actions { gap: 10px; }
            .action-btn { font-size: 0.9rem; padding: 12px; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- MENU -->
    <section id="menu-view" class="view-section active">
        <div class="menu-container">
            <header class="app-header">
                <h1>–ù–ê–í–ß–ê–õ–¨–ù–ò–ô –ö–û–ú–ü–õ–ï–ö–° –ï–†2</h1>
                <p>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ñ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∏ –¥–ª—è –ª–æ–∫–æ–º–æ—Ç–∏–≤–Ω–∏—Ö –±—Ä–∏–≥–∞–¥</p>
            </header>

            <div class="category-section">
                <h2 class="category-title"><span>‚ö°</span> –ï–õ–ï–ö–¢–†–ò–ß–ù–Ü –°–•–ï–ú–ò</h2>
                <div class="cards-grid">
                    <div class="module-card" onclick="startSimulator('er2_hv')">
                        <div class="card-icon">üîå</div>
                        <div class="card-title">–°—Ö–µ–º–∞ –ø—ñ–¥–Ω—è—Ç—Ç—è —Å—Ç—Ä—É–º–æ–ø—Ä–∏–π–º–∞—á–∞</div>
                        <div class="card-desc">–ü–æ–≤–Ω–∏–π —Ü–∏–∫–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–∞ –∑–∞–ø—É—Å–∫—É: –ê–ë, –ø–Ω–µ–≤–º–∞—Ç–∏–∫–∞, –í–£, –î—ñ–Ω–∞–º–æ—Ç–æ—Ä —Ç–∞ –ö–æ–º–ø—Ä–µ—Å–æ—Ä.</div>
                        <div class="card-badge">–î–û–°–¢–£–ü–ù–û</div>
                    </div>
                </div>
            </div>
            
            <div class="category-section">
                <h2 class="category-title"><span>üí®</span> –ü–ù–ï–í–ú–ê–¢–ò–ß–ù–Ü –°–•–ï–ú–ò</h2>
                <div class="cards-grid">
                    <div class="module-card disabled">
                        <div class="card-icon">üöÇ</div>
                        <div class="card-title">–ì–∞–ª—å–º—ñ–≤–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</div>
                        <div class="card-desc">–†–æ–±–æ—Ç–∞ –∫—Ä–∞–Ω–∞ –º–∞—à–∏–Ω—ñ—Å—Ç–∞ ‚Ññ394, –ï–ü–¢ —Ç–∞ –ø–æ–≤—ñ—Ç—Ä–æ—Ä–æ–∑–ø–æ–¥—ñ–ª—å–Ω–∏–∫—ñ–≤.</div>
                        <div class="card-badge" style="background:rgba(255,255,255,0.1); color:#94a3b8; border-color:transparent;">–í –†–û–ó–†–û–ë–¶–Ü</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SIMULATOR -->
    <section id="sim-view" class="view-section">
        <div class="diagram-area" id="diagramWrapper">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoom(1.2)" title="–ó–±—ñ–ª—å—à–∏—Ç–∏">+</button>
                <button class="zoom-btn" onclick="zoom(0.8)" title="–ó–º–µ–Ω—à–∏—Ç–∏">-</button>
                <button class="zoom-btn" onclick="resetZoom()" title="–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏">‚õ∂</button>
            </div>
            <div id="svg-host"></div>
        </div>

        <aside class="control-panel" id="controlPanel">
            <div class="panel-handle" onclick="togglePanel()"></div>
            <div class="panel-header">
                <button class="btn-menu" onclick="exitToMenu()">‚Üê –ú–ï–ù–Æ</button>
                <span style="color:#94a3b8; font-size:0.75rem; font-weight:bold; letter-spacing:1px;" id="module-header">–ú–û–î–£–õ–¨</span>
            </div>

            <div class="panel-content" id="panel-content">
                <div id="step-title" class="step-title"></div>
                <div id="step-desc" class="description"></div>
                
                <div id="tech-box" class="tech-box">
                    <span class="tech-label">–¢–ï–•–ù–Ü–ß–ù–ê –î–û–í–Ü–î–ö–ê</span>
                    <div id="tech-text" class="tech-text"></div>
                </div>

                <div id="fault-container" class="fault-wrapper"></div>

                <div id="fault-card" class="fault-card">
                    <div class="fault-header"><span>‚ö†Ô∏è</span> –ú–û–ñ–õ–ò–í–ê –ù–ï–°–ü–†–ê–í–ù–Ü–°–¢–¨</div>
                    <div id="fault-text" class="fault-text"></div>
                </div>
            </div>

            <div class="panel-actions" id="actions-container">
                <!-- Buttons injected by JS -->
            </div>
        </aside>
    </section>

    <!-- TEMPLATES -->
    <template id="tpl-er2_hv">
        <svg class="svg-container" viewBox="0 -50 1000 2200" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrow" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
                    <path d="M0,0 L0,6 L9,3 z" fill="#475569" />
                </marker>
                <marker id="arrow-active" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
                    <path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" />
                </marker>
            </defs>
            <g id="viewport">
                <!-- WIRES -->
                <path id="path-0" d="M500,80 L500,130" class="connector" marker-end="url(#arrow)"/>
                <path id="path-1" d="M500,190 L500,240" class="connector" marker-end="url(#arrow)"/>
                
                <path id="path-2-yes" d="M500,320 L500,380" class="connector" marker-end="url(#arrow)"/>
                <path id="path-2-no" d="M580,280 L760,280 L760,320" class="connector" marker-end="url(#arrow)"/>
                <path id="path-aux-back" d="M760,380 L760,420 L500,420" class="connector" style="stroke-dasharray: 6,4;" marker-end="url(#arrow)"/>
                
                <path id="path-3" d="M500,450 L500,500" class="connector" marker-end="url(#arrow)"/>
                <path id="path-4" d="M500,560 L500,610" class="connector" marker-end="url(#arrow)"/>
                <path id="path-5" d="M500,690 L500,740" class="connector" marker-end="url(#arrow)"/>
                <path id="path-vu-out" d="M500,820 L500,870" class="connector"/>
                
                <path id="path-6-dk" d="M500,870 L300,870 L300,920" class="connector" marker-end="url(#arrow)"/>
                <path id="path-6-mk" d="M500,870 L700,870 L700,920" class="connector" marker-end="url(#arrow)"/>
                <path id="path-wire27" d="M300,1050 L300,1100 L700,1100 L700,1050" class="connector" style="stroke-dasharray: 6,4;" />

                <!-- LABELS -->
                <rect x="420" y="1085" width="160" height="20" rx="4" fill="#0f172a" />
                <text x="500" y="1100" fill="#f59e0b" font-family="JetBrains Mono" font-size="11" text-anchor="middle" font-weight="bold">–ü–†–û–í–Ü–î 27</text>
                <text x="535" y="850" class="wire-label">–ü–†. 22</text>
                
                <text x="515" y="340" fill="#10b981" font-size="12" font-weight="bold" font-family="JetBrains Mono">–¢–ê–ö</text>
                <text x="595" y="270" fill="#f59e0b" font-size="12" font-weight="bold" font-family="JetBrains Mono">–ù–Ü</text>

                <!-- NODES -->
                <g class="node-group" id="node-start" data-step="0"><rect x="400" y="20" width="200" height="60" rx="30" class="node-box"/><text x="500" y="55" class="node-title">–ü–û–ß–ê–¢–û–ö –ó–ú–Ü–ù–ò</text></g>
                <g class="node-group" id="node-vb" transform="translate(500, 160)" data-step="1"><rect x="-120" y="-30" width="240" height="60" rx="6" class="node-box"/><text x="0" y="-5" class="node-title">1. –†–£–ë–ò–õ–¨–ù–ò–ö –ê–ë</text><text x="0" y="15" class="node-sub">–ü—Ä. 15 (+50–í)</text></g>
                <g class="node-group" id="node-air" transform="translate(500, 280)" data-step="2"><polygon points="0,-40 90,0 0,40 -90,0" class="node-box"/><text x="0" y="-5" class="node-title">–¢–ò–°–ö –ü–û–í–Ü–¢–†–Ø</text><text x="0" y="15" class="node-sub">> 5.0 –∞—Ç–º?</text></g>
                <g class="node-group" id="node-aux" transform="translate(760, 350)" data-step="3"><rect x="-90" y="-30" width="180" height="60" rx="6" class="node-box" style="stroke: var(--warning); stroke-dasharray: 4,2;"/><text x="0" y="-5" class="node-title" fill="#f59e0b">–î–û–ü. –ö–û–ú–ü–†–ï–°–û–†</text><text x="0" y="15" class="node-sub">–ü—Ä. 13</text></g>
                <g class="node-group" id="node-btn" transform="translate(500, 420)" data-step="4"><rect x="-120" y="-30" width="240" height="60" rx="6" class="node-box"/><text x="0" y="-5" class="node-title">2. –ö–ù–û–ü–ö–ê</text><text x="0" y="15" class="node-sub">"–°—Ç—Ä—É–º–æ–ø—Ä–∏–π–º–∞—á –ø—ñ–¥–Ω—è—Ç–∏–π"</text></g>
                <g class="node-group" id="node-mech" transform="translate(500, 530)" data-step="5"><rect x="-100" y="-30" width="200" height="60" rx="4" class="node-box" style="stroke-dasharray: 2,2;"/><text x="0" y="-5" class="node-title">–ö–õ–ê–ü–ê–ù –ö–õ–ü-–ü</text><text x="0" y="15" class="node-sub">–ü—Ä. 25 -> –ü–Ω–µ–≤–º–∞—Ç–∏–∫–∞</text></g>
                <g class="node-group" id="node-volts" transform="translate(500, 650)" data-step="6"><polygon points="0,-40 90,0 0,40 -90,0" class="node-box"/><text x="0" y="-5" class="node-title">–ù–ê–ü–†–£–ì–ê –ö–°</text><text x="0" y="15" class="node-sub">3000 –í –Ñ?</text></g>
                <g class="node-group" id="node-vu" transform="translate(500, 780)" data-step="7"><rect x="-80" y="-40" width="160" height="80" rx="6" class="node-box" style="stroke-width: 3px;"/><text x="0" y="-5" class="node-title">3. –í–£</text><text x="0" y="15" class="node-sub">–ü—Ä. 15 -> –ü—Ä. 22</text></g>
                <g class="node-group" id="node-dk" transform="translate(300, 990)" data-step="8"><rect x="-100" y="-70" width="200" height="140" rx="8" class="node-box"/><text x="0" y="-30" font-size="24" fill="var(--accent)" font-weight="bold" text-anchor="middle">DK</text><text x="0" y="10" class="node-title">–î–ò–ù–ê–ú–û–¢–û–†</text><text x="0" y="30" class="node-sub">–ú–ö-1 (–ü—Ä. 21)</text></g>
                <g class="node-group" id="node-mk" transform="translate(700, 990)" data-step="8"><rect x="-100" y="-70" width="200" height="140" rx="8" class="node-box"/><text x="0" y="-30" font-size="24" fill="var(--success)" font-weight="bold" text-anchor="middle">EK</text><text x="0" y="10" class="node-title">–ö–û–ú–ü–†–ï–°–û–†</text><text x="0" y="30" class="node-sub">–ú–ö-2 (–ü—Ä. 27)</text></g>
            </g>
        </svg>
    </template>

<script>
    const modules = {
        er2_hv: {
            id: 'er2_hv',
            title: '–í–∏—Å–æ–∫–æ–≤–æ–ª—å—Ç–Ω—ñ –ª–∞–Ω—Ü—é–≥–∏',
            tplId: 'tpl-er2_hv',
            steps: [
                {
                    id: 'node-start',
                    title: "–ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω–∏ (–¢–ë)",
                    desc: "<strong>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–µ–∑–ø–µ–∫–∏ –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º —Ä–æ–±—ñ—Ç:</strong><br>–ö–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ –∑–∞–±–æ—Ä–æ–Ω—è—î—Ç—å—Å—è –ø—ñ–¥—ñ–π–º–∞—Ç–∏ —Å—Ç—Ä—É–º–æ–ø—Ä–∏–π–º–∞—á, —è–∫—â–æ:<br>1. –ü—ñ–¥ –≤–∞–≥–æ–Ω–∞–º–∏ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –ª—é–¥–∏.<br>2. –ù–∞ –¥–∞—Ö—É –≤–∞–≥–æ–Ω—ñ–≤ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è —Å—Ç–æ—Ä–æ–Ω–Ω—ñ –ø—Ä–µ–¥–º–µ—Ç–∏ –∞–±–æ –ª—é–¥–∏.<br>3. –í—ñ–¥–∫—Ä–∏—Ç—ñ –≤–∏—Å–æ–∫–æ–≤–æ–ª—å—Ç–Ω—ñ —à–∞—Ñ–∏ –∞–±–æ —è—â–∏–∫–∏ –ø—ñ–¥–≤–∞–≥–æ–Ω–Ω–æ–≥–æ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è.",
                    tech: "–ü–æ–¥–∞—á–∞ –Ω–∞–ø—Ä—É–≥–∏ 3000–í –Ω–∞ –ø–æ—ó–∑–¥ —î –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ—é –¥–ª—è –∂–∏—Ç—Ç—è –æ–ø–µ—Ä–∞—Ü—ñ—î—é. –ú–∞—à–∏–Ω—ñ—Å—Ç –ø–æ–≤–∏–Ω–µ–Ω –ø–æ–¥–∞—Ç–∏ –∑–≤—É–∫–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª (–æ–¥–∏–Ω –¥–æ–≤–≥–∏–π) –ø–µ—Ä–µ–¥ –ø—ñ–¥–Ω—è—Ç—Ç—è–º —Å—Ç—Ä—É–º–æ–ø—Ä–∏–π–º–∞—á–∞.",
                    paths: [], 
                    nextStep: 1
                },
                {
                    id: 'node-vb',
                    title: "1. –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –ê–ë",
                    desc: "–£–≤—ñ–º–∫–Ω—ñ—Ç—å —Ä—É–±–∏–ª—å–Ω–∏–∫ –∞–∫—É–º—É–ª—è—Ç–æ—Ä–Ω–æ—ó –±–∞—Ç–∞—Ä–µ—ó (–ê–ë) —É —à–∞—Ñ—ñ –Ω–∏–∑—å–∫–æ–≤–æ–ª—å—Ç–Ω–æ–≥–æ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è.",
                    tech: "–ü—Ä–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—ñ —Ä—É–±–∏–ª—å–Ω–∏–∫–∞ –∑–∞–º–∏–∫–∞—î—Ç—å—Å—è –ª–∞–Ω—Ü—é–≥ –≤—ñ–¥ ¬´–ø–ª—é—Å–∞¬ª –∞–∫—É–º—É–ª—è—Ç–æ—Ä–Ω–æ—ó –±–∞—Ç–∞—Ä–µ—ó —á–µ—Ä–µ–∑ –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫ <strong>–ü-1 (160–ê)</strong> –Ω–∞ –ø–æ—ó–∑–Ω–∏–π –ø—Ä–æ–≤—ñ–¥ <strong>‚Ññ15</strong> (+50–í). –ü—Ä–æ–≤—ñ–¥ 15 –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –≤–µ—Å—å –ø–æ—ó–∑–¥ —ñ –∂–∏–≤–∏—Ç—å –≤—Å—ñ –ª–∞–Ω—Ü—é–≥–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≤ ¬´—Ö–æ–ª–æ–¥–Ω–æ–º—É¬ª —Å—Ç–∞–Ω—ñ.",
                    paths: ['path-0'],
                    fault: {
                        text: "<strong>–ù–µ–º–∞—î –Ω–∞–ø—Ä—É–≥–∏ (—Ç–µ–º–Ω–æ –≤ —à–∞—Ñ—ñ):</strong><br>1. –ó–≥–æ—Ä—ñ–≤ –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫ –ü-1 (160–ê).<br>2. –ì–ª–∏–±–æ–∫–∏–π —Ä–æ–∑—Ä—è–¥ –ê–ë (–Ω–∏–∂—á–µ 40–í).<br>3. –í—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ–Ω—Ç–∞–∫—Ç –Ω–∞ –Ω–æ–∂–∞—Ö —Ä—É–±–∏–ª—å–Ω–∏–∫–∞."
                    },
                    nextStep: 2
                },
                {
                    id: 'node-air',
                    title: "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏—Å–∫—É",
                    desc: "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –º–∞–Ω–æ–º–µ—Ç—Ä –Ω–∞–ø—ñ—Ä–Ω–æ—ó –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ. –¢–∏—Å–∫ –º–∞—î –±—É—Ç–∏ <strong>–±—ñ–ª—å—à–µ 5.0 –∫–≥/—Å–º¬≤</strong>.",
                    tech: "–ü–∞–Ω—Ç–æ–≥—Ä–∞—Ñ –ï–†2 –ø—ñ–¥–Ω—ñ–º–∞—î—Ç—å—Å—è —Å—Ç–∏—Å–Ω–µ–Ω–∏–º –ø–æ–≤—ñ—Ç—Ä—è–º. –ü—Ä—É–∂–∏–Ω–∏ –ø—Ä–∞—Ü—é—é—Ç—å –Ω–∞ –æ–ø—É—Å–∫–∞–Ω–Ω—è. –Ø–∫—â–æ —Ç–∏—Å–∫ —É —Ä–µ–∑–µ—Ä–≤—É–∞—Ä—ñ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ–π, –∫–ª–∞–ø–∞–Ω –ö–õ–ü-–ü –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è, –∞–ª–µ –∑—É—Å–∏–ª–ª—è –ø–æ–≤—ñ—Ç—Ä—è –Ω–µ –≤–∏—Å—Ç–∞—á–∏—Ç—å –¥–ª—è —Å—Ç–∏—Å–∫–∞–Ω–Ω—è –æ–ø—É—Å–∫–∞—é—á–∏—Ö –ø—Ä—É–∂–∏–Ω.",
                    paths: ['path-0', 'path-1'],
                    choices: [
                        { text: "–¢–ê–ö (>5.0)", nextStep: 4, class: "success" },
                        { text: "–ù–Ü (<5.0)", nextStep: 3, class: "warning" }
                    ],
                    fault: {
                        text: "<strong>–¢–∏—Å–∫ < 5.0 –∞—Ç–º:</strong><br>–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–∞—Å–æ–±–∏ –¥–æ–ø–æ–º—ñ–∂–Ω–æ—ó –ø—ñ–¥–∫–∞—á–∫–∏."
                    }
                },
                {
                    id: 'node-aux',
                    title: "–ü—ñ–¥–∫–∞—á–∫–∞ –ø–æ–≤—ñ—Ç—Ä—è",
                    desc: "–ü—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –ø–æ–≤—ñ—Ç—Ä—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:<br>1. <strong>–î–æ–ø–æ–º—ñ–∂–Ω–∏–π –∫–æ–º–ø—Ä–µ—Å–æ—Ä</strong> (–µ–ª–µ–∫—Ç—Ä–∏—á–Ω–∏–π, —Ç—É–º–±–ª–µ—Ä —É —à–∞—Ñ—ñ).<br>2. <strong>–†—É—á–Ω–∏–π –Ω–∞—Å–æ—Å</strong> (–º–µ—Ö–∞–Ω—ñ—á–Ω–∏–π, –¥–ª—è –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö —Å–∏—Ç—É–∞—Ü—ñ–π).",
                    tech: "<strong>–î–æ–ø. –∫–æ–º–ø—Ä–µ—Å–æ—Ä:</strong> –ñ–∏–≤–∏—Ç—å—Å—è –≤—ñ–¥ –ø—Ä–æ–≤–æ–¥—É 13 (+50–í). –í–º–∏–∫–∞—î—Ç—å—Å—è —Ç—É–º–±–ª–µ—Ä–æ–º, –≤–∏–º–∏–∫–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ–ª–µ —Ç–∏—Å–∫—É –ø—Ä–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—ñ 5.0 –∞—Ç–º.<br><strong>–†—É—á–Ω–∏–π –Ω–∞—Å–æ—Å:</strong> –ö–∞—á–∞—î –ø–æ–≤—ñ—Ç—Ä—è –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ —Ü–∏–ª—ñ–Ω–¥—Ä. –ü–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –û–ë–û–í'–Ø–ó–ö–û–í–û –ø–µ—Ä–µ–∫—Ä–∏—Ç–∏ —Ç—Ä–∏—Ö–æ–¥–æ–≤–∏–π –∫—Ä–∞–Ω.",
                    paths: ['path-0', 'path-1', 'path-2-no', 'path-aux-back'],
                    specs: {
                        "–î–æ–ø. –∫–æ–º–ø—Ä–µ—Å–æ—Ä": "–ï–ö-1",
                        "–ñ–∏–≤–ª–µ–Ω–Ω—è": "50–í (–ü—Ä. 13)",
                        "–ó–∞–ø–æ–±—ñ–∂–Ω–∏–∫": "30–ê"
                    },
                    fault: {
                        text: "<strong>–ö–æ–º–ø—Ä–µ—Å–æ—Ä –ø—Ä–∞—Ü—é—î, —Ç–∏—Å–∫ –Ω–µ —Ä–æ—Å—Ç–µ:</strong><br>1. –í–∏—Ç—ñ–∫ –ø–æ–≤—ñ—Ç—Ä—è –≤ –º–∞–≥—ñ—Å—Ç—Ä–∞–ª—ñ.<br>2. –ù–µ –ø–µ—Ä–µ–∫—Ä–∏—Ç—ñ –∫—Ä–∞–Ω–∏ –ø—Ä–æ–¥—É–≤–∫–∏.<br><strong>–ù–µ –≤–º–∏–∫–∞—î—Ç—å—Å—è:</strong> –ó–≥–æ—Ä—ñ–≤ –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫ 30–ê."
                    },
                    nextStep: 4
                },
                {
                    id: 'node-btn',
                    title: "2. –ö–Ω–æ–ø–∫–∞ '–ü—ñ–¥–Ω—è—Ç–∏'",
                    desc: "–ù–∞ –ø—É–ª—å—Ç—ñ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ¬´–°—Ç—Ä—É–º–æ–ø—Ä–∏–π–º–∞—á –ø—ñ–¥–Ω—è—Ç–∏–π¬ª.",
                    tech: "–°—Ç—Ä—É–º –≤—ñ–¥ –ø—Ä–æ–≤–æ–¥–∞ 15 —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç –∑–∞—Ö–∏—Å—Ç—É ¬´–°—Ç—Ä—É–º–æ–ø—Ä–∏–π–º–∞—á—ñ¬ª (Q19) —Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∏ –∫–Ω–æ–ø–∫–∏ –Ω–∞–¥—Ö–æ–¥–∏—Ç—å —É –ø—Ä–æ–≤—ñ–¥ <strong>‚Ññ25</strong>. –ü—Ä–æ–≤—ñ–¥ 25 –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –º—ñ–∂–≤–∞–≥–æ–Ω–Ω—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è (–ñ–æ–∫—Å–∏) –¥–æ –≤—Å—ñ—Ö –º–æ—Ç–æ—Ä–Ω–∏—Ö –≤–∞–≥–æ–Ω—ñ–≤ –ø–æ—ó–∑–¥–∞.",
                    paths: ['path-0', 'path-1', 'path-2-yes'],
                    fault: {
                        text: "<strong>–ù–µ–º–∞—î —Ä–µ–∞–∫—Ü—ñ—ó:</strong><br>1. –í–∏–±–∏–≤ –∞–≤—Ç–æ–º–∞—Ç Q19.<br>2. –û–±—Ä–∏–≤ –ø—Ä–æ–≤–æ–¥–∞ 25 —É –∂–æ–∫—Å–∞—Ö.<br>3. –£–≤—ñ–º–∫–Ω–µ–Ω–æ –∫–Ω–æ–ø–∫—É –í–£ (—Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ü–†–£)."
                    },
                    nextStep: 5
                },
                {
                    id: 'node-mech',
                    title: "–ö–ª–∞–ø–∞–Ω –ö–õ–ü-–ü",
                    desc: "–ù–∞ –∫–æ–∂–Ω–æ–º—É –º–æ—Ç–æ—Ä–Ω–æ–º—É –≤–∞–≥–æ–Ω—ñ —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –µ–ª–µ–∫—Ç—Ä–æ–ø–Ω–µ–≤–º–∞—Ç–∏—á–Ω–∏–π –≤–µ–Ω—Ç–∏–ª—å –ö–õ–ü-–ü.",
                    tech: "–ö–æ—Ç—É—à–∫–∞ –≤–µ–Ω—Ç–∏–ª—è –æ—Ç—Ä–∏–º—É—î –∂–∏–≤–ª–µ–Ω–Ω—è –≤—ñ–¥ –ø—Ä–æ–≤–æ–¥–∞ 25. –Ø–∫—ñ—Ä –≤—Ç—è–≥—É—î—Ç—å—Å—è, –≤—ñ–¥–∫—Ä–∏–≤–∞—é—á–∏ –¥–æ—Å—Ç—É–ø –ø–æ–≤—ñ—Ç—Ä—è –∑ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤ —Ü–∏–ª—ñ–Ω–¥—Ä —Å—Ç—Ä—É–º–æ–ø—Ä–∏–π–º–∞—á–∞. –ü–æ—Ä—à–µ–Ω—å –ø–µ—Ä–µ–º—ñ—â—É—î—Ç—å—Å—è, —Å–∏—Å—Ç–µ–º–∞ –≤–∞–∂–µ–ª—ñ–≤ –ø—ñ–¥–Ω—ñ–º–∞—î –ª–∏–∂—É –¥–æ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ –ø—Ä–æ–≤–æ–¥—É.",
                    paths: ['path-0', 'path-1', 'path-2-yes', 'path-3'],
                    specs: {
                        "–¢–∏–ø –∫–ª–∞–ø–∞–Ω–∞": "–ö–õ–ü-101",
                        "–ù–∞–ø—Ä—É–≥–∞ –∫–æ—Ç—É—à–∫–∏": "50 –í",
                        "–¢–∏—Å–∫": "3.5 - 5.0 –∞—Ç–º"
                    },
                    fault: {
                        text: "<strong>–®–∏–ø—ñ–Ω–Ω—è –ø–æ–≤—ñ—Ç—Ä—è:</strong> –ü—Ä–æ—Ä–∏–≤ –≥—É–º–æ–≤–æ—ó –º–∞–Ω–∂–µ—Ç–∏ —Ü–∏–ª—ñ–Ω–¥—Ä–∞.<br><strong>–ú–µ—Ö–∞–Ω—ñ–∫–∞:</strong> –ó–∞–∫–ª–∏–Ω—é–≤–∞–Ω–Ω—è —à–∞—Ä–Ω—ñ—Ä—ñ–≤ —á–µ—Ä–µ–∑ –æ–±–ª–µ–¥–µ–Ω—ñ–Ω–Ω—è."
                    },
                    nextStep: 6
                },
                {
                    id: 'node-volts',
                    title: "–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–ø—Ä—É–≥–∏",
                    desc: "–ö—ñ–ª–æ–≤–æ–ª—å—Ç–º–µ—Ç—Ä –Ω–∞ –ø—É–ª—å—Ç—ñ –ø–æ–≤–∏–Ω–µ–Ω –ø–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞–ø—Ä—É–≥—É –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ—ó –º–µ—Ä–µ–∂—ñ (3.0 ‚Äî 3.6 –∫–í).",
                    tech: "–í–∏—Å–æ–∫–∞ –Ω–∞–ø—Ä—É–≥–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —à–ª—è—Ö: –°—Ç—Ä—É–º–æ–ø—Ä–∏–π–º–∞—á ‚Üí –î—Ä–æ—Å–µ–ª—å —Ä–∞–¥—ñ–æ–ø–µ—Ä–µ—à–∫–æ–¥ ‚Üí –ì–æ–ª–æ–≤–Ω–∏–π —Ä–æ–∑'—î–¥–Ω—É–≤–∞—á ‚Üí –í–≤—ñ–¥–Ω–∏–π —ñ–∑–æ–ª—è—Ç–æ—Ä ‚Üí –í–∏—Å–æ–∫–æ–≤–æ–ª—å—Ç–Ω–∞ —à–∞—Ñ–∞. –ù–∞—è–≤–Ω—ñ—Å—Ç—å –Ω–∞–ø—Ä—É–≥–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è –¥—ñ–ª—å–Ω–∏–∫–æ–º –Ω–∞–ø—Ä—É–≥–∏ –∫—ñ–ª–æ–≤–æ–ª—å—Ç–º–µ—Ç—Ä–∞ —Ç–∞ –†–µ–ª–µ –ù–∞–ø—Ä—É–≥–∏ (–†–ù).",
                    paths: ['path-0', 'path-1', 'path-2-yes', 'path-3', 'path-4'],
                    fault: {
                        text: "<strong>–ü–∞–Ω—Ç–æ–≥—Ä–∞—Ñ –ø—ñ–¥–Ω—è—Ç–æ, –Ω–∞–ø—Ä—É–≥–∏ –Ω–µ–º–∞—î:</strong><br>1. –ó–Ω–µ—Å—Ç—Ä—É–º–ª–µ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –º–µ—Ä–µ–∂–∞.<br>2. –ó–≥–æ—Ä—ñ–≤ –≤—ñ–ª—ñ—Ç–æ–≤–∏–π –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫ –Ω–∞ –¥–∞—Ö—É.<br>3. –ù–µ—Å–ø—Ä–∞–≤–Ω—ñ—Å—Ç—å —Å–∞–º–æ–≥–æ –∫—ñ–ª–æ–≤–æ–ª—å—Ç–º–µ—Ç—Ä–∞."
                    },
                    nextStep: 7
                },
                {
                    id: 'node-vu',
                    title: "3. –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –í–£",
                    desc: "–£–≤—ñ–º–∫–Ω—ñ—Ç—å —Ç—É–º–±–ª–µ—Ä <strong>–í–£ (–í–∏–º–∏–∫–∞—á –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è)</strong>. –¶–µ –∫—Ä–∏—Ç–∏—á–Ω–∏–π –µ—Ç–∞–ø –¥–ª—è –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –∑–∞–ø—É—Å–∫—É –º–∞—à–∏–Ω.",
                    tech: "–í–£ ‚Äî —Ü–µ –≥–æ–ª–æ–≤–Ω–∏–π –ø–µ—Ä–µ–º–∏–∫–∞—á –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∏—Å–æ–∫–æ–≤–æ–ª—å—Ç–Ω–∏–º–∏ –∞–ø–∞—Ä–∞—Ç–∞–º–∏. –í—ñ–Ω –∑'—î–¥–Ω—É—î –ø—Ä–æ–≤—ñ–¥ 15 (+50–í –ø–æ—Å—Ç—ñ–π–Ω–µ) –∑ –ø—Ä–æ–≤–æ–¥–æ–º <strong>‚Ññ22</strong>. <br><br><strong>–ü—Ä–æ–≤—ñ–¥ 22</strong> —î —à–∏–Ω–æ—é –∂–∏–≤–ª–µ–Ω–Ω—è –¥–ª—è –∫–æ—Ç—É—à–æ–∫ –≤—Å—ñ—Ö —Å–∏–ª–æ–≤–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ—Ä—ñ–≤ (–õ—ñ–Ω—ñ–π–Ω–∏—Ö, –ú–ö1, –ú–ö2, –û–ø–∞–ª–µ–Ω–Ω—è).",
                    paths: ['path-0', 'path-1', 'path-2-yes', 'path-3', 'path-4', 'path-5'],
                    specs: {
                        "–ê–ø–∞—Ä–∞—Ç": "–í–£-223",
                        "–°—Ç—Ä—É–º": "16 –ê",
                        "–§—É–Ω–∫—Ü—ñ—è": "–ü—Ä.15 -> –ü—Ä.22"
                    },
                    fault: {
                        text: "<strong>–í–£ —É–≤—ñ–º–∫–Ω–µ–Ω–æ, –º–∞—à–∏–Ω–∏ –Ω–µ –ø—É—Å–∫–∞—é—Ç—å—Å—è:</strong><br>1. –ü–æ–ª–æ–º–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ –í–£.<br>2. –ö–æ—Ä–æ—Ç–∫–µ –∑–∞–º–∏–∫–∞–Ω–Ω—è –≤ –ø—Ä–æ–≤–æ–¥—ñ 22 (–≤–∏–±–∏–≤–∞—î –∑–∞–ø–æ–±—ñ–∂–Ω–∏–∫ –ü-1)."
                    },
                    nextStep: 8
                },
                {
                    id: ['node-dk', 'node-mk'],
                    title: "–ó–∞–ø—É—Å–∫ –î–æ–ø. –ú–∞—à–∏–Ω",
                    desc: "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ¬´–ó–∞–ø—É—Å–∫ –¥–æ–ø–æ–º—ñ–∂–Ω–∏—Ö –º–∞—à–∏–Ω¬ª. –ü—Ä–æ—Ü–µ—Å –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ –¥–≤–∞ –µ—Ç–∞–ø–∏.",
                    tech: "<strong>–ï—Ç–∞–ø 1 (–î—ñ–Ω–∞–º–æ—Ç–æ—Ä):</strong> –ù–∞–ø—Ä—É–≥–∞ –∑ –ø—Ä–æ–≤–æ–¥–∞ 22 —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–ü—É—Å–∫¬ª –π–¥–µ –≤ –ø—Ä–æ–≤—ñ–¥ <strong>21</strong>. –°–ø—Ä–∞—Ü—å–æ–≤—É—î –∫–æ–Ω—Ç–∞–∫—Ç–æ—Ä <strong>–ú–ö-1</strong>. –í—ñ–Ω –ø—ñ–¥–∫–ª—é—á–∞—î –¥—ñ–Ω–∞–º–æ—Ç–æ—Ä –¥–æ –º–µ—Ä–µ–∂—ñ 3000–í. –î—ñ–Ω–∞–º–æ—Ç–æ—Ä —Ä–æ–∑–∫—Ä—É—á—É—î—Ç—å—Å—è, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞ –π–æ–≥–æ –≤–∞–ª—É –≤–∏–¥–∞—î 50–í.<br><br><strong>–ï—Ç–∞–ø 2 (–ö–æ–º–ø—Ä–µ—Å–æ—Ä):</strong> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–∞—î –Ω–∞–ø—Ä—É–≥—É. –°—Ç—Ä—É–º –π–¥–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–∞–∫—Ç–∏ <strong>–†–µ–ª–µ –¢–∏—Å–∫—É (–ê–ö-11–ë)</strong> (–∑–∞–º–∫–Ω—É—Ç—ñ, —è–∫—â–æ —Ç–∏—Å–∫ < 6.5 –∞—Ç–º) —É –ø—Ä–æ–≤—ñ–¥ <strong>27</strong>. –°–ø—Ä–∞—Ü—å–æ–≤—É—î –∫–æ–Ω—Ç–∞–∫—Ç–æ—Ä <strong>–ú–ö-2</strong>, –∑–∞–ø—É—Å–∫–∞—é—á–∏ –∫–æ–º–ø—Ä–µ—Å–æ—Ä.",
                    paths: ['path-0', 'path-1', 'path-2-yes', 'path-3', 'path-4', 'path-5', 'path-vu-out', 'path-6-dk', 'path-6-mk', 'path-wire27'],
                    specs: {
                        "–î—ñ–Ω–∞–º–æ—Ç–æ—Ä": "–î–ö-604–ê (52 –∫–í—Ç)",
                        "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä": "–ü–ù-28 (50–í, 10–∫–í—Ç)",
                        "–ö–æ–º–ø—Ä–µ—Å–æ—Ä": "–ï–ö-7–ë (0.63 –º¬≥/—Ö–≤)"
                    },
                    fault: {
                        text: "<strong>–î—ñ–Ω–∞–º–æ—Ç–æ—Ä –ø—Ä–∞—Ü—é—î, –∫–æ–º–ø—Ä–µ—Å–æ—Ä —Å—Ç–æ—ó—Ç—å:</strong><br>1. –†–µ–ª–µ —Ç–∏—Å–∫—É —Ä–æ–∑—ñ–º–∫–Ω–µ–Ω–µ (—Ç–∏—Å–∫ –≤ –Ω–æ—Ä–º—ñ).<br>2. –û–±—Ä–∏–≤ –ø—Ä–æ–≤–æ–¥–∞ 27.<br>3. –ó–≥–æ—Ä—ñ–ª–∞ –∫–æ—Ç—É—à–∫–∞ –ú–ö-2."
                    },
                    nextStep: null 
                }
            ]
        }
    };

    let currentModule = null;
    let currentStepIndex = 0; 
    let stepHistory = [];     
    let scale = 1, pointX = 0, pointY = 0;
    let isPanning = false;
    let rafId = null;
    let isPanelCollapsed = false;

    // --- INIT ---
    function startSimulator(modId) {
        currentModule = modules[modId];
        if(!currentModule) return;

        document.getElementById('menu-view').classList.remove('active');
        document.getElementById('sim-view').classList.add('active');
        document.getElementById('module-header').innerText = currentModule.title.toUpperCase();

        const host = document.getElementById('svg-host');
        host.innerHTML = '';
        const tpl = document.getElementById(currentModule.tplId);
        host.appendChild(tpl.content.cloneNode(true));

        document.querySelectorAll('.node-group').forEach(node => {
            node.addEventListener('click', (e) => {
                e.stopPropagation();
                const id = node.getAttribute('id');
                const idx = currentModule.steps.findIndex(s => {
                    return Array.isArray(s.id) ? s.id.includes(id) : s.id === id;
                });
                
                if(idx !== -1) {
                    jumpToStep(idx);
                    if (isPanelCollapsed) {
                        isPanelCollapsed = false;
                        updatePanelState();
                    }
                }
            });
        });

        setupInputHandlers(document.getElementById('diagramWrapper'));
        stepHistory = [];
        loadStep(0);
        isPanelCollapsed = false;
        updatePanelState();
        setTimeout(resetZoom, 150);
    }

    function exitToMenu() {
        document.getElementById('sim-view').classList.remove('active');
        document.getElementById('menu-view').classList.add('active');
        currentModule = null;
    }

    // --- STEP LOGIC ---
    function loadStep(idx) {
        currentStepIndex = idx;
        updateUI();
    }

    function nextStep(targetIdx) {
        stepHistory.push(currentStepIndex);
        loadStep(targetIdx);
    }

    function prevStep() {
        if(stepHistory.length > 0) {
            loadStep(stepHistory.pop());
        }
    }
    
    function jumpToStep(idx) {
        if(idx !== currentStepIndex) {
            stepHistory.push(currentStepIndex);
            loadStep(idx);
        }
    }

    function updateUI() {
        if(!currentModule) return;
        const step = currentModule.steps[currentStepIndex];

        document.getElementById('step-title').innerText = step.title;
        document.getElementById('step-desc').innerHTML = step.desc;
        
        let techHtml = step.tech;
        if(step.specs) {
            let table = '<table class="specs-table">';
            for (const [key, val] of Object.entries(step.specs)) {
                table += `<tr><td class="spec-key">${key}</td><td class="spec-val">${val}</td></tr>`;
            }
            table += '</table>';
            techHtml += table;
        }
        document.getElementById('tech-text').innerHTML = techHtml;

        const svg = document.getElementById('svg-host');
        svg.querySelectorAll('.node-group').forEach(n => n.classList.remove('active', 'error'));
        svg.querySelectorAll('.connector').forEach(c => c.classList.remove('active'));
        
        const ids = Array.isArray(step.id) ? step.id : [step.id];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('active');
        });

        if (step.paths) {
            step.paths.forEach(pathId => {
                const p = document.getElementById(pathId);
                if(p) p.classList.add('active');
            });
        }

        const faultContainer = document.getElementById('fault-container');
        faultContainer.innerHTML = ''; 
        const faultCard = document.getElementById('fault-card');
        faultCard.classList.remove('visible'); 

        if (step.fault) {
            const btnFault = document.createElement('div');
            btnFault.className = 'btn-fault-inline';
            btnFault.innerHTML = '<span>‚ö†Ô∏è</span> –ù–ï–°–ü–†–ê–í–ù–Ü–°–¢–¨';
            
            btnFault.onclick = () => {
                const isVisible = faultCard.classList.contains('visible');
                if (isVisible) {
                    faultCard.classList.remove('visible');
                    btnFault.classList.remove('active');
                    ids.forEach(id => document.getElementById(id)?.classList.remove('error'));
                } else {
                    faultCard.classList.add('visible');
                    btnFault.classList.add('active');
                    document.getElementById('fault-text').innerHTML = step.fault.text;
                    ids.forEach(id => document.getElementById(id)?.classList.add('error'));
                    
                    setTimeout(() => {
                         const p = document.getElementById('panel-content');
                         p.scrollTo({ top: p.scrollHeight, behavior: 'smooth' });
                    }, 100);
                }
            };
            faultContainer.appendChild(btnFault);
        }

        const container = document.getElementById('actions-container');
        container.innerHTML = '';

        const btnPrev = document.createElement('button');
        btnPrev.className = 'action-btn btn-prev';
        btnPrev.innerText = '–ù–ê–ó–ê–î';
        btnPrev.disabled = stepHistory.length === 0;
        btnPrev.onclick = prevStep;
        container.appendChild(btnPrev);

        if (step.choices) {
            step.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = `action-btn btn-choice ${choice.class || ''}`;
                btn.innerText = choice.text;
                btn.onclick = () => nextStep(choice.nextStep);
                container.appendChild(btn);
            });
        } else if (step.nextStep !== null && step.nextStep !== undefined) {
            const btnNext = document.createElement('button');
            btnNext.className = 'action-btn btn-next';
            btnNext.innerText = '–î–ê–õ–Ü';
            btnNext.onclick = () => nextStep(step.nextStep);
            container.appendChild(btnNext);
        } else {
            const btnFin = document.createElement('button');
            btnFin.className = 'action-btn btn-next';
            btnFin.innerText = '–ó–ê–í–ï–†–®–ò–¢–ò';
            btnFin.onclick = exitToMenu;
            container.appendChild(btnFin);
        }
    }

    // --- PANEL UI & RESIZING ---
    function togglePanel() {
        isPanelCollapsed = !isPanelCollapsed;
        updatePanelState();
    }

    function updatePanelState() {
        const p = document.getElementById('controlPanel');
        if(isPanelCollapsed) p.classList.add('collapsed');
        else p.classList.remove('collapsed');
    }

    // --- ZOOM & PAN ENGINE ---
    function setupInputHandlers(wrapper) {
        let startX = 0, startY = 0;
        let initialPinchDist = 0;
        let initialScale = 1;
        
        wrapper.onmousedown = (e) => {
            isPanning = true;
            startX = e.clientX - pointX;
            startY = e.clientY - pointY;
            wrapper.style.cursor = 'grabbing';
        };
        wrapper.onmousemove = (e) => {
            if(!isPanning) return;
            e.preventDefault();
            pointX = e.clientX - startX;
            pointY = e.clientY - startY;
            requestRender();
        };
        window.addEventListener('mouseup', () => {
            if(isPanning) {
                isPanning = false;
                wrapper.style.cursor = 'grab';
            }
        });
        
        wrapper.onwheel = (e) => {
            e.preventDefault();
            const xs = (e.clientX - pointX) / scale;
            const ys = (e.clientY - pointY) / scale;
            const delta = -e.deltaY;
            const factor = delta > 0 ? 1.1 : 0.9;
            const newScale = Math.min(Math.max(0.1, scale * factor), 8);
            pointX = e.clientX - xs * newScale;
            pointY = e.clientY - ys * newScale;
            scale = newScale;
            requestRender();
        };

        wrapper.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                isPanning = true;
                startX = e.touches[0].clientX - pointX;
                startY = e.touches[0].clientY - pointY;
            } else if (e.touches.length === 2) {
                isPanning = false;
                initialPinchDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                initialScale = scale;
            }
        }, {passive: false});

        wrapper.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 1 && isPanning) {
                pointX = e.touches[0].clientX - startX;
                pointY = e.touches[0].clientY - startY;
                requestRender();
            } else if (e.touches.length === 2) {
                const dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                const wx = (cx - pointX) / scale;
                const wy = (cy - pointY) / scale;
                const newScale = initialScale * (dist / initialPinchDist);
                scale = Math.min(Math.max(0.1, newScale), 8);
                pointX = cx - wx * scale;
                pointY = cy - wy * scale;
                requestRender();
            }
        }, {passive: false});

        wrapper.addEventListener('touchend', (e) => { isPanning = false; });
    }

    function zoom(factor) {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        
        const wx = (cx - pointX) / scale;
        const wy = (cy - pointY) / scale;
        
        scale *= factor;
        scale = Math.min(Math.max(0.1, scale), 8);
        
        pointX = cx - wx * scale;
        pointY = cy - wy * scale;
        requestRender();
    }

    function resetZoom() {
        const winW = window.innerWidth;
        const winH = window.innerHeight;

        const targetW = 1000;
        const targetH = 2200; 

        const ratioW = winW / targetW;
        const ratioH = winH / targetH;

        // –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ —à–∏—Ä–∏–Ω—É (Fit Width) –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö (–ø–æ—Ä—Ç—Ä–µ—Ç–Ω–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è)
        if (winW < winH) {
             scale = ratioW; 
        } else {
             // –ù–∞ —à–∏—Ä–æ–∫–∏—Ö –µ–∫—Ä–∞–Ω–∞—Ö –≤–ø–∏—Å—É—î–º–æ –ø–æ–≤–Ω—ñ—Å—Ç—é
             scale = Math.min(ratioW, ratioH);
        }

        scale = Math.min(Math.max(0.1, scale), 8);

        pointX = (winW - targetW * scale) / 2;
        pointY = (winH - targetH * scale) / 2;

        requestRender();
    }

    function requestRender() {
        if (!rafId) {
            rafId = requestAnimationFrame(() => {
                document.getElementById('viewport').style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                rafId = null;
            });
        }
    }
</script>
</body>
</html>