<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивне ДЗ: Несправності електричних кіл</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        :root {
            /* Нова фіолетово-бузкова схема */
            --bg-gradient: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%);
            --bg-light: rgba(255, 255, 255, 0.9);
            --text-color: #311b92;
            --correct: #4caf50; 
            --incorrect: #f44336;
            --partial: #ffc107;
            --accent: #5e35b1;
            --border-color: rgba(94, 53, 177, 0.2);
            --shadow: 0 8px 25px 0 rgba(49, 27, 146, 0.1);
            --shadow-light: 0 4px 15px 0 rgba(49, 27, 146, 0.08);
            --action-gradient: linear-gradient(45deg, #7e57c2, #5e35b1);
        }
        body {
            font-family: 'Nunito', sans-serif; background-image: var(--bg-gradient); color: var(--text-color);
            margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .test-wrapper {
            width: 100%; max-width: 800px; background: var(--bg-light); backdrop-filter: blur(15px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow); overflow: hidden;
        }
        .header { padding: 25px 30px; text-align: center; border-bottom: 1px solid var(--border-color); }
        h1, h2, h3, h4 { margin: 0; padding: 0; color: var(--accent); }
        h1 { font-size: 1.8rem; font-weight: 800; }
        h1 span { color: var(--text-color); }
        h2 { font-size: 1.5rem; margin-bottom: 25px; }
        .content { padding: 30px; transition: opacity 0.4s ease-in-out; }
        .is-changing { opacity: 0; }
        
        #user-info-form .form-group { margin: 0 auto 20px auto; max-width: 400px; }
        #user-info-form label { display: block; margin-bottom: 8px; font-weight: 600; }
        #user-info-form input { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: rgba(255,255,255,0.5); }
        .current-date { text-align: center; margin-bottom: 25px; color: #555; }
        .button-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .btn {
            display: inline-block; background: var(--action-gradient);
            color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem;
            font-weight: 700; cursor: pointer; text-align: center; box-sizing: border-box;
            transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(94, 53, 177, 0.3);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(94, 53, 177, 0.4); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; transform: none; }
        .save-btn { background: #00796b; box-shadow: 0 4px 15px rgba(0, 121, 107, 0.3); }

        #quiz-container { display: none; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .progress-bar { width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 25px; overflow: hidden; }
        .progress-bar-inner { height: 100%; width: 0%; background: var(--action-gradient); border-radius: 5px; transition: width 0.5s ease-in-out; }
        .question-points { background: var(--accent); color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; display: inline-block; white-space: nowrap; }
        
        .answers label {
            position: relative; overflow: hidden; display: flex; align-items: center; padding: 14px;
            border: 2px solid transparent; background-clip: padding-box; border-radius: 14px; margin-bottom: 12px; cursor: pointer;
            transition: all 0.2s ease; background-color: rgba(255,255,255,0.7); box-shadow: var(--shadow-light);
        }
        .answers label:hover { transform: scale(1.02); box-shadow: var(--shadow); }
        .answers input { display: none; }
        .answers label:has(input:checked) { border-color: var(--accent); }
        .answer-text::before { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #bdc3c7; border-radius: 50%; margin-right: 15px; transition: all 0.2s ease; }
        input[type="checkbox"] + .answer-text::before { border-radius: 5px; }
        .answers input:checked + .answer-text::before { border-color: var(--accent); background-color: var(--accent); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--accent); }
        
        .dnd-container { display: flex; gap: 20px; }
        .dnd-source-column { flex-basis: 250px; }
        .dnd-target-column { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .dnd-item { position: relative; padding: 12px; padding-left: 35px; background-color: white; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; cursor: grab; transition: all 0.2s ease; user-select: none; box-shadow: var(--shadow-light); }
        .dnd-item::before { content: '⠿'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 1.5rem; color: #aaa; cursor: grab; }
        .dnd-item.dragging { opacity: 0.5; }
        .drop-zone { flex-grow: 1; min-height: 40px; background-color: rgba(0,0,0,0.02); border: 2px dashed var(--border-color); border-radius: 8px; transition: all 0.2s ease; padding: 10px; }
        .drop-zone.drag-over { background-color: rgba(94, 53, 177, 0.1); border-color: var(--accent); }

        .sequence-click-item { position: relative; background-color: rgba(255,255,255,0.6); border-radius: 14px; padding: 14px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; box-shadow: var(--shadow-light); user-select: none; }
        .sequence-click-item:hover { transform: scale(1.02); box-shadow: var(--shadow); }
        .sequence-click-item.numbered { background-color: rgba(94, 53, 177, 0.1); border: 2px solid var(--accent); cursor: not-allowed; }
        .sequence-number { position: absolute; top: 50%; left: 14px; transform: translateY(-50%) scale(0); width: 30px; height: 30px; border-radius: 50%; background: rgba(94, 53, 177, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .sequence-click-item.numbered .sequence-number { transform: translateY(-50%) scale(1); }
        .sequence-text { margin-left: 45px; }
        .reset-sequence-btn { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        
        #results-container { display: none; }
        .results-layout { display: flex; gap: 30px; align-items: flex-start; }
        .results-left-column { flex: 2; }
        .results-right-column { flex: 1; text-align: center; background: rgba(237, 231, 246, 0.8); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; }
        .answer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; margin-bottom: 30px;}
        .answer-grid span { display: flex; justify-content: center; align-items: center; height: 35px; border-radius: 6px; color: white; font-weight: 700; }
        .grid-correct { background: var(--correct); } .grid-incorrect { background: var(--incorrect); } .grid-partial { background: var(--partial); }
        
        .results-legend { display: flex; justify-content: center; gap: 20px; margin-top: 10px; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color-box { width: 18px; height: 18px; border-radius: 4px; }
        .legend-text { font-size: 0.9rem; color: #555; }
        .legend-correct { background-color: var(--correct); }
        .legend-partial { background-color: var(--partial); }
        .legend-incorrect { background-color: var(--incorrect); }

        #time-chart-container { margin-top: 15px; }
        .time-chart { display: flex; align-items: flex-end; gap: 5px; height: 150px; border-bottom: 2px solid #ccc; padding-top: 10px; }
        .time-bar { flex: 1; background: var(--action-gradient); border-radius: 5px 5px 0 0; position: relative; }
        .bar-label { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
        .final-score .score-value { font-size: 4.5rem; font-weight: 800; color: var(--accent); line-height: 1; margin: 10px 0; }
        .status-badge { font-size: 1.8rem; font-weight: 800; padding: 20px; margin: 20px 0; width: 100%; box-sizing: border-box; border-radius: 15px; display: flex; align-items: center; justify-content: center; gap: 15px; animation: status-pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: white; }
        @keyframes status-pop-in { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .status-badge::before { font-size: 2.5rem; line-height: 1; }
        .status-passed { background: linear-gradient(45deg, #4caf50, #388e3c); box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4); }
        .status-passed::before { content: '✓'; }
        .status-failed { background: linear-gradient(45deg, #f44336, #d32f2f); box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4); }
        .status-failed::before { content: '✗'; }

        #history-table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.5); border-radius: 8px; overflow: hidden; }
        #history-table th, #history-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #history-table th { background-color: rgba(94, 53, 177, 0.1); font-weight: 700; }
        
        @media (min-width: 992px) { .answers.grid-2-cols { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; } }
        @media (max-width: 768px) {
            body { padding: 10px; } .content { padding: 20px; } h1 { font-size: 1.5rem; }
            .results-layout { flex-direction: column-reverse; }
        }
    </style>
</head>
<body>
<div class="test-wrapper">
    <header class="header"><h1>Інтерактивне завдання: <span>Несправності електричних кіл</span></h1></header>
    <main class="content" id="content-area">
        <div id="user-info-form">
            <h2>Введіть ваші дані</h2>
            <form onsubmit="startQuiz(event)">
                <div class="form-group"><label for="fullName">Прізвище, Ім'я</label><input type="text" id="fullName" required></div>
                <div class="form-group"><label for="group">Група</label><input type="text" id="group" required></div>
                <p class="current-date" id="current-date"></p>
                <div class="button-container"><button type="submit" class="btn">Почати</button></div>
            </form>
        </div>
        
        <div id="quiz-container">
            <div class="quiz-header">
                <span id="question-counter"></span>
                <span id="timer" style="font-weight: 700; font-size: 1.2rem;">00:00</span>
            </div>
            <div class="progress-bar"><div class="progress-bar-inner" id="progress-bar-inner"></div></div>
            <div id="question-display"></div>
            <div class="button-container">
                <button id="next-btn" class="btn" onclick="nextQuestion()" disabled>Наступне питання</button>
            </div>
        </div>
        
        <div id="results-container">
             <h2>Результати тестування</h2>
             <div class="results-layout">
                <div class="results-left-column">
                    <h3 class="user-name"></h3>
                    <p id="result-group"></p>
                    <p id="time-taken"></p>
                    <h4>Ваші відповіді:</h4>
                    <div class="results-legend">
                        <div class="legend-item"><span class="legend-color-box legend-correct"></span><span class="legend-text">Правильно</span></div>
                        <div class="legend-item"><span class="legend-color-box legend-partial"></span><span class="legend-text">Частково</span></div>
                        <div class="legend-item"><span class="legend-color-box legend-incorrect"></span><span class="legend-text">Неправильно</span></div>
                    </div>
                    <div class="answer-grid" id="answer-grid"></div>
                    <h4>Час, витрачений на кожне питання (сек):</h4>
                    <div id="time-chart-container">
                        <div class="time-chart" id="time-chart"></div>
                    </div>
                    <div id="history-container"></div>
                </div>
                <aside class="results-right-column">
                    <div class="final-score">
                        <h4>Ваша оцінка (10-бальна):</h4>
                        <div class="score-value" id="final-grade">0</div>
                        <p id="raw-score" style="font-size: 1.1rem; margin-top: 5px;"></p>
                    </div>
                    <div id="status-badge" class="status-badge"></div>
                     <div class="button-container" style="flex-direction: column;">
                        <button class="btn" onclick="repeatTest()">Повторити тест</button>
                        <button id="save-report-btn" class="btn save-btn" onclick="saveReportAsHTML()">Зберегти звіт</button>
                    </div>
                </aside>
            </div>
        </div>
    </main>
</div>
<div id="image-modal">
    <span class="close-modal">&times;</span>
    
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('current-date').innerText = `Сьогодні: ${new Date().toLocaleDateString('uk-UA')}`;
    });
    
    const quizData = [
        { points: 1, type: "radio", question: "Який перший крок має зробити машиніст, отримавши сигнал про несправність на перегоні?", options: ["Негайно усунути несправність.", "З'ясувати місце, характер пошкодження та оцінити загрозу безпеці.", "Викликати допоміжний локомотив.", "Продовжувати рух до найближчого депо."], answer: "З'ясувати місце, характер пошкодження та оцінити загрозу безпеці." },
        { points: 1, type: "radio", question: "Що з переліченого НЕ є основною несправністю електричних кіл?", options: ["Замикання струмоведучих деталей на 'землю'.", "Низький рівень мастила в редукторі.", "Порушення цілісності ланцюга через обрив проводу.", "З'єднання між собою нормально ізольованих ланцюгів."], answer: "Низький рівень мастила в редукторі." },
        { points: 1, type: "radio", question: "Який інструмент використовується для послідовної перевірки наявності напруги в різних точках ланцюга?", options: ["Гайковий ключ.", "Гальмівний башмак.", "Контрольна (прозвонювальна) лампа.", "Напильник."], answer: "Контрольна (прозвонювальна) лампа." },
        { points: 1, type: "radio", question: "Що необхідно зробити з акумуляторною батареєю на вагоні, що перевіряється, під час прозвонки від стороннього джерела?", options: ["Повністю зарядити.", "Підключити паралельно до джерела.", "Відключити.", "Перевірити рівень електроліту."], answer: "Відключити." },
        { points: 1, type: "radio", question: "Як називається метод перевірки, при якому контрольна лампа підключається паралельно до ділянки, де передбачається обрив?", options: ["Послідовне включення.", "Резервування.", "Шунтування.", "Заземлення."], answer: "Шунтування." },
        { points: 1, type: "radio", question: "Чи можна використовувати акумуляторну батарею сусіднього вагона як джерело живлення для прозвонки?", options: ["Так, попередньо роз'єднавши міжвагонні з'єднання.", "Ні, це заборонено."], answer: "Так, попередньо роз'єднавши міжвагонні з'єднання." },
        { points: 1, type: "radio", question: "Який прилад використовується для контролю тиску повітря в апаратах з пневматичним приводом?", options: ["Вольтметр.", "Амперметр.", "Омметр.", "Манометр."], answer: "Манометр." },
        { points: 1, type: "radio", question: "Чи завжди машиніст повинен намагатися замінити пошкоджену деталь на лінії?", options: ["Так, завжди.", "Ні, у більшості випадків він лише відключає несправний вузол."], answer: "Ні, у більшості випадків він лише відключає несправний вузол." },
        { points: 1, type: "radio", question: "Що з переліченого є обов'язковою дією машиніста перед виходом з кабіни для огляду обладнання на перегоні?", options: ["Увімкнути освітлення салонів.", "Опустити струмоприймачі.", "Залишити двері кабіни відчиненими.", "Перевести контролер у ходову позицію."], answer: "Опустити струмоприймачі." },
        { points: 1, type: "radio", question: "Чи можна використовувати контрольну лампу на 50 В для прозвонки ланцюга з напругою 110 В?", options: ["Так, якщо підключити її послідовно.", "Ні, напруга лампи має відповідати напрузі ланцюга."], answer: "Ні, напруга лампи має відповідати напрузі ланцюга." },
        { points: 2, type: "checkbox", question: "Виберіть ВСІ інструменти та прилади, що входять до стандартного набору (готовальні) для усунення несправностей на електропоїзді:", options: ["Пасатижі з ізольованими ручками.", "Мегаомметр.", "Перемички з затискачами «Крокодил».", "Газовий пальник.", "Контрольна лампа."], answer: ["Пасатижі з ізольованими ручками.", "Перемички з затискачами «Крокодил».", "Контрольна лампа."] },
        { points: 2, type: "sequence", question: "Розташуйте у правильній послідовності дії при прозвонці низьковольтного ланцюга паралельним методом (спосіб 2):", items: ["Переміщувати другий щуп вздовж ланцюга, що перевіряється.", "Подати напругу на ланцюг, що перевіряється, від штатної АБ.", "Підключити один провід контрольної лампи до 'мінуса' ланцюга керування.", "Визначити місце обриву за точкою, де лампа перестане горіти."], answer: ["Подати напругу на ланцюг, що перевіряється, від штатної АБ.", "Підключити один провід контрольної лампи до 'мінуса' ланцюга керування.", "Переміщувати другий щуп вздовж ланцюга, що перевіряється.", "Визначити місце обриву за точкою, де лампа перестане горіти."] },
        { points: 2, type: "match", question: "Встановіть відповідність між ситуацією та станом контрольної лампи при перевірці запобіжника методом шунтування.", items: ["Запобіжник справний", "Запобіжник перегорів"], definitions: ["Лампа горить", "Лампа не горить"], answer: ["Запобіжник справний-Лампа не горить", "Запобіжник перегорів-Лампа горить"] }
    ];
    
    let maxPossiblePoints = quizData.reduce((sum, q) => sum + q.points, 0);
    let currentQuestionIndex = 0, userAnswers = [], questionTimings = [], questionStartTime, timerInterval, studentData = {};

    function isLocalStorageAvailable() {
        try {
            const storage = window.localStorage;
            const x = '__storage_test__';
            storage.setItem(x, x);
            storage.removeItem(x);
            return true;
        } catch (e) {
            return false;
        }
    }

    function loadHistory() {
        if (!isLocalStorageAvailable()) return;
        const historyContainer = document.getElementById('history-container');
        try {
            const history = JSON.parse(localStorage.getItem('quizHistory_faults')) || [];
            if (history.length <= 1) return;
            const previousAttempts = history.slice(0, -1).sort((a, b) => new Date(b.date) - new Date(a.date));
            let tableHTML = `<h4 style="margin-top: 30px;">Історія попередніх спроб</h4><table id="history-table"><tr><th>Дата і час</th><th>Бали</th><th>Оцінка</th></tr>`;
            previousAttempts.forEach(item => {
                const date = new Date(item.date).toLocaleString('uk-UA');
                const score = `${Number(item.score).toFixed(1)} / ${maxPossiblePoints}`;
                const grade10 = item.grade ?? '-';
                tableHTML += `<tr><td>${date}</td><td>${score}</td><td>${grade10}</td></tr>`;
            });
            tableHTML += '</table>';
            historyContainer.innerHTML = tableHTML;
        } catch (e) {
            console.error("Помилка завантаження історії:", e);
            localStorage.removeItem('quizHistory_faults');
        }
    }

    function saveHistory(score, grade10) {
        if (!isLocalStorageAvailable()) return;
        try {
            const history = JSON.parse(localStorage.getItem('quizHistory_faults')) || [];
            history.push({ 
                date: new Date().toISOString(), 
                score: score,
                grade: grade10
            });
            localStorage.setItem('quizHistory_faults', JSON.stringify(history));
        } catch (e) {
            console.error("Помилка збереження історії:", e);
        }
    }
    
    function repeatTest() { window.location.reload(); }

    function setupModal() {
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const closeModal = document.querySelector('.close-modal');
        const openModal = (src) => { modalImage.src = src; modal.style.display = 'flex'; };
        
        closeModal.onclick = () => { modal.style.display = 'none'; };
        modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
        document.getElementById('content-area').addEventListener('click', (e) => {
            if (e.target && e.target.id === 'question-image') openModal(e.target.src);
        });
    }

    function startQuiz(e) {
        e.preventDefault();
        studentData.fullName = document.getElementById('fullName').value;
        studentData.group = document.getElementById('group').value;
        document.getElementById('user-info-form').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block';
        setupModal();
        startTimer();
        renderQuestion();
    }

    function startTimer() {
        let startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const minutes = String(Math.floor(elapsed / 60000)).padStart(2, '0');
            const seconds = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, '0');
            document.getElementById('timer').innerText = `${minutes}:${seconds}`;
        }, 1000);
    }

    function renderQuestion() {
        const contentArea = document.querySelector('.content');
        contentArea.classList.add('is-changing');
        questionStartTime = Date.now();
        
        setTimeout(() => {
            const q = quizData[currentQuestionIndex];
            const display = document.getElementById('question-display');
            let html = `<div class="question-block" id="current-question-block" data-type="${q.type}">`;
            html += `<p style="font-size: 1.2rem; font-weight: 600;">${q.question} <span class="question-points">${q.points} ${q.points === 1 ? 'бал' : 'бали'}</span></p>`;
            
            switch (q.type) {
                case 'radio': html += `<div class="answers grid-2-cols">${q.options.map(opt => `<label><input type="radio" name="answer" value="${opt}"><span class="answer-text">${opt}</span></label>`).join('')}</div>`; break;
                case 'checkbox': html += `<div class="answers grid-2-cols">${q.options.map(opt => `<label><input type="checkbox" name="answer" value="${opt}"><span class="answer-text">${opt}</span></label>`).join('')}</div>`; break;
                case 'match':
                    const items = [...q.items].sort(() => Math.random() - 0.5);
                    html += `<div class="dnd-container">
                                <div class="dnd-source-column">
                                    <h4>Перетягніть:</h4>
                                    <div class="source-list">${items.map(i => `<div class="dnd-item" draggable="true" data-id="${i}">${i}</div>`).join('')}</div>
                                </div>
                                <div class="dnd-target-column">
                                    ${q.definitions.map(d => `<div><h4>${d}:</h4><div class="drop-zone" data-target-id="${d}"></div></div>`).join('')}
                                </div>
                             </div>`;
                    break;
                case 'sequence':
                    const s_items = [...q.items].sort(() => Math.random() - 0.5);
                    html += `<div class="sequence-click-container">${s_items.map(i => `<div class="sequence-click-item" data-text="${i}"><span class="sequence-number"></span><span class="sequence-text">${i}</span></div>`).join('')}</div><button class="reset-sequence-btn">Скинути вибір</button>`;
                    break;
            }
            display.innerHTML = html + '</div>';

            if (q.type === 'match') setupDragAndDrop();
            if (q.type === 'sequence') setupSequenceClick();

            document.getElementById('question-counter').innerText = `Питання ${currentQuestionIndex + 1} з ${quizData.length}`;
            updateProgressBar();
            document.getElementById('next-btn').innerText = (currentQuestionIndex === quizData.length - 1) ? 'Завершити' : 'Наступне питання';
            contentArea.classList.remove('is-changing');
            
            const questionBlock = document.getElementById('current-question-block');
            if (questionBlock) {
                questionBlock.addEventListener('change', checkAnswerProvided);
            }
        }, 400);
    }

    function checkAnswerProvided() {
        let isProvided = false;
        const qBlock = document.getElementById('current-question-block');
        if (!qBlock) return;
        const qType = qBlock.dataset.type;
        switch (qType) {
            case 'radio': isProvided = !!qBlock.querySelector('input[name="answer"]:checked'); break;
            case 'checkbox': isProvided = qBlock.querySelectorAll('input[name="answer"]:checked').length > 0; break;
            case 'match': isProvided = qBlock.querySelector('.source-list').children.length === 0; break;
            case 'sequence': isProvided = qBlock.querySelectorAll('.numbered').length === quizData[currentQuestionIndex].items.length; break;
        }
        document.getElementById('next-btn').disabled = !isProvided;
    }

    function setupDragAndDrop() {
        document.querySelectorAll('.dnd-item').forEach(d => {
            d.addEventListener('dragstart', () => d.classList.add('dragging'));
            d.addEventListener('dragend', () => { d.classList.remove('dragging'); checkAnswerProvided(); });
        });
        document.querySelectorAll('.drop-zone').forEach(z => {
            z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('drag-over'); });
            z.addEventListener('dragleave', () => z.classList.remove('drag-over'));
            z.addEventListener('drop', e => {
                e.preventDefault(); z.classList.remove('drag-over');
                const d = document.querySelector('.dragging');
                if (d && z.children.length === 0) { z.appendChild(d); checkAnswerProvided(); }
            });
        });
    }

    function setupSequenceClick() {
        const container = document.querySelector('.sequence-click-container');
        if (!container) return;
        container.querySelectorAll('.sequence-click-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.classList.contains('numbered')) return;
                item.classList.add('numbered');
                item.dataset.order = container.querySelectorAll('.numbered').length;
                item.querySelector('.sequence-number').innerText = item.dataset.order;
                checkAnswerProvided();
            });
        });
        document.querySelector('.reset-sequence-btn')?.addEventListener('click', () => {
            container.querySelectorAll('.sequence-click-item').forEach(item => {
                item.classList.remove('numbered');
                item.querySelector('.sequence-number').innerText = '';
                delete item.dataset.order;
            });
            checkAnswerProvided();
        });
    }

    function collectAnswer() {
        const q = quizData[currentQuestionIndex];
        const qBlock = document.getElementById('current-question-block');
        if (!qBlock) return;
        switch (q.type) {
            case 'radio': userAnswers[currentQuestionIndex] = qBlock.querySelector('input[name="answer"]:checked')?.value || null; break;
            case 'checkbox': userAnswers[currentQuestionIndex] = Array.from(qBlock.querySelectorAll('input[name="answer"]:checked')).map(cb => cb.value); break;
            case 'match':
                const matches = [];
                qBlock.querySelectorAll('.drop-zone').forEach(zone => {
                    const zoneId = zone.dataset.targetId;
                    zone.querySelectorAll('.dnd-item').forEach(item => {
                        matches.push(`${item.dataset.id}-${zoneId}`);
                    });
                });
                userAnswers[currentQuestionIndex] = matches.sort(); break;
            case 'sequence':
                userAnswers[currentQuestionIndex] = Array.from(qBlock.querySelectorAll('.sequence-click-item'))
                    .sort((a, b) => a.dataset.order - b.dataset.order)
                    .map(item => item.dataset.text); break;
        }
    }

    function nextQuestion() {
        questionTimings.push(Date.now() - questionStartTime);
        collectAnswer();
        currentQuestionIndex++;
        if (currentQuestionIndex < quizData.length) renderQuestion();
        else finishQuiz();
    }

    function updateProgressBar() {
        document.getElementById('progress-bar-inner').style.width = `${((currentQuestionIndex) / quizData.length) * 100}%`;
    }

    function finishQuiz() {
        clearInterval(timerInterval);
        let score = 0;
        const results = quizData.map((q, i) => {
            const userAns = userAnswers[i];
            const correctAns = q.answer;
            let questionScore = 0, resultType = 'incorrect';
            switch (q.type) {
                case 'radio':
                    if (String(userAns || '').toLowerCase().trim() === String(correctAns).toLowerCase().trim()) {
                        questionScore = q.points; resultType = 'correct';
                    } break;
                case 'checkbox':
                    if (userAns?.length) {
                        const correctCount = userAns.filter(ans => correctAns.includes(ans)).length;
                        const incorrectCount = userAns.length - correctCount;
                        const scorePerItem = q.points / correctAns.length;
                        questionScore = Math.max(0, correctCount * scorePerItem - incorrectCount * scorePerItem);
                        if (incorrectCount === 0 && correctCount === correctAns.length) resultType = 'correct';
                        else if (questionScore > 0) resultType = 'partial';
                    } break;
                case 'match':
                    if (userAns?.length) {
                        const correctMatches = userAns.filter(m => correctAns.sort().includes(m)).length;
                        questionScore = (correctMatches / correctAns.length) * q.points;
                        if (correctMatches === correctAns.length) resultType = 'correct';
                        else if (questionScore > 0) resultType = 'partial';
                    } break;
                case 'sequence':
                    if (userAns?.length === correctAns.length && userAns.every((item, index) => item === correctAns[index])) {
                        questionScore = q.points; resultType = 'correct';
                    } break;
            }
            score += questionScore;
            return resultType;
        });

        const grade10 = convertToFinalGrade(score, maxPossiblePoints);
        saveHistory(score, grade10);
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        displayResults(results, score, grade10);
    }

    function convertToFinalGrade(score, maxScore) {
        if (maxScore === 0) return 0;
        const grade = (score / maxScore) * 10;
        return Math.round(grade);
    }

    function displayResults(results, score, grade10) {
        let totalTime = questionTimings.reduce((a, b) => a + b, 0);
        const resultsContainer = document.getElementById('results-container');
        
        resultsContainer.querySelector('.user-name').innerText = studentData.fullName;
        resultsContainer.querySelector('#result-group').innerText = `Група: ${studentData.group}`;
        resultsContainer.querySelector('#time-taken').innerHTML = `⏱️ Загальний час: <strong>${String(Math.floor(totalTime/60000)).padStart(2,'0')}:${String(Math.floor((totalTime%60000)/1000)).padStart(2,'0')}</strong>`;
        resultsContainer.querySelector('#answer-grid').innerHTML = results.map((res, i) => `<span class="grid-${res}">${i + 1}</span>`).join('');
        resultsContainer.querySelector('#final-grade').innerText = grade10;
        resultsContainer.querySelector('#raw-score').innerHTML = `(Набрано <strong>${score.toFixed(1)}</strong> із <strong>${maxPossiblePoints}</strong> балів)`;
        
        const statusBadge = resultsContainer.querySelector('#status-badge');
        if (grade10 >= 4) {
            statusBadge.innerHTML = 'Зараховано'; 
            statusBadge.className = 'status-badge status-passed'; 
        } else { 
            statusBadge.innerHTML = 'Не зараховано'; 
            statusBadge.className = 'status-badge status-failed'; 
        }
        
        const timeChart = resultsContainer.querySelector('#time-chart');
        const maxTime = Math.max(...questionTimings, 1);
        timeChart.innerHTML = questionTimings.map((time, index) => {
            const height = maxTime > 0 ? (time / maxTime) * 100 : 0;
            const timeInSeconds = (time / 1000).toFixed(1);
            return `<div class="time-bar" style="height: ${height}%;" title="Питання ${index + 1}: ${timeInSeconds} сек."><span class="bar-label">${timeInSeconds}с</span></div>`;
        }).join('');
        
        loadHistory();
    }

    function saveReportAsHTML() {
        const btn = document.getElementById('save-report-btn');
        btn.innerText = 'Зберігаємо...'; btn.disabled = true;
        const styles = Array.from(document.styleSheets).map(s => { try { return Array.from(s.cssRules).map(r => r.cssText).join('\n'); } catch (e) { return ''; }}).join('\n');
        const report = document.getElementById('results-container').innerHTML;
        const header = document.querySelector('.header').outerHTML;
        const html = `<!DOCTYPE html><html lang="uk"><head><meta charset="UTF-8"><title>Звіт: ${studentData.fullName}</title><style>${styles}</style><style>body{align-items:flex-start}.test-wrapper{margin:20px auto}#results-container{display:block !important}.button-container{flex-direction: column; gap: 10px; align-items: center;} #save-report-btn, .btn[onclick="repeatTest()"] {display:none !important}</style></head><body><div class="test-wrapper">${header}<main class="content">${report}</main></div></body></html>`;
        const blob = new Blob([html], { type: 'text/html' });
        const link = document.createElement('a');
        const dateStr = new Date().toISOString().slice(0, 10);
        const name = studentData.fullName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        link.download = `zvit-nespravnosti-${name}-${dateStr}.html`;
        link.href = URL.createObjectURL(blob);
        link.click(); URL.revokeObjectURL(link.href);
        setTimeout(() => { btn.innerText = 'Зберегти звіт'; btn.disabled = false; }, 1000);
    }
</script>
</body>
</html>