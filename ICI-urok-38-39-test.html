<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивне ДЗ: Сигнали при маневрах</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        :root {
            --bg-light: #e6e7ee;
            --text-color: #37474f;
            --correct: #4caf50;
            --incorrect: #f44336;
            --partial: #ffc107;
            --accent: #546e7a;
            --accent-dark: #455a64;
            --border-color: rgba(84, 110, 122, 0.2);
            /* Пом'якшені тіні для більш чистого вигляду */
            --shadow-dark: 5px 5px 10px rgba(55, 71, 79, 0.2);
            --shadow-light: -5px -5px 10px rgba(255, 255, 255, 0.9);
            --shadow-inset-dark: inset 4px 4px 8px rgba(55, 71, 79, 0.15);
            --shadow-inset-light: inset -4px -4px 8px rgba(255, 255, 255, 1);
            --action-gradient: linear-gradient(135deg, #78909c, #546e7a);
        }
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-light);
            background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%); /* Виразний градієнтний фон */
            color: var(--text-color);
            margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh;
            transition: background-color 0.5s ease;
        }
        .test-wrapper {
            width: 100%; max-width: 800px; background: var(--bg-light);
            border-radius: 20px;
            box-shadow: var(--shadow-dark), var(--shadow-light); overflow: hidden;
        }
        .header { padding: 25px 30px; text-align: center; border-bottom: 1px solid var(--border-color); }
        h1, h2, h3, h4 { margin: 0; padding: 0; color: var(--accent); }
        h1 { font-size: 1.8rem; font-weight: 800; }
        h1 span { color: var(--text-color); }
        h2 { font-size: 1.5rem; margin-bottom: 25px; }
        .content { padding: 30px; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; }
        .is-changing {
            opacity: 0;
            transform: translateY(15px); /* Плавний зсув при зміні контенту */
        }

        #user-info-form .form-group { margin: 0 auto 20px auto; max-width: 400px; }
        #user-info-form label { display: block; margin-bottom: 8px; font-weight: 600; }
        #user-info-form input { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: var(--bg-light); box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); }
        .current-date { text-align: center; margin-bottom: 25px; color: #555; }
        .button-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .btn {
            display: inline-block; background: var(--action-gradient);
            color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem;
            font-weight: 700; cursor: pointer; text-align: center; box-sizing: border-box;
            box-shadow: var(--shadow-dark), var(--shadow-light);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Більш плавна анімація */
        }
        .btn:hover {
            transform: translateY(-4px) scale(1.02); /* Більш виразний ефект */
            box-shadow: 7px 7px 14px rgba(55, 71, 79, 0.25), -7px -7px 14px rgba(255, 255, 255, 0.9);
        }
        .btn:active {
            transform: translateY(1px);
            box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light);
        }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; transform: none; }
        .save-btn { background: #00796b; }

        #quiz-container { display: none; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .progress-bar { width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 25px; overflow: hidden; box-shadow: inset 2px 2px 5px rgba(55, 71, 79, 0.1); }
        .progress-bar-inner { height: 100%; width: 0%; background: linear-gradient(135deg, #78909c, #455a64); border-radius: 5px; transition: width 0.5s ease-in-out; }
        .question-points { background: var(--accent); color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; display: inline-block; white-space: nowrap; }

        .answers.grid-2-cols { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 600px) { .answers.grid-2-cols { grid-template-columns: repeat(2, 1fr); } }
        .answers label {
            position: relative; overflow: hidden; display: flex; align-items: center; gap: 15px; padding: 14px;
            border-radius: 14px; margin-bottom: 12px; cursor: pointer;
            background-color: var(--bg-light);
            box-shadow: var(--shadow-dark), var(--shadow-light);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .answers label:hover {
            transform: translateY(-3px);
            box-shadow: 7px 7px 14px rgba(55, 71, 79, 0.2), -7px -7px 14px rgba(255, 255, 255, 0.8);
        }
        .answers input { display: none; }
        .answers label:has(input:checked) {
            box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light);
            background-color: #d1d9e6; /* Легка зміна кольору при виборі */
        }
        .answers label::after {
            content: ""; position: absolute; top: -50%; left: -75%; width: 50%; height: 200%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transform: skewX(-30deg); transition: left 1.2s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .answers label:has(input:checked)::after { left: 125%; }

        .dnd-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .dnd-source-column { flex-basis: 250px; flex-grow: 1; }
        .dnd-target-column { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 200px; }

        .dnd-item-wrapper { position: relative; border-radius: 8px; margin-bottom: 10px; background: var(--bg-light); box-shadow: var(--shadow-dark), var(--shadow-light); }
        .dnd-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 10px; cursor: grab; user-select: none; position: relative; z-index: 10; background-color: transparent; transition: all 0.2s ease; }
        .dnd-item .signal-body { transform: scale(0.8); margin: -5px 0; }
        .dnd-item.dragging { opacity: 0.8; background: var(--bg-light); box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); }
        .dnd-item-wrapper.ghost .dnd-item { visibility: hidden; }
        .dnd-item-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: bold; color: #ccc; z-index: 5; opacity: 0; transition: opacity 0.3s; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { color: #ccc; } 50% { color: var(--accent); } 100% { color: #ccc; } }
        .dnd-item-wrapper.ghost .dnd-item-placeholder { opacity: 1; }

        .drop-zone { flex-grow: 1; min-height: 40px; background-color: rgba(0,0,0,0.02); border: 2px dashed var(--border-color); border-radius: 8px; transition: all 0.2s ease; padding: 5px; box-shadow: inset 2px 2px 5px rgba(55, 71, 79, 0.1); }
        .drop-zone .dnd-item-wrapper { box-shadow: none; border: none; }
        .drop-zone .dnd-item { cursor: default; }
        .drop-zone.drag-over { background-color: rgba(84, 110, 122, 0.1); border-color: var(--accent); }

        .sequence-click-item { position: relative; background-color: var(--bg-light); border-radius: 14px; padding: 14px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; user-select: none; box-shadow: var(--shadow-dark), var(--shadow-light); }
        .sequence-click-item:hover { transform: translateY(-2px); }
        .sequence-click-item.numbered { background-color: rgba(84, 110, 122, 0.1); cursor: not-allowed; box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); }
        .sequence-number { position: absolute; top: 50%; left: 14px; transform: translateY(-50%) scale(0); width: 30px; height: 30px; border-radius: 50%; background: rgba(84, 110, 122, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .sequence-click-item.numbered .sequence-number { transform: translateY(-50%) scale(1); }
        .sequence-text { margin-left: 45px; }
        /* ВИПРАВЛЕНО: Стилі для кнопки скидання вибору */
        .reset-sequence-btn {
            display: inline-block;
            background: transparent;
            color: var(--accent);
            padding: 10px 20px;
            border: 2px solid var(--accent);
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            margin-top: 20px;
        }
        .reset-sequence-btn:hover {
            background: var(--accent);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* ВИПРАВЛЕНО: Стилі для модального вікна (приховує хрестик) */
        #image-modal {
            display: none; /* Приховує модальне вікно за замовчуванням */
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(55, 71, 79, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            line-height: 1;
        }
        .close-modal:hover,
        .close-modal:focus {
            color: var(--bg-light);
            transform: scale(1.1);
        }

        .signal-drawing { text-align: center; margin: 15px 0; }
        .signal-body { display: inline-flex; flex-direction: column; background: #333; padding: 8px; border-radius: 8px; border: 3px solid #555; position: relative; }
        .light { width: 35px; height: 35px; border-radius: 50%; background: #1a1a1a; margin: 4px; transition: all 0.2s; box-shadow: inset 1px 1px 3px #000; }
        .light.blue { background-color: #0d6efd; box-shadow: 0 0 12px 2px #0d6efd, inset 2px 2px 5px rgba(0,0,0,0.4), inset -2px -2px 5px rgba(150, 200, 255, 0.7); }
        .light.white { background-color: #f8f9fa; box-shadow: 0 0 12px 2px #f8f9fa, inset 2px 2px 5px rgba(0,0,0,0.4), inset -2px -2px 5px rgba(255, 255, 255, 1); }
        .light.red { background-color: #dc3545; box-shadow: 0 0 12px 2px #dc3545, inset 2px 2px 5px rgba(0,0,0,0.4), inset -2px -2px 5px rgba(255, 150, 150, 0.7); }
        .light.yellow { background-color: #ffc107; box-shadow: 0 0 12px 2px #ffc107, inset 2px 2px 5px rgba(0,0,0,0.4), inset -2px -2px 5px rgba(255, 255, 150, 0.7); }
        .light.green { background-color: #198754; box-shadow: 0 0 12px 2px #198754, inset 2px 2px 5px rgba(0,0,0,0.4), inset -2px -2px 5px rgba(150, 255, 150, 0.7); }
        .signal-letter { position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); font-size: 1.8rem; color: #fff; font-weight: 800; background-color: #333; padding: 0 8px; border-radius: 5px; }

        #results-container { display: none; }
        .results-layout { display: flex; gap: 30px; align-items: flex-start; }
        .results-left-column { flex: 2; }
        .results-right-column { flex: 1; text-align: center; background: var(--bg-light); padding: 20px; border-radius: 15px; box-shadow: var(--shadow-dark), var(--shadow-light); }
        .answer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; margin-bottom: 30px;}
        .answer-grid span {
            display: flex; justify-content: center; align-items: center; height: 35px; border-radius: 6px; color: white; font-weight: 700; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.2);
            /* ПОКРАЩЕНО: анімація появи */
            opacity: 0;
            transform: scale(0.5);
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes pop-in { to { opacity: 1; transform: scale(1); } }

        .grid-correct { background: var(--correct); } .grid-incorrect { background: var(--incorrect); } .grid-partial { background: var(--partial); }

        .results-legend { display: flex; justify-content: center; gap: 20px; margin-top: 10px; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color-box { width: 18px; height: 18px; border-radius: 4px; }
        .legend-text { font-size: 0.9rem; color: #555; }
        .legend-correct { background-color: var(--correct); }
        .legend-partial { background-color: var(--partial); }
        .legend-incorrect { background-color: var(--incorrect); }

        #time-chart-container { background: var(--bg-light); border-radius: 10px; padding: 15px; box-shadow: var(--shadow-inset-dark), var(--shadow-inset-light); margin-top: 15px; }
        .time-chart { display: flex; align-items: flex-end; gap: 5px; height: 150px; border-bottom: 2px solid #ccc; padding-top: 10px; }
        .time-bar {
            flex: 1; background: var(--action-gradient); border-radius: 5px 5px 0 0; position: relative; box-shadow: var(--shadow-dark);
            /* ПОКРАЩЕНО: анімація появи */
            transform: scaleY(0);
            transform-origin: bottom;
            animation: grow-up 0.5s ease-out forwards;
        }
        @keyframes grow-up { to { transform: scaleY(1); } }

        .bar-label { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
        .final-score .score-value { font-size: 4.5rem; font-weight: 800; color: var(--accent); line-height: 1; margin: 10px 0; }
        .status-badge { font-size: 1.8rem; font-weight: 800; padding: 20px; margin: 20px 0; width: 100%; box-sizing: border-box; border-radius: 15px; display: flex; align-items: center; justify-content: center; gap: 15px; animation: status-pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: white; box-shadow: var(--shadow-dark); }
        @keyframes status-pop-in { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .status-badge::before { font-size: 2.5rem; line-height: 1; }
        .status-passed { background: linear-gradient(45deg, #4caf50, #388e3c); }
        .status-passed::before { content: '✓'; }
        .status-failed { background: linear-gradient(45deg, #f44336, #d32f2f); }
        .status-failed::before { content: '✗'; }

        #history-table { width: 100%; border-collapse: collapse; background: var(--bg-light); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-dark), var(--shadow-light); }
        #history-table th, #history-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #history-table th { background-color: rgba(84, 110, 122, 0.1); font-weight: 700; }

        @media (max-width: 767px) {
            body { padding: 10px; } .content { padding: 20px; } h1 { font-size: 1.5rem; }
            .results-layout { flex-direction: column-reverse; }
        }
    </style>
</head>
<body>
<div class="test-wrapper">
    <header class="header"><h1>Інтерактивне завдання: <span>Сигнали при маневрах</span></h1></header>
    <main class="content" id="content-area">
        <div id="user-info-form"></div>
        <div id="quiz-container"></div>
        <div id="results-container"></div>
    </main>
</div>
<div id="image-modal">
    <span class="close-modal">&times;</span>
</div>

<script>
    const fullUserInfoHTML = `<h2>Введіть ваші дані</h2><form onsubmit="startQuiz(event)"><div class="form-group"><label for="fullName">Прізвище, Ім'я</label><input type="text" id="fullName" required></div><div class="form-group"><label for="group">Група</label><input type="text" id="group" required></div><p class="current-date" id="current-date"></p><div class="button-container"><button type="submit" class="btn">Почати</button></div></form>`;
    const fullQuizContainerHTML = `<div class="quiz-header"><span id="question-counter"></span><span id="timer" style="font-weight: 700; font-size: 1.2rem;">00:00</span></div><div class="progress-bar"><div class="progress-bar-inner" id="progress-bar-inner"></div></div><div id="question-display"></div><div class="button-container"><button id="next-btn" class="btn" onclick="nextQuestion()" disabled>Наступне питання</button></div>`;
    const fullResultsContainerHTML = `<h2>Результати тестування</h2><div class="results-layout"><div class="results-left-column"><h3 class="user-name"></h3><p id="result-group"></p><p id="time-taken"></p><h4>Ваші відповіді:</h4><div class="results-legend"><div class="legend-item"><span class="legend-color-box legend-correct"></span><span class="legend-text">Правильно</span></div><div class="legend-item"><span class="legend-color-box legend-partial"></span><span class="legend-text">Частково</span></div><div class="legend-item"><span class="legend-color-box legend-incorrect"></span><span class="legend-text">Неправильно</span></div></div><div class="answer-grid" id="answer-grid"></div><h4>Час, витрачений на кожне питання (сек):</h4><div id="time-chart-container"><div class="time-chart" id="time-chart"></div></div><div id="history-container"></div></div><aside class="results-right-column"><div class="final-score"><h4>Ваша оцінка (10-бальна):</h4><div class="score-value" id="final-grade">0</div><p id="raw-score" style="font-size: 1.1rem; margin-top: 5px;"></p></div><div id="status-badge" class="status-badge"></div><div class="button-container" style="flex-direction: column;"><button class="btn" onclick="repeatTest()">Повторити тест</button><button id="save-report-btn" class="btn save-btn" onclick="saveReportAsHTML()">Зберегти звіт</button></div></aside></div>`;

    document.getElementById('user-info-form').innerHTML = fullUserInfoHTML;
    document.getElementById('quiz-container').innerHTML = fullQuizContainerHTML;
    document.getElementById('results-container').innerHTML = fullResultsContainerHTML;

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('current-date').innerText = `Сьогодні: ${new Date().toLocaleDateString('uk-UA')}`;
    });

    const quizData = [
        {
            points: 1, type: "radio",
            question: "Який сигнал подає маневровий світлофор, що забороняє проводити маневри?",
            options: [
                { text: "Один червоний вогонь.", drawing: `<div class="signal-body"><div class="light red"></div></div>`},
                { text: "Один місячно-білий вогонь.", drawing: `<div class="signal-body"><div class="light white"></div></div>`},
                { text: "Один синій вогонь.", drawing: `<div class="signal-body"><div class="light blue"></div></div>`},
                { text: "Один жовтий вогонь.", drawing: `<div class="signal-body"><div class="light yellow"></div></div>`}
            ],
            answer: "Один синій вогонь."
        },
        { points: 1, type: "radio",
          drawing: `<div class="signal-drawing"><div class="signal-body"><div class="light green"></div><div class="light"></div><div class="light"></div></div></div>`,
          question: "Що означає один зелений вогонь на гірковому світлофорі?", options: ["Дозволяється розпуск вагонів із зменшеною швидкістю.", "Стій! Забороняється розпуск.", "Дозволяється розпуск вагонів з встановленою швидкістю.", "Осадити вагони з гірки."], answer: "Дозволяється розпуск вагонів з встановленою швидкістю." },
        { points: 1, type: "radio", question: "Який звуковий сигнал означає команду «Стій!» під час маневрів?", options: ["Один довгий.", "Два довгих.", "Два коротких.", "Три коротких."], answer: "Три коротких." },
        { points: 1, type: "radio", question: "Який ручний сигнал вдень означає команду «Дозволяється локомотиву прямувати управлінням назад»?", options: ["Рух піднятої вверх руки з жовтим прапорцем.", "Рух опущеної вниз руки з жовтим прапорцем.", "Рухи по колу жовтим прапорцем.", "Повільні рухи вверх і вниз жовтим прапорцем."], answer: "Рух опущеної вниз руки з жовтим прапорцем." },
        { points: 1, type: "radio",
          drawing: `<div class="signal-drawing" style="padding-bottom: 25px;"><div class="signal-body"><div class="light"></div><div class="light"></div><div class="light red"></div><div class="signal-letter">Н</div></div></div>`,
          question: "Що означає літера «Н» білого кольору, яка горить на гірковому світлофорі одночасно з червоним вогнем?", options: ["Негайно зупинитися.", "На колії перешкода.", "Наступний склад — небезпечний вантаж.", "Осадити вагони з гірки."], answer: "Осадити вагони з гірки." },
        { points: 1, type: "radio", question: "Хто встановлює конкретні значення швидкостей розпуску вагонів на сортувальних гірках?", options: ["Машиніст локомотива.", "Черговий по станції.", "Начальник залізниці.", "Керівник маневрів."], answer: "Начальник залізниці." },
        { points: 1, type: "radio", question: "Як машиніст локомотива повинен підтвердити прийняття ручного або звукового сигналу під час маневрів?", options: ["Повторити сигнал ручним прапорцем.", "Повторити команду по радіозв'язку.", "Подати відповідний сигнал свистком локомотива.", "Увімкнути та вимкнути прожектор."], answer: "Подати відповідний сигнал свистком локомотива." },
        {
            points: 1, type: "radio",
            question: "Який сигнал може застосовуватися на маневрових світлофорах на станціях з електричною централізацією для позначення, що колія вільна?",
            options: [
                { text: "Один зелений вогонь.", drawing: `<div class="signal-body"><div class="light green"></div></div>`},
                { text: "Два місячно-білих вогні.", drawing: `<div class="signal-body"><div class="light white"></div><div class="light white"></div></div>`},
                { text: "Один місячно-білий та один синій вогні.", drawing: `<div class="signal-body"><div class="light white"></div><div class="light blue"></div></div>`},
                { text: "Миготливий місячно-білий вогонь.", drawing: `<div class="signal-body"><div class="light white"></div></div>`}
            ],
            answer: "Два місячно-білих вогні."
        },
        { points: 1, type: "radio", question: "Яким ручним сигналом вночі подається команда «Стій!»?", options: ["Рухом по колу ліхтаря з будь-яким вогнем.", "Швидкими вертикальними рухами ліхтаря з білим вогнем.", "Горизонтальними рухами ліхтаря з червоним вогнем.", "Одним довгим спалахом ліхтаря."], answer: "Рухом по колу ліхтаря з будь-яким вогнем." },
        { points: 1, type: "radio", question: "У якому випадку дозволяється проїзд вихідного світлофора з червоним вогнем під час маневрів за відсутності маневрових світлофорів?", options: ["На розсуд машиніста.", "Тільки в світлий час доби.", "За наказом чергового по станції або керівника маневрів.", "Ніколи не дозволяється."], answer: "За наказом чергового по станції або керівника маневрів." },
        { points: 2, type: "checkbox", question: "Виберіть два значення, які може мати один місячно-білий вогонь маневрового світлофора.", options: ["Забороняється проводити маневри.", "Дозволяється проводити маневри.", "Дозволяється вихід маневрового состава за межу станції.", "Колія, на яку виконуються маневри, вільна."], answer: ["Дозволяється проводити маневри.", "Дозволяється вихід маневрового состава за межу станції."] },
        { points: 3, type: "checkbox", question: "Виберіть три способи, якими керівник маневрів може подати команду машиністу.", options: ["Сигналом семафора.", "Ручним сигналом (прапорцем).", "Звуковим сигналом (свистком).", "Сигналом вхідного світлофора.", "Через радіозв'язок.", "Сигналом покажчика межі блок-ділянки."], answer: ["Ручним сигналом (прапорцем).", "Звуковим сигналом (свистком).", "Через радіозв'язок."] },
        {
            points: 4, type: "match", question: "Встановіть відповідність між сигналом гіркового світлофора та його значенням.",
            items: [
                { id: "green", text: "Один зелений вогонь", drawing: `<div class="signal-body"><div class="light green"></div></div>`},
                { id: "red", text: "Один червоний вогонь", drawing: `<div class="signal-body"><div class="light red"></div></div>`},
                { id: "yellow_green", text: "Один жовтий і один зелений вогні", drawing: `<div class="signal-body"><div class="light yellow"></div><div class="light green"></div></div>`},
                { id: "yellow", text: "Один жовтий вогонь", drawing: `<div class="signal-body"><div class="light yellow"></div></div>`}
            ],
            definitions: ["Розпуск із зменшеною швидкістю.", "Розпуск із встановленою швидкістю.", "Стій! Забороняється розпуск.", "Розпуск із проміжною швидкістю."],
            answer: ["green-Розпуск із встановленою швидкістю.", "red-Стій! Забороняється розпуск.", "yellow_green-Розпуск із проміжною швидкістю.", "yellow-Розпуск із зменшеною швидкістю."]
        },
        {
            points: 4, type: "match", question: "Встановіть відповідність між звуковим сигналом при маневрах та його значенням.",
            items: [
                { id: "one_long", text: "Один довгий", morse: "—" },
                { id: "two_short", text: "Два коротких", morse: "••" },
                { id: "three_short", text: "Три коротких", morse: "•••" },
                { id: "two_long", text: "Два довгих", morse: "— —" }
            ],
            definitions: ["«Тихіше»", "«Стій!»", "«Рух управлінням уперед»", "«Рух управлінням назад»"],
            answer: ["one_long-«Рух управлінням уперед»", "two_short-«Тихіше»", "three_short-«Стій!»", "two_long-«Рух управлінням назад»"]
        },
        { points: 3, type: "sequence", question: "Розташуйте сигнали гіркового світлофора у порядку зростання дозволеної швидкості розпуску.", items: ["Один зелений вогонь", "Один жовтий вогонь", "Один жовтий і один зелений вогні"], answer: ["Один жовтий вогонь", "Один жовтий і один зелений вогні", "Один зелений вогонь"] }
    ];

    let maxPossiblePoints = quizData.reduce((sum, q) => sum + q.points, 0);
    let currentQuestionIndex = 0, userAnswers = [], questionTimings = [], questionStartTime, timerInterval, studentData = {};

    function isLocalStorageAvailable() { try { const storage = window.localStorage, x = '__storage_test__'; storage.setItem(x, x); storage.removeItem(x); return true; } catch (e) { return false; } }
    function loadHistory() { if (!isLocalStorageAvailable()) return; const historyContainer = document.getElementById('history-container'); try { const history = JSON.parse(localStorage.getItem('quizHistory_maneuvers')) || []; if (history.length <= 1) return; const previousAttempts = history.slice(0, -1).sort((a, b) => new Date(b.date) - new Date(a.date)); let tableHTML = `<h4 style="margin-top: 30px;">Історія попередніх спроб</h4><table id="history-table"><tr><th>Дата і час</th><th>Бали</th><th>Оцінка</th></tr>`; previousAttempts.forEach(item => { const date = new Date(item.date).toLocaleString('uk-UA'); const score = `${Number(item.score).toFixed(1)} / ${maxPossiblePoints}`; const grade10 = item.grade ?? '-'; tableHTML += `<tr><td>${date}</td><td>${score}</td><td>${grade10}</td></tr>`; }); tableHTML += '</table>'; historyContainer.innerHTML = tableHTML; } catch (e) { console.error("Помилка завантаження історії:", e); localStorage.removeItem('quizHistory_maneuvers'); } }
    function saveHistory(score, grade10) { if (!isLocalStorageAvailable()) return; try { const history = JSON.parse(localStorage.getItem('quizHistory_maneuvers')) || []; history.push({ date: new Date().toISOString(), score: score, grade: grade10 }); localStorage.setItem('quizHistory_maneuvers', JSON.stringify(history)); } catch (e) { console.error("Помилка збереження історії:", e); } }
    function repeatTest() { window.location.reload(); }
    function setupModal() { const modal = document.getElementById('image-modal'); const closeModal = document.querySelector('.close-modal'); modal.onclick = (e) => { if (e.target === modal || e.target === closeModal) modal.style.display = 'none'; }; }
    function startQuiz(e) { e.preventDefault(); studentData.fullName = document.getElementById('fullName').value; studentData.group = document.getElementById('group').value; document.getElementById('user-info-form').style.display = 'none'; document.getElementById('quiz-container').style.display = 'block'; setupModal(); startTimer(); renderQuestion(); }
    function startTimer() { let startTime = Date.now(); timerInterval = setInterval(() => { const elapsed = Date.now() - startTime; const minutes = String(Math.floor(elapsed / 60000)).padStart(2, '0'); const seconds = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, '0'); document.getElementById('timer').innerText = `${minutes}:${seconds}`; }, 1000); }

    function renderQuestion() {
        const contentArea = document.querySelector('.content');
        contentArea.classList.add('is-changing');
        questionStartTime = Date.now();

        setTimeout(() => {
            const q = quizData[currentQuestionIndex];
            const display = document.getElementById('question-display');
            let html = `<div class="question-block" id="current-question-block" data-type="${q.type}">`;
            if (q.drawing) html += q.drawing;
            html += `<p style="font-size: 1.2rem; font-weight: 600;">${q.question} <span class="question-points">${q.points} ${q.points === 1 ? 'бал' : 'бали'}</span></p>`;

            switch (q.type) {
                case 'radio':
                    html += `<div class="answers grid-2-cols">${q.options.map(opt => {
                        const text = typeof opt === 'object' ? opt.text : opt;
                        const drawing = typeof opt === 'object' ? opt.drawing || '' : '';
                        return `<label><input type="radio" name="answer" value="${text}">${drawing}<span class="answer-text">${text}</span></label>`
                    }).join('')}</div>`;
                    break;
                case 'checkbox':
                    html += `<div class="answers grid-2-cols">${q.options.map(opt => `<label><input type="checkbox" name="answer" value="${opt}"><span class="answer-text">${opt}</span></label>`).join('')}</div>`;
                    break;
                case 'match':
                    const items = [...q.items].sort(() => Math.random() - 0.5);
                    html += `<div class="dnd-container">
                                <div class="dnd-source-column">
                                    <h4>Перетягніть:</h4>
                                    <div class="source-list">${items.map(i => {
                                        const id = typeof i === 'object' ? i.id : i;
                                        const drawing = typeof i === 'object' ? i.drawing || '' : '';
                                        const text = typeof i === 'object' ? `<span>${i.text}</span>` : `<span>${i}</span>`;
                                        const morse = typeof i === 'object' && i.morse ? `<div class="dnd-item-placeholder">${i.morse}</div>` : '';
                                        const content = typeof i === 'object' ? `${drawing}${text}` : text;
                                        return `<div class="dnd-item-wrapper"><div class="dnd-item" draggable="true" data-id="${id}">${content}</div>${morse}</div>`;
                                    }).join('')}</div>
                                </div>
                                <div class="dnd-target-column">
                                    ${q.definitions.map(d => `<div><h4>${d}:</h4><div class="drop-zone" data-target-id="${d}"></div></div>`).join('')}
                                </div>
                             </div>`;
                    break;
                case 'sequence':
                    const s_items = [...q.items].sort(() => Math.random() - 0.5);
                    html += `<div class="sequence-click-container">${s_items.map(i => `<div class="sequence-click-item" data-text="${i}"><span class="sequence-number"></span><span class="sequence-text">${i}</span></div>`).join('')}</div><div style="text-align: center;"><button class="reset-sequence-btn">Скинути вибір</button></div>`;
                    break;
            }
            display.innerHTML = html + '</div>';

            if (q.type === 'match') setupDragAndDrop();
            if (q.type === 'sequence') setupSequenceClick();

            document.getElementById('question-counter').innerText = `Питання ${currentQuestionIndex + 1} з ${quizData.length}`;
            updateProgressBar();
            document.getElementById('next-btn').innerText = (currentQuestionIndex === quizData.length - 1) ? 'Завершити' : 'Наступне питання';
            document.getElementById('next-btn').disabled = true; // Завжди вимикаємо кнопку спочатку
            contentArea.classList.remove('is-changing');

            document.getElementById('current-question-block')?.addEventListener('change', checkAnswerProvided);
            document.getElementById('current-question-block')?.addEventListener('click', checkAnswerProvided); // Для sequence
        }, 400);
    }

    function setupDragAndDrop() {
        document.querySelectorAll('.dnd-item').forEach(d => {
            d.addEventListener('dragstart', (e) => {
                e.target.classList.add('dragging');
                const wrapper = e.target.closest('.dnd-item-wrapper');
                if (wrapper) setTimeout(() => wrapper.classList.add('ghost'), 0);
            });
            d.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
                 const wrapper = e.target.closest('.dnd-item-wrapper');
                 if (wrapper) wrapper.classList.remove('ghost');
                checkAnswerProvided();
            });
        });
        document.querySelectorAll('.drop-zone').forEach(z => {
            z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('drag-over'); });
            z.addEventListener('dragleave', () => z.classList.remove('drag-over'));
            z.addEventListener('drop', e => {
                e.preventDefault(); z.classList.remove('drag-over');
                const draggedItem = document.querySelector('.dragging');
                if (!draggedItem) return;
                const draggableUnit = draggedItem.closest('.dnd-item-wrapper') || draggedItem;
                if (z.children.length === 0) {
                    z.appendChild(draggableUnit);
                    checkAnswerProvided();
                }
            });
        });
    }

    checkAnswerProvided = function() { let isProvided = false; const qBlock = document.getElementById('current-question-block'); if (!qBlock) return; const qType = qBlock.dataset.type; switch (qType) { case 'radio': isProvided = !!qBlock.querySelector('input[name="answer"]:checked'); break; case 'checkbox': isProvided = qBlock.querySelectorAll('input[name="answer"]:checked').length > 0; break; case 'match': isProvided = qBlock.querySelector('.source-list').children.length === 0; break; case 'sequence': isProvided = qBlock.querySelectorAll('.numbered').length === quizData[currentQuestionIndex].items.length; break; } document.getElementById('next-btn').disabled = !isProvided; };
    setupSequenceClick = function() { const container = document.querySelector('.sequence-click-container'); if (!container) return; container.querySelectorAll('.sequence-click-item').forEach(item => { item.addEventListener('click', () => { if (item.classList.contains('numbered')) return; item.classList.add('numbered'); item.dataset.order = container.querySelectorAll('.numbered').length; item.querySelector('.sequence-number').innerText = item.dataset.order; checkAnswerProvided(); }); }); document.querySelector('.reset-sequence-btn')?.addEventListener('click', () => { container.querySelectorAll('.sequence-click-item').forEach(item => { item.classList.remove('numbered'); item.querySelector('.sequence-number').innerText = ''; delete item.dataset.order; }); checkAnswerProvided(); }); };
    collectAnswer = function() { const q = quizData[currentQuestionIndex]; const qBlock = document.getElementById('current-question-block'); if (!qBlock) return; switch (q.type) { case 'radio': userAnswers[currentQuestionIndex] = qBlock.querySelector('input[name="answer"]:checked')?.value || null; break; case 'checkbox': userAnswers[currentQuestionIndex] = Array.from(qBlock.querySelectorAll('input[name="answer"]:checked')).map(cb => cb.value); break; case 'match': const matches = []; qBlock.querySelectorAll('.drop-zone').forEach(zone => { const zoneId = zone.dataset.targetId; zone.querySelectorAll('.dnd-item').forEach(item => { matches.push(`${item.dataset.id}-${zoneId}`); }); }); userAnswers[currentQuestionIndex] = matches.sort(); break; case 'sequence': userAnswers[currentQuestionIndex] = Array.from(qBlock.querySelectorAll('.sequence-click-item')).sort((a, b) => a.dataset.order - b.dataset.order).map(item => item.dataset.text); break; } };
    nextQuestion = function() { questionTimings.push(Date.now() - questionStartTime); collectAnswer(); currentQuestionIndex++; if (currentQuestionIndex < quizData.length) renderQuestion(); else finishQuiz(); };
    updateProgressBar = function() { document.getElementById('progress-bar-inner').style.width = `${((currentQuestionIndex) / quizData.length) * 100}%`; };
    finishQuiz = function() { clearInterval(timerInterval); let score = 0; const results = quizData.map((q, i) => { const userAns = userAnswers[i]; const correctAns = q.answer; let questionScore = 0, resultType = 'incorrect'; switch (q.type) { case 'radio': if (String(userAns || '').toLowerCase().trim() === String(correctAns).toLowerCase().trim()) { questionScore = q.points; resultType = 'correct'; } break; case 'checkbox': if (userAns?.length) { const correctCount = userAns.filter(ans => correctAns.includes(ans)).length; const incorrectCount = userAns.length - correctCount; const scorePerItem = q.points / correctAns.length; questionScore = Math.max(0, correctCount * scorePerItem - incorrectCount * scorePerItem); if (incorrectCount === 0 && correctCount === correctAns.length) resultType = 'correct'; else if (questionScore > 0) resultType = 'partial'; } break; case 'match': if (userAns?.length) { const correctMatches = userAns.filter(m => correctAns.sort().includes(m)).length; questionScore = (correctMatches / q.items.length) * q.points; if (correctMatches === q.items.length) resultType = 'correct'; else if (questionScore > 0) resultType = 'partial'; } break; case 'sequence': if (userAns?.length === correctAns.length && userAns.every((item, index) => item === correctAns[index])) { questionScore = q.points; resultType = 'correct'; } break; } score += questionScore; return resultType; }); const grade10 = convertToFinalGrade(score, maxPossiblePoints); saveHistory(score, grade10); document.getElementById('quiz-container').style.display = 'none'; document.getElementById('results-container').style.display = 'block'; displayResults(results, score, grade10); };
    convertToFinalGrade = function(score, maxScore) { if (maxScore === 0) return 0; const grade = (score / maxScore) * 10; return Math.round(grade); };

    // ПОКРАЩЕНО: функція displayResults з анімаціями
    displayResults = function(results, score, grade10) {
        let totalTime = questionTimings.reduce((a, b) => a + b, 0);
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.querySelector('.user-name').innerText = studentData.fullName;
        resultsContainer.querySelector('#result-group').innerText = `Група: ${studentData.group}`;
        resultsContainer.querySelector('#time-taken').innerHTML = `⏱️ Загальний час: <strong>${String(Math.floor(totalTime/60000)).padStart(2,'0')}:${String(Math.floor((totalTime%60000)/1000)).padStart(2,'0')}</strong>`;
        
        // Анімація сітки відповідей
        resultsContainer.querySelector('#answer-grid').innerHTML = results.map((res, i) =>
            `<span class="grid-${res}" style="animation-delay: ${i * 50}ms;">${i + 1}</span>`
        ).join('');

        // Анімація підрахунку оцінки
        const finalGradeEl = resultsContainer.querySelector('#final-grade');
        let currentGrade = 0;
        finalGradeEl.innerText = 0;
        if (grade10 > 0) {
            const counter = setInterval(() => {
                currentGrade++;
                finalGradeEl.innerText = currentGrade;
                if (currentGrade >= grade10) {
                    clearInterval(counter);
                    finalGradeEl.innerText = grade10;
                }
            }, 800 / grade10);
        }

        resultsContainer.querySelector('#raw-score').innerHTML = `(Набрано <strong>${score.toFixed(1)}</strong> із <strong>${maxPossiblePoints}</strong> балів)`;
        const statusBadge = resultsContainer.querySelector('#status-badge');
        if (grade10 >= 4) {
            statusBadge.innerHTML = 'Зараховано';
            statusBadge.className = 'status-badge status-passed';
        } else {
            statusBadge.innerHTML = 'Не зараховано';
            statusBadge.className = 'status-badge status-failed';
        }

        const timeChart = document.getElementById('time-chart');
        const maxTime = Math.max(...questionTimings, 1);
        if(timeChart) {
            timeChart.innerHTML = questionTimings.map((time, index) => {
                const height = maxTime > 0 ? (time / maxTime) * 100 : 0;
                const timeInSeconds = (time / 1000).toFixed(1);
                // Анімація графіку часу
                return `<div class="time-bar" style="height: ${height}%; animation-delay: ${index * 50}ms;" title="Питання ${index + 1}: ${timeInSeconds} сек."><span class="bar-label">${timeInSeconds}с</span></div>`;
            }).join('');
        }
        loadHistory();
    };

    saveReportAsHTML = function() { const btn = document.getElementById('save-report-btn'); btn.innerText = 'Зберігаємо...'; btn.disabled = true; const styles = Array.from(document.styleSheets).map(s => { try { return Array.from(s.cssRules).map(r => r.cssText).join('\n'); } catch (e) { return ''; }}).join('\n'); const report = document.getElementById('results-container').innerHTML; const header = document.querySelector('.header').outerHTML; const html = `<!DOCTYPE html><html lang="uk"><head><meta charset="UTF-8"><title>Звіт: ${studentData.fullName}</title><style>${styles}</style><style>body{align-items:flex-start}.test-wrapper{margin:20px auto}#results-container{display:block !important}.button-container{flex-direction: column; gap: 10px; align-items: center;} #save-report-btn, .btn[onclick="repeatTest()"] {display:none !important}</style></head><body><div class="test-wrapper">${header}<main class="content">${report}</main></div></body></html>`; const blob = new Blob([html], { type: 'text/html' }); const link = document.createElement('a'); const dateStr = new Date().toISOString().slice(0, 10); const name = studentData.fullName.replace(/[^a-z0-9]/gi, '_').toLowerCase(); link.download = `zvit-manevry-${name}-${dateStr}.html`; link.href = URL.createObjectURL(blob); link.click(); URL.revokeObjectURL(link.href); setTimeout(() => { btn.innerText = 'Зберегти звіт'; btn.disabled = false; }, 1000); };
</script>
</body>
</html>