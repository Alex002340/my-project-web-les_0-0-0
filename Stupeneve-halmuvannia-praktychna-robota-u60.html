<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Практична робота: Аналіз швидкостемірної стрічки (v2.9)</title>
<style>
    :root {
        --bg-color: #f4f7f9;
        --card-bg: #ffffff;
        --primary-color: #005a9c;
        --secondary-color: #333333;
        --accent-color: #d9534f;
        --button-report-bg: #5cb85c;
        --button-example-bg: #f0ad4e;
        --border-color: #e1e4e8;
        --paper-bg: #fdf5e6;
        --tape-border: #c9b8a2;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: var(--font-family);
        background-color: var(--bg-color);
        color: var(--secondary-color);
        margin: 0;
        padding: 15px;
        line-height: 1.6;
    }
    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--card-bg);
        padding: clamp(15px, 4vw, 30px);
        border-radius: 12px;
        box-shadow: var(--shadow);
    }
    h1, h2, h3 {
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 0.5em;
    }
    h1 { font-size: clamp(1.5rem, 5vw, 2.2rem); }
    h2 { font-size: clamp(1.2rem, 4vw, 1.8rem); margin-top: 1.5em; }
    
    .card {
        margin-bottom: 25px;
        padding: clamp(15px, 3vw, 25px);
        background: #fafcff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }
    
    .student-info .form-grid, .analysis-section .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }
    
    label { font-weight: 600; display: block; margin-bottom: 5px; }
    input[type="text"], input[type="number"], textarea {
        width: 100%; padding: 10px; border: 1px solid var(--border-color);
        border-radius: 6px; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.15);
        outline: none;
    }
    input[readonly] { background-color: #f0f0f0; cursor: not-allowed; }
    textarea { resize: vertical; min-height: 120px; }

    .control-panel { text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .action-button {
        padding: 12px 25px; font-size: 1rem; cursor: pointer; color: white; border: none;
        border-radius: 6px; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        font-weight: 600;
    }
    #generateButton { background-color: var(--primary-color); }
    #generateButton:hover { background-color: #004170; transform: translateY(-2px); }
    #saveReportButton { background-color: var(--button-report-bg); }
    #saveReportButton:hover { background-color: #4a9d4a; transform: translateY(-2px); }
    #exampleButton { background-color: var(--button-example-bg); }
    #exampleButton:hover { background-color: #ec971f; transform: translateY(-2px); }
    
    #example-mode-indicator {
        display: none; background-color: var(--button-example-bg); color: #fff;
        text-align: center; padding: 10px; border-radius: 6px;
        font-weight: bold; margin-bottom: 20px;
    }

    .tape-container {
        width: 100%; height: 450px; background-color: var(--paper-bg);
        border: 2px solid var(--tape-border); overflow-x: auto; position: relative;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) inset; margin-top: 20px;
    }
    .tape { height: 100%; }
    .time-writer-line { fill: none; stroke: var(--accent-color); stroke-width: 1; }
    .speed-line { fill: none; stroke: #0055a4; stroke-width: 2; }
    .pressure-line { fill: none; stroke: #2ca02c; stroke-width: 1.5; }
    .braking-point { fill: var(--accent-color); }
    .tooltip {
        position: fixed; background-color: rgba(0,0,0,0.85); color: white; padding: 10px;
        border-radius: 6px; font-size: 14px; font-family: 'Consolas', monospace;
        pointer-events: none; opacity: 0; transition: opacity 0.2s; white-space: pre; z-index: 1000;
    }
    .axis-text { font-size: 10px; fill: #a52a2a; }
    .grid-line { stroke: #d1a6a6; stroke-width: 0.5; }

    .stat-line { stroke-width: 1.5; stroke-dasharray: 8, 4; opacity: 0.9; }
    .max-speed-line { stroke: #2ca02c; }
    .avg-speed-line { stroke: #ff7f0e; }
    .min-speed-line { stroke: #1f77b4; }

    .stat-label {
        font-size: 12px; font-weight: bold; paint-order: stroke;
        stroke: var(--paper-bg); stroke-width: 3px; stroke-linecap: butt;
    }
    .max-speed-label { fill: #2ca02c; }
    .avg-speed-label { fill: #ff7f0e; }
    .min-speed-label { fill: #1f77b4; }
    
    #brakingAnalysisTable { width: 100%; border-collapse: collapse; margin-top: 10px; }
    #brakingAnalysisTable th, #brakingAnalysisTable td {
        border: 1px solid var(--border-color); padding: 8px; text-align: center;
    }
    #brakingAnalysisTable th { background-color: #f2f5f8; }
    #brakingAnalysisTable input { width: 90%; text-align: center; padding: 6px; }

    #distanceReport {
        background-color: #eef7ff; border-left: 5px solid var(--primary-color);
        padding: 15px; margin-top: 20px; border-radius: 4px; font-style: italic;
    }
</style>
</head>
<body>

<div class="main-container">
    <header><h1>Інтерактивна практична робота</h1><h2>Аналіз швидкостемірної стрічки v2.9</h2></header>

    <section class="card student-info">
        <h3>Дані виконавця</h3>
        <div class="form-grid">
            <div><label for="studentName">ПІБ здобувача освіти:</label><input type="text" id="studentName" placeholder="Введіть повне ім'я"></div>
            <div><label for="studentGroup">Група:</label><input type="text" id="studentGroup" placeholder="Введіть назву групи"></div>
        </div>
    </section>
    
    <div id="example-mode-indicator">Ви перебуваєте в режимі "Приклад". Збереження звіту неможливе.</div>

    <section class="card control-panel">
        <button id="generateButton" class="action-button">Згенерувати нову стрічку</button>
        <button id="exampleButton" class="action-button">Показати приклад</button>
        <button id="saveReportButton" class="action-button">Сформувати та завантажити звіт</button>
    </section>

    <section>
        <div class="tape-container" id="tapeContainer"><svg id="speedTape" class="tape"></svg></div>
        <div id="tooltip" class="tooltip"></div>
    </section>

    <section id="analysis-form" class="card analysis-section">
        <h2>Форма для аналізу та спостережень</h2>
        <div class="analysis-block">
            <h3>1. Загальний аналіз руху та відстань</h3>
            <div id="distanceReport"><p>Згенеруйте стрічку для розрахунку відстані.</p></div>
            <div class="form-grid">
                <div><label for="maxSpeed">Макс. швидкість (км/год):</label><input type="number" id="maxSpeed" step="0.1"></div>
                <div><label for="avgSpeed">Середня швидкість (км/год):</label><input type="number" id="avgSpeed" step="0.1"></div>
                <div><label for="travelTime">Загальний час РУХУ (хв):</label><input type="number" id="travelTime" readonly></div>
                <div><label for="stopCount">Кількість зупинок:</label><input type="number" id="stopCount" readonly></div>
                <div><label for="brakingCount">Кількість гальмувань:</label><input type="number" id="brakingCount"></div>
            </div>
        </div>
        <div class="analysis-block">
            <h3>2. Детальний аналіз ступеневих гальмувань</h3>
            <div id="brakingTableContainer" style="overflow-x: auto;"><p>Згенеруйте стрічку, щоб тут з'явилася таблиця для аналізу.</p></div>
        </div>
        <div class="analysis-block">
            <h3>3. Аналітичні висновки</h3>
            <div><label for="conclusion1">Яким був загальний характер руху поїзда?</label><textarea id="conclusion1"></textarea></div>
            <div style="margin-top: 15px;"><label for="conclusion2">Порівняйте найбільш та найменш інтенсивне гальмування.</label><textarea id="conclusion2"></textarea></div>
            <div style="margin-top: 15px;"><label for="conclusion3">Чи були на стрічці моменти, що можуть свідчити про нештатну ситуацію?</label><textarea id="conclusion3"></textarea></div>
            <div style="margin-top: 15px;"><label for="conclusion4">Ваша загальна оцінка дій машиніста.</label><textarea id="conclusion4"></textarea></div>
        </div>
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const svg = document.getElementById('speedTape'); const tooltip = document.getElementById('tooltip'); const container = document.getElementById('tapeContainer');
    const generateButton = document.getElementById('generateButton'); const saveReportButton = document.getElementById('saveReportButton');
    const exampleButton = document.getElementById('exampleButton'); const exampleIndicator = document.getElementById('example-mode-indicator');
    
    let isExampleMode = false; let currentTapeStats = {}; let brakingEventsData = [];

    function generateRandomTapeData() {
        const data = []; brakingEventsData = []; 
        let currentTime = 0, currentSpeed = 0, brakingEventCount = 0, stopsGenerated = 0; const totalTime = 180;
        while (currentTime < totalTime) {
            const topSpeed = 60 + Math.random() * 80; const accelTime = Math.random() * 10 + 8;
            for (let t = 0; t < accelTime && currentTime < totalTime; t++, currentTime++) { currentSpeed += (topSpeed - currentSpeed) * Math.random() * 0.15; data.push({ time: currentTime, speed: currentSpeed, pressure: 0 }); }
            if (currentTime >= totalTime) break;
            const constTime = Math.random() * 20 + 15;
            for (let t = 0; t < constTime && currentTime < totalTime; t++, currentTime++) { data.push({ time: currentTime, speed: currentSpeed + (Math.random() - 0.5) * 4, pressure: 0 }); }
            if (currentTime >= totalTime) break;
            if (currentTime < totalTime) {
                brakingEventCount++;
                const brakingData = { time: currentTime, speed: currentSpeed, stages: [] }; 
                let numStages = Math.floor(Math.random() * 3) + 2; let isStoppingEvent = numStages >= 3;
                if (brakingEventCount === 2 && stopsGenerated === 0) { isStoppingEvent = true; } if (brakingEventCount === 4 && stopsGenerated < 2) { isStoppingEvent = true; }
                if (isStoppingEvent && numStages < 3) { numStages = 3; } if (isStoppingEvent) { stopsGenerated++; }
                let lastPressure = 0;
                for (let i = 1; i <= numStages; i++) { let pressure_step = Math.random() * 1.3 + 0.5; lastPressure = Math.min(4.0, lastPressure + pressure_step); brakingData.stages.push({ stage: i, pressure: parseFloat(lastPressure.toFixed(2)) }); }
                brakingEventsData.push(brakingData);
                for (let i = 0; i < numStages; i++) {
                    const stagePressure = brakingData.stages[i].pressure, brakeDurationPerStage = Math.random() * 4 + 4;
                    for (let t = 0; t < brakeDurationPerStage && currentTime < totalTime; t++, currentTime++) {
                        currentSpeed -= (stagePressure * 0.5); currentSpeed = isStoppingEvent ? Math.max(0, currentSpeed) : Math.max(20, currentSpeed);
                        data.push({ time: currentTime, speed: currentSpeed, pressure: stagePressure });
                    }
                    if (currentTime >= totalTime) break;
                }
                if (currentTime < totalTime) {
                    data.push({ time: currentTime, speed: currentSpeed, pressure: 0 });
                    if (isStoppingEvent && currentSpeed < 0.1) {
                         const stopDuration = Math.random() * 10 + 5;
                         for (let t = 0; t < stopDuration && currentTime < totalTime; t++, currentTime++) { data.push({ time: currentTime, speed: 0, pressure: 0 }); }
                    }
                }
            }
        }
        return data;
    }

    function generateExampleTapeData() {
        const data = []; brakingEventsData = []; let currentTime = 0, currentSpeed = 0;
        const totalTime = 180;
        const scenario = [
            { type: 'accel', targetSpeed: 110, duration: 15 }, { type: 'cruise', duration: 35 },
            { type: 'brake', stages: 3, durationPerStage: 5 }, { type: 'stop', duration: 10 },
            { type: 'accel', targetSpeed: 95, duration: 12 }, { type: 'cruise', duration: 40 },
            { type: 'brake', stages: 4, durationPerStage: 4 }, { type: 'stop', duration: 8 },
            { type: 'accel', targetSpeed: 120, duration: 15 }, { type: 'cruise', duration: 100 }
        ];
        scenario.forEach(event => {
            if (currentTime >= totalTime) return;
            switch(event.type) {
                case 'accel': for(let t=0; t < event.duration && currentTime < totalTime; t++, currentTime++) { currentSpeed += (event.targetSpeed - currentSpeed) * 0.2; data.push({ time: currentTime, speed: currentSpeed, pressure: 0 }); } break;
                case 'cruise': for(let t=0; t < event.duration && currentTime < totalTime; t++, currentTime++) { data.push({ time: currentTime, speed: currentSpeed + (Math.random()-0.5)*2, pressure: 0 }); } break;
                case 'brake':
                    const brakingData = { time: currentTime, speed: currentSpeed, stages: [] }; let lastPressure = 0;
                    for (let i = 1; i <= event.stages; i++) { let pressure_step = Math.random() * 1.3 + 0.5; lastPressure = Math.min(4.0, lastPressure + pressure_step); brakingData.stages.push({ stage: i, pressure: parseFloat(lastPressure.toFixed(2)) }); }
                    brakingEventsData.push(brakingData);
                    for (let i = 0; i < event.stages; i++) { const stagePressure = brakingData.stages[i].pressure; for (let t = 0; t < event.durationPerStage && currentTime < totalTime; t++, currentTime++) { currentSpeed -= (stagePressure * 0.7); currentSpeed = Math.max(0, currentSpeed); data.push({ time: currentTime, speed: currentSpeed, pressure: stagePressure }); } }
                    data.push({ time: currentTime, speed: currentSpeed, pressure: 0 }); break;
                case 'stop': for(let t=0; t < event.duration && currentTime < totalTime; t++, currentTime++) { data.push({ time: currentTime, speed: 0, pressure: 0 }); } break;
            }
        });
        return data;
    }

    function drawTape(data) {
        svg.innerHTML = '';
        const width = 3000, height = container.clientHeight, maxSpeed = 160;
        const margin = { top: 20, right: 150, bottom: 30, left: 10 };
        const plotWidth = width - margin.left - margin.right; const plotHeight = height - margin.top - margin.bottom;
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("transform", `translate(${margin.left},${margin.top})`);
        svg.setAttribute('width', width); svg.setAttribute('height', height); svg.appendChild(g);

        let cumulativeMovingTime = 0, stopCount = 0;
        for(let i = 0; i < data.length; i++) {
            if (data[i].speed > 0.1) cumulativeMovingTime++;
            if (i > 0 && data[i].speed < 0.1 && data[i-1].speed > 0.1) { stopCount++; }
            data[i].cumulativeMovingTime = cumulativeMovingTime;
        }

        const maxPressure = 6; const xScale = t => (t / 180) * plotWidth; const yScaleSpeed = s => plotHeight - (s / maxSpeed) * plotHeight;
        
        for (let i = 0; i <= maxSpeed; i += 10) { const y = yScaleSpeed(i), line = document.createElementNS("http://www.w3.org/2000/svg", "line"); line.setAttribute("x1", 0); line.setAttribute("y1", y); line.setAttribute("x2", plotWidth); line.setAttribute("y2", y); line.setAttribute("class", "grid-line"); g.appendChild(line); if (i % 20 === 0 && i > 0) { const text = document.createElementNS("http://www.w3.org/2000/svg", "text"); text.setAttribute("class", "axis-text"); text.setAttribute("x", -5); text.setAttribute("y", y + 3); text.setAttribute("text-anchor", "end"); text.textContent = i; g.appendChild(text); } }
        for (let i = 0; i <= 180; i += 10) { const x = xScale(i), text = document.createElementNS("http://www.w3.org/2000/svg", "text"); text.setAttribute("class", "axis-text"); text.setAttribute("x", x); text.setAttribute("y", plotHeight + 15); text.setAttribute("text-anchor", "middle"); text.textContent = i; g.appendChild(text); }
        
        const path = (d, className) => { const p = document.createElementNS("http://www.w3.org/2000/svg", "path"); p.setAttribute("d", d); p.setAttribute("class", className); g.appendChild(p); };
        const speedPathData = data.map((d, i) => `${i === 0 ? 'M' : 'L'}${xScale(d.time)} ${yScaleSpeed(d.speed)}`).join(' ');
        const pressurePathData = data.map((d, i, arr) => { const yScalePressure = p => plotHeight - (p / maxPressure) * plotHeight; if (i > 0 && arr[i-1].pressure !== d.pressure) return `L${xScale(d.time)} ${yScalePressure(arr[i-1].pressure)} L${xScale(d.time)} ${yScalePressure(d.pressure)}`; return `${i === 0 ? 'M' : 'L'}${xScale(d.time)} ${yScalePressure(d.pressure)}`; }).join(' ');
        const timeWriterPathData = data.map((d, i) => { const yTime = (plotHeight * 0.15) - (d.cumulativeMovingTime % 60) * ((plotHeight * 0.15) / 60); return `${i === 0 ? 'M' : 'L'}${xScale(d.time)} ${yTime}`; }).join(' ');
        path(timeWriterPathData, "time-writer-line"); path(speedPathData, "speed-line"); path(pressurePathData, "pressure-line");

        let maxSpeedValue = 0, minSpeedValue = maxSpeed, speedSum = 0, movingTimePoints = 0;
        data.forEach(d => { if (d.speed > maxSpeedValue) maxSpeedValue = d.speed; if (d.speed > 0.1) { if (d.speed < minSpeedValue) minSpeedValue = d.speed; speedSum += d.speed; movingTimePoints++; } });
        if (movingTimePoints === 0) minSpeedValue = 0;
        const averageSpeedValue = movingTimePoints > 0 ? speedSum / movingTimePoints : 0;
        currentTapeStats = { maxSpeedValue, averageSpeedValue, movingTimePoints, stopCount, brakingEventCount: brakingEventsData.length };
        
        function drawStatLine(speed, label, cssClass) { if (speed <= 0) return; const y = yScaleSpeed(speed), line = document.createElementNS("http://www.w3.org/2000/svg", "line"), text = document.createElementNS("http://www.w3.org/2000/svg", "text"); line.setAttribute('x1', 0); line.setAttribute('y1', y); line.setAttribute('x2', plotWidth); line.setAttribute('y2', y); line.setAttribute('class', `stat-line ${cssClass}-line`); g.appendChild(line); text.setAttribute('x', plotWidth + 5); text.setAttribute('y', y + 4); text.setAttribute('class', `stat-label ${cssClass}-label`); text.setAttribute('text-anchor', 'start'); text.textContent = `${label}: ${speed.toFixed(1)} км/год`; g.appendChild(text); }
        drawStatLine(maxSpeedValue, 'Vmax', 'max-speed'); drawStatLine(averageSpeedValue, 'Vavg', 'avg-speed'); drawStatLine(minSpeedValue, 'Vmin', 'min-speed');

        brakingEventsData.forEach((event, index) => {
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("class", "braking-point"); circle.setAttribute("cx", xScale(event.time)); circle.setAttribute("cy", yScaleSpeed(event.speed)); circle.setAttribute("r", 6);
            const tooltipText = `Гальмування #${index + 1}\nК-сть ступенів: ${event.stages.length}\n---------------------\n`+ event.stages.map(s => `Ступінь ${s.stage}: ${s.pressure} кгс/см²`).join('\n');
            circle.addEventListener('mouseover', e => { tooltip.style.opacity = 1; tooltip.innerHTML = tooltipText.replace(/\n/g, '<br>'); });
            circle.addEventListener('mousemove', e => { tooltip.style.left = `${e.clientX + 15}px`; tooltip.style.top = `${e.clientY + 5}px`; });
            circle.addEventListener('mouseout', () => { tooltip.style.opacity = 0; });
            g.appendChild(circle);
        });
        
        document.getElementById('travelTime').value = movingTimePoints; document.getElementById('stopCount').value = stopCount;
        const totalDistance = averageSpeedValue * (movingTimePoints / 60); const tapeLengthMm = totalDistance * 5;
        document.getElementById('distanceReport').innerHTML = `<p><b>Приклад розрахунку відстані:</b></p><ul><li>Загальний час руху (V > 0): <b>${movingTimePoints} хв</b>.</li><li>Середня швидкість під час руху: <b>${averageSpeedValue.toFixed(1)} км/год</b>.</li><li>Розрахункова пройдена відстань: ${averageSpeedValue.toFixed(1)} км/год * (${movingTimePoints} хв / 60) ≈ <b>${totalDistance.toFixed(1)} км</b>.</li><li>Довжина стрічки (за масштабом 5 мм/км): ${totalDistance.toFixed(1)} км * 5 мм/км = <b>${tapeLengthMm.toFixed(1)} мм</b>.</li></ul>`;
        updateAnalysisTable();
    }

    function updateAnalysisTable() {
        const container = document.getElementById('brakingTableContainer'); if (brakingEventsData.length === 0) { container.innerHTML = '<p>Немає даних. Згенеруйте стрічку.</p>'; return; }
        let tableHTML = `<table id="brakingAnalysisTable"><tr><th>№ гальм.</th><th>К-сть ступенів</th><th>1 ступінь кгс/см²</th><th>2 ступінь кгс/см²</th><th>3 ступінь кгс/см²</th><th>4 ступінь кгс/см²</th></tr>`;
        brakingEventsData.forEach((event, index) => { tableHTML += `<tr><td>${index + 1}</td><td><input type="number" id="stages-count-${index}" placeholder="${event.stages.length} (факт.)"></td><td><input type="number" step="0.1" id="pressure-${index}-0"></td><td><input type="number" step="0.1" id="pressure-${index}-1"></td><td><input type="number" step="0.1" id="pressure-${index}-2"></td><td><input type="number" step="0.1" id="pressure-${index}-3"></td></tr>`; });
        tableHTML += `</table>`; container.innerHTML = tableHTML;
    }

    function clearAllFields() {
        document.getElementById('studentName').value = ''; document.getElementById('studentGroup').value = '';
        const inputs = document.querySelectorAll('#analysis-form input, #analysis-form textarea');
        inputs.forEach(input => { if(!input.readOnly) input.value = ''; });
    }

    function enterExampleMode() {
        isExampleMode = true; exampleIndicator.style.display = 'block'; exampleButton.textContent = 'Завершити приклад';
        const exampleData = generateExampleTapeData(); drawTape(exampleData);
        setTimeout(() => { 
            document.getElementById('studentName').value = 'Зразок Прикладенко'; document.getElementById('studentGroup').value = 'ПМТЕ-Приклад';
            document.getElementById('maxSpeed').value = currentTapeStats.maxSpeedValue.toFixed(1); document.getElementById('avgSpeed').value = currentTapeStats.averageSpeedValue.toFixed(1);
            document.getElementById('brakingCount').value = currentTapeStats.brakingEventCount;
            brakingEventsData.forEach((event, index) => {
                document.getElementById(`stages-count-${index}`).value = event.stages.length;
                event.stages.forEach((stage, stageIndex) => { const pressureInput = document.getElementById(`pressure-${index}-${stageIndex}`); if (pressureInput) pressureInput.value = stage.pressure; });
            });
            document.getElementById('conclusion1').value = `Характер руху поїзда відповідав приміському сполученню з двома повними зупинками на проміжних станціях. Спостерігалися інтенсивні розгони, тривалий рух з крейсерською швидкістю та повні службові гальмування для зупинок.`;
            document.getElementById('conclusion2').value = `Найбільш інтенсивним було гальмування №2 (4 ступені), яке забезпечило плавну, але впевнену зупинку з високої швидкості. Гальмування №1 (3 ступені) також було ефективним. Нерівномірність амплітуди тиску на ступенях свідчить про ручне керування гальмами машиністом.`;
            document.getElementById('conclusion3').value = `Нештатних ситуацій на стрічці не виявлено. Максимальний тиск в ГЦ під час гальмувань не перевищив 4.0 кгс/см², що є нормою. Всі зупинки були прогнозованими і виконані за допомогою 3-х та 4-х ступеневих гальмувань.`;
            document.getElementById('conclusion4').value = `Дії машиніста оцінюються як високопрофесійні. Вибір режимів руху та гальмування є оптимальним для даного типу перевезень, забезпечуючи як виконання графіку, так і комфорт для пасажирів.`;
        }, 100);
    }

    function exitExampleMode() {
        if (!isExampleMode) return;
        isExampleMode = false; exampleIndicator.style.display = 'none'; exampleButton.textContent = 'Показати приклад';
        clearAllFields();
    }

    function startNewWork() {
        exitExampleMode(); const randomData = generateRandomTapeData(); drawTape(randomData);
    }
    
    function saveReport() {
        if (isExampleMode) { alert('Зберегти звіт у режимі "Приклад" неможливо. Натисніть "Завершити приклад" або "Згенерувати нову стрічку", щоб почати власну роботу.'); return; }
        const studentName = document.getElementById('studentName').value, studentGroup = document.getElementById('studentGroup').value;
        if (!studentName || !studentGroup) { alert('Будь ласка, заповніть поля ПІБ та Група.'); return; }
        const svgString = new XMLSerializer().serializeToString(svg), reportDate = new Date().toLocaleDateString('uk-UA');
        const analysisData = {
            maxSpeed: document.getElementById('maxSpeed').value, avgSpeed: document.getElementById('avgSpeed').value, travelTime: document.getElementById('travelTime').value,
            stopCount: document.getElementById('stopCount').value, brakingCount: document.getElementById('brakingCount').value, distanceReport: document.getElementById('distanceReport').innerHTML,
            c1: document.getElementById('conclusion1').value.replace(/\n/g, '<br>'), c2: document.getElementById('conclusion2').value.replace(/\n/g, '<br>'),
            c3: document.getElementById('conclusion3').value.replace(/\n/g, '<br>'), c4: document.getElementById('conclusion4').value.replace(/\n/g, '<br>'),
            brakingTable: brakingEventsData.map((event, index) => ({ num: index + 1, stagesFact: event.stages.length, stagesInput: document.getElementById(`stages-count-${index}`).value, p1: document.getElementById(`pressure-${index}-0`).value, p2: document.getElementById(`pressure-${index}-1`).value, p3: document.getElementById(`pressure-${index}-2`).value, p4: document.getElementById(`pressure-${index}-3`).value }))
        };
        const reportBrakingTableHTML = analysisData.brakingTable.map(row => `<tr><td>${row.num}</td><td>${row.stagesInput || '-'} (факт: ${row.stagesFact})</td><td>${row.p1 || '-'}</td><td>${row.p2 || '-'}</td><td>${row.p3 || '-'}</td><td>${row.p4 || '-'}</td></tr>`).join('');
        const htmlContent = `
        <!DOCTYPE html><html lang="uk"><head><meta charset="UTF-8"><title>Звіт: ${studentName}</title>
        <style> body { font-family: 'Times New Roman', serif; margin: 2cm; font-size: 14pt; line-height: 1.5; } h1, h2, h3 { text-align: center; } .header p { text-align: right; margin: 0; } .tape-container { border: 1px solid black; overflow: hidden; page-break-inside: avoid; background-color: #fdf5e6; } table { width: 100%; border-collapse: collapse; margin: 25px 0; } th, td { border: 1px solid black; padding: 8px; text-align: center; } th { background-color: #f2f2f2; } .conclusions-block, .distance-block { margin-top: 25px; } .conclusions-block h4 { margin-top: 1.5em; margin-bottom: 0.5em; } .conclusions-block p { text-align: justify; margin-top: 0; } @media print { body { margin: 1.5cm; font-size: 12pt; } } /* SVG STYLES FOR REPORT */ .time-writer-line { fill: none; stroke: #d9534f; stroke-width: 1; } .speed-line { fill: none; stroke: #0055a4; stroke-width: 2; } .pressure-line { fill: none; stroke: #2ca02c; stroke-width: 1.5; } .braking-point { fill: #d9534f; } .axis-text { font-size: 10px; fill: #a52a2a; } .grid-line { stroke: #d1a6a6; stroke-width: 0.5; } .stat-line { stroke-width: 1.5; stroke-dasharray: 8, 4; opacity: 0.9; } .max-speed-line { stroke: #2ca02c; } .avg-speed-line { stroke: #ff7f0e; } .min-speed-line { stroke: #1f77b4; } .stat-label { font-size: 12px; font-weight: bold; paint-order: stroke; stroke: #fdf5e6; stroke-width: 3px; stroke-linecap: butt; } .max-speed-label { fill: #2ca02c; } .avg-speed-label { fill: #ff7f0e; } .min-speed-label { fill: #1f77b4; } </style>
        </head><body>
            <header class="header"><h1>Звіт про виконання практичної роботи</h1><p><b>Виконав(ла):</b> ${studentName}</p><p><b>Група:</b> ${studentGroup}</p><p><b>Дата:</b> ${reportDate}</p></header><hr>
            <h2>Діаграмна стрічка, що аналізувалася</h2><div class="tape-container" style="width:100%; height:auto;">${svgString}</div>
            <h2>Результати аналізу</h2><h3>1. Загальні параметри та відстань</h3>
            <div class="distance-block">${analysisData.distanceReport}</div>
            <table><tr><th>Параметр</th><th>Значення</th></tr><tr><td>Максимальна швидкість (км/год)</td><td>${analysisData.maxSpeed||'-'}</td></tr><tr><td>Середня швидкість (км/год)</td><td>${analysisData.avgSpeed||'-'}</td></tr><tr><td>Загальний час руху (хв)</td><td>${analysisData.travelTime||'-'}</td></tr><tr><td>Кількість зупинок</td><td>${analysisData.stopCount||'-'}</td></tr><tr><td>Кількість гальмувань</td><td>${analysisData.brakingCount||'-'}</td></tr></table>
            <h3>2. Детальний аналіз ступеневих гальмувань</h3>
            <table><tr><th>№ гальм.</th><th>К-сть ступенів</th><th>1 ступінь кгс/см²</th><th>2 ступінь кгс/см²</th><th>3 ступінь кгс/см²</th><th>4 ступінь кгс/см²</th></tr>${reportBrakingTableHTML}</table>
            <div class="conclusions-block"><h3>3. Аналітичні висновки</h3>
                <h4>Загальний характер руху поїзда:</h4><p>${analysisData.c1||'Відповідь не надано.'}</p>
                <h4>Порівняння інтенсивності гальмувань:</h4><p>${analysisData.c2||'Відповідь не надано.'}</p>
                <h4>Аналіз нештатних ситуацій:</h4><p>${analysisData.c3||'Відповідь не надано.'}</p>
                <h4>Загальна оцінка дій машиніста:</h4><p>${analysisData.c4||'Відповідь не надано.'}</p>
            </div>
        </body></html>`;
        const blob = new Blob([htmlContent], { type: 'text/html' }); const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `Zvit_${studentName.replace(/ /g, '_')}.html`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    
    generateButton.addEventListener('click', startNewWork);
    saveReportButton.addEventListener('click', saveReport);
    exampleButton.addEventListener('click', () => { isExampleMode ? startNewWork() : enterExampleMode(); });
    
    startNewWork();
});
</script>

</body>
</html>