<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Інтерактивне ДЗ: Системи вентиляції та опалення</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        :root {
            /* Нова синя кольорова схема */
            --bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            --bg-light: rgba(255, 255, 255, 0.9);
            --text-color: #0d47a1; /* Темно-синій */
            --correct: #4caf50; 
            --incorrect: #f44336;
            --partial: #ffc107;
            --accent: #1976d2; /* Основний синій */
            --border-color: rgba(25, 118, 210, 0.2);
            --shadow: 0 8px 25px 0 rgba(25, 118, 210, 0.1);
            --shadow-light: 0 4px 15px 0 rgba(25, 118, 210, 0.08);
            --action-gradient: linear-gradient(45deg, #42a5f5, #1976d2); /* Синій градієнт */
        }
        body {
            font-family: 'Nunito', sans-serif; background-image: var(--bg-gradient); color: var(--text-color);
            margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .test-wrapper {
            width: 100%; max-width: 800px; background: var(--bg-light); backdrop-filter: blur(15px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow); overflow: hidden;
        }
        .header { padding: 25px 30px; text-align: center; border-bottom: 1px solid var(--border-color); }
        h1, h2, h3, h4 { margin: 0; padding: 0; color: var(--accent); }
        h1 { font-size: 1.8rem; font-weight: 800; }
        h1 span { color: var(--text-color); }
        h2 { font-size: 1.5rem; margin-bottom: 25px; }
        .content { padding: 30px; transition: opacity 0.4s ease-in-out; }
        .is-changing { opacity: 0; }
        
        #user-info-form .form-group { margin: 0 auto 20px auto; max-width: 400px; }
        #user-info-form label { display: block; margin-bottom: 8px; font-weight: 600; }
        #user-info-form input { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: rgba(255,255,255,0.5); }
        .current-date { text-align: center; margin-bottom: 25px; color: #555; }
        .button-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .btn {
            display: inline-block; background: var(--action-gradient);
            color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem;
            font-weight: 700; cursor: pointer; text-align: center; box-sizing: border-box;
            transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; transform: none; }
        .save-btn { background: #4caf50; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }

        #quiz-container { display: none; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .progress-bar { width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 25px; overflow: hidden; }
        .progress-bar-inner { height: 100%; width: 0%; background: var(--action-gradient); border-radius: 5px; transition: width 0.5s ease-in-out; }
        .question-points { background: var(--accent); color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; display: inline-block; white-space: nowrap; }
        
        .answers label {
            position: relative; overflow: hidden; display: flex; align-items: center; padding: 14px;
            border: 2px solid transparent; background-clip: padding-box; border-radius: 14px; margin-bottom: 12px; cursor: pointer;
            transition: all 0.2s ease; background-color: rgba(255,255,255,0.7); box-shadow: var(--shadow-light);
        }
        .answers label:hover { transform: scale(1.02); box-shadow: var(--shadow); }
        .answers input { display: none; }
        .answers label:has(input:checked) { border-color: var(--accent); }
        .answer-text::before { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #bdc3c7; border-radius: 50%; margin-right: 15px; transition: all 0.2s ease; }
        input[type="checkbox"] + .answer-text::before { border-radius: 5px; }
        .answers input:checked + .answer-text::before { border-color: var(--accent); background-color: var(--accent); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--accent); }
        
        .dnd-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .dnd-column { flex: 1; min-width: 250px; }
        .dnd-item { position: relative; padding: 12px; padding-left: 35px; background-color: white; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; cursor: grab; transition: all 0.2s ease; user-select: none; box-shadow: var(--shadow-light); }
        .dnd-item::before { content: '⠿'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 1.5rem; color: #aaa; cursor: grab; }
        .dnd-item.dragging { opacity: 0.5; }
        .drop-zone { flex: 1; min-height: 50px; background-color: rgba(0,0,0,0.02); border: 2px dashed var(--border-color); border-radius: 8px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; padding: 5px; }
        .drop-zone.drag-over { background-color: rgba(25, 118, 210, 0.1); border-color: var(--accent); }

        .sequence-click-item { position: relative; background-color: rgba(255,255,255,0.6); border-radius: 14px; padding: 14px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; box-shadow: var(--shadow-light); user-select: none; }
        .sequence-click-item:hover { transform: scale(1.02); box-shadow: var(--shadow); }
        .sequence-click-item.numbered { background-color: rgba(25, 118, 210, 0.1); border: 2px solid var(--accent); cursor: not-allowed; }
        .sequence-number { position: absolute; top: 50%; left: 14px; transform: translateY(-50%) scale(0); width: 30px; height: 30px; border-radius: 50%; background: rgba(25, 118, 210, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .sequence-click-item.numbered .sequence-number { transform: translateY(-50%) scale(1); }
        .sequence-text { margin-left: 45px; }
        .reset-sequence-btn { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        
        #results-container { display: none; }
        .results-layout { display: flex; gap: 30px; align-items: flex-start; }
        .results-left-column { flex: 2; }
        .results-right-column { flex: 1; text-align: center; background: rgba(227, 242, 253, 0.8); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; }
        .answer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; margin-bottom: 30px;}
        .answer-grid span { display: flex; justify-content: center; align-items: center; height: 35px; border-radius: 6px; color: white; font-weight: 700; }
        .grid-correct { background: var(--correct); } .grid-incorrect { background: var(--incorrect); } .grid-partial { background: var(--partial); }
        
        .results-legend { display: flex; justify-content: center; gap: 20px; margin-top: 10px; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color-box { width: 18px; height: 18px; border-radius: 4px; }
        .legend-text { font-size: 0.9rem; color: #555; }
        .legend-correct { background-color: var(--correct); }
        .legend-partial { background-color: var(--partial); }
        .legend-incorrect { background-color: var(--incorrect); }

        .final-score .score-value { font-size: 4.5rem; font-weight: 800; color: var(--accent); line-height: 1; margin: 10px 0; }
        .status-badge { font-size: 1.8rem; font-weight: 800; padding: 20px; margin: 20px 0; width: 100%; box-sizing: border-box; border-radius: 15px; display: flex; align-items: center; justify-content: center; gap: 15px; animation: status-pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: white; }
        @keyframes status-pop-in { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .status-badge::before { font-size: 2.5rem; line-height: 1; }
        .status-passed { background: linear-gradient(45deg, #4caf50, #388e3c); box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4); }
        .status-passed::before { content: '✓'; }
        .status-failed { background: linear-gradient(45deg, #f44336, #d32f2f); box-shadow: 0 5px 20px rgba(244, 67, 54, 0.4); }
        .status-failed::before { content: '✗'; }

        #history-table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.5); border-radius: 8px; overflow: hidden; }
        #history-table th, #history-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #history-table th { background-color: rgba(25, 118, 210, 0.1); font-weight: 700; }
        
        @media (min-width: 992px) { .answers.grid-2-cols { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; } }
        @media (max-width: 768px) {
            body { padding: 10px; } .content { padding: 20px; } h1 { font-size: 1.5rem; }
            .results-layout { flex-direction: column-reverse; }
        }
    </style>
</head>
<body>
<div class="test-wrapper">
    <header class="header"><h1>Інтерактивне завдання: <span>Системи вентиляції та опалення</span></h1></header>
    <main class="content" id="content-area">
        <div id="user-info-form">
            <h2>Введіть ваші дані</h2>
            <form onsubmit="startQuiz(event)">
                <div class="form-group"><label for="fullName">Прізвище, Ім'я</label><input type="text" id="fullName" required></div>
                <div class="form-group"><label for="group">Група</label><input type="text" id="group" required></div>
                <p class="current-date" id="current-date"></p>
                <div class="button-container"><button type="submit" class="btn">Почати</button></div>
            </form>
        </div>
        
        <div id="quiz-container">
            <div class="quiz-header">
                <span id="question-counter"></span>
                <span id="timer" style="font-weight: 700; font-size: 1.2rem;">00:00</span>
            </div>
            <div class="progress-bar"><div class="progress-bar-inner" id="progress-bar-inner"></div></div>
            <div id="question-display"></div>
            <div class="button-container">
                <button id="next-btn" class="btn" onclick="nextQuestion()" disabled>Наступне питання</button>
            </div>
        </div>
        
        <div id="results-container">
             <h2>Результати тестування</h2>
             <div class="results-layout">
                <div class="results-left-column">
                    <h3 class="user-name"></h3>
                    <p id="result-group"></p>
                    <p id="time-taken"></p>
                    <h4>Ваші відповіді:</h4>
                    <div class="results-legend">
                        <div class="legend-item"><span class="legend-color-box legend-correct"></span><span class="legend-text">Правильно</span></div>
                        <div class="legend-item"><span class="legend-color-box legend-partial"></span><span class="legend-text">Частково</span></div>
                        <div class="legend-item"><span class="legend-color-box legend-incorrect"></span><span class="legend-text">Неправильно</span></div>
                    </div>
                    <div class="answer-grid" id="answer-grid"></div>
                    <div id="history-container"></div>
                </div>
                <aside class="results-right-column">
                    <div class="final-score">
                        <h4>Ваша оцінка (10-бальна):</h4>
                        <div class="score-value" id="final-grade">0</div>
                    </div>
                    <div id="status-badge" class="status-badge"></div>
                     <div class="button-container" style="flex-direction: column;">
                        <button class="btn" onclick="repeatTest()">Повторити тест</button>
                        <button id="save-report-btn" class="btn save-btn" onclick="saveReportAsHTML()">Зберегти звіт</button>
                    </div>
                </aside>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('current-date').innerText = `Сьогодні: ${new Date().toLocaleDateString('uk-UA')}`;
    });
    
    // Новий контент для тесту
    const quizData = [
        { points: 1, type: "radio", question: "Який основний принцип роботи системи вентиляції салонів електропоїзда?", options: ["Витяжна, природна", "Припливна, примусова", "Припливно-витяжна, природна", "Витяжна, примусова"], answer: "Припливна, примусова" },
        { points: 1, type: "radio", question: "Який апарат керує роботою малої групи електрокалориферів (ЕК1) та електропечей (ЕП)?", options: ["Терморегулятор ТР, встановлений в салоні.", "Термоконтактори ТК8° і ТК16°, встановлені в вентканалі.", "Реле перевантаження опалення РПО.", "Кнопка \"Интенсивное отопление\" в кабіні."], answer: "Терморегулятор ТР, встановлений в салоні." },
        { points: 1, type: "radio", question: "Яке головне призначення струмового реле вентиляторів (ТРВ)?", options: ["Захищати двигуни вентиляторів від перевантаження.", "Регулювати швидкість обертання вентиляторів.", "Відключати опалення (калорифери) при непрацюючих вентиляторах для запобігання перегріву.", "Вмикати сигнальну лампу при забрудненні фільтрів."], answer: "Відключати опалення (калорифери) при непрацюючих вентиляторах для запобігання перегріву." },
        { points: 2, type: "checkbox", question: "Оберіть ДВА основні компоненти, що входять до складу вентиляційного агрегату салону:", options: ["Калорифер", "Відцентрові вентилятори", "Рециркуляційний люк", "Електродвигун П41"], answer: ["Відцентрові вентилятори", "Електродвигун П41"] },
        { points: 3, type: "checkbox", question: "Оберіть ТРИ умови, необхідні для увімкнення контакторів опалення (МК3, МК5):", options: ["Замкнені контакти реле ТРВ (вентилятори працюють).", "Увімкнений режим \"Интенсивное отопление\".", "Замкнені контакти реле ПТР (температура в каналі низька).", "Відчинені рециркуляційні люки.", "Замкнені контакти реле РПО (немає перевантаження).", "Напруга в контактній мережі не нижче 3000 В."], answer: ["Замкнені контакти реле ТРВ (вентилятори працюють).", "Замкнені контакти реле ПТР (температура в каналі низька).", "Замкнені контакти реле РПО (немає перевантаження)."] },
        { points: 3, type: "sequence", question: "Розташуйте у правильній послідовності шлях повітря в системі вентиляції салону:", items: ["Прохід через вентиляційний агрегат.", "Забір повітря через зовнішні жалюзі.", "Вихід в салон через перфоровані листи.", "Очищення у фільтрах."], answer: ["Забір повітря через зовнішні жалюзі.", "Очищення у фільтрах.", "Прохід через вентиляційний агрегат.", "Вихід в салон через перфоровані листи."] },
        { points: 3, type: "sequence", question: "Встановіть послідовність подій при автоматичному керуванні великою групою калориферів (ЕК2, ЕК3) при падінні температури:", items: ["Замикається контакт термоконтактора ТК8°.", "Вмикається контактор МК3, подаючи живлення на калорифери.", "Вимикається реле ПТР.", "Температура повітря у вентиляційному каналі опускається нижче +8 °С."], answer: ["Температура повітря у вентиляційному каналі опускається нижче +8 °С.", "Замикається контакт термоконтактора ТК8°.", "Вимикається реле ПТР.", "Вмикається контактор МК3, подаючи живлення на калорифери."] },
        { points: 4, type: "match", question: "Встановіть відповідність між компонентом системи та його функцією:", items: ["Калорифер", "Електрична піч", "Дефлектор", "Фільтр"], definitions: ["Обігрів салону, розташована під диваном.", "Забезпечує витяжну вентиляцію туалету.", "Очищує припливне повітря від пилу.", "Підігріває повітря у вентиляційному каналі."], answer: ["Калорифер-Підігріває повітря у вентиляційному каналі.", "Електрична піч-Обігрів салону, розташована під диваном.", "Дефлектор-Забезпечує витяжну вентиляцію туалету.", "Фільтр-Очищує припливне повітря від пилу."] },
        { points: 4, type: "match", question: "Встановіть відповідність між температурним режимом та його параметрами:", items: ["Робота малого обігріву салону", "Робота великого обігріву (вентканал)", "Автоматичний обігрів кабіни", "Перехід з літнього режиму вентиляції на зимовий"], definitions: ["+16 °С ... +20 °С", "+12 °С ... +14 °С", "+15 °С", "+8 °С ... +16 °С"], answer: ["Робота малого обігріву салону-+12 °С ... +14 °С", "Робота великого обігріву (вентканал)-+8 °С ... +16 °С", "Автоматичний обігрів кабіни-+16 °С ... +20 °С", "Перехід з літнього режиму вентиляції на зимовий-+15 °С"] },
        { points: 1, type: "radio", question: "Для чого призначений поворотний щиток 13, встановлений навпроти верхньої жалюзі в кабіні машиніста?", options: ["Для повного перекриття потоку повітря.", "Для зміни напрямку потоку повітря.", "Для регулювання температури повітря.", "Для фільтрації повітря."], answer: "Для зміни напрямку потоку повітря." },
        { points: 1, type: "radio", question: "Яка потужність малого та великого ступенів калорифера в кабіні машиніста?", options: ["3 кВт та 5 кВт", "4,66 кВт та 7,5 кВт", "5 кВт та 10 кВт", "2,5 кВт та 4,66 кВт"], answer: "4,66 кВт та 7,5 кВт" },
        { points: 1, type: "radio", question: "Що відбувається з опаленням туалетного вузла, коли машиніст вмикає \"Дополнительный обогрев кабины\" (обігрів підніжок)?", options: ["Нічого не змінюється.", "Опалення туалету також вмикається в інтенсивний режим.", "Опалення туалетного вузла відключається.", "Вмикається лише обігрів бака для води."], answer: "Опалення туалетного вузла відключається." },
        { points: 4, type: "match", question: "Встановіть відповідність між апаратом захисту в колі опалення та його функцією:", items: ["ТРВ", "РПО", "Т39, Т310", "ПТРК"], definitions: ["Термоконтакти, що захищають калорифери від перегріву.", "Контролює роботу вентиляторів і блокує опалення при їх зупинці.", "Проміжне реле, що керує опаленням кабіни за сигналами термоконтактів.", "Реле, що захищає калорифери від струмового перевантаження."], answer: ["ТРВ-Контролює роботу вентиляторів і блокує опалення при їх зупинці.", "РПО-Реле, що захищає калорифери від струмового перевантаження.", "Т39, Т310-Термоконтакти, що захищають калорифери від перегріву.", "ПТРК-Проміжне реле, що керує опаленням кабіни за сигналами термоконтактів."] },
        { points: 2, type: "checkbox", question: "Оберіть ДВІ причини, через які може загорітися сигнальна лампа РПО в кабіні машиніста:", options: ["Спрацювання реле перевантаження опалення (РПО).", "Забруднення повітряних фільтрів.", "Недостатній рівень води в баку туалету.", "Несправність вентиляторів (спрацювання реле ТРВ).", "Падіння напруги в колах керування."], answer: ["Спрацювання реле перевантаження опалення (РПО).", "Несправність вентиляторів (спрацювання реле ТРВ)."] },
        { points: 1, type: "radio", question: "При якій температурі зовнішнього повітря система вентиляції переходить з літнього режиму на зимовий?", options: ["+20 °С", "+15 °С", "+10 °С", "0 °С"], answer: "+15 °С" }
    ];
    
    // Вся логіка тесту залишається без змін
    let maxPossiblePoints = quizData.reduce((sum, q) => sum + q.points, 0);
    let currentQuestionIndex = 0, userAnswers = [], questionTimings = [], questionStartTime, timerInterval, studentData = {};

    function isLocalStorageAvailable() {
        try {
            const storage = window.localStorage;
            const x = '__storage_test__';
            storage.setItem(x, x);
            storage.removeItem(x);
            return true;
        } catch (e) {
            return false;
        }
    }

    function loadHistory() {
        if (!isLocalStorageAvailable()) return;
        const historyContainer = document.getElementById('history-container');
        try {
            const history = JSON.parse(localStorage.getItem('quizHistory_ventilation')) || [];
            if (history.length <= 1) return;
            const previousAttempts = history.slice(0, -1).sort((a, b) => new Date(b.date) - new Date(a.date));
            let tableHTML = `<h4 style="margin-top: 30px;">Історія попередніх спроб</h4><table id="history-table"><tr><th>Дата і час</th><th>Бали</th><th>Оцінка</th></tr>`;
            previousAttempts.forEach(item => {
                const date = new Date(item.date).toLocaleString('uk-UA');
                const score = `${Number(item.score).toFixed(1)} / ${maxPossiblePoints}`;
                const grade10 = item.grade ?? '-';
                tableHTML += `<tr><td>${date}</td><td>${score}</td><td>${grade10}</td></tr>`;
            });
            tableHTML += '</table>';
            historyContainer.innerHTML = tableHTML;
        } catch (e) {
            console.error("Помилка завантаження історії:", e);
            localStorage.removeItem('quizHistory_ventilation');
        }
    }

    function saveHistory(score, grade10) {
        if (!isLocalStorageAvailable()) return;
        try {
            const history = JSON.parse(localStorage.getItem('quizHistory_ventilation')) || [];
            history.push({ 
                date: new Date().toISOString(), 
                score: score,
                grade: grade10
            });
            localStorage.setItem('quizHistory_ventilation', JSON.stringify(history));
        } catch (e) {
            console.error("Помилка збереження історії:", e);
        }
    }
    
    function repeatTest() { window.location.reload(); }

    function startQuiz(e) {
        e.preventDefault();
        studentData.fullName = document.getElementById('fullName').value;
        studentData.group = document.getElementById('group').value;
        document.getElementById('user-info-form').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block';
        startTimer();
        renderQuestion();
    }

    function startTimer() {
        let startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const minutes = String(Math.floor(elapsed / 60000)).padStart(2, '0');
            const seconds = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, '0');
            document.getElementById('timer').innerText = `${minutes}:${seconds}`;
        }, 1000);
    }

    function renderQuestion() {
        const contentArea = document.querySelector('.content');
        contentArea.classList.add('is-changing');
        questionStartTime = Date.now();
        
        setTimeout(() => {
            const q = quizData[currentQuestionIndex];
            const display = document.getElementById('question-display');
            let html = `<div class="question-block" id="current-question-block" data-type="${q.type}">`;
            html += `<p style="font-size: 1.2rem; font-weight: 600;">${q.question} <span class="question-points">${q.points} ${q.points === 1 ? 'бал' : (q.points > 1 && q.points < 5 ? 'бали' : 'балів')}</span></p>`;
            
            switch (q.type) {
                case 'radio': html += `<div class="answers grid-2-cols">${q.options.map(opt => `<label><input type="radio" name="answer" value="${opt}"><span class="answer-text">${opt}</span></label>`).join('')}</div>`; break;
                case 'checkbox': html += `<div class="answers grid-2-cols">${q.options.map(opt => `<label><input type="checkbox" name="answer" value="${opt}"><span class="answer-text">${opt}</span></label>`).join('')}</div>`; break;
                case 'match':
                    const items = [...q.items].sort(() => Math.random() - 0.5);
                    html += `<div class="dnd-container"><div class="dnd-column"><h4>Перетягніть:</h4><div class="source-list">${items.map(i => `<div class="dnd-item" draggable="true" data-id="${i}">${i}</div>`).join('')}</div></div><div class="dnd-column"><h4>До відповідників:</h4><div>${q.definitions.map(d => `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><div class="drop-zone" data-target-id="${d}" style="flex:1;"></div><div style="flex:2;">${d}</div></div>`).join('')}</div></div></div>`;
                    break;
                case 'sequence':
                    const s_items = [...q.items].sort(() => Math.random() - 0.5);
                    html += `<div class="sequence-click-container">${s_items.map(i => `<div class="sequence-click-item" data-text="${i}"><span class="sequence-number"></span><span class="sequence-text">${i}</span></div>`).join('')}</div><button class="reset-sequence-btn">Скинути вибір</button>`;
                    break;
            }
            display.innerHTML = html + '</div>';

            if (q.type === 'match') setupDragAndDrop();
            if (q.type === 'sequence') setupSequenceClick();

            document.getElementById('question-counter').innerText = `Питання ${currentQuestionIndex + 1} з ${quizData.length}`;
            updateProgressBar();
            document.getElementById('next-btn').innerText = (currentQuestionIndex === quizData.length - 1) ? 'Завершити' : 'Наступне питання';
            document.getElementById('next-btn').disabled = true; // Завжди блокуємо кнопку спочатку
            contentArea.classList.remove('is-changing');
            
            const questionBlock = document.getElementById('current-question-block');
            if (questionBlock) {
                questionBlock.addEventListener('change', checkAnswerProvided);
                questionBlock.addEventListener('input', checkAnswerProvided);
            }
        }, 400);
    }

    function checkAnswerProvided() {
        let isProvided = false;
        const qBlock = document.getElementById('current-question-block');
        if (!qBlock) return;
        const qType = qBlock.dataset.type;
        switch (qType) {
            case 'radio': isProvided = !!qBlock.querySelector('input[name="answer"]:checked'); break;
            case 'checkbox': isProvided = qBlock.querySelectorAll('input[name="answer"]:checked').length > 0; break;
            case 'match': isProvided = qBlock.querySelector('.source-list').children.length === 0; break;
            case 'sequence': isProvided = qBlock.querySelectorAll('.numbered').length === quizData[currentQuestionIndex].items.length; break;
        }
        document.getElementById('next-btn').disabled = !isProvided;
    }

    function setupDragAndDrop() {
        document.querySelectorAll('.dnd-item').forEach(d => {
            d.addEventListener('dragstart', () => d.classList.add('dragging'));
            d.addEventListener('dragend', () => { d.classList.remove('dragging'); checkAnswerProvided(); });
        });
        document.querySelectorAll('.drop-zone').forEach(z => {
            z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('drag-over'); });
            z.addEventListener('dragleave', () => z.classList.remove('drag-over'));
            z.addEventListener('drop', e => {
                e.preventDefault(); z.classList.remove('drag-over');
                const d = document.querySelector('.dragging');
                if (d && z.children.length === 0) { z.appendChild(d); checkAnswerProvided(); }
            });
        });
    }

    function setupSequenceClick() {
        const container = document.querySelector('.sequence-click-container');
        if (!container) return;
        container.querySelectorAll('.sequence-click-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.classList.contains('numbered')) return;
                item.classList.add('numbered');
                item.dataset.order = container.querySelectorAll('.numbered').length;
                item.querySelector('.sequence-number').innerText = item.dataset.order;
                checkAnswerProvided();
            });
        });
        document.querySelector('.reset-sequence-btn')?.addEventListener('click', () => {
            container.querySelectorAll('.sequence-click-item').forEach(item => {
                item.classList.remove('numbered');
                item.querySelector('.sequence-number').innerText = '';
                delete item.dataset.order;
            });
            checkAnswerProvided();
        });
    }

    function collectAnswer() {
        const q = quizData[currentQuestionIndex];
        const qBlock = document.getElementById('current-question-block');
        if (!qBlock) return;
        switch (q.type) {
            case 'radio': userAnswers[currentQuestionIndex] = qBlock.querySelector('input[name="answer"]:checked')?.value || null; break;
            case 'checkbox': userAnswers[currentQuestionIndex] = Array.from(qBlock.querySelectorAll('input[name="answer"]:checked')).map(cb => cb.value); break;
            case 'match':
                const matches = [];
                qBlock.querySelectorAll('.drop-zone').forEach(z => {
                    const item = z.querySelector('.dnd-item');
                    if (item) matches.push(`${item.dataset.id}-${z.dataset.targetId}`);
                });
                userAnswers[currentQuestionIndex] = matches.sort(); break;
            case 'sequence':
                userAnswers[currentQuestionIndex] = Array.from(qBlock.querySelectorAll('.sequence-click-item'))
                    .sort((a, b) => a.dataset.order - b.dataset.order)
                    .map(item => item.dataset.text); break;
        }
    }

    function nextQuestion() {
        questionTimings.push(Date.now() - questionStartTime);
        collectAnswer();
        currentQuestionIndex++;
        if (currentQuestionIndex < quizData.length) renderQuestion();
        else finishQuiz();
    }

    function updateProgressBar() {
        document.getElementById('progress-bar-inner').style.width = `${((currentQuestionIndex) / quizData.length) * 100}%`;
    }

    function finishQuiz() {
        clearInterval(timerInterval);
        let score = 0;
        const results = quizData.map((q, i) => {
            const userAns = userAnswers[i];
            const correctAns = q.answer;
            let questionScore = 0, resultType = 'incorrect';
            switch (q.type) {
                case 'radio':
                    if (userAns === correctAns) { questionScore = q.points; resultType = 'correct'; }
                    break;
                case 'checkbox':
                    if (userAns?.length) {
                        const correctCount = userAns.filter(ans => correctAns.includes(ans)).length;
                        const incorrectCount = userAns.length - correctCount;
                        const scorePerItem = q.points / correctAns.length;
                        questionScore = Math.max(0, correctCount * scorePerItem - incorrectCount * scorePerItem);
                        if (incorrectCount === 0 && correctCount === correctAns.length) resultType = 'correct';
                        else if (questionScore > 0) resultType = 'partial';
                    } break;
                case 'match':
                    if (userAns?.length) {
                        const correctMatches = userAns.filter(m => correctAns.sort().includes(m)).length;
                        questionScore = (correctMatches / correctAns.length) * q.points;
                        if (correctMatches === correctAns.length) resultType = 'correct';
                        else if (questionScore > 0) resultType = 'partial';
                    } break;
                case 'sequence':
                    if (userAns?.length === correctAns.length && userAns.every((item, index) => item === correctAns[index])) {
                        questionScore = q.points; resultType = 'correct';
                    } break;
            }
            score += questionScore;
            return resultType;
        });

        const grade10 = convertTo10PointScale(score, maxPossiblePoints);

        saveHistory(score, grade10);
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        displayResults(results, score, grade10);
    }

    function convertTo10PointScale(score, maxScore) {
        if (maxScore === 0) return 0;
        const p = (score / maxScore) * 100;
        if (p >= 95) return 10; if (p >= 85) return 9; if (p >= 75) return 8;
        if (p >= 65) return 7; if (p >= 55) return 6; if (p >= 45) return 5;
        if (p >= 35) return 4; if (p >= 25) return 3; if (p >= 15) return 2;
        if (p > 0) return 1; return 0;
    }

    function displayResults(results, score, grade10) {
        let totalTime = questionTimings.reduce((a, b) => a + b, 0);
        const resultsContainer = document.getElementById('results-container');
        
        resultsContainer.querySelector('.user-name').innerText = studentData.fullName;
        resultsContainer.querySelector('#result-group').innerText = `Група: ${studentData.group}`;
        resultsContainer.querySelector('#time-taken').innerHTML = `⏱️ Загальний час: <strong>${String(Math.floor(totalTime/60000)).padStart(2,'0')}:${String(Math.floor((totalTime%60000)/1000)).padStart(2,'0')}</strong>`;
        resultsContainer.querySelector('#answer-grid').innerHTML = results.map((res, i) => `<span class="grid-${res}">${i + 1}</span>`).join('');
        resultsContainer.querySelector('#final-grade').innerText = grade10;
        
        const statusBadge = resultsContainer.querySelector('#status-badge');
        if (grade10 >= 4) {
            statusBadge.innerHTML = 'Зараховано'; 
            statusBadge.className = 'status-badge status-passed'; 
        } else { 
            statusBadge.innerHTML = 'Не зараховано'; 
            statusBadge.className = 'status-badge status-failed'; 
        }
        loadHistory();
    }

    function saveReportAsHTML() {
        const btn = document.getElementById('save-report-btn');
        btn.innerText = 'Зберігаємо...'; btn.disabled = true;
        const styles = Array.from(document.styleSheets).map(s => { try { return Array.from(s.cssRules).map(r => r.cssText).join('\n'); } catch (e) { return ''; }}).join('\n');
        const report = document.getElementById('results-container').innerHTML;
        const header = document.querySelector('.header').outerHTML;
        const html = `<!DOCTYPE html><html lang="uk"><head><meta charset="UTF-8"><title>Звіт: ${studentData.fullName}</title><style>${styles}</style><style>body{align-items:flex-start}.test-wrapper{margin:20px auto}#results-container{display:block !important}.button-container{flex-direction: column; gap: 10px; align-items: center;} #save-report-btn, .btn[onclick="repeatTest()"] {display:none !important}</style></head><body><div class="test-wrapper">${header}<main class="content">${report}</main></div></body></html>`;
        const blob = new Blob([html], { type: 'text/html' });
        const link = document.createElement('a');
        const dateStr = new Date().toISOString().slice(0, 10);
        const name = studentData.fullName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        link.download = `zvit-ventylatsiya-opalennya-${name}-${dateStr}.html`;
        link.href = URL.createObjectURL(blob);
        link.click(); URL.revokeObjectURL(link.href);
        setTimeout(() => { btn.innerText = 'Зберегти звіт'; btn.disabled = false; }, 1000);
    }
</script>
</body>
</html>