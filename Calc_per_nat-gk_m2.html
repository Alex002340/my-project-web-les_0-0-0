<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>КАЛЬКУЛЯТОР ПЕРЕРАХУНКУ НАТИСКУ ГАЛЬМІВНИХ КОЛОДОК</title> <!-- Uppercase Title -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* --- Neon Dark Theme (Default) --- */
            --bg-color: #10101a; --container-bg: #1a1a2e; --section-bg: rgba(26, 26, 46, 0.7); --section-bg-alt: rgba(35, 35, 60, 0.8); --input-bg: #252540;
            --text-color: #e5e5e5; --text-color-darker: #a0a0c0; --border-color: #404060;
            --primary-neon: #00e676; --secondary-neon: #00e5ff; --tertiary-neon: #ff00ff;
            --accent-color: #ffc107; /* Yellow for recalculation accents */
            --success-color: var(--primary-neon); /* Neon Green for positive delta */
            --danger-color: #ff4d4d; /* Neon Red for negative delta */
            --initial-color: var(--secondary-neon); /* Cyan for initial values */
            --changed-color: var(--accent-color); /* Yellow for changed values */
            --accent-bg-light: rgba(255, 193, 7, 0.1); --accent-bg-medium: rgba(255, 193, 7, 0.15); --accent-bg-strong: rgba(255, 193, 7, 0.2); --accent-bg-hover: rgba(255, 193, 7, 0.3);
            --table-header-bg: rgba(42, 58, 90, 0.8); --table-row-odd-bg: rgba(30, 30, 50, 0.5); --table-row-hover-bg: rgba(52, 73, 94, 0.7);
            --button-text-color: white; --shadow-color: rgba(0, 0, 0, 0.5);
            --glow-color: rgba(255, 193, 7, 0.4); --glow-color-secondary: rgba(0, 229, 255, 0.3);
            --scroll-track-bg: #2a3a5a; --scroll-thumb-bg: #556a91;
            --link-color: var(--secondary-neon); --icon-filter: invert(0.9) hue-rotate(180deg) brightness(1.2);
            --animation-speed: 0.3s; --shine-speed: 0.8s; /* Speed for shine animation */
            /* Reduced Glows */
            --neon-text-shadow: 0 0 2px rgba(229, 229, 229, 0.7), 0 0 4px var(--accent-color);
            --heading-neon-shadow: 0 0 4px var(--secondary-neon), 0 0 8px var(--secondary-neon);
            --th-neon-shadow: 0 0 3px rgba(229, 229, 229, 0.5); /* Subtle white glow for TH text */
            /* Chart Gradients (Dark) */
            --chart-grad-1-start: #00e5ff; --chart-grad-1-end: #00a2ff; /* Initial (Cyan) */
            --chart-grad-2-start: #ffc107; --chart-grad-2-end: #ffae00; /* Changed (Yellow) */
            --chart-grad-3-start: #ff00ff; --chart-grad-3-end: #c600ff; /* Magenta */
            --chart-grad-4-start: #00e676; --chart-grad-4-end: #00bfa5; /* Green */
            --chart-grad-5-start: #ff8a00; --chart-grad-5-end: #e52e71; /* Orange/Pink */
        }

        body.light-theme {
            /* --- Gradient Light Theme --- */
            --bg-color: linear-gradient(135deg, #eef2f7 0%, #f8fafc 100%); --container-bg: rgba(255, 255, 255, 0.9); --section-bg: rgba(255, 255, 255, 0.85); --section-bg-alt: #f8f9fa; --input-bg: #ffffff;
            --text-color: #343a40; --text-color-darker: #495057; --border-color: #ced4da;
            --primary-gradient-start: #007bff; --primary-gradient-end: #0056b3; --accent-color: #ffc107; /* Yellow */
            --success-color: #28a745; --danger-color: #dc3545;
            --initial-color: #007bff; --changed-color: #e0a800;
            --accent-bg-light: rgba(255, 193, 7, 0.08); --accent-bg-medium: rgba(255, 193, 7, 0.12); --accent-bg-strong: rgba(255, 193, 7, 0.18); --accent-bg-hover: rgba(255, 193, 7, 0.25);
            --table-header-bg: #e9ecef; --table-row-odd-bg: transparent; --table-row-hover-bg: #e2e6ea;
            --button-text-color: white; --shadow-color: rgba(100, 100, 150, 0.15);
            --glow-color: rgba(0, 123, 255, 0.2); --glow-color-secondary: rgba(23, 162, 184, 0.25);
            --scroll-track-bg: #e9ecef; --scroll-thumb-bg: #adb5bd;
            --link-color: var(--primary-gradient-start); --icon-filter: none;
            --neon-text-shadow: none; --heading-neon-shadow: none; --th-neon-shadow: none;
            /* Chart Gradients (Light) */
            --chart-grad-1-start: #007bff; --chart-grad-1-end: #56abff; /* Initial (Blue) */
            --chart-grad-2-start: #ffc107; --chart-grad-2-end: #ffe082; /* Changed (Yellow) */
            --chart-grad-3-start: #17a2b8; --chart-grad-3-end: #52c2d5; /* Teal */
            --chart-grad-4-start: #28a745; --chart-grad-4-end: #5dd080; /* Green */
            --chart-grad-5-start: #fd7e14; --chart-grad-5-end: #ffab70; /* Orange */
        }

        /* Base Styles */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text-color); line-height: 1.6; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: background var(--animation-speed) ease, color var(--animation-speed) ease; }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: var(--scroll-track-bg); border-radius: 4px; } ::-webkit-scrollbar-thumb { background-color: var(--scroll-thumb-bg); border-radius: 4px; border: 2px solid var(--scroll-track-bg); } ::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--scroll-thumb-bg) 80%, white); }
        .calculator-container { background-color: var(--container-bg); padding: 35px 40px; border-radius: 15px; box-shadow: 0 10px 30px var(--shadow-color), 0 0 15px var(--glow-color-secondary); width: 100%; max-width: 1100px; margin-top: 20px; transition: all var(--animation-speed) ease; border: 1px solid var(--border-color); position: relative; backdrop-filter: blur(5px); }
        body.light-theme .calculator-container { box-shadow: 0 8px 25px var(--shadow-color); backdrop-filter: blur(10px); }
        .theme-toggle { position: absolute; top: 20px; right: 20px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all var(--animation-speed) ease; z-index: 20; text-shadow: none; }
        .theme-toggle:hover { background: var(--section-bg-alt); box-shadow: 0 0 8px var(--glow-color); }
        body.light-theme .theme-toggle:hover { box-shadow: 0 0 8px var(--shadow-color); }

        /* Headings */
        h1, h2 { color: var(--text-color); text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid; border-image: linear-gradient(to right, var(--secondary-neon), var(--tertiary-neon)) 1; transition: color var(--animation-speed) ease, border-image var(--animation-speed) ease, text-shadow var(--animation-speed) ease; text-shadow: var(--heading-neon-shadow); }
        body.light-theme h1, body.light-theme h2 { border-image: linear-gradient(to right, var(--primary-gradient-start), var(--primary-gradient-end)) 1; }
        h1 { font-size: 1.6rem; font-weight: 600; margin-top: 10px; text-transform: uppercase; }
        h2 { font-size: 1.3rem; font-weight: 500; margin-top: 25px; margin-bottom: 15px; }

        /* Sections */
        .input-section, .results-section, .report-section, .chart-section { margin-bottom: 30px; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--section-bg); transition: all 0.5s ease-in-out; }

        /* Inputs & Select */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-weight: bold; color: var(--text-color-darker); transition: color var(--animation-speed); }
        .input-group input[type="text"], .input-group input[type="number"], .input-group input[type="date"], .input-group select { flex-grow: 1; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; background-color: var(--input-bg); color: var(--text-color); transition: all var(--animation-speed); min-width: 150px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); width: 100%; box-sizing: border-box; }
        .input-group select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23a0a0c0' d='M6 8L0 2l1.4-1.4L6 5.2 10.6.6 12 2z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; background-size: 12px; }
        body:not(.light-theme) .input-group select { filter: var(--icon-filter); }
        .input-group option { background-color: var(--input-bg); color: var(--text-color); padding: 5px; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: var(--icon-filter); }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--secondary-neon); box-shadow: 0 0 8px var(--glow-color-secondary), inset 0 1px 3px rgba(0,0,0,0.3); }
        body.light-theme .input-group input:focus, body.light-theme .input-group select:focus { border-color: var(--primary-gradient-end); box-shadow: 0 0 8px var(--glow-color), inset 0 1px 3px rgba(0,0,0,0.1); }
        .input-group input[style*="border-color: red"], .input-group select[style*="border-color: red"] { border-color: var(--error-color) !important; box-shadow: 0 0 5px color-mix(in srgb, var(--error-color) 50%, transparent); }
        .input-group .unit { font-size: 0.9em; color: #777; text-align: right; margin-top: -28px; margin-right: 10px; pointer-events: none; transition: color var(--animation-speed); }
         body:not(.light-theme) .input-group .unit { color: var(--text-color-darker); }

        /* Wagon Module */
        .wagon-module { border: 1px dashed var(--tertiary-neon); padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: var(--section-bg-alt); position: relative; overflow: hidden; animation: fadeIn var(--animation-speed) ease forwards; transition: background-color var(--animation-speed) ease, border-color var(--animation-speed) ease; }
        body.light-theme .wagon-module { border: 1px dashed var(--primary-gradient-start); }
        .wagon-module h3 { margin-top: 0; color: var(--text-color); font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; text-shadow: var(--neon-text-shadow); transition: color var(--animation-speed) ease, border-color var(--animation-speed) ease; }
        .wagon-module h4 { margin-top: 15px; margin-bottom: 10px; font-size: 1em; color: var(--text-color-darker); border-bottom: 1px dotted var(--border-color); padding-bottom: 3px; transition: color var(--animation-speed) ease, border-color var(--animation-speed) ease; }
        body.light-theme .wagon-module h3 { text-shadow: none; }
        .wagon-module[style*="border: 2px solid"] { border: 2px solid var(--error-color) !important; }
        .wagon-specs-grid, .wagon-counts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .wagon-counts-grid { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); transition: border-color var(--animation-speed); }
        .remove-wagon-btn { position: absolute; top: 10px; right: 10px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-weight: bold; cursor: pointer; transition: background-color var(--animation-speed), transform var(--animation-speed); line-height: 25px; text-align: center; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-shadow: none; z-index: 5; }
        .remove-wagon-btn:hover { background-color: color-mix(in srgb, var(--danger-color) 70%, black); transform: scale(1.1); }

        /* Buttons */
        button:not(.theme-toggle):not(.remove-wagon-btn) { position: relative; overflow: hidden; display: inline-flex; justify-content: center; align-items: center; min-width: 150px; padding: 10px 25px; border: none; border-radius: 6px; font-size: 1rem; font-weight: 500; color: var(--button-text-color); cursor: pointer; transition: filter var(--animation-speed), transform var(--animation-speed), box-shadow var(--animation-speed); margin: 5px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); text-shadow: 0 0 2px rgba(0,0,0,0.4); z-index: 1; }
        body:not(.light-theme) button:not(.theme-toggle):not(.remove-wagon-btn) { text-shadow: 0 0 3px rgba(0, 0, 0, 0.8); }
        button:not(.theme-toggle):not(.remove-wagon-btn):hover { filter: brightness(1.15); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4); }
        button:not(.theme-toggle):not(.remove-wagon-btn):active { transform: translateY(0); filter: brightness(0.9); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); }
        /* Shine Animation */
        button:not(.theme-toggle):not(.remove-wagon-btn)::before { content: ""; position: absolute; top: 0; left: -100%; width: 75%; height: 100%; background: linear-gradient( 100deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.3) 50%, rgba(255, 255, 255, 0) 100% ); transform: skewX(-25deg); z-index: 2; pointer-events: none; opacity: 0; transition: none; }
        button:not(.theme-toggle):not(.remove-wagon-btn):hover::before { opacity: 1; left: 125%; transition: left var(--shine-speed) ease-in-out; }

        /* Button Gradients */
        button[onclick="calculateAll()"] { background: linear-gradient(45deg, var(--primary-neon), var(--secondary-neon)); }
        #chart-toggle-btn { background: linear-gradient(45deg, var(--secondary-neon), var(--tertiary-neon)); }
        button[onclick="generateReport()"] { background: linear-gradient(45deg, var(--tertiary-neon), var(--primary-neon)); }
        #print-btn { background: linear-gradient(45deg, #ff8a00, #e52e71); }
        button[onclick="resetCalculator()"] { background: linear-gradient(45deg, #7f8c8d, #505f60); }
        #add-wagon-btn { background: linear-gradient(45deg, var(--primary-neon), #00bfa5); }
        body.light-theme button[onclick="calculateAll()"] { background: linear-gradient(45deg, #007bff, #0056b3); }
        body.light-theme #chart-toggle-btn { background: linear-gradient(45deg, #17a2b8, #117a8b); }
        body.light-theme button[onclick="generateReport()"] { background: linear-gradient(45deg, #28a745, #218838); }
        body.light-theme #print-btn { background: linear-gradient(45deg, #6c757d, #5a6268); }
        body.light-theme button[onclick="resetCalculator()"] { background: linear-gradient(45deg, #ffc107, #e0a800); }
        body.light-theme #add-wagon-btn { background: linear-gradient(45deg, #17a2b8, #218838); }

        /* Results Table */
        .results-table-container { overflow-x: auto; margin-top: 15px; border: 1px solid var(--border-color); border-radius: 5px; }
        .results-table { width: 100%; min-width: 900px; border-collapse: collapse; }
        .results-table th, .results-table td { border: 1px solid var(--border-color); padding: 10px 8px; text-align: center; vertical-align: middle; white-space: nowrap; transition: background-color var(--animation-speed) ease, border-color var(--animation-speed) ease; }
        .results-table th { background-color: var(--table-header-bg); font-weight: bold; color: var(--text-color); position: sticky; top: 0; z-index: 1; text-shadow: var(--th-neon-shadow); transition: background-color var(--animation-speed) ease, color var(--animation-speed) ease, text-shadow var(--animation-speed) ease; }
        .results-table th:nth-child(7), .results-table th:nth-child(10) { border-left: 2px solid var(--initial-color); }
        body.light-theme .results-table th:nth-child(7), body.light-theme .results-table th:nth-child(10) { border-left: 2px solid var(--primary-gradient-start); }
        .results-table td:nth-child(7), .results-table td:nth-child(10) { border-left: 2px solid var(--initial-color); }
        body.light-theme .results-table td:nth-child(7), body.light-theme .results-table td:nth-child(10) { border-left: 2px solid var(--primary-gradient-start); }
        .results-table tbody tr:nth-child(odd) td { background-color: var(--table-row-odd-bg); }
        .results-table tbody tr:hover td { background-color: var(--table-row-hover-bg); }
        .results-table td span.result-value { font-weight: bold; display: inline-block; min-width: 50px; transition: all 0.5s ease; padding: 2px 5px; border-radius: 3px; }
        .results-table td span.initial { color: var(--initial-color); text-shadow: 0 0 4px var(--initial-color); }
        .results-table td span.changed { color: var(--changed-color); text-shadow: 0 0 4px var(--changed-color); }
        body.light-theme .results-table td span.initial, body.light-theme .results-table td span.changed { text-shadow: none; }
        .results-table td span.highlight { background-color: var(--accent-bg-strong); animation: highlightAnim 1s ease; filter: brightness(1.3); }

        /* Summary Results */
        .summary-results { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center; }
        .summary-item { padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--section-bg-alt); transition: background-color var(--animation-speed), border-color var(--animation-speed); }
        .summary-item .label { display: block; font-size: 0.9em; color: var(--text-color-darker); margin-bottom: 5px; transition: color var(--animation-speed); }
        .summary-item .value { font-size: 1.3em; font-weight: bold; transition: color var(--animation-speed); }
        .summary-item .value.initial { color: var(--initial-color); text-shadow: 0 0 6px var(--initial-color); }
        .summary-item .value.changed { color: var(--changed-color); text-shadow: 0 0 6px var(--changed-color); }
        .summary-item .value.delta {}
        .summary-item .value.positive { color: var(--success-color); text-shadow: 0 0 6px var(--success-color); }
        .summary-item .value.negative { color: var(--danger-color); text-shadow: 0 0 6px var(--danger-color); }
        .summary-item .value.zero { color: var(--text-color-darker); text-shadow: none; }
        body.light-theme .summary-item .value { text-shadow: none; }
         .summary-item .value span.highlight { background-color: var(--accent-bg-hover); animation: highlightAnim 1s ease; display: inline-block; padding: 0 5px; border-radius: 3px; }

        /* Report */
        #report-content { white-space: pre-wrap; background-color: var(--input-bg); padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; font-family: 'Courier New', Courier, monospace; max-height: 400px; overflow-y: auto; color: var(--text-color); box-shadow: inset 0 1px 4px rgba(0,0,0,0.3); transition: all var(--animation-speed) ease; }

        /* Actions */
        .actions { text-align: center; margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; /* Added gap for mobile */ }

         /* Chart Section */
         .chart-section { max-height: 0; opacity: 0; overflow: hidden; padding: 0; margin: 0; border: none; transition: all 0.6s ease-in-out; }
         .chart-section.visible { max-height: 850px; opacity: 1; padding: 25px; margin-bottom: 30px; border: 1px solid var(--border-color); margin-top: 30px; }
         .chart-container { position: relative; width: 100%; max-width: 750px; margin: 25px auto; height: 380px; }
         .chart-container canvas { display: block; height: 100% !important; width: 100% !important; background-color: transparent; }
         .chart-section > p { text-align: center; padding: 20px; color: var(--text-color-darker); transition: color var(--animation-speed); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes highlightAnim { 0% { filter: brightness(1.6); } 100% { filter: brightness(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); max-height: 300px; } to { opacity: 0; transform: scale(0.9); height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; border: none; } }

        /* Print Styles */
        @media print {
             :root { /* Reset theme vars */ }
             body { padding: 0; background: #fff; color: #000; font-size: 9pt; }
             .calculator-container { box-shadow: none; border: none; padding: 0; max-width: 100%; background: #fff; backdrop-filter: none; }
             h1, h2 { border: none; color: #000; text-align: left; font-size: 12pt; margin-bottom: 10px; text-shadow: none; }
             h1 { text-transform: uppercase; }
             .input-section, .results-section { border: none; padding: 0; margin-bottom: 10px; background: #fff; }
             .wagon-module { border: 1px solid #ccc; background: #fff; padding: 10px; margin-bottom: 10px; page-break-inside: avoid; }
             .wagon-module h3, .wagon-module h4 { font-size: 10pt; margin-bottom: 5px; color: #000; border: none; text-shadow: none; }
             .input-grid, .wagon-specs-grid, .wagon-counts-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 5px; border: none; padding: 0; }
             .input-group label { color: #000; font-size: 9pt; }
             .input-group input[type="text"], .input-group input[type="number"], .input-group input[type="date"], .input-group select { border: none; border-bottom: 1px dotted #ccc; padding: 1px 0; background: none; box-shadow: none; font-size: 9pt; color: #000; -webkit-appearance: none; -moz-appearance: none; appearance: none; display: inline; width: auto; background-image: none; filter: none; }
             .input-group select::after { content: " (" attr(data-selected-text) ")"; font-style: italic; }
             .input-group option { display: none; }
             input[type="date"]::-webkit-calendar-picker-indicator { display: none; }
             .unit { display: none; }
             .results-table-container { overflow: visible; border: none;}
             .results-table { min-width: unset; font-size: 8pt; border: 1px solid #666; }
             .results-table th, .results-table td { border: 1px solid #999; padding: 4px; white-space: normal; }
             .results-table th { background-color: #eee !important; color: #000; position: static; text-shadow: none; }
             .results-table th:nth-child(7), .results-table th:nth-child(10), .results-table td:nth-child(7), .results-table td:nth-child(10) { border-left: 1px solid #999; }
             .results-table td span.result-value { font-weight: normal; color: #000 !important; background: none !important; padding: 0; text-shadow: none; filter: none;}
             .summary-results { grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 9pt; border: none; padding: 0; margin-top: 10px; }
             .summary-item { border: 1px solid #ccc; padding: 5px; background: #fff; }
             .summary-item .label { font-size: 8pt; color: #333;}
             .summary-item .value { font-size: 10pt; color: #000 !important; text-shadow: none !important; }
             .summary-item .value span.highlight { background: none !important; padding: 0; border-radius: 0; }
             .actions, .remove-wagon-btn, #report-content, .report-section h2, .theme-toggle, .chart-section { display: none; }
             #report-print-area { display: block !important; font-family: 'Courier New', Courier, monospace; font-size: 9pt; white-space: pre-wrap; margin-top: 15px; color: #000; background: none; }
             button:not(.theme-toggle):not(.remove-wagon-btn) { border: 1px solid #ccc; background: #eee; color: #000; box-shadow: none; text-shadow: none; filter: none; }
             button:not(.theme-toggle):not(.remove-wagon-btn)::before { display: none; }
        }
        #report-print-area { display: none; }

        /* Mobile Adaptation - Updated Button Styles */
        @media (max-width: 768px) {
             body { padding: 10px; }
             .calculator-container { padding: 15px; }
             .theme-toggle { top: 10px; right: 10px; padding: 6px 10px; font-size: 0.8em; }
             h1 { font-size: 1.4rem; margin-top: 40px; }
             h2 { font-size: 1.1rem; }
             .input-grid { grid-template-columns: 1fr; }
             .wagon-specs-grid, .wagon-counts-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
             .actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; } /* Ensure flexbox for actions */
             .actions button:not(.theme-toggle):not(.remove-wagon-btn) {
                 flex-grow: 0; /* Do not grow */
                 flex-shrink: 0; /* Do not shrink */
                 /* min-width: 140px; */ /* Keep a reasonable min-width */
                 width: auto; /* Let the content and padding define width */
                 margin: 5px; /* Spacing around buttons */
                 padding: 10px 20px; /* Adjust padding */
                 font-size: 0.9rem;
             }
             #add-wagon-btn { /* Keep Add button full width if desired */
                 width: 100%;
                 margin-bottom: 10px;
             }
             .results-table th, .results-table td { font-size: 0.8rem; padding: 5px; }
             .results-section div[style*="overflow-x: auto"] { border: 1px solid var(--border-color); border-radius: 5px; margin-top: 10px; }
             .summary-results { grid-template-columns: 1fr; }
             .summary-item .value { font-size: 1.1em; }
             .chart-section.visible { max-height: 750px; }
             .chart-container { height: 320px; }
        }
        @media (max-width: 480px) {
             h1 { font-size: 1.2rem; }
             h2 { font-size: 1rem; }
             button:not(.theme-toggle):not(.remove-wagon-btn) {
                  /* Slightly smaller buttons on very small screens */
                  min-width: 120px;
                  height: 40px;
                  font-size: 0.85rem;
                  padding: 8px 15px;
             }
             #add-wagon-btn { min-width: unset; } /* Allow Add button to be full width */
        }

    </style>
</head>
<body> <!-- Theme class added by JS -->

    <div class="calculator-container">
        <button class="theme-toggle" id="theme-toggle-btn" title="Змінити тему">Тема</button>
        <h1>КАЛЬКУЛЯТОР ПЕРЕРАХУНКУ НАТИСКУ ГАЛЬМІВНИХ КОЛОДОК</h1>

        <!-- Інформація про студента -->
        <section class="input-section student-info">
            <h2>Інформація про виконавця</h2>
            <div class="input-grid">
                <div class="input-group"> <label for="student-name">ПІБ:</label> <input type="text" id="student-name" placeholder="Введіть ваше ПІБ"> </div>
                <div class="input-group"> <label for="student-group">Група:</label> <input type="text" id="student-group" placeholder="Введіть назву групи"> </div>
                <div class="input-group"> <label for="report-date">Дата:</label> <input type="date" id="report-date"> </div>
            </div>
        </section>

        <!-- Загальні параметри тиску -->
        <section class="input-section common-params">
            <h2>Розрахунковий тиск у ГЦ (p_ц)</h2>
             <div class="input-grid">
                 <div class="input-group"> <label for="pressure-mpa-initial">Початковий тиск:</label> <input type="number" id="pressure-mpa-initial" step="0.01" value="0.4" required> <span class="unit">МПа</span> </div>
                 <div class="input-group"> <label for="pressure-mpa-changed">Змінений тиск:</label> <input type="number" id="pressure-mpa-changed" step="0.01" value="0.38" required> <span class="unit">МПа</span> </div>
            </div>
        </section>

        <!-- Модулі вагонів -->
        <section class="input-section wagon-modules">
            <h2>Типи вагонів у поїзді</h2>
            <div id="wagon-modules-container"></div>
            <button id="add-wagon-btn">+ Додати тип вагона</button>
        </section>

        <!-- Результати -->
        <section class="results-section">
            <h2>Результати розрахунку та перерахунку</h2>
            <div class="results-table-container">
                <table class="results-table" id="results-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Тип вагона</th> <th rowspan="2">D_ц, м</th> <th rowspan="2">F_ц, м²</th> <th rowspan="2">i_гп</th> <th rowspan="2">η_гп</th> <th rowspan="2">N_ц</th>
                            <th colspan="3">Початковий стан</th> <th colspan="3">Змінений стан</th>
                        </tr>
                         <tr>
                            <th>N<sub>поч</sub></th> <th>K<sub>ваг поч</sub>, тс</th> <th>∑ K<sub>поч</sub>, тс</th>
                            <th>N<sub>змін</sub></th> <th>K<sub>ваг змін</sub>, тс</th> <th>∑ K<sub>змін</sub>, тс</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody"></tbody>
                </table>
            </div>
            <div class="summary-results">
                 <div class="summary-item"> <span class="label">Загальний початковий натиск</span> <span class="value initial" id="total-initial-pressure">0.00</span> тс </div>
                 <div class="summary-item"> <span class="label">Загальний змінений натиск</span> <span class="value changed" id="total-changed-pressure">0.00</span> тс </div>
                 <div class="summary-item"> <span class="label">Абсолютна зміна</span> <span class="value delta" id="delta-k">0.00</span> тс </div>
                 <div class="summary-item"> <span class="label">Відносна зміна</span> <span class="value delta" id="percent-change">0.00</span> % </div>
            </div>
        </section>

         <!-- Секція для Інфографіки (Графіка) -->
        <section class="chart-section" id="chart-section">
             <h2>Інфографіка Перерахунку</h2>
             <div class="chart-container" id="comparisonChartContainer"> <canvas id="comparisonChart"></canvas> </div>
             <div class="chart-container" id="deltaChartContainer"> <canvas id="deltaChart"></canvas> </div>
        </section>

        <!-- Звіт -->
        <section class="report-section">
             <h2>Звіт про виконання роботи</h2>
             <div id="report-content">Натисніть "Сформувати звіт" після розрахунку.</div>
        </section>

         <!-- Дії -->
         <div class="actions">
            <button onclick="calculateAll()">Розрахувати</button>
            <button id="chart-toggle-btn" onclick="toggleChart()">Графіки</button>
            <button onclick="generateReport()">Сформувати звіт</button>
            <button id="print-btn" onclick="printReport()">Друкувати</button>
            <button onclick="resetCalculator()">Скинути</button>
         </div>
    </div>

    <!-- Прихована область для версії звіту для друку -->
    <div id="report-print-area"></div>


    <script>
        // --- Global Variables ---
        let wagonCounter = 0; const PI = Math.PI; const N_TO_TC_FACTOR = 9810;
        let calculationSuccess = false;
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const bodyElement = document.body;
        let comparisonChart = null; let deltaChart = null; let chartData = null;

        // --- Predefined Wagon Data ---
        const wagonTypeData = { 'custom': { name: 'Інший (ввести вручну)', diameter_in: '', i_gp: '', eta_gp: '', n_cyl: 1 }, 'gondola_14': { name: 'Піввагон (14")', diameter_in: 14, i_gp: 6.8, eta_gp: 0.85, n_cyl: 1 }, 'tank_12': { name: 'Цистерна (12")', diameter_in: 12, i_gp: 5.5, eta_gp: 0.88, n_cyl: 1 }, 'platform': { name: 'Платформа (14")', diameter_in: 14, i_gp: 6.5, eta_gp: 0.85, n_cyl: 1 }, 'covered': { name: 'Критий (14")', diameter_in: 14, i_gp: 7.0, eta_gp: 0.86, n_cyl: 1 }, 'hopper': { name: 'Хоппер (16")', diameter_in: 16, i_gp: 7.2, eta_gp: 0.84, n_cyl: 1 }, 'reefer': { name: 'Рефрижератор (14")', diameter_in: 14, i_gp: 6.0, eta_gp: 0.88, n_cyl: 1 }, 'tank_16': { name: 'Цистерна велика (16")', diameter_in: 16, i_gp: 5.8, eta_gp: 0.87, n_cyl: 1 }, };

        // --- Theme Management ---
        function getThemeColors() { const styles = getComputedStyle(bodyElement); const isLightTheme = bodyElement.classList.contains('light-theme'); const gradientPairs = []; for (let i = 1; i <= 5; i++) { const startColor = styles.getPropertyValue(`--chart-grad-${i}-start`)?.trim(); const endColor = styles.getPropertyValue(`--chart-grad-${i}-end`)?.trim(); if (startColor && endColor) { gradientPairs.push({ start: startColor, end: endColor }); } else { console.warn(`CSS variables for --chart-grad-${i} not found.`); gradientPairs.push({ start: '#cccccc', end: '#999999' }); } } return { textColor: styles.getPropertyValue('--text-color').trim(), gridColor: styles.getPropertyValue('--border-color').trim(), isLight: isLightTheme, gradients: gradientPairs, success: styles.getPropertyValue('--success-color').trim(), danger: styles.getPropertyValue('--danger-color').trim(), initial: styles.getPropertyValue('--initial-color').trim(), changed: styles.getPropertyValue('--changed-color').trim() }; }
        function setPreferredTheme() { const savedTheme = localStorage.getItem('theme') || 'dark'; if (savedTheme === 'light') { bodyElement.classList.add('light-theme'); themeToggleBtn.textContent = 'Темна Тема'; } else { bodyElement.classList.remove('light-theme'); themeToggleBtn.textContent = 'Світла Тема'; } updateChartThemes(); }
        themeToggleBtn.addEventListener('click', () => { bodyElement.classList.toggle('light-theme'); let newTheme = bodyElement.classList.contains('light-theme') ? 'light' : 'dark'; themeToggleBtn.textContent = newTheme === 'light' ? 'Темна Тема' : 'Світла Тема'; localStorage.setItem('theme', newTheme); updateChartThemes(); });
        function updateChartThemes() { if (calculationSuccess && (comparisonChart || deltaChart)) { renderCharts(); } }

        // --- Core Calculator Logic ---
        document.getElementById('report-date').valueAsDate = new Date();
        function createWagonModule(id, selectedTypeKey = 'gondola_14') { const module = document.createElement('div'); module.classList.add('wagon-module'); module.id = `wagon-module-${id}`; let optionsHTML = ''; for (const key in wagonTypeData) { const selected = (key === selectedTypeKey) ? 'selected' : ''; optionsHTML += `<option value="${key}" ${selected}>${wagonTypeData[key].name}</option>`; } const defaults = wagonTypeData[selectedTypeKey] || wagonTypeData['custom']; module.innerHTML = `<button class="remove-wagon-btn" onclick="removeWagonModule(${id})" title="Видалити тип вагона">×</button><h3>Вагон #${id}</h3><div class="input-group" style="margin-bottom: 15px;"> <label for="wagon-type-select-${id}">Тип вагона:</label> <select id="wagon-type-select-${id}" onchange="updateWagonInputs(${id})"> ${optionsHTML} </select> </div><h4>Технічні характеристики</h4><div class="wagon-specs-grid"> <div class="input-group"> <label for="cylinder-diameter-${id}">D_ц:</label> <input type="number" id="cylinder-diameter-${id}" step="any" value="${defaults.diameter_in}" required> <span class="unit">дюйм</span> </div> <div class="input-group"> <label for="transmission-ratio-${id}">i_гп:</label> <input type="number" id="transmission-ratio-${id}" step="any" value="${defaults.i_gp}" required> </div> <div class="input-group"> <label for="efficiency-${id}">η_гп:</label> <input type="number" id="efficiency-${id}" step="0.01" min="0" max="1" value="${defaults.eta_gp}" required> </div> <div class="input-group"> <label for="cylinder-count-${id}">N_ц:</label> <input type="number" id="cylinder-count-${id}" min="1" step="1" value="${defaults.n_cyl}" required> </div> </div><h4>Кількість вагонів</h4><div class="wagon-counts-grid"> <div class="input-group"> <label for="wagon-count-initial-${id}">Початкова (N<sub>поч</sub>):</label> <input type="number" id="wagon-count-initial-${id}" min="0" step="1" value="${defaults.count_initial || 0}" required> </div> <div class="input-group"> <label for="wagon-count-changed-${id}">Змінена (N<sub>змін</sub>):</label> <input type="number" id="wagon-count-changed-${id}" min="0" step="1" value="${defaults.count_changed || 0}" required> </div> </div> `; const selectElement = module.querySelector(`#wagon-type-select-${id}`); if (selectElement) { selectElement.setAttribute('data-selected-text', selectElement.options[selectElement.selectedIndex].text); } return module; }
        function updateWagonInputs(id) { const selectElement = document.getElementById(`wagon-type-select-${id}`); const selectedKey = selectElement.value; const data = wagonTypeData[selectedKey]; const diameterInput = document.getElementById(`cylinder-diameter-${id}`); const ratioInput = document.getElementById(`transmission-ratio-${id}`); const efficiencyInput = document.getElementById(`efficiency-${id}`); const cylCountInput = document.getElementById(`cylinder-count-${id}`); if (data) { diameterInput.value = data.diameter_in; ratioInput.value = data.i_gp; efficiencyInput.value = data.eta_gp; cylCountInput.value = data.n_cyl; selectElement.setAttribute('data-selected-text', selectElement.options[selectElement.selectedIndex].text); } calculationSuccess = false; hideChart(); document.getElementById('total-initial-pressure').textContent = '...?'; document.getElementById('total-changed-pressure').textContent = '...?'; }
        document.getElementById('add-wagon-btn').addEventListener('click', () => { wagonCounter++; document.getElementById('wagon-modules-container').appendChild(createWagonModule(wagonCounter, 'custom')); hideChart(); calculationSuccess = false; });
        function removeWagonModule(id) { const module = document.getElementById(`wagon-module-${id}`); if (module) { module.style.animation = 'fadeOut var(--animation-speed) ease forwards'; setTimeout(() => { module.remove(); hideChart(); calculationSuccess = false; document.getElementById('total-initial-pressure').textContent = '...?'; }, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--animation-speed') || '0.3') * 1000); } }
        function addInitialData() { wagonCounter++; const data1 = { count_initial: 40, count_changed: 35 }; document.getElementById('wagon-modules-container').appendChild(createWagonModule(wagonCounter, 'gondola_14')); document.getElementById(`wagon-count-initial-${wagonCounter}`).value = data1.count_initial; document.getElementById(`wagon-count-changed-${wagonCounter}`).value = data1.count_changed; wagonCounter++; const data2 = { count_initial: 20, count_changed: 30 }; document.getElementById('wagon-modules-container').appendChild(createWagonModule(wagonCounter, 'tank_12')); document.getElementById(`wagon-count-initial-${wagonCounter}`).value = data2.count_initial; document.getElementById(`wagon-count-changed-${wagonCounter}`).value = data2.count_changed; }
        function highlightElement(element) { if (!element) return; element.classList.add('highlight'); setTimeout(() => { element.classList.remove('highlight'); }, 1000); }
        function setDeltaClass(element, value) { element.classList.remove('positive', 'negative', 'zero'); if (value > 0) { element.classList.add('positive'); } else if (value < 0) { element.classList.add('negative'); } else { element.classList.add('zero'); } }
        function calculateAll() {
            calculationSuccess = false; chartData = null; hideChart();
            const pressureMpaInitial = parseFloat(document.getElementById('pressure-mpa-initial').value); const pressureMpaChanged = parseFloat(document.getElementById('pressure-mpa-changed').value);
            if (isNaN(pressureMpaInitial) || pressureMpaInitial < 0 || isNaN(pressureMpaChanged) || pressureMpaChanged < 0) { alert("Введіть коректні тиски."); return; }
            const pressurePaInitial = pressureMpaInitial * 1e6; const pressurePaChanged = pressureMpaChanged * 1e6;
            const resultsTbody = document.getElementById('results-tbody'); resultsTbody.innerHTML = '';
            let totalInitialPressureTc = 0; let totalChangedPressureTc = 0; let hasErrors = false;
            const modules = document.querySelectorAll('.wagon-module');
            document.querySelectorAll('.wagon-module').forEach(m => m.style.border = ''); document.querySelectorAll('.input-group input, .input-group select').forEach(i => i.style.borderColor = '');
            const currentChartData = { labels: [], initialSums: [], changedSums: [], deltas: [] };
            if (modules.length === 0) { document.getElementById('total-initial-pressure').textContent = '0.00'; document.getElementById('total-changed-pressure').textContent = '0.00'; document.getElementById('delta-k').textContent = '0.00'; document.getElementById('percent-change').textContent = '0.00'; alert("Додайте вагони."); return; }
            modules.forEach(module => {
                if (hasErrors) return;
                const id = module.id.split('-').pop(); const selectElement = document.getElementById(`wagon-type-select-${id}`); const selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
                const inputs = { count_initial: document.getElementById(`wagon-count-initial-${id}`), count_changed: document.getElementById(`wagon-count-changed-${id}`), diameter: document.getElementById(`cylinder-diameter-${id}`), ratio: document.getElementById(`transmission-ratio-${id}`), efficiency: document.getElementById(`efficiency-${id}`), cylCount: document.getElementById(`cylinder-count-${id}`) };
                Object.values(inputs).forEach(input => input.style.borderColor = ''); selectElement.style.borderColor = ''; module.style.border = '';
                const values = { type: selectedOptionText || `Тип #${id}`, count_initial: parseInt(inputs.count_initial.value), count_changed: parseInt(inputs.count_changed.value), diameterIn: parseFloat(inputs.diameter.value), i_gp: parseFloat(inputs.ratio.value), eta_gp: parseFloat(inputs.efficiency.value), n_cyl: parseInt(inputs.cylCount.value) };
                let moduleError = false;
                 if (isNaN(values.count_initial) || values.count_initial < 0) { moduleError = true; inputs.count_initial.style.borderColor = 'red'; }
                 if (isNaN(values.count_changed) || values.count_changed < 0) { moduleError = true; inputs.count_changed.style.borderColor = 'red'; }
                 if (isNaN(values.diameterIn) || values.diameterIn <= 0) { moduleError = true; inputs.diameter.style.borderColor = 'red'; }
                 if (isNaN(values.i_gp) || values.i_gp <= 0) { moduleError = true; inputs.ratio.style.borderColor = 'red'; }
                 if (isNaN(values.eta_gp) || values.eta_gp <= 0 || values.eta_gp > 1) { moduleError = true; inputs.efficiency.style.borderColor = 'red'; }
                 if (isNaN(values.n_cyl) || values.n_cyl <= 0) { moduleError = true; inputs.cylCount.style.borderColor = 'red'; }
                 if (moduleError) { alert(`Помилка даних для "${values.type}".`); hasErrors = true; module.style.border = '2px solid var(--error-color)'; return; }
                const diameterM = values.diameterIn * 0.0254; const areaM2 = PI * (diameterM ** 2) / 4;
                const k_wag_initial_N = pressurePaInitial * areaM2 * values.i_gp * values.eta_gp * values.n_cyl; const k_wag_initial_tc = (values.count_initial > 0 && pressurePaInitial > 0) ? k_wag_initial_N / N_TO_TC_FACTOR : 0; const sum_k_initial_tc = k_wag_initial_tc * values.count_initial;
                const k_wag_changed_N = pressurePaChanged * areaM2 * values.i_gp * values.eta_gp * values.n_cyl; const k_wag_changed_tc = (values.count_changed > 0 && pressurePaChanged > 0) ? k_wag_changed_N / N_TO_TC_FACTOR : 0; const sum_k_changed_tc = k_wag_changed_tc * values.count_changed;
                const delta_k_type = sum_k_changed_tc - sum_k_initial_tc;
                if (isNaN(sum_k_initial_tc) || isNaN(sum_k_changed_tc)) { alert(`Помилка розрахунку для "${values.type}".`); hasErrors = true; module.style.border = '2px solid var(--error-color)'; return; }
                totalInitialPressureTc += sum_k_initial_tc; totalChangedPressureTc += sum_k_changed_tc;
                const row = resultsTbody.insertRow(); row.innerHTML = `<td>${values.type}</td> <td>${diameterM.toFixed(4)}</td> <td><span class="result-value">${areaM2.toFixed(4)}</span></td> <td>${values.i_gp.toFixed(2)}</td> <td>${values.eta_gp.toFixed(2)}</td> <td>${values.n_cyl}</td> <td>${values.count_initial}</td> <td><span class="result-value initial">${k_wag_initial_tc.toFixed(2)}</span></td> <td><span class="result-value initial">${sum_k_initial_tc.toFixed(2)}</span></td> <td>${values.count_changed}</td> <td><span class="result-value changed">${k_wag_changed_tc.toFixed(2)}</span></td> <td><span class="result-value changed">${sum_k_changed_tc.toFixed(2)}</span></td>`; row.querySelectorAll('.result-value').forEach(highlightElement);
                currentChartData.labels.push(values.type); currentChartData.initialSums.push(sum_k_initial_tc); currentChartData.changedSums.push(sum_k_changed_tc); currentChartData.deltas.push(delta_k_type);
            });
            const totalInitialElem = document.getElementById('total-initial-pressure'); const totalChangedElem = document.getElementById('total-changed-pressure'); const deltaKElem = document.getElementById('delta-k'); const percentChangeElem = document.getElementById('percent-change');
             if (hasErrors) { totalInitialElem.textContent = 'ПОМИЛКА'; totalChangedElem.textContent = 'ПОМИЛКА'; deltaKElem.textContent = 'ПОМИЛКА'; percentChangeElem.textContent = 'ПОМИЛКА'; [totalInitialElem, totalChangedElem, deltaKElem, percentChangeElem].forEach(el => { el.classList.remove('highlight'); el.parentElement.querySelectorAll('.value').forEach(v => v.classList.remove('positive', 'negative', 'zero')); }); calculationSuccess = false; return; }
            const deltaK = totalChangedPressureTc - totalInitialPressureTc; const percentChange = (totalInitialPressureTc !== 0) ? (deltaK / totalInitialPressureTc) * 100 : (totalChangedPressureTc > 0 ? Infinity : 0);
            totalInitialElem.textContent = totalInitialPressureTc.toFixed(2); totalChangedElem.textContent = totalChangedPressureTc.toFixed(2); deltaKElem.textContent = deltaK.toFixed(2); percentChangeElem.textContent = isFinite(percentChange) ? percentChange.toFixed(2) : "∞";
            setDeltaClass(deltaKElem, deltaK); setDeltaClass(percentChangeElem, deltaK);
            [totalInitialElem, totalChangedElem, deltaKElem, percentChangeElem].forEach(highlightElement);
            chartData = currentChartData; calculationSuccess = true;
            if(document.getElementById('report-content').textContent !== 'Натисніть "Сформувати звіт" після розрахунку.') { generateReport(); }
        }

        // --- Chart Functions ---
        function createChartGradient(context, colors) { const chart = context.chart; const {ctx, chartArea} = chart; if (!chartArea || !colors) { return colors?.start || '#cccccc'; } let x0, y0, x1, y1; if (chart.config.type === 'bar' && chart.config.options.indexAxis === 'y') { x0 = chartArea.left; y0 = 0; x1 = chartArea.right; y1 = 0; } else if (chart.config.type === 'bar') { x0 = 0; y0 = chartArea.bottom; x1 = 0; y1 = chartArea.top; } else { x0 = chartArea.left; y0 = chartArea.bottom; x1 = chartArea.right; y1 = chartArea.top; } const gradient = ctx.createLinearGradient(x0, y0, x1, y1); gradient.addColorStop(0, colors.start); gradient.addColorStop(1, colors.end); return gradient; }

        function renderCharts() {
            if (!calculationSuccess || !chartData || chartData.labels.length === 0) { console.warn("RenderCharts: No data or calculation failed."); document.getElementById('comparisonChartContainer').innerHTML = '<canvas id="comparisonChart"></canvas>'; document.getElementById('deltaChartContainer').innerHTML = '<canvas id="deltaChart"></canvas>'; const msg = '<p>Спочатку виконайте успішний розрахунок.</p>'; const chartSection = document.getElementById('chart-section'); const existingMsg = chartSection.querySelector('p'); if (!existingMsg) { chartSection.insertAdjacentHTML('afterbegin', msg); } const comparisonCanvas = document.getElementById('comparisonChart'); if(comparisonCanvas) comparisonCanvas.style.display = 'none'; const deltaCanvas = document.getElementById('deltaChart'); if(deltaCanvas) deltaCanvas.style.display = 'none'; return false; }
            const chartSection = document.getElementById('chart-section'); const existingMsg = chartSection.querySelector('p'); if(existingMsg) existingMsg.remove();
            let comparisonCanvas = document.getElementById('comparisonChart'); if (!comparisonCanvas) { document.getElementById('comparisonChartContainer').innerHTML = '<canvas id="comparisonChart"></canvas>'; comparisonCanvas = document.getElementById('comparisonChart'); } comparisonCanvas.style.display = 'block';
            let deltaCanvas = document.getElementById('deltaChart'); if (!deltaCanvas) { document.getElementById('deltaChartContainer').innerHTML = '<canvas id="deltaChart"></canvas>'; deltaCanvas = document.getElementById('deltaChart'); } deltaCanvas.style.display = 'block';
            const comparisonCtx = comparisonCanvas.getContext('2d'); const deltaCtx = deltaCanvas.getContext('2d');
            if (comparisonChart) comparisonChart.destroy(); if (deltaChart) deltaChart.destroy();
            const themeColors = getThemeColors();
            const initialGradient = themeColors.gradients[0]; const changedGradient = themeColors.gradients[1];

            // --- Grouped Bar Chart ---
            comparisonChart = new Chart(comparisonCtx, { type: 'bar', data: { labels: chartData.labels, datasets: [ { label: '∑ K поч (тс)', data: chartData.initialSums.map(v => v.toFixed(2)), backgroundColor: context => createChartGradient(context, initialGradient), borderWidth: 0, hoverBorderColor: themeColors.textColor, hoverBorderWidth: 1 }, { label: '∑ K змін (тс)', data: chartData.changedSums.map(v => v.toFixed(2)), backgroundColor: context => createChartGradient(context, changedGradient), borderWidth: 0, hoverBorderColor: themeColors.textColor, hoverBorderWidth: 1 } ] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', scales: { x: { ticks: { color: themeColors.textColor }, grid: { display: false } }, y: { beginAtZero: false, /* Allow negative axis for comparison */ title: { display: true, text: 'Сумарний натиск (тс)', color: themeColors.textColor }, ticks: { color: themeColors.textColor }, grid: { color: themeColors.gridColor } } }, plugins: { legend: { position: 'top', labels: { color: themeColors.textColor } }, tooltip: { mode: 'index', intersect: false }, title: { display: true, text: 'Порівняння Сумарного Натиску (Початковий vs Змінений)', color: themeColors.textColor, font: { size: 16, weight: 'bold' }, padding: { top: 10, bottom: 20 } } } } });
            // --- Delta Bar Chart ---
            deltaChart = new Chart(deltaCtx, { type: 'bar', data: { labels: chartData.labels, datasets: [{ label: 'ΔK (тс)', data: chartData.deltas.map(v => v.toFixed(2)), backgroundColor: context => { const value = context.raw; return value >= 0 ? themeColors.success : themeColors.danger; }, borderColor: context => { const value = context.raw; return value >= 0 ? themeColors.success : themeColors.danger; }, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { position: 'center', title: { display: true, text: 'Зміна натиску ΔK (тс)', color: themeColors.textColor }, ticks: { color: themeColors.textColor }, grid: { color: themeColors.gridColor } }, y: { ticks: { color: themeColors.textColor }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => `Зміна: ${context.raw.toFixed(2)} тс` } }, title: { display: true, text: 'Абсолютна Зміна Натиску за Типом Вагона (ΔK)', color: themeColors.textColor, font: { size: 16, weight: 'bold' }, padding: { top: 10, bottom: 20 } } } } });
            return true;
        }

        function toggleChart() { const chartSection = document.getElementById('chart-section'); if (!calculationSuccess) { alert("Спочатку виконайте розрахунок."); hideChart(); return; } if (chartSection.classList.contains('visible')) { hideChart(); } else { if (renderCharts()) { chartSection.classList.add('visible'); } else { chartSection.classList.add('visible'); } } }
        function hideChart() { const chartSection = document.getElementById('chart-section'); chartSection.classList.remove('visible'); }

        // --- Report, Print, Reset Functions ---
        function generateReport() { const studentName = document.getElementById('student-name').value || 'Не вказано'; const studentGroup = document.getElementById('student-group').value || 'Не вказано'; const reportDate = document.getElementById('report-date').value || 'Не вказано'; const pressureMpaInitial = document.getElementById('pressure-mpa-initial').value; const pressureMpaChanged = document.getElementById('pressure-mpa-changed').value; const totalInitial = document.getElementById('total-initial-pressure').textContent; const totalChanged = document.getElementById('total-changed-pressure').textContent; const deltaK = document.getElementById('delta-k').textContent; const percentChange = document.getElementById('percent-change').textContent; let reportText = `ЗВІТ ПРО ВИКОНАННЯ ПРАКТИЧНОЇ РОБОТИ\nТема: Перерахунок натиску гальмівних колодок у вантажних поїздах\n\nВиконавець:\n  ПІБ: ${studentName}\n  Група: ${studentGroup}\nДата: ${reportDate}\n\n=========================================================================\nВИХІДНІ ДАНІ ТА РЕЗУЛЬТАТИ РОЗРАХУНКУ / ПЕРЕРАХУНКУ\n=========================================================================\n\nЗагальні параметри:\n  Початковий тиск у ГЦ (p_ц_поч): ${pressureMpaInitial} МПа\n  Змінений тиск у ГЦ   (p_ц_змін): ${pressureMpaChanged} МПа\n\n-------------------------------------------------------------------------\nХарактеристики та результати по типах вагонів:\n-------------------------------------------------------------------------\nТип вагона | D_ц(м) | F_ц(м²) | i_гп | η_гп | N_ц | N_поч | K_ваг_п(тс)| ∑K_поч(тс)| N_змін | K_ваг_з(тс)| ∑K_змін(тс)\n-----------|--------|---------|------|------|-----|-------|------------|-----------|--------|------------|-----------\n`; const tableRows = document.querySelectorAll('#results-tbody tr'); if (!calculationSuccess && totalInitial === 'ПОМИЛКА') { reportText += `ПОМИЛКА В РОЗРАХУНКАХ! Перевірте вхідні дані.\n`; } else if (tableRows.length === 0) { reportText += `Розрахунок ще не виконано або у поїзді 0 типів вагонів.\n`; } else if (!calculationSuccess) { reportText += `Розрахунок не був виконаний успішно.\n`;} else { tableRows.forEach(row => { const cells = row.cells; const type = (cells[0]?.textContent ?? 'N/A').padEnd(10).substring(0,10); const d_c = (cells[1]?.textContent ?? 'N/A').padStart(6); const f_c = (cells[2]?.querySelector('.result-value')?.textContent ?? 'N/A').padStart(7); const i_gp = (cells[3]?.textContent ?? 'N/A').padStart(4); const eta_gp = (cells[4]?.textContent ?? 'N/A').padStart(4); const n_c = (cells[5]?.textContent ?? 'N/A').padStart(3); const n_i = (cells[6]?.textContent ?? 'N/A').padStart(5); const k_i = (cells[7]?.querySelector('.result-value')?.textContent ?? 'N/A').padStart(10); const sum_i = (cells[8]?.querySelector('.result-value')?.textContent ?? 'N/A').padStart(9); const n_cng = (cells[9]?.textContent ?? 'N/A').padStart(6); const k_cng = (cells[10]?.querySelector('.result-value')?.textContent ?? 'N/A').padStart(10); const sum_cng = (cells[11]?.querySelector('.result-value')?.textContent ?? 'N/A').padStart(9); reportText += `${type} | ${d_c} | ${f_c} | ${i_gp} | ${eta_gp} | ${n_c} | ${n_i} | ${k_i} | ${sum_i} | ${n_cng} | ${k_cng} | ${sum_cng}\n`; }); reportText += `-------------------------------------------------------------------------\n`; } reportText += `\n=========================================================================\nЗАГАЛЬНІ РЕЗУЛЬТАТИ:\n  Загальний початковий натиск (К_поїзда_поч): ${totalInitial} тс\n  Загальний змінений натиск   (К_поїзда_змін): ${totalChanged} тс\n  Абсолютна зміна (ΔK):                       ${deltaK} тс\n  Відносна зміна (%):                         ${percentChange} %\n=========================================================================\n`; document.getElementById('report-content').textContent = reportText; document.getElementById('report-print-area').textContent = reportText; }
        function printReport() { if(document.getElementById('report-content').textContent === 'Натисніть "Сформувати звіт" після розрахунку.') { generateReport(); } if (!calculationSuccess || document.getElementById('total-initial-pressure').textContent === 'ПОМИЛКА') { alert('Неможливо роздрукувати звіт з помилками або без успішного розрахунку.'); return; } window.print(); }
        function resetCalculator() { document.getElementById('student-name').value = ''; document.getElementById('student-group').value = ''; document.getElementById('report-date').valueAsDate = new Date(); document.getElementById('pressure-mpa-initial').value = '0.4'; document.getElementById('pressure-mpa-changed').value = '0.38'; document.getElementById('wagon-modules-container').innerHTML = ''; document.getElementById('results-tbody').innerHTML = ''; document.getElementById('total-initial-pressure').textContent = '0.00'; document.getElementById('total-changed-pressure').textContent = '0.00'; document.getElementById('delta-k').textContent = '0.00'; document.getElementById('percent-change').textContent = '0.00'; setDeltaClass(document.getElementById('delta-k'), 0); setDeltaClass(document.getElementById('percent-change'), 0); document.getElementById('report-content').textContent = 'Натисніть "Сформувати звіт" після розрахунку.'; document.getElementById('report-print-area').textContent = ''; document.querySelectorAll('.wagon-module').forEach(m => m.style.border = ''); document.querySelectorAll('.input-group input, .input-group select').forEach(i => i.style.borderColor = ''); wagonCounter = 0; calculationSuccess = false; chartData = null; hideChart(); if (comparisonChart) { comparisonChart.destroy(); comparisonChart = null; } if (deltaChart) { deltaChart.destroy(); deltaChart = null; } document.getElementById('comparisonChartContainer').innerHTML = '<canvas id="comparisonChart"></canvas>'; document.getElementById('deltaChartContainer').innerHTML = '<canvas id="deltaChart"></canvas>'; const chartSection = document.getElementById('chart-section'); const existingMsg = chartSection.querySelector('p'); if(existingMsg) existingMsg.remove(); addInitialData(); }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => { setPreferredTheme(); addInitialData(); hideChart(); });

    </script>

</body>
</html>